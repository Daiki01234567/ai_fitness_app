# デプロイワークフロー
# mainブランチへのマージで本番環境にデプロイ
# developブランチへのマージでステージング環境にデプロイ

name: Deploy to Firebase

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"

jobs:
  # 環境の決定
  set-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      firebase_project: ${{ steps.set-env.outputs.firebase_project }}

    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

          # Firebase project mapping
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "firebase_project=tokyo-list-478804-e5" >> $GITHUB_OUTPUT
          else
            echo "firebase_project=tokyo-list-478804-e5" >> $GITHUB_OUTPUT
          fi

  # Cloud Functions デプロイ
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        working-directory: functions
        run: npm ci

      - name: Build functions
        working-directory: functions
        run: npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Functions
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions --project ${{ needs.set-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # Firestore Rules デプロイ
  deploy-firestore-rules:
    name: Deploy Firestore Rules
    runs-on: ubuntu-latest
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Firestore Rules
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:rules --project ${{ needs.set-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # Storage Rules デプロイ
  deploy-storage-rules:
    name: Deploy Storage Rules
    runs-on: ubuntu-latest
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Storage Rules
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only storage:rules --project ${{ needs.set-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # Firestore Indexes デプロイ
  deploy-firestore-indexes:
    name: Deploy Firestore Indexes
    runs-on: ubuntu-latest
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Firestore Indexes
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:indexes --project ${{ needs.set-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # デプロイ後のヘルスチェック
  health-check:
    name: Post-deploy Health Check
    runs-on: ubuntu-latest
    needs:
      - set-environment
      - deploy-functions
      - deploy-firestore-rules
      - deploy-storage-rules
    if: success()

    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Health check - Functions
        run: |
          # Check if the functions endpoint is responding
          # Note: Replace with actual health check endpoint when available
          echo "Deployment completed for ${{ needs.set-environment.outputs.environment }}"
          echo "Firebase Project: ${{ needs.set-environment.outputs.firebase_project }}"

      - name: Verify deployment
        run: |
          echo "✅ All Firebase resources deployed successfully"
          echo "Environment: ${{ needs.set-environment.outputs.environment }}"

  # デプロイ完了通知
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs:
      - set-environment
      - deploy-functions
      - deploy-firestore-rules
      - deploy-storage-rules
      - health-check
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy-functions.result }}" == "success" ] && \
             [ "${{ needs.deploy-firestore-rules.result }}" == "success" ] && \
             [ "${{ needs.deploy-storage-rules.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: ${{ vars.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} Firebase Deploy - ${{ needs.set-environment.outputs.environment }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.status.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ needs.set-environment.outputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ needs.set-environment.outputs.environment }}';
            const status = '${{ steps.status.outputs.status }}';

            // Create deployment
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: environment,
              required_contexts: [],
              auto_merge: false,
              description: `Deploy to ${environment}`
            });

            // Create deployment status
            if (deployment.data.id) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: status === 'success' ? 'success' : 'failure',
                environment_url: `https://console.firebase.google.com/project/${{ needs.set-environment.outputs.firebase_project }}`,
                description: `Deployment ${status}`
              });
            }
