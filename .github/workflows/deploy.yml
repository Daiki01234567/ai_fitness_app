# 本番デプロイワークフロー
# 手動トリガーまたはリリースタグ作成時に実行
# GitHub Environments の承認機能を使用
#
# Based on: docs/common/tickets/008-cicd-pipeline.md
# Requirements:
#   - mainブランチへのマージで開発環境にデプロイ
#   - タグ作成（リリース）で本番環境にデプロイ
#   - 本番デプロイは手動承認を必要とする

name: Deploy to Firebase

on:
  # 手動トリガー
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      deploy_functions:
        description: 'Deploy Cloud Functions'
        required: true
        default: true
        type: boolean
      deploy_firestore_rules:
        description: 'Deploy Firestore Rules'
        required: true
        default: true
        type: boolean
      deploy_storage_rules:
        description: 'Deploy Storage Rules'
        required: true
        default: true
        type: boolean
      deploy_indexes:
        description: 'Deploy Firestore Indexes'
        required: true
        default: true
        type: boolean

  # mainブランチへのプッシュで開発環境にデプロイ
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - 'firebase/**'

  # リリースタグ作成で本番環境にデプロイ
  release:
    types: [published]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"
  FIREBASE_PROJECT_DEV: "tokyo-list-478804-e5"
  FIREBASE_PROJECT_PROD: "tokyo-list-478804-e5"  # 本番プロジェクトIDに変更

jobs:
  # 環境の決定
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      firebase_project: ${{ steps.set-env.outputs.firebase_project }}
      deploy_functions: ${{ steps.set-env.outputs.deploy_functions }}
      deploy_firestore_rules: ${{ steps.set-env.outputs.deploy_firestore_rules }}
      deploy_storage_rules: ${{ steps.set-env.outputs.deploy_storage_rules }}
      deploy_indexes: ${{ steps.set-env.outputs.deploy_indexes }}

    steps:
      - name: Set environment variables
        id: set-env
        run: |
          # Determine environment
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deploy_functions=${{ github.event.inputs.deploy_functions }}" >> $GITHUB_OUTPUT
            echo "deploy_firestore_rules=${{ github.event.inputs.deploy_firestore_rules }}" >> $GITHUB_OUTPUT
            echo "deploy_storage_rules=${{ github.event.inputs.deploy_storage_rules }}" >> $GITHUB_OUTPUT
            echo "deploy_indexes=${{ github.event.inputs.deploy_indexes }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "deploy_functions=true" >> $GITHUB_OUTPUT
            echo "deploy_firestore_rules=true" >> $GITHUB_OUTPUT
            echo "deploy_storage_rules=true" >> $GITHUB_OUTPUT
            echo "deploy_indexes=true" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "deploy_functions=true" >> $GITHUB_OUTPUT
            echo "deploy_firestore_rules=true" >> $GITHUB_OUTPUT
            echo "deploy_storage_rules=true" >> $GITHUB_OUTPUT
            echo "deploy_indexes=true" >> $GITHUB_OUTPUT
          fi

          # Set Firebase project based on environment
          if [ "${{ github.event.inputs.environment }}" == "production" ] || [ "${{ github.event_name }}" == "release" ]; then
            echo "firebase_project=${{ env.FIREBASE_PROJECT_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "firebase_project=${{ env.FIREBASE_PROJECT_DEV }}" >> $GITHUB_OUTPUT
          fi

  # デプロイ前のテスト実行
  pre-deploy-tests:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest
    needs: determine-environment

    defaults:
      run:
        working-directory: functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build TypeScript
        run: npm run build

      - name: Run tests
        run: npm test

  # Cloud Functions デプロイ
  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    needs: [determine-environment, pre-deploy-tests]
    if: needs.determine-environment.outputs.deploy_functions == 'true' && vars.DEPLOY_ENABLED == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: https://console.firebase.google.com/project/${{ needs.determine-environment.outputs.firebase_project }}/functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: functions

      - name: Build functions
        run: npm run build
        working-directory: functions

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Cloud Functions
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions --project ${{ needs.determine-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # Firestore Rules デプロイ
  deploy-firestore-rules:
    name: Deploy Firestore Rules
    runs-on: ubuntu-latest
    needs: [determine-environment, pre-deploy-tests]
    if: needs.determine-environment.outputs.deploy_firestore_rules == 'true' && vars.DEPLOY_ENABLED == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Validate Firestore rules before deploy
        run: |
          npm install -g firebase-tools
          firebase --project=${{ needs.determine-environment.outputs.firebase_project }} \
            firestore:rules:validate firebase/firestore.rules

      - name: Deploy Firestore Rules
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:rules --project ${{ needs.determine-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # Storage Rules デプロイ
  deploy-storage-rules:
    name: Deploy Storage Rules
    runs-on: ubuntu-latest
    needs: [determine-environment, pre-deploy-tests]
    if: needs.determine-environment.outputs.deploy_storage_rules == 'true' && vars.DEPLOY_ENABLED == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Storage Rules
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only storage:rules --project ${{ needs.determine-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # Firestore Indexes デプロイ
  deploy-firestore-indexes:
    name: Deploy Firestore Indexes
    runs-on: ubuntu-latest
    needs: [determine-environment, pre-deploy-tests]
    if: needs.determine-environment.outputs.deploy_indexes == 'true' && vars.DEPLOY_ENABLED == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Deploy Firestore Indexes
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only firestore:indexes --project ${{ needs.determine-environment.outputs.firebase_project }}
        env:
          GCP_SA_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

  # デプロイ後のヘルスチェック
  post-deploy-health-check:
    name: Post-deploy Health Check
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - deploy-functions
      - deploy-firestore-rules
      - deploy-storage-rules
      - deploy-firestore-indexes
    if: always() && !cancelled()

    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Health check summary
        run: |
          echo "## Deployment Health Check"
          echo ""
          echo "Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "Firebase Project: ${{ needs.determine-environment.outputs.firebase_project }}"
          echo ""
          echo "| Component | Status |"
          echo "|-----------|--------|"
          echo "| Cloud Functions | ${{ needs.deploy-functions.result }} |"
          echo "| Firestore Rules | ${{ needs.deploy-firestore-rules.result }} |"
          echo "| Storage Rules | ${{ needs.deploy-storage-rules.result }} |"
          echo "| Firestore Indexes | ${{ needs.deploy-firestore-indexes.result }} |"

  # デプロイ完了通知
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - deploy-functions
      - deploy-firestore-rules
      - deploy-storage-rules
      - deploy-firestore-indexes
      - post-deploy-health-check
    if: always()

    steps:
      - name: Determine overall status
        id: status
        run: |
          # Check if any deployment failed
          FUNCTIONS_RESULT="${{ needs.deploy-functions.result }}"
          RULES_RESULT="${{ needs.deploy-firestore-rules.result }}"
          STORAGE_RESULT="${{ needs.deploy-storage-rules.result }}"
          INDEXES_RESULT="${{ needs.deploy-firestore-indexes.result }}"

          # Skip counts as success (when deploy is disabled)
          if [[ "$FUNCTIONS_RESULT" == "failure" ]] || \
             [[ "$RULES_RESULT" == "failure" ]] || \
             [[ "$STORAGE_RESULT" == "failure" ]] || \
             [[ "$INDEXES_RESULT" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Deployment failed!" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Deployment completed successfully!" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Firebase Deployment - ${{ needs.determine-environment.outputs.environment }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.status.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ needs.determine-environment.outputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Project:*\n${{ needs.determine-environment.outputs.firebase_project }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub deployment record
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const environment = '${{ needs.determine-environment.outputs.environment }}';
            const status = '${{ steps.status.outputs.status }}';

            try {
              // Create deployment record
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: environment,
                required_contexts: [],
                auto_merge: false,
                description: `Deploy to ${environment} - ${{ github.event_name }}`
              });

              if (deployment.data && deployment.data.id) {
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.data.id,
                  state: status === 'success' ? 'success' : 'failure',
                  environment_url: `https://console.firebase.google.com/project/${{ needs.determine-environment.outputs.firebase_project }}`,
                  description: `Deployment ${status}`
                });
                console.log(`Deployment status created: ${status}`);
              }
            } catch (error) {
              console.log(`Could not create deployment status: ${error.message}`);
            }

  # ロールバック手順の表示（失敗時）
  rollback-instructions:
    name: Rollback Instructions
    runs-on: ubuntu-latest
    needs:
      - determine-environment
      - deploy-functions
      - deploy-firestore-rules
    if: failure()

    steps:
      - name: Display rollback instructions
        run: |
          echo "## Deployment Failed - Rollback Instructions"
          echo ""
          echo "Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "Firebase Project: ${{ needs.determine-environment.outputs.firebase_project }}"
          echo ""
          echo "### To rollback Cloud Functions:"
          echo "\`\`\`bash"
          echo "# Option 1: Revert the commit and re-deploy"
          echo "git revert <commit-hash>"
          echo "git push origin main"
          echo ""
          echo "# Option 2: Manual rollback using Firebase Console"
          echo "# Visit: https://console.firebase.google.com/project/${{ needs.determine-environment.outputs.firebase_project }}/functions/list"
          echo ""
          echo "# Option 3: Deploy previous version"
          echo "git checkout <previous-tag>"
          echo "firebase deploy --only functions --project ${{ needs.determine-environment.outputs.firebase_project }}"
          echo "\`\`\`"
          echo ""
          echo "### To rollback Firestore Rules:"
          echo "\`\`\`bash"
          echo "# Revert to previous rules version"
          echo "git checkout <previous-commit> -- firebase/firestore.rules"
          echo "firebase deploy --only firestore:rules --project ${{ needs.determine-environment.outputs.firebase_project }}"
          echo "\`\`\`"
