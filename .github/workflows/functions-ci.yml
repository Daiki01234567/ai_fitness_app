# Cloud Functions CI ワークフロー
# PRごとおよびmainブランチへのマージでLint、テスト、セキュリティチェックを実行
#
# Based on: docs/common/tickets/008-cicd-pipeline.md
# Requirements:
#   - NFR-026: コードカバレッジ 80%以上
#   - NFR-027: 全機能のドキュメント化

name: Cloud Functions CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'functions/**'
      - '.github/workflows/functions-ci.yml'
  push:
    branches: [main]
    paths:
      - 'functions/**'
      - '.github/workflows/functions-ci.yml'

concurrency:
  group: functions-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  COVERAGE_THRESHOLD: 80

jobs:
  # Lint & Format チェック
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

  # TypeScript ビルド
  build:
    name: Build TypeScript
    runs-on: ubuntu-latest
    needs: lint

    defaults:
      run:
        working-directory: functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: functions/lib
          retention-days: 7

  # ユニットテスト & カバレッジ
  test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: build

    defaults:
      run:
        working-directory: functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage -- --ci --reporters=default --reporters=jest-junit
        env:
          JEST_JUNIT_OUTPUT_DIR: ./reports
          JEST_JUNIT_OUTPUT_NAME: junit.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: functions/coverage
          flags: functions
          name: functions-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        run: |
          # Read coverage summary
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Line coverage: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is below the threshold of ${{ env.COVERAGE_THRESHOLD }}%"
            # Set as warning only, not fail for now
            # exit 1
          else
            echo "Coverage meets the threshold!"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: functions/reports
          retention-days: 30

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: functions/coverage
          retention-days: 30

  # セキュリティチェック
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for known vulnerabilities
        run: |
          # Run npm audit and capture output
          npm audit --json > audit-report.json || true

          # Check for high/critical vulnerabilities
          HIGH_VULNS=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')

          echo "High vulnerabilities: $HIGH_VULNS"
          echo "Critical vulnerabilities: $CRITICAL_VULNS"

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "::error::Critical vulnerabilities found!"
            exit 1
          fi

          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "::warning::High vulnerabilities found. Please review and update dependencies."
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: functions/audit-report.json
          retention-days: 30

  # Firebase Emulator を使った統合テスト
  integration-test:
    name: Integration Tests (Emulator)
    runs-on: ubuntu-latest
    needs: build

    defaults:
      run:
        working-directory: functions

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Setup Java (for Firebase Emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Build functions
        run: npm run build

      - name: Run integration tests with emulator
        run: |
          firebase emulators:exec --only functions,firestore,auth "npm run test:integration" \
            --project tokyo-list-478804-e5 || true
        continue-on-error: true

  # 結果サマリー
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, build, test, security, integration-test]
    if: always()

    steps:
      - name: Check all job results
        run: |
          echo "## Cloud Functions CI Results"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Lint & Format | ${{ needs.lint.result }} |"
          echo "| Build | ${{ needs.build.result }} |"
          echo "| Unit Tests | ${{ needs.test.result }} |"
          echo "| Security Audit | ${{ needs.security.result }} |"
          echo "| Integration Tests | ${{ needs.integration-test.result }} |"

          # Fail if critical jobs failed
          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.build.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ]; then
            echo ""
            echo "Critical job(s) failed!"
            exit 1
          fi

          echo ""
          echo "All critical checks passed!"
