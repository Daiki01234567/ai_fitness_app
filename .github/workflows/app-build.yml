# Flutter ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ãŒä½œæˆã•ã‚ŒãŸã¨ãã«Android/iOSãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ

name: Build Flutter App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android'
        required: true
        default: true
        type: boolean
      build_ios:
        description: 'Build iOS'
        required: true
        default: true
        type: boolean
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - profile
          - release

env:
  FLUTTER_VERSION: "3.24.0"
  JAVA_VERSION: "17"
  XCODE_VERSION: "15.0"

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æŠ½å‡º
  extract-version:
    name: Extract Version Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}

    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          else
            # Use a default version for manual runs
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
          fi
          # Use run number as build number
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT

  # Android ãƒ“ãƒ«ãƒ‰
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: extract-version
    if: ${{ github.event_name == 'push' || github.event.inputs.build_android == 'true' }}

    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - name: Decode keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks

      - name: Set version
        run: |
          flutter pub run flutter_version_tool --set-version=${{ needs.extract-version.outputs.version }} --set-build-number=${{ needs.extract-version.outputs.build_number }} || true

      - name: Build APK
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          flutter build apk --${BUILD_TYPE} --build-number=${{ needs.extract-version.outputs.build_number }}

      - name: Build App Bundle (AAB)
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          flutter build appbundle --${BUILD_TYPE} --build-number=${{ needs.extract-version.outputs.build_number }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ needs.extract-version.outputs.version }}
          path: flutter_app/build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ needs.extract-version.outputs.version }}
          path: flutter_app/build/app/outputs/bundle/release/*.aab
          retention-days: 30

  # iOS ãƒ“ãƒ«ãƒ‰
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: extract-version
    if: ${{ github.event_name == 'push' || github.event.inputs.build_ios == 'true' }}

    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          architecture: x64

      - name: Get dependencies
        run: flutter pub get

      - name: Setup CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Install Apple Certificate
        if: ${{ env.IOS_P12_BASE64 != '' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Install Provisioning Profile
        if: ${{ env.IOS_PROVISIONING_PROFILE_BASE64 != '' }}
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Build iOS (No Code Sign)
        if: ${{ env.IOS_P12_BASE64 == '' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        run: |
          flutter build ios --release --no-codesign --build-number=${{ needs.extract-version.outputs.build_number }}

      - name: Build iOS (With Code Sign)
        if: ${{ env.IOS_P12_BASE64 != '' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        run: |
          flutter build ipa --release --build-number=${{ needs.extract-version.outputs.build_number }} \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload iOS artifact (No Code Sign)
        if: ${{ env.IOS_P12_BASE64 == '' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ needs.extract-version.outputs.version }}
          path: flutter_app/build/ios/iphoneos/*.app
          retention-days: 30

      - name: Upload IPA artifact
        if: ${{ env.IOS_P12_BASE64 != '' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ needs.extract-version.outputs.version }}
          path: flutter_app/build/ios/ipa/*.ipa
          retention-days: 30

      - name: Clean up keychain and provisioning profile
        if: ${{ always() }}
        run: |
          # Clean up keychain if it exists
          if [ -f "$RUNNER_TEMP/app-signing.keychain-db" ]; then
            security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          fi
          # Clean up provisioning profile if it exists
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision || true

  # ãƒ“ãƒ«ãƒ‰çµæžœã®ã‚µãƒžãƒªãƒ¼
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs:
      - extract-version
      - build-android
      - build-ios
    if: always()

    steps:
      - name: Create release notes
        run: |
          echo "# Release ${{ needs.extract-version.outputs.version }}" > release_notes.md
          echo "" >> release_notes.md
          echo "## Build Information" >> release_notes.md
          echo "- Version: ${{ needs.extract-version.outputs.version }}" >> release_notes.md
          echo "- Build Number: ${{ needs.extract-version.outputs.build_number }}" >> release_notes.md
          echo "- Commit: ${{ github.sha }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Build Status" >> release_notes.md
          echo "- Android: ${{ needs.build-android.result }}" >> release_notes.md
          echo "- iOS: ${{ needs.build-ios.result }}" >> release_notes.md

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ needs.extract-version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.extract-version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify build completion
        run: |
          echo "ðŸŽ‰ Build completed!"
          echo "Version: ${{ needs.extract-version.outputs.version }}"
          echo "Android: ${{ needs.build-android.result }}"
          echo "iOS: ${{ needs.build-ios.result }}"
