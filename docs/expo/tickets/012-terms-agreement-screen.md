# 012 利用規約同意画面実装

## 概要

ユーザーが利用規約とプライバシーポリシーに同意するための画面を実装します。両方の文書を表示し、チェックボックスで明示的な同意を取得します。同意しないとアプリを利用できません。

## Phase

Phase 1（基盤構築）

## 依存チケット

- 007: スプラッシュ画面実装（画面遷移のため）
- 011: 新規登録画面実装

## 要件

### 画面構成

- 画面タイトル「利用規約とプライバシーポリシー」
- 説明文「サービスをご利用いただく前に、以下の内容をご確認ください。」
- 利用規約セクション（スクロール可能なテキスト）
- プライバシーポリシーセクション（スクロール可能なテキスト）
- 利用規約同意チェックボックス「利用規約に同意します」
- プライバシーポリシー同意チェックボックス「プライバシーポリシーに同意します」
- 注意書き「両方の同意が必要です」
- 「同意して続ける」ボタン（両方チェック時のみ有効）
- 「同意しない（ログアウト）」リンク

### 利用規約・プライバシーポリシー表示

- 利用規約 v3.2の全文を表示
- プライバシーポリシー v3.1の全文を表示
- 各セクションは独立してスクロール可能
- 長文を読みやすくするためのタイポグラフィ

### 同意取得の仕組み

- 2つのチェックボックスは独立して操作可能
- 両方にチェックが入った場合のみ「同意して続ける」ボタンが有効化
- チェックボックスはデフォルトでオフ（GDPRの明示的同意要件）

### 同意処理

同意ボタン押下時に以下を実行:
1. `users/{userId}` ドキュメントを更新
   - `tosAccepted = true`
   - `ppAccepted = true`
   - `tosAcceptedAt = serverTimestamp()`
   - `ppAcceptedAt = serverTimestamp()`
2. `consents` コレクションに同意記録を追加（2件）
3. ホーム画面へ遷移

### 同意しない場合の処理

- 確認ダイアログを表示
- 「同意しないとサービスを利用できません」と説明
- ユーザーがキャンセルした場合は画面に戻る
- ユーザーが確認した場合はログアウトしてログイン画面へ遷移

## 受け入れ条件

- [ ] 利用規約の全文が表示される
- [ ] プライバシーポリシーの全文が表示される
- [ ] 各セクションがスクロール可能
- [ ] 利用規約チェックボックスが動作する
- [ ] プライバシーポリシーチェックボックスが動作する
- [ ] 両方にチェックが入らないと「同意して続ける」ボタンが無効
- [ ] 同意後、Firestoreの`users`ドキュメントが更新される
- [ ] 同意後、`consents`コレクションに記録が追加される
- [ ] 同意後、ホーム画面に遷移する
- [ ] 「同意しない」を選択すると確認ダイアログが表示される
- [ ] 同意拒否後、ログアウトされログイン画面に遷移する
- [ ] ローディング状態が適切に表示される
- [ ] エラー発生時に日本語でエラーメッセージが表示される

## 参照ドキュメント

- [要件定義書 Part 1](../specs/01_要件定義書_Expo版_v1_Part1.md) - FR-002-1 同意状態管理機能
- [要件定義書 Part 5](../specs/05_要件定義書_Expo版_v1_Part5.md) - GDPR対応、consentsコレクション
- [画面遷移図・ワイヤーフレーム](../specs/07_画面遷移図_ワイヤーフレーム_v1_0.md) - セクション3.5
- [利用規約 v3.2](../../specs/利用規約_v3_2.md)
- [プライバシーポリシー v3.1](../../specs/プライバシーポリシー_v3.1.md)

## 技術詳細

### Expo Router パス

`/auth/agreement`

### 使用ライブラリ

- `react-native-paper`: Checkbox, Button, Portal, Dialog, Text
- `react-native`: ScrollView
- `firebase/firestore`: updateDoc, addDoc, serverTimestamp

### 同意記録の作成

```typescript
// consentsコレクションに追加するドキュメント（利用規約）
{
  userId: string,
  consentType: 'tos',
  version: 'v3.2',
  accepted: true,
  consentedAt: serverTimestamp(),
  ipAddress: string, // ハッシュ化
  userAgent: 'AIFitness App/1.0.0'
}

// consentsコレクションに追加するドキュメント（プライバシーポリシー）
{
  userId: string,
  consentType: 'privacy_policy',
  version: 'v3.1',
  accepted: true,
  consentedAt: serverTimestamp(),
  ipAddress: string, // ハッシュ化
  userAgent: 'AIFitness App/1.0.0'
}
```

### 認証ガードとの連携

- ログイン時に`tosAccepted`と`ppAccepted`をチェック
- どちらかが`false`の場合、この画面に強制リダイレクト

## 注意事項

- チェックボックスは事前にチェックされていない状態で表示すること（GDPRの明示的同意要件）
- 利用規約・プライバシーポリシーのバージョンは将来のアップデートに備えて記録すること
- IPアドレスはハッシュ化して保存すること
- 同意記録は監査目的で保持するため、削除しないこと
- スクロールビューの高さは画面サイズに応じて調整すること

## 見積もり

- 想定工数: 1〜2日

## 進捗

- [ ] 未着手
