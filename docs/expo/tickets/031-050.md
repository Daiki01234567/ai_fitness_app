# 031 Apple認証実装

## 概要

Apple認証（Sign in with Apple）をExpo/React Nativeアプリに実装するチケットです。iOS環境でのソーシャルログイン手段として、Appleの必須要件に対応します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/006（認証画面）完了後に着手可能

## 要件

### 機能要件

- FR-001: ユーザー登録（Apple認証追加）
- FR-002: ユーザーログイン（Apple認証追加）

### 非機能要件

- NFR-009: 通信暗号化（TLS 1.3）
- NFR-013: OAuth 2.0準拠の認証

## 受け入れ条件（Todo）

- [ ] expo-apple-authenticationライブラリをインストール
- [ ] Apple Developer Consoleでアプリ設定（Sign in with Apple有効化）
- [ ] Firebaseコンソールでサインインプロバイダ追加（Apple）
- [ ] ログイン画面にAppleボタンを追加
- [ ] Apple認証フローを実装（IDトークン取得→Firebase認証）
- [ ] エラーハンドリング実装（キャンセル、失敗時）
- [ ] iOS実機でテスト（シミュレータは非対応）
- [ ] 既存ユーザーとの紐付け処理を実装

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-001, FR-002
- `docs/common/specs/02-2_非機能要件_v1_0.md` - NFR-009, NFR-013
- `docs/expo/specs/01_技術スタック_v1_0.md` - 認証技術

## 技術詳細

### 使用パッケージ

```bash
npx expo install expo-apple-authentication
```

### 実装例

```typescript
import * as AppleAuthentication from 'expo-apple-authentication';
import { getAuth, signInWithCredential, OAuthProvider } from 'firebase/auth';

const handleAppleSignIn = async () => {
  try {
    const credential = await AppleAuthentication.signInAsync({
      requestedScopes: [
        AppleAuthentication.AppleAuthenticationScope.FULL_NAME,
        AppleAuthentication.AppleAuthenticationScope.EMAIL,
      ],
    });

    // Apple IDトークンを使用してFirebase認証
    const oauthCredential = OAuthProvider.credential({
      idToken: credential.identityToken,
    });

    const auth = getAuth();
    const userCredential = await signInWithCredential(auth, oauthCredential);

    // ログイン成功
  } catch (error) {
    // エラーハンドリング
  }
};
```

### Firebaseコンソール設定

Authentication → Sign-in method → Apple → 有効化

### Apple Developer設定

1. Certificates, Identifiers & Profiles → Identifiers
2. アプリID選択 → Capabilities → Sign in with Apple有効化
3. Services ID作成（OAuth用）

### エラー処理

- `AppleAuthenticationError.CANCELED`: ユーザーがキャンセル
- `AppleAuthenticationError.FAILED`: 認証失敗
- `AppleAuthenticationError.INVALID_RESPONSE`: 無効なレスポンス
- `AppleAuthenticationError.NOT_HANDLED`: 処理エラー

## 見積もり

- 工数: 2日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- iOS 13以上が必要
- Expoシミュレータでは動作しない（実機のみ）
- Appleストア申請時、他のソーシャルログインがある場合はAppleログインも必須

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 032 Stripe Payment Sheet実装

## 概要

Stripe Payment SheetをExpo/React Nativeアプリに統合するチケットです。ユーザーが課金プランを選択して決済できる仕組みを実装します。Common/031（Stripe統合基盤）が完了している必要があります。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/002（開発環境セットアップ）完了後に着手可能
- common/031（Stripe統合基盤）完了後に実装可能

## 要件

### 機能要件

- FR-015: 課金プラン選択（月額/年額）
- FR-016: サブスクリプション購入

### 非機能要件

- NFR-009: 通信暗号化（TLS 1.3）
- NFR-010: PCI DSS準拠（Stripeが保証）

## 受け入れ条件（Todo）

- [ ] @stripe/stripe-react-nativeライブラリをインストール
- [ ] StripeProviderでアプリをラップ
- [ ] Publishable Keyの設定（環境変数）
- [ ] Payment Intent作成APIをCloud Functionsに実装（common/031で実装済み確認）
- [ ] Payment Sheet表示処理を実装
- [ ] 決済成功・失敗時の処理を実装
- [ ] サブスクリプション状態の同期処理
- [ ] 実機でテスト決済（Test Mode）

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-015, FR-016
- `docs/common/specs/04_API設計書_Firebase_Functions_v1_0.md` - Stripe API
- `docs/expo/specs/01_技術スタック_v1_0.md` - 決済技術

## 技術詳細

### 使用パッケージ

```bash
npm install @stripe/stripe-react-native
```

### 環境変数設定

```bash
# .env
EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
```

### 実装例

```typescript
import { StripeProvider, useStripe } from '@stripe/stripe-react-native';

// App.tsx
export default function App() {
  return (
    <StripeProvider publishableKey={process.env.EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY}>
      {/* アプリコンポーネント */}
    </StripeProvider>
  );
}

// 決済画面
const { initPaymentSheet, presentPaymentSheet } = useStripe();

const handleSubscribe = async (priceId: string) => {
  // Cloud FunctionからPayment Intentを取得
  const { clientSecret } = await fetch('https://asia-northeast1-tokyo-list-478804-e5.cloudfunctions.net/createPaymentIntent', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ priceId }),
  }).then(res => res.json());

  // Payment Sheet初期化
  const { error: initError } = await initPaymentSheet({
    paymentIntentClientSecret: clientSecret,
    merchantDisplayName: 'AIフィットネスアプリ',
  });

  if (initError) {
    console.error(initError);
    return;
  }

  // Payment Sheet表示
  const { error: presentError } = await presentPaymentSheet();

  if (presentError) {
    console.error(presentError);
  } else {
    // 決済成功
    console.log('決済成功');
  }
};
```

### Stripe Webhook設定（Cloud Functions側）

common/031で実装される内容:
- `functions/src/api/stripe/webhook.ts` - Webhook受信処理
- Firestore更新（users/{userId}/subscriptionStatus）
- カスタムクレーム更新

## 見積もり

- 工数: 3日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- common/031（Stripe統合基盤）が完了していることが前提
- テスト決済はStripe Test Modeで実施
- 本番環境ではLive Keyを使用

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 033 課金画面実装

## 概要

課金プランを選択する画面を実装するチケットです。月額プラン・年額プランの選択とStripe Payment Sheetへの遷移を実装します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/032（Stripe Payment Sheet実装）完了後に着手可能

## 要件

### 機能要件

- FR-015: 課金プラン選択（月額/年額）

### 非機能要件

- NFR-022: ユーザビリティ - 直感的な操作性

## 受け入れ条件（Todo）

- [ ] 課金画面UIを作成（プラン選択カード）
- [ ] 月額プラン・年額プランの表示
- [ ] プラン比較表示（年額の割引率表示）
- [ ] 「購入」ボタン実装
- [ ] Payment Sheet呼び出し処理
- [ ] 購入後のナビゲーション処理（ホーム画面へ）
- [ ] レスポンシブデザイン対応
- [ ] アクセシビリティ対応（スクリーンリーダー）

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-015
- `docs/expo/specs/07_画面遷移図_ワイヤーフレーム_v1_0.md` - 課金画面UI

## 技術詳細

### 画面構成

- タイトル：「プレミアムプラン」
- プラン選択カード（月額/年額）
- 各プランの機能説明
- 「購入」ボタン
- 利用規約リンク

### UIコンポーネント例

```typescript
import { View, Text, TouchableOpacity } from 'react-native';
import { Card, Button } from 'react-native-paper';

export default function BillingScreen() {
  const [selectedPlan, setSelectedPlan] = useState('monthly');

  const plans = [
    { id: 'monthly', name: '月額プラン', price: '¥980/月', priceId: 'price_xxxxx' },
    { id: 'yearly', name: '年額プラン', price: '¥9,800/年', priceId: 'price_yyyyy', discount: '17%お得' },
  ];

  const handlePurchase = async () => {
    const plan = plans.find(p => p.id === selectedPlan);
    await handleSubscribe(plan.priceId); // expo/032で実装
  };

  return (
    <View>
      {plans.map(plan => (
        <Card key={plan.id} onPress={() => setSelectedPlan(plan.id)}>
          <Card.Title title={plan.name} subtitle={plan.price} />
          {plan.discount && <Text>{plan.discount}</Text>}
        </Card>
      ))}
      <Button mode="contained" onPress={handlePurchase}>
        購入する
      </Button>
    </View>
  );
}
```

### ルーティング

Expo Router: `app/(tabs)/billing.tsx`

## 見積もり

- 工数: 2日
- 難易度: 低

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- プラン価格はFirebase Remote Configで管理することを検討
- UIデザインはMaterial Design 3に準拠

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 034 サブスクリプション管理画面

## 概要

ユーザーがサブスクリプション状態を確認・変更できる画面を実装するチケットです。現在のプラン、次回請求日、プラン変更、解約ボタンを表示します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/032（Stripe Payment Sheet実装）完了後に着手可能

## 要件

### 機能要件

- FR-017: サブスクリプション状態確認
- FR-018: プラン変更

### 非機能要件

- NFR-022: ユーザビリティ - 直感的な操作性

## 受け入れ条件（Todo）

- [ ] サブスクリプション管理画面UIを作成
- [ ] 現在のプラン表示（月額/年額）
- [ ] 次回請求日表示
- [ ] プラン変更ボタン実装
- [ ] 解約ボタン実装（expo/038とリンク）
- [ ] Firestoreからサブスクリプション状態を取得
- [ ] サブスクリプション状態の自動更新（リアルタイムリスナー）
- [ ] レスポンシブデザイン対応

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-017, FR-018
- `docs/common/specs/03_Firestoreデータベース設計書_v1_0.md` - StripeCustomers

## 技術詳細

### データ取得

```typescript
import { doc, onSnapshot } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';

const auth = getAuth();
const userId = auth.currentUser?.uid;

const unsubscribe = onSnapshot(
  doc(db, `users/${userId}/stripeCustomers/default`),
  (docSnap) => {
    const data = docSnap.data();
    setSubscriptionStatus(data?.subscriptionStatus);
    setCurrentPlan(data?.planId);
    setNextBillingDate(data?.nextBillingDate);
  }
);
```

### UIコンポーネント例

```typescript
import { View, Text } from 'react-native';
import { Card, Button } from 'react-native-paper';

export default function SubscriptionManagementScreen() {
  const [subscriptionStatus, setSubscriptionStatus] = useState('active');
  const [currentPlan, setCurrentPlan] = useState('monthly');
  const [nextBillingDate, setNextBillingDate] = useState('2025-12-31');

  return (
    <View>
      <Card>
        <Card.Title title="現在のプラン" subtitle={currentPlan === 'monthly' ? '月額プラン' : '年額プラン'} />
        <Card.Content>
          <Text>次回請求日: {nextBillingDate}</Text>
          <Text>状態: {subscriptionStatus === 'active' ? 'アクティブ' : '停止中'}</Text>
        </Card.Content>
      </Card>
      <Button mode="contained" onPress={() => navigation.navigate('billing')}>
        プラン変更
      </Button>
      <Button mode="outlined" onPress={() => navigation.navigate('cancellation')}>
        解約
      </Button>
    </View>
  );
}
```

## 見積もり

- 工数: 2日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- サブスクリプション状態はFirestoreリアルタイムリスナーで取得
- Stripe Customer Portalへのリンクも検討

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 035 無料トライアル機能

## 概要

7日間の無料トライアル機能を実装するチケットです。初回登録ユーザーに無料トライアルを提供し、期間終了後に自動課金へ移行します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/032（Stripe Payment Sheet実装）完了後に着手可能

## 要件

### 機能要件

- FR-015: 課金プラン選択（無料トライアル）

### 非機能要件

- NFR-022: ユーザビリティ - わかりやすい説明

## 受け入れ条件（Todo）

- [ ] 無料トライアル開始UI実装
- [ ] Stripe Subscriptionにtrial_period_days設定
- [ ] トライアル期間表示（残り日数）
- [ ] トライアル終了通知実装
- [ ] トライアル中のUI表示（バッジ等）
- [ ] トライアルキャンセル処理
- [ ] トライアル利用済みユーザーの判定
- [ ] レスポンシブデザイン対応

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-015
- `docs/common/specs/04_API設計書_Firebase_Functions_v1_0.md` - Stripe API

## 技術詳細

### Stripe Subscription作成例

```typescript
// Cloud Function側（common/031で実装）
const subscription = await stripe.subscriptions.create({
  customer: customerId,
  items: [{ price: priceId }],
  trial_period_days: 7, // 7日間無料トライアル
});
```

### トライアル期間表示

```typescript
import { View, Text } from 'react-native';
import { Badge } from 'react-native-paper';

export default function TrialBadge({ trialEndDate }: { trialEndDate: Date }) {
  const remainingDays = Math.ceil((trialEndDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24));

  return (
    <View>
      <Badge>無料トライアル中</Badge>
      <Text>残り {remainingDays} 日</Text>
    </View>
  );
}
```

### トライアル利用済み判定

Firestoreにトライアル利用フラグを保存：

```typescript
await setDoc(doc(db, `users/${userId}`), {
  trialUsed: true,
  trialStartDate: new Date(),
  trialEndDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
}, { merge: true });
```

## 見積もり

- 工数: 2日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- トライアル終了前に通知を送信（プッシュ通知）
- トライアル中にキャンセルしても再登録時は課金開始

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 036 課金エラーハンドリング

## 概要

決済失敗時のエラーハンドリングとユーザーへの通知を実装するチケットです。カード期限切れ、残高不足、ネットワークエラーなどを適切に処理します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/032（Stripe Payment Sheet実装）完了後に着手可能

## 要件

### 機能要件

- FR-016: サブスクリプション購入（エラーハンドリング）

### 非機能要件

- NFR-022: ユーザビリティ - わかりやすいエラーメッセージ
- NFR-028: 可読性の高いエラーメッセージ

## 受け入れ条件（Todo）

- [ ] 決済失敗時のエラーメッセージ表示
- [ ] エラー種別ごとの適切なメッセージ実装
- [ ] リトライボタン実装
- [ ] カード情報変更へのナビゲーション
- [ ] エラーログをCloud Loggingに送信
- [ ] ネットワークエラー時のオフライン表示
- [ ] ユーザー向けヘルプリンクの表示

## 参照ドキュメント

- `docs/common/specs/02-2_非機能要件_v1_0.md` - NFR-022, NFR-028
- `docs/expo/specs/01_技術スタック_v1_0.md` - エラーハンドリング

## 技術詳細

### エラー種別

| エラーコード | 説明 | ユーザーメッセージ |
|------------|------|------------------|
| card_declined | カード拒否 | 「カードが拒否されました。別のカードをお試しください」 |
| insufficient_funds | 残高不足 | 「残高不足のため決済できませんでした」 |
| expired_card | カード期限切れ | 「カードの有効期限が切れています」 |
| network_error | ネットワークエラー | 「ネットワーク接続を確認してください」 |

### エラーハンドリング実装例

```typescript
import { Alert } from 'react-native';

const handlePaymentError = (error: any) => {
  let message = '決済に失敗しました。再度お試しください。';

  if (error.code === 'card_declined') {
    message = 'カードが拒否されました。別のカードをお試しください。';
  } else if (error.code === 'insufficient_funds') {
    message = '残高不足のため決済できませんでした。';
  } else if (error.code === 'expired_card') {
    message = 'カードの有効期限が切れています。';
  }

  Alert.alert(
    '決済エラー',
    message,
    [
      { text: 'ヘルプを見る', onPress: () => navigation.navigate('help') },
      { text: '再試行', onPress: () => handleSubscribe() },
      { text: 'キャンセル', style: 'cancel' },
    ]
  );

  // エラーログ送信
  logger.error('Payment failed', { error, userId });
};
```

### リトライロジック

```typescript
const retryPayment = async (maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      await handleSubscribe();
      return; // 成功
    } catch (error) {
      if (i === maxRetries - 1) {
        handlePaymentError(error);
      }
      await new Promise(resolve => setTimeout(resolve, 2000)); // 2秒待機
    }
  }
};
```

## 見積もり

- 工数: 2日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- Stripeのエラーコードは公式ドキュメント参照
- エラーログはCloud Loggingに送信（デバッグ用）

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 037 購入履歴画面

## 概要

ユーザーの支払い履歴を表示する画面を実装するチケットです。過去の請求、領収書ダウンロードリンク、決済ステータスを表示します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/032（Stripe Payment Sheet実装）完了後に着手可能

## 要件

### 機能要件

- FR-019: 購入履歴表示

### 非機能要件

- NFR-022: ユーザビリティ - 直感的な操作性

## 受け入れ条件（Todo）

- [ ] 購入履歴画面UIを作成
- [ ] Firestoreから履歴データ取得
- [ ] 履歴一覧表示（日付、金額、ステータス）
- [ ] 領収書ダウンロードリンク実装
- [ ] ページネーション実装（10件ごと）
- [ ] ローディング状態表示
- [ ] 空状態表示（履歴がない場合）
- [ ] レスポンシブデザイン対応

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-019
- `docs/common/specs/03_Firestoreデータベース設計書_v1_0.md` - StripeCustomers

## 技術詳細

### データ取得

```typescript
import { collection, query, orderBy, limit, getDocs } from 'firebase/firestore';

const fetchPurchaseHistory = async (userId: string) => {
  const q = query(
    collection(db, `users/${userId}/stripeCustomers/default/payments`),
    orderBy('createdAt', 'desc'),
    limit(10)
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};
```

### UIコンポーネント例

```typescript
import { FlatList, View, Text } from 'react-native';
import { List, Divider } from 'react-native-paper';

export default function PurchaseHistoryScreen() {
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPurchaseHistory(userId).then(data => {
      setHistory(data);
      setLoading(false);
    });
  }, []);

  return (
    <FlatList
      data={history}
      keyExtractor={item => item.id}
      renderItem={({ item }) => (
        <>
          <List.Item
            title={`¥${item.amount.toLocaleString()}`}
            description={new Date(item.createdAt).toLocaleDateString()}
            right={() => <Text>{item.status === 'succeeded' ? '成功' : '失敗'}</Text>}
            onPress={() => openReceipt(item.receiptUrl)}
          />
          <Divider />
        </>
      )}
      ListEmptyComponent={<Text>購入履歴がありません</Text>}
    />
  );
}
```

### 領収書ダウンロード

```typescript
import * as WebBrowser from 'expo-web-browser';

const openReceipt = async (receiptUrl: string) => {
  await WebBrowser.openBrowserAsync(receiptUrl);
};
```

## 見積もり

- 工数: 2日
- 難易度: 低

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- 領収書URLはStripe APIから取得（common/031で実装）
- ページネーションは`startAfter`を使用

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 038 解約機能実装

## 概要

サブスクリプションの解約機能を実装するチケットです。ユーザーが解約を申請し、解約理由を収集します。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/034（サブスクリプション管理画面）完了後に着手可能

## 要件

### 機能要件

- FR-020: サブスクリプション解約

### 非機能要件

- NFR-022: ユーザビリティ - わかりやすい説明

## 受け入れ条件（Todo）

- [ ] 解約画面UIを作成
- [ ] 解約理由選択フォーム実装
- [ ] 解約確認ダイアログ表示
- [ ] Cloud Function呼び出し（解約API）
- [ ] 解約完了画面表示
- [ ] 解約後のナビゲーション処理（ホーム画面へ）
- [ ] 解約理由データをFirestoreに保存
- [ ] 解約確認メール送信（Cloud Functions側）

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-020
- `docs/common/specs/04_API設計書_Firebase_Functions_v1_0.md` - Stripe API

## 技術詳細

### 解約理由選択肢

- 価格が高い
- 必要な機能がない
- 使わなくなった
- 他のサービスを使う
- その他（自由記述）

### UIコンポーネント例

```typescript
import { View, Text, Alert } from 'react-native';
import { RadioButton, TextInput, Button } from 'react-native-paper';

export default function CancellationScreen() {
  const [reason, setReason] = useState('');
  const [otherReason, setOtherReason] = useState('');

  const handleCancel = async () => {
    Alert.alert(
      '解約確認',
      '本当に解約しますか？解約後も現在の請求期間終了までご利用いただけます。',
      [
        { text: 'キャンセル', style: 'cancel' },
        {
          text: '解約する',
          style: 'destructive',
          onPress: async () => {
            await cancelSubscription(userId, reason, otherReason);
            Alert.alert('解約完了', '解約が完了しました。');
            navigation.navigate('home');
          },
        },
      ]
    );
  };

  return (
    <View>
      <Text>解約理由を教えてください</Text>
      <RadioButton.Group onValueChange={setReason} value={reason}>
        <RadioButton.Item label="価格が高い" value="price" />
        <RadioButton.Item label="必要な機能がない" value="features" />
        <RadioButton.Item label="使わなくなった" value="unused" />
        <RadioButton.Item label="その他" value="other" />
      </RadioButton.Group>
      {reason === 'other' && (
        <TextInput
          label="詳細"
          value={otherReason}
          onChangeText={setOtherReason}
          multiline
        />
      )}
      <Button mode="contained" onPress={handleCancel}>
        解約する
      </Button>
    </View>
  );
}
```

### Cloud Function呼び出し

```typescript
import { httpsCallable } from 'firebase/functions';

const cancelSubscription = async (userId: string, reason: string, otherReason: string) => {
  const cancelFunc = httpsCallable(functions, 'cancelSubscription');
  await cancelFunc({ userId, reason, otherReason });
};
```

## 見積もり

- 工数: 2日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- 解約後も請求期間終了まで利用可能（Stripe仕様）
- 解約理由は今後のサービス改善に活用

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 039 予備チケット

## 概要

Phase 3で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 3で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 040 予備チケット

## 概要

Phase 3で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 3（課金フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 3で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 041 管理者ダッシュボード

## 概要

管理者向けダッシュボード画面を実装するチケットです。ユーザー統計、サブスクリプション統計、セッション統計をグラフ表示します。Common/041（管理者認証API）が完了している必要があります。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/006（認証画面）完了後に着手可能
- common/041（管理者認証API）完了後に実装可能

## 要件

### 機能要件

- FR-024: 管理者権限（ダッシュボード表示）

### 非機能要件

- NFR-022: ユーザビリティ - 直感的な操作性

## 受け入れ条件（Todo）

- [ ] 管理者ダッシュボード画面UIを作成
- [ ] ユーザー統計表示（総ユーザー数、アクティブユーザー数）
- [ ] サブスクリプション統計表示（有料ユーザー数、MRR）
- [ ] セッション統計表示（総セッション数、平均セッション時間）
- [ ] グラフ表示（react-native-chart-kit使用）
- [ ] Cloud Functionから統計データ取得API実装
- [ ] リアルタイム更新機能（定期的なポーリング）
- [ ] レスポンシブデザイン対応

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-024
- `docs/expo/specs/01_技術スタック_v1_0.md` - グラフライブラリ

## 技術詳細

### 使用パッケージ

```bash
npm install react-native-chart-kit
```

### UIコンポーネント例

```typescript
import { ScrollView, View, Text } from 'react-native';
import { Card } from 'react-native-paper';
import { LineChart } from 'react-native-chart-kit';

export default function AdminDashboardScreen() {
  const [stats, setStats] = useState({
    totalUsers: 0,
    activeUsers: 0,
    paidUsers: 0,
    mrr: 0,
    totalSessions: 0,
  });

  useEffect(() => {
    fetchAdminStats().then(setStats);
  }, []);

  return (
    <ScrollView>
      <Card>
        <Card.Title title="ユーザー統計" />
        <Card.Content>
          <Text>総ユーザー数: {stats.totalUsers}</Text>
          <Text>アクティブユーザー数: {stats.activeUsers}</Text>
        </Card.Content>
      </Card>

      <Card>
        <Card.Title title="サブスクリプション統計" />
        <Card.Content>
          <Text>有料ユーザー数: {stats.paidUsers}</Text>
          <Text>MRR: ¥{stats.mrr.toLocaleString()}</Text>
        </Card.Content>
      </Card>

      <Card>
        <Card.Title title="セッション統計" />
        <Card.Content>
          <LineChart
            data={{
              labels: ['月', '火', '水', '木', '金', '土', '日'],
              datasets: [{ data: [20, 45, 28, 80, 99, 43, 50] }],
            }}
            width={300}
            height={200}
            chartConfig={{
              backgroundColor: '#ffffff',
              decimalPlaces: 0,
            }}
          />
        </Card.Content>
      </Card>
    </ScrollView>
  );
}
```

### Cloud Function API呼び出し

```typescript
import { httpsCallable } from 'firebase/functions';

const fetchAdminStats = async () => {
  const getStatsFunc = httpsCallable(functions, 'getAdminStats');
  const result = await getStatsFunc();
  return result.data;
};
```

## 見積もり

- 工数: 3日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- common/041（管理者認証API）が完了していることが前提
- 統計データはBigQueryから集計

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 042 ユーザー管理画面

## 概要

管理者がユーザーを管理できる画面を実装するチケットです。ユーザー一覧、検索、アカウント停止/復帰、詳細表示を実装します。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/041（管理者ダッシュボード）完了後に着手可能

## 要件

### 機能要件

- FR-025: ユーザー管理（一覧、停止、復帰）

### 非機能要件

- NFR-022: ユーザビリティ - 直感的な操作性

## 受け入れ条件（Todo）

- [ ] ユーザー管理画面UIを作成
- [ ] ユーザー一覧表示（ページネーション）
- [ ] ユーザー検索機能実装（メールアドレス、ID）
- [ ] アカウント停止ボタン実装
- [ ] アカウント復帰ボタン実装
- [ ] ユーザー詳細モーダル表示
- [ ] Cloud Function API呼び出し（停止/復帰）
- [ ] レスポンシブデザイン対応

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-025
- `docs/common/specs/03_Firestoreデータベース設計書_v1_0.md` - Users

## 技術詳細

### UIコンポーネント例

```typescript
import { FlatList, View, TextInput } from 'react-native';
import { List, Searchbar, Button, Dialog } from 'react-native-paper';

export default function UserManagementScreen() {
  const [users, setUsers] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedUser, setSelectedUser] = useState(null);

  const handleSuspend = async (userId: string) => {
    await suspendUserAccount(userId);
    Alert.alert('アカウント停止', 'アカウントを停止しました。');
    fetchUsers(); // 再読み込み
  };

  const handleRestore = async (userId: string) => {
    await restoreUserAccount(userId);
    Alert.alert('アカウント復帰', 'アカウントを復帰しました。');
    fetchUsers(); // 再読み込み
  };

  return (
    <View>
      <Searchbar
        placeholder="メールアドレス、IDで検索"
        value={searchQuery}
        onChangeText={setSearchQuery}
      />
      <FlatList
        data={users}
        keyExtractor={item => item.id}
        renderItem={({ item }) => (
          <List.Item
            title={item.email}
            description={`UID: ${item.id}`}
            right={() => (
              <>
                <Button onPress={() => setSelectedUser(item)}>詳細</Button>
                {item.disabled ? (
                  <Button onPress={() => handleRestore(item.id)}>復帰</Button>
                ) : (
                  <Button onPress={() => handleSuspend(item.id)}>停止</Button>
                )}
              </>
            )}
          />
        )}
      />

      <Dialog visible={!!selectedUser} onDismiss={() => setSelectedUser(null)}>
        <Dialog.Title>ユーザー詳細</Dialog.Title>
        <Dialog.Content>
          <Text>メール: {selectedUser?.email}</Text>
          <Text>UID: {selectedUser?.id}</Text>
          <Text>登録日: {selectedUser?.createdAt}</Text>
        </Dialog.Content>
      </Dialog>
    </View>
  );
}
```

### Cloud Function API呼び出し

```typescript
import { httpsCallable } from 'firebase/functions';

const suspendUserAccount = async (userId: string) => {
  const suspendFunc = httpsCallable(functions, 'suspendUser');
  await suspendFunc({ userId });
};

const restoreUserAccount = async (userId: string) => {
  const restoreFunc = httpsCallable(functions, 'restoreUser');
  await restoreFunc({ userId });
};
```

## 見積もり

- 工数: 3日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- アカウント停止はFirebase Authの`disabled`フラグを使用
- 停止理由を記録するフィールドも検討

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 043 多言語対応基盤

## 概要

アプリの多言語対応基盤を実装するチケットです。日本語と英語に対応し、将来的に他の言語も追加できる仕組みを構築します。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

- expo/002（開発環境セットアップ）完了後に着手可能

## 要件

### 機能要件

- FR-030: 多言語対応（日本語、英語）

### 非機能要件

- NFR-022: ユーザビリティ - 言語切り替え

## 受け入れ条件（Todo）

- [ ] react-i18nextライブラリをインストール
- [ ] expo-localizationで端末言語を取得
- [ ] 翻訳ファイル作成（ja.json、en.json）
- [ ] i18n初期化処理実装
- [ ] 全画面に翻訳キーを適用
- [ ] 言語切り替え機能実装（設定画面）
- [ ] 日付フォーマットのローカライズ
- [ ] 通貨フォーマットのローカライズ

## 参照ドキュメント

- `docs/common/specs/02-1_機能要件_v1_0.md` - FR-030
- `docs/expo/specs/01_技術スタック_v1_0.md` - 多言語対応技術

## 技術詳細

### 使用パッケージ

```bash
npm install react-i18next i18next
npx expo install expo-localization
```

### i18n初期化

```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import * as Localization from 'expo-localization';
import ja from './locales/ja.json';
import en from './locales/en.json';

i18n
  .use(initReactI18next)
  .init({
    resources: {
      ja: { translation: ja },
      en: { translation: en },
    },
    lng: Localization.locale.split('-')[0], // 端末言語（ja, en）
    fallbackLng: 'ja',
    interpolation: {
      escapeValue: false,
    },
  });

export default i18n;
```

### 翻訳ファイル例（ja.json）

```json
{
  "common": {
    "login": "ログイン",
    "register": "登録",
    "logout": "ログアウト"
  },
  "home": {
    "title": "ホーム",
    "welcome": "ようこそ"
  },
  "billing": {
    "title": "課金プラン",
    "monthly": "月額プラン",
    "yearly": "年額プラン"
  }
}
```

### 使用例

```typescript
import { useTranslation } from 'react-i18next';

export default function HomeScreen() {
  const { t } = useTranslation();

  return (
    <View>
      <Text>{t('home.title')}</Text>
      <Text>{t('home.welcome')}</Text>
    </View>
  );
}
```

### 言語切り替え

```typescript
import { Button } from 'react-native-paper';
import { useTranslation } from 'react-i18next';

export default function SettingsScreen() {
  const { i18n } = useTranslation();

  const changeLanguage = (lng: string) => {
    i18n.changeLanguage(lng);
  };

  return (
    <View>
      <Button onPress={() => changeLanguage('ja')}>日本語</Button>
      <Button onPress={() => changeLanguage('en')}>English</Button>
    </View>
  );
}
```

## 見積もり

- 工数: 5日
- 難易度: 中

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

- 翻訳キーは階層構造で管理（common, home, billingなど）
- 将来的に韓国語、中国語も追加予定

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 044 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 045 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 046 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 047 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 048 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 049 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |

---

# 050 予備チケット

## 概要

Phase 4で追加機能が必要になった場合に使用する予備チケットです。

## Phase

Phase 4（管理者フロントエンド）

## プラットフォーム

expo（Expo/React Native）

## 依存チケット

未定

## 要件

### 機能要件

未定

### 非機能要件

未定

## 受け入れ条件（Todo）

- [ ] 未定

## 参照ドキュメント

未定

## 技術詳細

未定

## 見積もり

- 工数: 未定
- 難易度: 未定

## 進捗

- [ ] 未着手

## 完了日

未定

## 備考

Phase 4で追加機能が必要になった場合に使用します。

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-10 | 初版作成 |
