# 技術スタック v1.0 (Expo版)

**プロジェクト名**: AIフィットネスアプリ（Expo版）
**バージョン**: 1.0.0
**作成日**: 2025年12月9日
**最終更新日**: 2025年12月9日
**対象読者**: 開発チーム、技術担当者

---

## 目次

1. [概要](#1-概要)
2. [フロントエンド技術スタック](#2-フロントエンド技術スタック)
3. [バックエンド技術スタック](#3-バックエンド技術スタック)
4. [データベース](#4-データベース)
5. [AI処理（姿勢検出）](#5-ai処理姿勢検出)
6. [認証・課金](#6-認証課金)
7. [開発環境セットアップ](#7-開発環境セットアップ)
8. [主要ライブラリ詳細](#8-主要ライブラリ詳細)
9. [MediaPipe統合方法](#9-mediapipe統合方法)
10. [変更履歴](#10-変更履歴)

---

## 1. 概要

### 1.1 Expo選択の理由

| 理由 | 説明 | メリット |
|-----|------|---------|
| **開発者の確保** | React/JavaScriptの開発者はFlutter/Dartより多い | 採用しやすい |
| **Webとの共通化** | Reactの知識があればWeb版も作れる | 将来の展開が容易 |
| **エコシステム** | npmパッケージが豊富 | 機能追加が迅速 |
| **学習コスト** | Web開発経験者なら習得が早い | 開発スピード向上 |

### 1.2 技術スタックサマリー

```
【クライアント】
Expo (React Native)
  ├── TypeScript 5.0+
  ├── Zustand (ローカル状態管理)
  ├── TanStack Query (サーバー状態管理)
  ├── Expo Router (ルーティング)
  ├── React Native Paper (UI)
  └── react-native-vision-camera + MediaPipe (姿勢検出)

【バックエンド】
Firebase
  ├── Cloud Functions (Node.js 20, TypeScript)
  ├── Cloud Firestore (データベース)
  ├── Firebase Storage (ファイル保存)
  ├── Firebase Auth (認証)
  └── BigQuery (分析)

【課金】
Stripe (メイン)、RevenueCat (代替)
```

---

## 2. フロントエンド技術スタック

### 2.1 フレームワーク

| 技術 | バージョン | 説明 |
|-----|-----------|------|
| **Expo** | SDK 52+ | React Nativeアプリを簡単に開発・配布できるツール |
| **React Native** | 0.76+ | iOSとAndroid両方のアプリを一度に作れるフレームワーク |
| **TypeScript** | 5.0+ | 型安全なJavaScript。コードの品質と保守性が向上 |

**Expoの特徴**:
- **Managed Workflow**: Expoが環境を管理してくれる（初期開発に最適）
- **Development Build**: ネイティブコードも使える（MediaPipe統合に必須）
- **Expo Go**: 実機でテストできるアプリ
- **OTA更新**: アプリストアを経由せずにアップデート可能

### 2.2 状態管理

#### 2.2.1 Zustand（ローカル状態管理）

**用途**: アプリ内のローカル状態を管理

```typescript
import { create } from 'zustand';

// ログイン状態を管理する例
interface AuthState {
  isLoggedIn: boolean;
  userId: string | null;
  login: (id: string) => void;
  logout: () => void;
}

const useAuthStore = create<AuthState>((set) => ({
  isLoggedIn: false,
  userId: null,
  login: (id) => set({ isLoggedIn: true, userId: id }),
  logout: () => set({ isLoggedIn: false, userId: null }),
}));
```

**特徴**:
- 軽量（約1KB）
- シンプルなAPI
- TypeScript完全対応
- DevToolsサポート

**管理する状態**:
- ログイン状態
- UI設定（音声ON/OFF、通知設定など）
- トレーニングセッション中の一時データ

#### 2.2.2 TanStack Query（サーバー状態管理）

**用途**: サーバーから取得したデータをキャッシュして管理

```typescript
import { useQuery } from '@tanstack/react-query';
import { collection, query, where, getDocs } from 'firebase/firestore';

export function useTodaySessions(userId: string) {
  return useQuery({
    queryKey: ['sessions', 'today', userId],
    queryFn: async () => {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const q = query(
        collection(db, 'sessions'),
        where('userId', '==', userId),
        where('startTime', '>=', today)
      );

      const snapshot = await getDocs(q);
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    },
    staleTime: 5 * 60 * 1000, // 5分間はキャッシュを使用
  });
}
```

**特徴**:
- 自動キャッシュ
- バックグラウンド更新
- エラーハンドリング
- ローディング状態管理
- リトライ機能

**管理するデータ**:
- ユーザー情報
- トレーニング履歴
- セッション結果

### 2.3 ルーティング

#### Expo Router（ファイルベースルーティング）

**ディレクトリ構造 = ルート構造**

```
app/
├── (splash)/
│   └── index.tsx              # / (スプラッシュ画面)
├── auth/
│   ├── login.tsx              # /auth/login
│   ├── register.tsx           # /auth/register
│   └── agreement.tsx          # /auth/agreement
├── (tabs)/
│   ├── home.tsx               # /(tabs)/home
│   ├── training.tsx           # /(tabs)/training
│   ├── history.tsx            # /(tabs)/history
│   └── profile.tsx            # /(tabs)/profile
└── training/
    ├── setup.tsx              # /training/setup
    ├── session.tsx            # /training/session
    └── result.tsx             # /training/result
```

**実装例**:

```typescript
// app/(tabs)/_layout.tsx
import { Tabs } from 'expo-router';

export default function TabLayout() {
  return (
    <Tabs
      screenOptions={{
        tabBarActiveTintColor: '#4CAF50',
      }}
    >
      <Tabs.Screen
        name="home"
        options={{
          title: 'ホーム',
          tabBarIcon: ({ color }) => <HomeIcon color={color} />,
        }}
      />
      {/* 他のタブ */}
    </Tabs>
  );
}
```

**ナビゲーション**:

```typescript
import { router } from 'expo-router';

// 画面遷移
router.push('/training/setup');

// 戻る
router.back();

// リダイレクト
router.replace('/auth/login');
```

### 2.4 UIライブラリ

#### React Native Paper

**Material Design 3準拠のUIコンポーネント**

```typescript
import { Button, Card, TextInput, BottomNavigation } from 'react-native-paper';

// ボタン
<Button mode="contained" onPress={handlePress}>
  トレーニング開始
</Button>

// カード
<Card>
  <Card.Title title="スクワット" subtitle="下半身 | 初級" />
  <Card.Content>
    {/* 内容 */}
  </Card.Content>
  <Card.Actions>
    <Button>開始する</Button>
  </Card.Actions>
</Card>

// テキスト入力
<TextInput
  label="メールアドレス"
  mode="outlined"
  value={email}
  onChangeText={setEmail}
/>
```

**主要コンポーネント**:
- Button（ボタン）
- Card（カード）
- TextInput（入力フォーム）
- BottomNavigation（ボトムナビゲーション）
- Dialog（ダイアログ）
- Switch（スイッチ）
- Checkbox（チェックボックス）
- ProgressBar（進捗バー）
- Snackbar（スナックバー）

**カスタムテーマ**:

```typescript
import { MD3LightTheme, PaperProvider } from 'react-native-paper';

const theme = {
  ...MD3LightTheme,
  colors: {
    ...MD3LightTheme.colors,
    primary: '#4CAF50',
    secondary: '#2196F3',
    error: '#F44336',
  },
};

export default function App() {
  return (
    <PaperProvider theme={theme}>
      {/* アプリ */}
    </PaperProvider>
  );
}
```

### 2.5 バリデーション

#### Zod（スキーマベースバリデーション）

```typescript
import { z } from 'zod';

// 新規登録フォームのスキーマ
const registerSchema = z.object({
  email: z.string().email({ message: '正しいメールアドレスを入力してください' }),
  password: z
    .string()
    .min(8, { message: 'パスワードは8文字以上で入力してください' })
    .max(128, { message: 'パスワードは128文字以内で入力してください' })
    .regex(/[A-Za-z]/, { message: 'パスワードには英字を含めてください' })
    .regex(/[0-9]/, { message: 'パスワードには数字を含めてください' }),
  displayName: z
    .string()
    .min(1, { message: 'ニックネームは1文字以上で入力してください' })
    .max(20, { message: 'ニックネームは20文字以内で入力してください' }),
  birthdate: z.date().refine(
    (date) => {
      const age = Math.floor((Date.now() - date.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
      return age >= 13; // 日本: 13歳以上
    },
    { message: '13歳以上である必要があります' }
  ),
});

// 使用例
try {
  const validData = registerSchema.parse(formData);
  // バリデーション成功
} catch (error) {
  if (error instanceof z.ZodError) {
    // エラーメッセージを表示
    console.error(error.errors);
  }
}
```

**特徴**:
- TypeScript完全対応
- 型推論が効く
- カスタムバリデーションルール
- エラーメッセージのカスタマイズ

---

## 3. バックエンド技術スタック

### 3.1 Cloud Functions for Firebase

| 項目 | 内容 |
|-----|------|
| **ランタイム** | Node.js 20 |
| **言語** | TypeScript 5.0+ |
| **リージョン** | asia-northeast1（東京） |
| **最大インスタンス数** | 10（コスト制御） |
| **メモリ** | 256MiB |
| **タイムアウト** | 60秒 |

**グローバル設定**:

```typescript
import { setGlobalOptions } from 'firebase-functions/v2';

setGlobalOptions({
  region: 'asia-northeast1',
  maxInstances: 10,
  memory: '256MiB',
  timeoutSeconds: 60,
});
```

**主要な関数**:
- Auth triggers（ユーザー作成・削除時の処理）
- HTTP callable関数（ユーザー情報更新など）
- Firestore triggers（データ変更時の処理）
- Scheduled functions（定期実行処理）

### 3.2 TypeScriptコーディング規約

- **ESLint**: Google Style Guide
- **Prettier**: ダブルクォート、セミコロンあり
- **strict mode**: 有効

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "esModuleInterop": true
  }
}
```

---

## 4. データベース

| 項目 | 技術 | 説明 | リージョン |
|-----|------|------|-----------|
| **メインDB** | Cloud Firestore | NoSQLデータベース、リアルタイム同期 | asia-northeast1 |
| **分析用DB** | BigQuery | 大規模データ分析 | asia-northeast1 |
| **ファイル保存** | Firebase Storage | 画像などのファイル保存 | asia-northeast1 |

**主要コレクション**:
- `users`: ユーザー情報
- `sessions`: トレーニングセッション
- `consents`: 同意履歴
- `dataDeletionRequests`: データ削除リクエスト
- `bigQuerySyncFailures`: BigQuery同期エラー

---

## 5. AI処理（姿勢検出）

### 5.1 カメラ処理

#### react-native-vision-camera

**高性能なカメラライブラリ**

```typescript
import { Camera, useCameraDevice } from 'react-native-vision-camera';

function CameraScreen() {
  const device = useCameraDevice('back');

  if (device == null) return <LoadingView />;

  return (
    <Camera
      device={device}
      isActive={true}
      style={StyleSheet.absoluteFill}
    />
  );
}
```

**特徴**:
- 高速フレームプロセッサ
- 60fps対応
- フレーム単位での処理が可能
- iOS/Android両対応

**注意**: Development Buildが必須（Expo Goでは動作不可）

### 5.2 姿勢検出

#### MediaPipe Vision

**Googleが開発した高精度な姿勢検出AI**

```typescript
import { MediaPipe } from 'react-native-mediapipe';

// MediaPipeで姿勢を検出
const poseData = await MediaPipe.detectPose(imageData);

// 33個の関節データ
poseData.landmarks.forEach((landmark, index) => {
  console.log(`関節${index}: x=${landmark.x}, y=${landmark.y}, z=${landmark.z}`);
});
```

**検出可能な関節（33箇所）**:
- 顔（鼻、目、耳など）: 11箇所
- 上半身（肩、肘、手首など）: 10箇所
- 下半身（腰、膝、足首など）: 12箇所

**性能目標**:
- **通常デバイス**: 30fps以上
- **低スペックデバイス**: 15fps以上（フレームスキップ使用）

**オンデバイス処理**:
- カメラ映像はスマホ内で処理
- 映像そのものはサーバーに送信しない
- 骨格データ（33関節の位置）のみを保存

### 5.3 代替手段

| 代替手段 | メリット | デメリット | 使用条件 |
|---------|---------|-----------|---------|
| **TensorFlow.js** | JavaScriptだけで動作 | 精度・速度が劣る | MediaPipeが使えない場合 |
| **TensorFlow Lite** | 高速 | ネイティブコードが必要 | MediaPipeが使えない場合 |
| **クラウドAPI** | 高精度 | 通信が必要、コストがかかる | 最終手段 |

---

## 6. 認証・課金

### 6.1 認証

#### Firebase Auth

```typescript
import auth from '@react-native-firebase/auth';

// メール/パスワードログイン
async function login(email: string, password: string) {
  try {
    const result = await auth().signInWithEmailAndPassword(email, password);
    console.log('ログイン成功:', result.user.uid);
  } catch (error) {
    console.error('ログイン失敗:', error);
  }
}

// Googleログイン
import { GoogleSignin } from '@react-native-google-signin/google-signin';

async function signInWithGoogle() {
  await GoogleSignin.hasPlayServices();
  const { idToken } = await GoogleSignin.signIn();
  const googleCredential = auth.GoogleAuthProvider.credential(idToken);
  return auth().signInWithCredential(googleCredential);
}
```

**サポート認証方式**:

| 認証方式 | Phase | ライブラリ |
|---------|-------|----------|
| メール/パスワード | Phase 1 | @react-native-firebase/auth |
| Googleログイン | Phase 1 | @react-native-google-signin/google-signin |
| Apple認証 | Phase 3 | expo-apple-authentication |

### 6.2 課金

#### Stripe（メイン）

```typescript
import { useStripe } from '@stripe/stripe-react-native';

const { initPaymentSheet, presentPaymentSheet } = useStripe();

// サブスクリプション購入フロー
async function purchaseSubscription() {
  // 1. Cloud Functionからclient secretを取得
  const response = await fetch('/api/create-subscription');
  const { clientSecret } = await response.json();

  // 2. Payment Sheetを初期化
  await initPaymentSheet({
    paymentIntentClientSecret: clientSecret,
    merchantDisplayName: 'AIフィットネスアプリ',
  });

  // 3. Payment Sheetを表示
  const { error } = await presentPaymentSheet();

  if (error) {
    console.error('課金エラー:', error);
  } else {
    console.log('課金成功');
  }
}
```

**選定理由**:
- Web版との統一が容易
- 柔軟な価格設定
- 日本での豊富な実績
- ドキュメントが充実

#### RevenueCat（代替）

```typescript
import Purchases from 'react-native-purchases';

// 初期化
Purchases.configure({ apiKey: 'YOUR_API_KEY' });

// サブスクリプション購入
async function purchaseSubscription() {
  try {
    const { customerInfo } = await Purchases.purchasePackage(package);
    console.log('課金成功:', customerInfo);
  } catch (error) {
    console.error('課金エラー:', error);
  }
}
```

**使用条件**: Stripe導入に問題が生じた場合の代替手段

---

## 7. 開発環境セットアップ

### 7.1 前提条件

| ソフトウェア | バージョン | 備考 |
|------------|-----------|------|
| Node.js | 20.x LTS | 必須 |
| npm | 10.x | 必須 |
| Git | 2.x | 必須 |
| Xcode | 15.x | iOS開発の場合 |
| Android Studio | 2024.x | Android開発の場合 |

### 7.2 セットアップ手順

#### ステップ1: リポジトリのクローン

```bash
git clone https://github.com/your-org/ai-fitness-app.git
cd ai-fitness-app/expo_app
```

#### ステップ2: 依存関係のインストール

```bash
npm install
```

#### ステップ3: Expoの設定

```bash
# Expo CLIのインストール
npm install -g expo-cli

# Development Buildのセットアップ
npx expo install expo-dev-client
```

#### ステップ4: Firebase設定

1. Firebaseプロジェクトを作成
2. iOS/Androidアプリを登録
3. 設定ファイルをダウンロード
   - iOS: `GoogleService-Info.plist`
   - Android: `google-services.json`
4. プロジェクトのルートに配置

#### ステップ5: 環境変数の設定

```bash
# .env.local ファイルを作成
cp .env.example .env.local

# 必要な環境変数を設定
FIREBASE_API_KEY=your_api_key
FIREBASE_PROJECT_ID=your_project_id
STRIPE_PUBLISHABLE_KEY=your_stripe_key
```

#### ステップ6: 実行

```bash
# Expo Goで実行（MediaPipe以外）
npx expo start

# Development Buildで実行（すべての機能）
npx expo run:ios
# または
npx expo run:android
```

### 7.3 開発コマンド

| コマンド | 説明 |
|---------|------|
| `npx expo start` | Expo Goで開発サーバー起動 |
| `npx expo run:ios` | iOSシミュレータで実行 |
| `npx expo run:android` | Androidエミュレータで実行 |
| `npm run lint` | ESLintでコードチェック |
| `npm run format` | Prettierでコード整形 |
| `npm test` | Jestでテスト実行 |
| `npx expo prebuild` | ネイティブコード生成 |

---

## 8. 主要ライブラリ詳細

### 8.1 必須ライブラリ

```json
{
  "dependencies": {
    "expo": "^52.0.0",
    "expo-router": "^4.0.0",
    "react": "18.3.1",
    "react-native": "0.76.5",
    "typescript": "^5.3.3",
    "zustand": "^5.0.0",
    "@tanstack/react-query": "^5.0.0",
    "react-native-paper": "^5.12.5",
    "zod": "^3.23.8",
    "@react-native-firebase/app": "^21.3.0",
    "@react-native-firebase/auth": "^21.3.0",
    "@react-native-firebase/firestore": "^21.3.0",
    "react-native-vision-camera": "^4.7.3",
    "@stripe/stripe-react-native": "^0.41.3"
  },
  "devDependencies": {
    "@types/react": "~18.3.12",
    "@types/react-native": "^0.76.0",
    "eslint": "^8.57.1",
    "prettier": "^3.4.2",
    "jest": "^29.7.0"
  }
}
```

### 8.2 オプションライブラリ

```json
{
  "dependencies": {
    "react-native-calendars": "^1.1309.0",
    "react-native-chart-kit": "^6.12.0",
    "expo-speech": "~12.0.2",
    "@react-native-async-storage/async-storage": "2.1.0",
    "@react-native-google-signin/google-signin": "^14.1.0",
    "expo-apple-authentication": "~7.1.3",
    "react-native-purchases": "^8.4.1"
  }
}
```

### 8.3 ライブラリの役割

| ライブラリ | 役割 | 使用箇所 |
|----------|------|---------|
| react-native-calendars | カレンダー表示 | 履歴画面 |
| react-native-chart-kit | グラフ表示 | ホーム画面、履歴画面 |
| expo-speech | 音声合成 | トレーニング実行画面 |
| async-storage | ローカルストレージ | 設定の保存 |
| google-signin | Googleログイン | ログイン画面 |
| expo-apple-authentication | Apple認証 | ログイン画面（Phase 3） |
| react-native-purchases | RevenueCat | 課金画面（代替） |

---

## 9. MediaPipe統合方法

### 9.1 Development Buildのセットアップ

```bash
# Development Clientをインストール
npx expo install expo-dev-client

# ネイティブコードを生成
npx expo prebuild

# iOSビルド
npx expo run:ios

# Androidビルド
npx expo run:android
```

### 9.2 カメラ権限の設定

#### iOS (`app.json`)

```json
{
  "expo": {
    "ios": {
      "infoPlist": {
        "NSCameraUsageDescription": "トレーニング中のフォームをチェックするためにカメラを使用します"
      }
    }
  }
}
```

#### Android (`app.json`)

```json
{
  "expo": {
    "android": {
      "permissions": [
        "CAMERA"
      ]
    }
  }
}
```

### 9.3 MediaPipe統合コード例

```typescript
import { Camera, useCameraDevice, useFrameProcessor } from 'react-native-vision-camera';
import { runOnJS } from 'react-native-reanimated';

function TrainingScreen() {
  const device = useCameraDevice('back');

  // フレーム処理
  const frameProcessor = useFrameProcessor((frame) => {
    'worklet';

    // MediaPipeで姿勢検出
    const poseData = detectPose(frame);

    // UIスレッドでコールバック
    runOnJS(handlePoseData)(poseData);
  }, []);

  const handlePoseData = (poseData: PoseData) => {
    // 姿勢データを処理
    console.log('姿勢データ:', poseData);
  };

  if (!device) return <LoadingView />;

  return (
    <Camera
      device={device}
      isActive={true}
      frameProcessor={frameProcessor}
      style={StyleSheet.absoluteFill}
    />
  );
}
```

### 9.4 MediaPipeネイティブモジュール作成

#### iOS (Swift)

```swift
import MediaPipeTasksVision

@objc(MediaPipeModule)
class MediaPipeModule: NSObject {
  private var poseDetector: PoseLandmarker?

  @objc
  func detectPose(_ imageData: UIImage, resolve: RCTPromiseResolveBlock, reject: RCTPromiseRejectBlock) {
    // MediaPipe Pose Detectionの実装
    let result = poseDetector?.detect(image: imageData)
    resolve(result)
  }
}
```

#### Android (Kotlin)

```kotlin
import com.google.mediapipe.tasks.vision.poselandmarker.PoseLandmarker

class MediaPipeModule(reactContext: ReactApplicationContext) : ReactContextBaseJavaModule(reactContext) {
  private var poseDetector: PoseLandmarker? = null

  @ReactMethod
  fun detectPose(imageData: ByteArray, promise: Promise) {
    // MediaPipe Pose Detectionの実装
    val result = poseDetector?.detect(imageData)
    promise.resolve(result)
  }
}
```

### 9.5 トラブルシューティング

| 問題 | 解決策 |
|-----|------|
| MediaPipeが動かない | Development Buildを使用しているか確認 |
| カメラが起動しない | 権限が正しく設定されているか確認 |
| fpsが低い | デバイスのスペックを確認、フレームスキップを検討 |
| ビルドエラー | `npx expo prebuild --clean` で再生成 |

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0.0 | 2025年12月9日 | 初版作成 | 開発チーム |

---

**Document Version**: v1.0.0
**Last Updated**: 2025年12月9日
**Author**: AIフィットネスアプリ開発チーム

---

**以上**
