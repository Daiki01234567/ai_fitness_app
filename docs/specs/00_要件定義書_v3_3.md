# 要件定義書 v3.3

**プロジェクト名**: AIフィットネスアプリ(仮称)
**バージョン**: 3.3 (MVP)
**作成日**: 2025年11月
**最終更新日**: 2025年11月24日
**対象期間**: Phase 1-2 (0-7ヶ月)

---

## 📝 v3.3での主な変更点

### プロジェクト懸念点分析v1.0の18項目全てを反映

✅ **重大度:高(5件)の対応を完全反映**:
1. **Firestoreセキュリティルールの詳細設計**(懸念点#1)
   - NFR-034: Firestoreセキュリティルール詳細要件を新規追加
   - フィールドレベルアクセス制御を明記
   - データバリデーション要件を追加
   - セキュリティルール実装例を付録に追加

2. **データ削除30日猶予期間のアクセス制御**(懸念点#2)
   - FR-025-1: 削除猶予期間のアクセス制御機能を新規追加
   - NFR-017を詳細化(削除予定ユーザーの読み取り専用化)
   - セキュリティルールの改善案を明記

3. **MediaPipeパフォーマンス要件の明確化**(懸念点#3)
   - NFR-024/NFR-025を詳細化(最低端末スペック明記)
   - NFR-035: フレームレート監視・フォールバック処理を新規追加
   - 低スペック端末対応の実装方針を追加

4. **BigQuery障害時のリトライ処理**(懸念点#4)
   - NFR-036: BigQueryリトライ処理・DLQ要件を新規追加
   - Cloud Tasksによるリトライキューの実装方針を明記
   - データ損失防止の具体的手法を追加

5. **スケジュールの現実的な見直し**(懸念点#5)
   - プロジェクト期間を4ヶ月→7ヶ月に延長
   - Phase 1を1ヶ月→2ヶ月に延長
   - Phase 2を3ヶ月→5ヶ月に延長
   - バッファ期間を各Phaseに組み込み

✅ **重大度:中(8件)の対応を反映**:
6. **カスタムML移行計画の策定**(懸念点#6)
   - セクション1.6.2を詳細化(移行計画のマイルストーン明記)
   - データ収集目標を明確化(10,000セッション)

7. **課金エラーハンドリング**(懸念点#7)
   - FR-022-1: 課金エラーハンドリング機能を新規追加
   - 各種決済エラーパターンとリトライ戦略を明記

8. **BigQueryコスト予測の改善**(懸念点#8)
   - セクション5.3を更新(コスト見積もりを保守的に修正)
   - ストレージ・クエリコストの詳細な算出根拠を追加

9. **同意撤回後のログアウト処理**(懸念点#9)
   - FR-024を詳細化(同意撤回時の強制ログアウト)
   - Cloud Functionsでのセッション無効化処理を明記

10. **データ侵害通知の具体的手順**(懸念点#10)
    - NFR-020を詳細化(72時間以内の通知手順)
    - インシデント対応フローを付録に追加

11. **MediaPipeデータのML移行準備**(懸念点#11)
    - FR-028を詳細化(ML移行に必要なデータ項目を明記)
    - アノテーション戦略を追加

12. **ストア審査の薬機法表現チェック**(懸念点#12)
    - セクション1.4を強化(ストア審査対応のチェックリスト追加)
    - プロモーション素材の表現ガイドライン追加

13. **Functionsコールドスタート対策**(懸念点#13)
    - NFR-037: コールドスタート対策要件を新規追加
    - 最小インスタンス数の設定方針を明記

✅ **重大度:低(5件)の対応方針を明記**:
14-18. Phase 3以降で対応する旨を明記
    - 無料プラン制限(懸念点#14)
    - 多言語対応(懸念点#15)
    - DR計画(懸念点#16)
    - ソーシャル機能(懸念点#17)
    - アクセシビリティ(懸念点#18)

✅ **その他の改善**:
- リスク管理セクション(7章)を大幅に強化
- 非機能要件を33項目→37項目に拡充
- 機能要件を35項目→38項目に拡充
- 付録に懸念点対応マッピング表を追加

---

## 📝 v3.2からの主な変更サマリー

| カテゴリ | v3.2 | v3.3 | 変更内容 |
|---------|------|------|---------|
| **プロジェクト期間** | 4ヶ月 | 7ヶ月 | 現実的なスケジュールに修正 |
| **機能要件** | 35項目 | 38項目 | +3項目(FR-022-1, FR-025-1, FR-028-1) |
| **非機能要件** | 33項目 | 37項目 | +4項目(NFR-034〜037) |
| **セキュリティ** | 基本的な要件 | 詳細なルールと実装例 | Firestoreセキュリティルール完全設計 |
| **パフォーマンス** | 目標値のみ | 実装方針と対策 | MediaPipe最適化、Functions対策 |
| **データ保護** | GDPR準拠 | 詳細な実装手順 | 削除猶予期間、侵害通知フロー |
| **リスク管理** | 12項目 | 18項目 | 懸念点分析を完全反映 |

---

## 目次

### Part 1: プロジェクト概要〜機能要件
1. [プロジェクト概要](#1-プロジェクト概要)
2. [プロジェクト体制](#2-プロジェクト体制)
3. [機能要件](#3-機能要件)

### Part 2: 非機能要件〜成果物
4. [非機能要件](#4-非機能要件)
5. [制約条件](#5-制約条件)
6. [前提条件](#6-前提条件)
7. [リスク管理](#7-リスク管理)
8. [成果物](#8-成果物)
9. [Firebase + GCP ハイブリッド構成](#9-firebase--gcp-ハイブリッド構成)
10. [まとめ](#10-まとめ)
11. [付録](#11-付録)

---

## 1. プロジェクト概要

### 1.1 プロジェクト背景

近年、自宅でのトレーニング需要が増加している一方で、正しいフォームでトレーニングを行えず、怪我をしたり効果が得られなかったりするユーザーが多い。専用のトレーニングデバイスやパーソナルトレーナーは高額であり、誰もが気軽に利用できるものではない。

本プロジェクトは、スマートフォンのカメラとAI技術を活用し、低コストでリアルタイムにフォーム確認を補助できるフィットネスアプリを開発することで、この課題を解決する。

### 1.2 プロジェクト目的と位置づけ

#### 1.2.1 本サービスの目的

1. **誰でも使える**: 専用デバイス不要、スマートフォンのみで利用可能
2. **リアルタイム参考情報**: AIによる即座のフォーム確認補助と音声による参考情報提供
3. **低価格**: 月額500円で利用可能(1週間無料トライアル付き)
4. **成長の可視化**: トレーニング履歴をグラフで表示し、モチベーション維持
5. **プライバシー保護**: GDPR/EDPB Guidelines完全準拠、カメラ映像は端末上でのみ処理

#### 1.2.2 重要な制限事項 ⚠️

本サービスは以下のものではありません:

| 本サービスではないもの | 理由 |
|---------------------|------|
| ❌ 医療機器 | 薬機法上の医療機器の承認を受けていません |
| ❌ 診断・治療・予防を目的とするもの | 医学的な判断は提供しません |
| ❌ 怪我の防止を保証するもの | あくまで参考情報です |
| ❌ 健康効果を保証するもの | 効果・効能は保証しません |
| ❌ 医療専門家による診断や指導の代替 | 専門家への相談を推奨します |
| ❌ リハビリテーション支援 | 医療行為は行いません |

**重要**: この制限事項は、利用規約v3.1第3.3条およびプライバシーポリシーv3.1第2.3条と完全に一致しています。

#### 1.2.3 本サービスの位置づけ

- ✅ **トレーニングフォームの確認を補助する参考情報提供ツール**
- ✅ **参考情報として利用者に情報を表示するサービス**
- ✅ **最終的な判断は利用者自身の責任において行うもの**

この位置づけは、利用規約v3.1第3.4条と完全に一致しています。

#### 1.2.4 年齢制限

| 地域 | 年齢制限 | 備考 | 法的根拠 |
|-----|---------|------|---------|
| **日本** | 13歳以上 | 個人情報保護法対応 | 利用規約v3.1第4.1条 |
| **EEA** | 16歳以上 | GDPR第8条準拠 | プライバシーポリシーv3.1第11.1条 |
| **全地域** | 未成年者(18歳未満)は親権者の同意が必要 | 利用規約で明記 | 利用規約v3.1第4.2条 |

**注記**: 未成年者とは18歳未満の者を指します(利用規約v3.1第4.2条)。

### 1.3 主な価値提案

#### 提供する機能

- ✅ リアルタイムフォーム確認補助(MediaPipe Pose → 将来ML化)
- ✅ 音声による参考情報の提供(ハンズフリー)
- ✅ トレーニング記録の管理
- ✅ 進捗の可視化
- ✅ プライバシー保護(GDPR/EDPB Guidelines完全準拠)

#### 提供しないもの

- ❌ 医学的アドバイス・診断
- ❌ パーソナルトレーニング指導
- ❌ 健康診断・健康管理・健康増進の保証
- ❌ リハビリテーション支援
- ❌ 怪我の治療・予防の保証
- ❌ 運動効果の保証

### 1.4 薬機法対応:表現の統一(v3.2完全版)

#### 1.4.1 背景

本サービスは薬機法上の「医療機器」に該当しないが、効能効果を標ぼうする表現は医療機器と誤認されるリスクがある。すべてのUI、ドキュメント、マーケティング資料において統一した表現を使用する。

この表現統一は、利用規約v3.1第1.2条およびプライバシーポリシーv3.1第2.3条の定義に基づいています。

#### 1.4.2 NG表現とOK表現

| 場面 | ❌ NG表現 | ✅ OK表現(v3.2) | 参照 |
|-----|---------|-----------------|------|
| **サービス概要** | フォーム判定 | フォーム確認補助 | 利用規約第1.2条 |
| **機能説明** | 改善アドバイス | 参考情報の提供 | 利用規約第1.2条 |
| **音声フィードバック** | 改善してください | 参考:確認してみてください | - |
| **スコア表示** | 正しいフォーム | 参考スコア | 利用規約第1.2条 |
| **効果訴求** | 怪我を防ぐ | フォーム確認の機会を提供 | 利用規約第3.3.3条 |
| **目的** | 安全なトレーニング | トレーニングフォームの確認補助 | 利用規約第3.1条 |
| **AI機能** | AI判定 | AI確認補助 | プライバシーポリシー第4.1条 |
| **精度表示** | 判定精度 | 確認補助の精度 | - |
| **フィードバック** | フィードバック | 参考情報 | 利用規約第1.2条 |
| **分析** | フォーム分析 | フォーム確認の参考情報 | - |

#### 1.4.3 マーケティングにおける表現ガイドライン

| 要素 | ❌ NG | ✅ OK |
|-----|------|------|
| **キャッチコピー** | AIが正しいフォームを判定 | AIがフォーム確認をサポート |
| **機能紹介** | 怪我を防ぐ安全なトレーニング | フォーム確認の参考情報を提供 |
| **効果訴求** | 効果的なトレーニングを実現 | トレーニング記録の管理をサポート |
| **ユーザー体験** | 正確な判定でトレーニング向上 | 参考情報でトレーニング管理を支援 |

**重要**: すべてのUI、ドキュメント、マーケティング資料で統一すること

#### 1.4.4 実装における注意点

| 実装箇所 | 注意事項 | 参照 |
|---------|---------|------|
| **音声TTS** | 「参考:」を必ず前置する | FR-005 |
| **画面表示** | 「参考スコア」「参考情報」等の表記を使用 | FR-006 |
| **通知** | 「確認してみてください」等の推奨表現 | FR-018 |
| **レポート** | 「記録」「参考データ」等の客観的表現 | FR-007 |
| **エラー** | 「確認できませんでした」等の中立的表現 | NFR-021 |

### 1.5 ターゲットユーザー

| 属性 | 内容 |
|-----|------|
| **年齢層** | 20-40代 |
| **性別** | 男女問わず |
| **トレーニング経験** | 初級〜中級者 |
| **利用シーン** | 自宅でのトレーニング |
| **課題** | 正しいフォームがわからない、継続できない |
| **ITリテラシー** | スマートフォンの基本操作ができる |
| **健康状態** | 医師から運動制限を受けていない方(利用規約第4.3条) |

### 1.6 技術的アプローチの進化

#### 1.6.1 MVP期(Phase 1-2): MediaPipe Pose

**採用理由**:
- 迅速な市場投入
- オンデバイス処理によるプライバシー保護
- 低コスト(無料)
- 枯れた技術で信頼性が高い

**特徴**:
- ルールベースの確認補助
- 33個の関節位置を検出
- リアルタイム処理(30fps)
- カメラ映像はサーバーに送信しない(プライバシーポリシーv3.1第8.1条)

#### 1.6.2 将来(Phase 4以降): カスタムML移行

**移行条件**:
- 10,000セッション以上のデータ蓄積
- 専任MLエンジニアの確保
- Phase 3での収益化成功

**メリット**:
- 個人差への対応
- より正確な確認補助
- 新しい種目への柔軟な対応

**技術スタック**:
- TensorFlow Lite
- on-device training
- federated learning(検討)

#### 1.6.3 データ収集戦略

**Phase 1-2(MVP)**:
- 骨格座標データのみ収集(プライバシーポリシーv3.1第5.1条)
- セッションメタデータ収集(プライバシーポリシーv3.1第5.2条)
- 法的根拠: GDPR第6条1項(a)同意、第6条1項(f)正当な利益

**Phase 3(データ蓄積期)**:
- 目標: 10,000セッション
- データ品質管理
- アノテーション準備

**Phase 4(ML移行期)**:
- モデル学習
- A/Bテスト
- 段階的ロールアウト

### 1.7 正当な利益の詳細(GDPR第6条1項(f))

#### 1.7.1 デバイス情報の収集における正当な利益

**法的根拠**: プライバシーポリシーv3.1第5条、GDPR第6条1項(f)

**当社の利益**:
- サービスの安定提供
- 不正利用の防止
- セキュリティの確保
- パフォーマンスの最適化

**利用者の利益**:
- 安定したサービス体験
- 個人データの保護
- 不正アクセスからの保護
- 快適な動作速度

**利益衡量テスト(Balancing Test)の結果**:
- **データの侵害性**: 低(デバイス情報のみ、個人特定困難)
- **利用者の期待**: 合理的(サービス安定化のため)
- **代替手段**: 限定的(デバイス情報なしでは安定提供困難)
- **透明性**: 高(プライバシーポリシーに明記)
- **データ最小化**: 遵守(必要最小限の情報のみ)
- **結論**: 正当な利益が利用者の権利・自由を上回る

**収集するデバイス情報**:
- OS種別(iOS/Android)
- OSバージョン
- デバイスモデル
- アプリバージョン
- IPアドレス(匿名化)

**収集しないデバイス情報**:
- デバイスID(UDID/IMEI)
- 電話番号
- 連絡先
- 位置情報(GPS)

### 1.8 スコープ定義

#### 1.8.1 MVP(Phase 1-2: 0-7ヶ月)で提供する機能

**重要**: スケジュールは懸念点分析#5に基づき、4ヶ月から7ヶ月に延長しました。

| カテゴリ | 機能 | 優先度 | Phase |
|---------|------|--------|-------|
| **認証** | メールアドレス/パスワード、Google/Apple | 必須 | Phase 1 |
| **トレーニング** | 5種目のフォーム確認補助 | 必須 | Phase 2 |
| **記録管理** | セッション記録の保存・表示 | 必須 | Phase 2 |
| **履歴** | カレンダー・グラフ表示 | 必須 | Phase 2 |
| **課金** | 月額500円(1週間無料) | 必須 | Phase 2 |
| **プライバシー** | GDPR完全準拠、同意管理 | 必須 | Phase 1 |
| **セキュリティ** | Firestoreセキュリティルール完全実装 | 必須 | Phase 1 |

#### 1.8.2 MVP後(Phase 3以降)で検討する機能

| カテゴリ | 機能 | Phase |
|---------|------|-------|
| **トレーニング** | 追加種目(10種目以上) | Phase 3 |
| **ソーシャル** | 友達機能、リーダーボード | Phase 3 |
| **プラン** | 無料プラン、複数の有料プラン | Phase 3 |
| **ML** | カスタムMLモデル移行 | Phase 4 |
| **コーチング** | AI コーチング(高度化) | Phase 5 |

### 1.9 ゴール定義

#### 1.9.1 Phase 1(0-2ヶ月): 基盤構築とセキュリティ完全実装

**期間**: 2ヶ月(懸念点#5対応: 1ヶ月から延長)

**目標**:
- Firebase認証実装
- Firestoreデータベース設計
- **Firestoreセキュリティルール完全実装**(懸念点#1対応)
- 基本的なUI/UX実装
- プロフィール管理機能
- **GDPR完全準拠機能の実装**(懸念点#2, #9対応)
- **セキュリティ専門家によるレビュー**(懸念点#1対応)

**成果物**:
- 認証フロー完成
- データベース設計書v3.3
- **Firestoreセキュリティルール実装完了**(懸念点#1)
- 基本画面実装
- **セキュリティレビューレポート**(懸念点#1)

**リスクバッファ**: 2週間(想定外の課題対応用)

#### 1.9.2 Phase 2(2-7ヶ月): MVP完成とパフォーマンス最適化

**期間**: 5ヶ月(懸念点#5対応: 3ヶ月から延長)

**目標**:
- 5種目のフォーム確認補助機能
- **MediaPipeパフォーマンス最適化**(懸念点#3対応)
- トレーニング記録管理
- **BigQueryリトライ処理とDLQ実装**(懸念点#4対応)
- 履歴表示機能
- 課金機能(Stripe/RevenueCat)
- **課金エラーハンドリング完全実装**(懸念点#7対応)
- GDPR完全準拠
- **データ侵害通知手順の策定**(懸念点#10対応)
- **ストア審査対策**(懸念点#12対応)

**KPI**:
- DAU: 100人
- リテンション: 30%(7日後)
- 課金転換率: 5%
- **MediaPipe平均FPS**: 30fps以上(懸念点#3)
- **BigQuery同期成功率**: 99.9%以上(懸念点#4)

**成果物**:
- リリース可能なMVPアプリ
- App Store/Google Play申請
- **パフォーマンステストレポート**(懸念点#3)
- **セキュリティ診断レポート**(懸念点#1, #2)
- **データ侵害対応マニュアル**(懸念点#10)

**リスクバッファ**: 3週間(想定外の課題対応用)

---

## 2. プロジェクト体制

### 2.1 チーム構成

| 役割 | 人数 | 主な責任 |
|-----|------|---------|
| **プロジェクトマネージャー(PM)** | 1名 | プロジェクト全体の管理、進捗管理、意思決定 |
| **バックエンドエンジニア(BE)** | 1名 | Firebase Functions、Firestore、BigQuery、API設計 |
| **フロントエンドエンジニア(FE)** | 1名 | Flutter、UI/UX実装、MediaPipe統合 |
| **デザイナー(Designer)** | 1名 | UI/UXデザイン、画面遷移図、ブランディング |
| **QAエンジニア(QA)** | 1名 | テスト計画、実行、品質保証 |

**合計**: 5名

### 2.2 RACI(責任分担マトリクス)

| タスク | PM | BE | FE | Designer | QA |
|--------|----|----|----|---------|----|
| **要件定義** | A | C | C | I | I |
| **設計** | R | A | C | C | I |
| **Firebase設定** | I | A | C | - | - |
| **Firestore設計** | I | A | C | - | - |
| **API実装** | I | A | C | - | I |
| **UI/UX実装** | I | C | A | R | I |
| **MediaPipe統合** | I | C | A | - | I |
| **テスト** | R | C | C | I | A |
| **リリース** | A | R | R | I | C |

**凡例**:
- **R**(Responsible): 実行責任者
- **A**(Accountable): 説明責任者
- **C**(Consulted): 相談を受ける
- **I**(Informed): 報告を受ける

### 2.3 外部協力者

| 役割 | 関与フェーズ | 主な責任 |
|-----|-----------|---------|
| **法務コンサルタント** | Phase 1 | GDPR、薬機法コンプライアンス確認 |
| **セキュリティ専門家** | Phase 2 | ペネトレーションテスト、脆弱性診断 |
| **MLエンジニア(将来)** | Phase 4以降 | カスタムMLモデル開発 |

### 2.4 コミュニケーション

#### 2.4.1 定例会議

| 会議 | 頻度 | 参加者 | 目的 |
|------|------|--------|------|
| **Daily Standup** | 毎日15分 | 全員 | 進捗共有、ブロッカー解消 |
| **Weekly Review** | 週1回1時間 | 全員 | 週次進捗、課題解決 |
| **Sprint Planning** | 2週に1回2時間 | 全員 | スプリント計画 |
| **Sprint Review** | 2週に1回1時間 | 全員+ステークホルダー | デモ、フィードバック |

#### 2.4.2 ツール

| ツール | 用途 |
|--------|------|
| **Slack** | 日常コミュニケーション |
| **GitHub** | コード管理、Issue管理 |
| **Figma** | デザイン共有 |
| **Google Meet** | オンライン会議 |
| **Notion** | ドキュメント管理 |

---

## 3. 機能要件

### 3.1 機能要件一覧(全38要件)

**v3.3での追加**: FR-022-1, FR-025-1, FR-028-1の3項目を新規追加

| ID | カテゴリ | 機能名 | 優先度 | Phase | 法的根拠 | 懸念点対応 |
|----|---------|--------|--------|-------|---------|-----------|
| FR-001 | 認証 | メールアドレス/パスワード認証 | 必須 | 1 | 利用規約v3.1第5条 | - |
| FR-002 | プロフィール | プロフィール管理 | 必須 | 1 | - | - |
| **FR-002-1** | **プロフィール** | **同意状態管理機能** | **必須** | **1** | **GDPR第7条** | - |
| FR-003 | トレーニング | 種目選択 | 必須 | 2 | - | - |
| FR-004 | トレーニング | フォーム確認補助(MediaPipe) | 必須 | 2 | プライバシーポリシーv3.1第4.2条 | #3 |
| **FR-004-1** | **トレーニング** | **カメラ設定自動開始機能** | **中** | **2** | **-** | - |
| FR-005 | トレーニング | 音声フィードバック | 必須 | 2 | - | - |
| FR-006 | トレーニング | スコア表示 | 必須 | 2 | - | - |
| FR-007 | 記録 | トレーニング記録保存 | 必須 | 2 | プライバシーポリシーv3.1第4.2条 | - |
| FR-008 | 履歴 | カレンダー表示 | 必須 | 2 | - | - |
| FR-009 | 履歴 | グラフ表示 | 必須 | 2 | - | - |
| FR-010 | 履歴 | セッション詳細表示 | 必須 | 2 | - | - |
| FR-011 | 設定 | 通知設定 | 推奨 | 2 | - | - |
| FR-012 | 設定 | 音声設定 | 必須 | 2 | - | - |
| FR-013 | 設定 | 言語設定 | 推奨 | 3 | - | #15 |
| FR-014 | 設定 | プライバシー設定 | 必須 | 1 | GDPR第7条 | - |
| FR-015 | 認証 | Google/Apple認証 | 推奨 | 1 | - | - |
| **FR-016** | **設定** | **設定管理機能** | **必須** | **2** | **-** | - |
| FR-017 | 通知 | リマインダー通知 | 推奨 | 2 | - | - |
| FR-018 | 通知 | 達成通知 | 推奨 | 2 | - | - |
| FR-019 | 課金 | 無料トライアル(1週間) | 必須 | 2 | 利用規約v3.1第6.2条 | - |
| FR-020 | 課金 | 月額課金(500円) | 必須 | 2 | 利用規約v3.1第6.3条 | - |
| FR-021 | 課金 | サブスクリプション管理 | 必須 | 2 | 利用規約v3.1第6条 | - |
| FR-022 | 課金 | 決済(Stripe/RevenueCat) | 必須 | 2 | - | - |
| **FR-022-1** | **課金** | **課金エラーハンドリング** | **必須** | **2** | **-** | **#7** |
| FR-023 | ヘルプ | チュートリアル | 推奨 | 2 | - | - |
| FR-024 | GDPR | 同意管理 | 必須 | 1 | GDPR第7条、プライバシーポリシーv3.1第9.1条 | #9 |
| **FR-024-1** | **GDPR** | **ログイン時同意確認機能** | **必須** | **1** | **GDPR第7条** | - |
| FR-025 | GDPR | データ削除権 | 必須 | 1 | GDPR第17条、プライバシーポリシーv3.1第9.6条 | #2 |
| **FR-025-1** | **GDPR** | **削除猶予期間のアクセス制御** | **必須** | **1** | **GDPR第17条** | **#2** |
| FR-026 | GDPR | データ訂正権 | 必須 | 1 | GDPR第16条、プライバシーポリシーv3.1第9.2条 | - |
| FR-027 | GDPR | データアクセス権 | 必須 | 1 | GDPR第15条・第20条、プライバシーポリシーv3.1第9.3条・第9.5条 | - |
| FR-028 | データ収集 | 骨格座標データ収集 | 必須 | 2 | GDPR第6条1項(a)、プライバシーポリシーv3.1第5.1条 | #11 |
| **FR-028-1** | **データ収集** | **ML移行準備データ収集** | **推奨** | **2** | **GDPR第6条1項(a)** | **#11** |
| FR-029 | データ収集 | セッションメタデータ収集 | 必須 | 2 | GDPR第6条1項(f)、プライバシーポリシーv3.1第5.2条 | - |
| FR-030 | サポート | ヘルプセンター | 推奨 | 2 | - | - |
| FR-031 | サポート | お問い合わせフォーム | 必須 | 2 | - | - |

**新規追加(v3.3)**:
- FR-022-1: 課金エラーハンドリング(懸念点#7対応)
- FR-025-1: 削除猶予期間のアクセス制御(懸念点#2対応)
- FR-028-1: ML移行準備データ収集(懸念点#11対応)

**v3.2からの継続**:
- FR-002-1: 同意状態管理機能
- FR-004-1: カメラ設定自動開始機能
- FR-016: 設定管理機能
- FR-024-1: ログイン時同意確認機能

### 3.2 主要機能の詳細

#### 3.2.1 認証機能(FR-001, FR-015)

##### FR-001: メールアドレス/パスワード認証

**法的根拠**: 利用規約v3.1第5条

**概要**: ユーザーがメールアドレスとパスワードでアカウントを作成し、ログインできる機能

**機能詳細**:
1. **新規登録**
   - メールアドレス入力
   - パスワード入力(8文字以上、英数字記号含む)
   - 確認メール送信
   - メール認証リンククリック
   - アカウント有効化

2. **ログイン**
   - メールアドレス入力
   - パスワード入力
   - ログイン実行
   - セッション開始

3. **パスワードリセット**
   - メールアドレス入力
   - リセットメール送信
   - リセットリンククリック
   - 新しいパスワード設定

**技術仕様**:
- Firebase Authentication使用
- パスワードハッシュ化(bcrypt)
- セッショントークン(JWT)
- トークン有効期限: 1時間
- リフレッシュトークン有効期限: 30日

**UI要件**:
- エラーメッセージは具体的かつ平易な日本語
- パスワード強度インジケーター
- 「パスワードを忘れた」リンク
- ローディング表示

**バリデーション**:
- メールアドレス形式チェック
- パスワード強度チェック
- 重複メールアドレスチェック

**エラーハンドリング**:
- 無効なメールアドレス: 「メールアドレスの形式が正しくありません」
- 弱いパスワード: 「パスワードは8文字以上で、英数字と記号を含む必要があります」
- ログイン失敗: 「メールアドレスまたはパスワードが間違っています」

**セキュリティ**:
- ブルートフォース攻撃対策(レート制限)
- パスワードの暗号化保存
- HTTPS必須

**優先度**: 必須
**対応Phase**: Phase 1

##### FR-015: Google/Apple認証

**概要**: ユーザーがGoogle/Appleアカウントでログインできる機能

**機能詳細**:
- OAuth 2.0認証フロー
- Google Sign-In SDK使用
- Apple Sign In使用

**優先度**: 推奨
**対応Phase**: Phase 1

#### 3.2.2 プロフィール管理機能(FR-002, FR-002-1)

##### FR-002: プロフィール管理

**概要**: ユーザーがプロフィール情報を管理できる機能

**プロフィール項目**:
| 項目 | 必須/任意 | データ型 | 法的根拠 |
|------|----------|---------|---------|
| **ニックネーム** | 必須 | string | GDPR第6条1項(b) |
| **性別** | 任意 | string (male/female/other/prefer_not_to_say) | GDPR第6条1項(a) |
| **身長** | 任意 | number (cm) | GDPR第6条1項(a) |
| **体重** | 任意 | number (kg) | GDPR第6条1項(a) |
| **生年月日** | 必須 | date | GDPR第6条1項(c) |
| **フィットネスレベル** | 任意 | string (beginner/intermediate/advanced) | GDPR第6条1項(a) |
| **目標** | 任意 | string | GDPR第6条1項(a) |

**機能詳細**:
1. プロフィール表示
2. プロフィール編集
3. 変更内容の保存
4. バリデーション

**優先度**: 必須
**対応Phase**: Phase 1

##### FR-002-1: 同意状態管理機能 ⭐NEW

**法的根拠**: GDPR第7条3項、プライバシーポリシーv3.1第9.1条

**概要**: ユーザーが自身の同意状態を確認・管理できる機能

**機能詳細**:
1. **プロフィール画面に「同意状態」セクションを表示**
   - 利用規約の同意状態を表示(同意日時を含む)
   - プライバシーポリシーの同意状態を表示(同意日時を含む)
   - 各同意文書へのリンクを提供
   - 同意解除リンクを提供(確認ダイアログ表示)

2. **同意解除時の動作**
   - 確認ダイアログ表示: 「同意を解除するとログアウトされます」
   - 同意解除確定後、Firestoreを更新:
     - `users.tosAccepted = false`
     - `users.ppAccepted = false`
     - `users.tosAcceptedAt = null`
     - `users.ppAcceptedAt = null`
   - 強制ログアウト
   - ログイン画面へ遷移

3. **データ構造**:
```json
{
  "tosAccepted": true,
  "tosAcceptedAt": "2025-11-23T10:00:00Z",
  "tosVersion": "3.1",
  "ppAccepted": true,
  "ppAcceptedAt": "2025-11-23T10:00:00Z",
  "ppVersion": "3.1"
}
```

**UI要件**:
- 同意状態は緑色のチェックマークで表示
- 未同意の場合は赤色の警告アイコン表示
- 同意日時はグレーで小さく表示
- 「同意を解除」ボタンは赤色で目立つように配置

**確認ダイアログの内容**:
```
タイトル: 同意の解除
本文: 利用規約またはプライバシーポリシーへの同意を解除すると、
      アプリを使用できなくなり、ログアウトされます。
      本当に解除しますか?
ボタン: [キャンセル] [解除する]
```

**優先度**: 必須(GDPR第7条3項対応)
**対応画面**: プロフィール画面(画面遷移図v3.3 3.12)
**対応Phase**: Phase 1
**参照**: 画面遷移図v3.3、利用規約v3.1第2.1条

#### 3.2.3 種目選択機能(FR-003)

**概要**: ユーザーがトレーニング種目を選択できる機能

**MVP対応種目**(5種目):
1. **スクワット** (Squat)
2. **プッシュアップ** (Push-up)
3. **プランク** (Plank)
4. **ランジ** (Lunge)
5. **バーピー** (Burpee)

**種目データ構造**:
```json
{
  "id": "squat",
  "name": "スクワット",
  "nameEn": "Squat",
  "description": "下半身を鍛える基本的なトレーニング",
  "difficulty": "beginner",
  "targetMuscles": ["大腿四頭筋", "大臀筋", "ハムストリング"],
  "defaultReps": 10,
  "defaultSets": 3,
  "thumbnailUrl": "https://...",
  "instructionVideoUrl": "https://..."
}
```

**優先度**: 必須
**対応Phase**: Phase 2

#### 3.2.4 フォーム確認補助機能(FR-004, FR-004-1)

##### FR-004: フォーム確認補助(MediaPipe Pose)

**法的根拠**: プライバシーポリシーv3.1第4.2条、GDPR第6条1項(a)

**概要**: リアルタイムで骨格を検出し、フォームの確認を補助する機能

**技術仕様**:
- **使用ライブラリ**: MediaPipe Pose
- **検出対象**: 33個の関節位置(ランドマーク)
- **フレームレート**: 30fps以上
- **処理場所**: 端末上のみ(オンデバイス)
- **カメラ映像**: サーバーに送信しない

**データフロー**:
1. カメラ映像取得(フロントカメラ)
2. MediaPipe Poseで骨格検出
3. カメラ映像を即座に破棄
4. 骨格座標データのみ抽出
5. 骨格座標データをFirestoreに保存

**骨格座標データ構造**:
```json
{
  "landmarks": [
    {
      "x": 0.5,
      "y": 0.5,
      "z": 0.0,
      "visibility": 0.99
    }
  ]
}
```

**確認補助ロジック**(ルールベース):
- 各種目ごとに理想的な角度範囲を定義
- リアルタイムで角度を計算
- 範囲外の場合、参考情報を表示

**例: スクワット**:
| チェック項目 | 理想的な範囲 | 参考情報 |
|------------|------------|---------|
| 膝の角度 | 80-100度 | 参考:もう少し深くしゃがんでみてください |
| 背中の角度 | 垂直±10度 | 参考:背中を伸ばしてみてください |
| 膝とつま先の位置 | 同一線上±5cm | 参考:膝がつま先より前に出ていないか確認してください |

**プライバシー保護**:
- カメラ映像はメモリ上でのみ処理
- サーバーに送信しない
- ストレージに保存しない
- 処理後即座に破棄

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-004-1: カメラ設定自動開始機能 ⭐NEW

**概要**: ユーザーの利便性向上のため、カメラ設定完了後に自動的にトレーニングを開始する機能

**機能詳細**:
1. **カメラ設定画面でチェック項目を全てクリア**
   - カメラの向き: OK
   - 距離: OK

2. **3秒間のカウントダウンを表示**
   - 画面中央に大きく「3...2...1...」を表示
   - 背景を半透明化
   - カウントダウン音声(オプション)

3. **カウントダウン終了後、自動的にトレーニング実行画面へ遷移**
   - スムーズな画面遷移
   - MediaPipe Pose開始

4. **ユーザーは待機中でも手動で「開始」ボタンをタップ可能**
   - 「開始」ボタンは常時タップ可能
   - タップすると即座にトレーニング開始

**UI要件**:
- カウントダウンは画面中央に大きく表示(フォントサイズ: 72pt)
- カウントダウン中は背景を半透明化(opacity: 0.5)
- 「開始」ボタンは画面下部に配置
- 「スキップ」ボタンを追加(カウントダウンをスキップ)

**技術仕様**:
```dart
// Flutter実装例
Future<void> startCountdown() async {
  for (int i = 3; i > 0; i--) {
    setState(() => countdownValue = i);
    await Future.delayed(Duration(seconds: 1));
  }
  // トレーニング実行画面へ遷移
  Navigator.pushReplacement(context, TrainingExecutionScreen());
}
```

**優先度**: 中
**対応画面**: カメラ設定画面(画面遷移図v3.3 3.8)
**対応Phase**: Phase 2
**参照**: 画面遷移図v3.3

#### 3.2.5 音声フィードバック機能(FR-005)

**概要**: トレーニング中にハンズフリーで参考情報を音声で提供する機能

**機能詳細**:
- リアルタイムで音声による参考情報を提供
- TTS(Text-to-Speech)使用
- 必ず「参考:」を前置する

**音声フィードバックの例**:
- 「参考:もう少し深くしゃがんでみてください」
- 「参考:背中を伸ばしてみてください」
- 「参考:良い姿勢です」
- 「参考:あと3回です」

**設定**:
- 音声ON/OFF
- 音量調整
- 音声速度調整

**技術仕様**:
- iOS: AVSpeechSynthesizer
- Android: TextToSpeech
- 言語: 日本語(ja-JP)

**優先度**: 必須
**対応Phase**: Phase 2

#### 3.2.6 スコア表示機能(FR-006)

**概要**: トレーニング中とセッション終了後に参考スコアを表示する機能

**表示内容**:
- **参考スコア**: 0-100点
- **レップ数**: 完了したレップ数
- **セット数**: 完了したセット数
- **経過時間**: セッション開始からの時間

**スコア計算ロジック**:
```
参考スコア = (姿勢スコア × 0.7) + (安定性スコア × 0.3)

姿勢スコア = 各チェック項目の達成率の平均
安定性スコア = 骨格座標の安定度(フレーム間の変動の少なさ)
```

**UI要件**:
- リアルタイム表示
- 大きく見やすい数字
- 色分け:
  - 80-100点: 緑色
  - 60-79点: 黄色
  - 0-59点: 赤色

**重要**: 「参考スコア」という表記を必ず使用

**優先度**: 必須
**対応Phase**: Phase 2

#### 3.2.7 トレーニング記録保存機能(FR-007)

**法的根拠**: プライバシーポリシーv3.1第4.2条、GDPR第6条1項(a)

**概要**: トレーニングセッションの記録をFirestoreに保存する機能

**保存データ構造**:
```json
{
  "sessionId": "uuid",
  "userId": "user_id",
  "exerciseId": "squat",
  "startTime": "2025-11-23T10:00:00Z",
  "endTime": "2025-11-23T10:15:00Z",
  "duration": 900,
  "repCount": 30,
  "setCount": 3,
  "averageScore": 85.5,
  "maxScore": 95.0,
  "minScore": 75.0,
  "landmarks": [
    // 骨格座標データ
  ],
  "metadata": {
    "appVersion": "1.0.0",
    "deviceModel": "iPhone 13",
    "osVersion": "iOS 16.0"
  },
  "createdAt": "2025-11-23T10:15:00Z",
  "updatedAt": "2025-11-23T10:15:00Z"
}
```

**データ保存期間**:
| データ種別 | 保存期間 | 法的根拠 |
|----------|---------|---------|
| **トレーニング記録** | アカウント削除まで | GDPR第6条1項(a) |
| **骨格座標データ** | アカウント削除まで | GDPR第6条1項(a) |
| **セッションメタデータ** | 2年間 | GDPR第5条1項(e) |
| **デバイス情報** | 1年間 | GDPR第5条1項(e) |

**注記**: 保存期間はプライバシーポリシーv3.1第10条に準拠

**優先度**: 必須
**対応Phase**: Phase 2

#### 3.2.8 履歴表示機能(FR-008, FR-009, FR-010)

##### FR-008: カレンダー表示

**概要**: トレーニング履歴をカレンダー形式で表示する機能

**機能詳細**:
- 月次カレンダー表示
- トレーニング実施日にマーク
- 日付タップで詳細表示

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-009: グラフ表示

**概要**: トレーニング履歴をグラフ形式で表示する機能

**グラフ種類**:
1. **週次グラフ**: 過去7日間のトレーニング時間
2. **月次グラフ**: 過去30日間のトレーニング頻度
3. **参考スコア推移**: 過去30日間の平均参考スコア

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-010: セッション詳細表示

**概要**: 過去のトレーニングセッションの詳細を表示する機能

**表示内容**:
- 種目名
- 実施日時
- 所要時間
- レップ数・セット数
- 平均参考スコア
- 最高/最低参考スコア

**優先度**: 必須
**対応Phase**: Phase 2

#### 3.2.9 設定管理機能(FR-011, FR-012, FR-013, FR-014, FR-016)

##### FR-016: 設定管理機能 ⭐NEW

**概要**: ユーザーがアプリの各種設定を管理できる機能

**設定項目**:

1. **音声設定**(FR-012)
   - 音声フィードバックのON/OFF
   - 音量調整(0-100%)
   - 音声速度調整(0.5x-2.0x)

2. **通知設定**(FR-011)
   - リマインダー通知のON/OFF
   - 通知時刻の設定
   - 通知頻度(毎日/週3回/週5回)

3. **表示設定**
   - 骨格線の表示/非表示
   - フォーム確認補助の表示/非表示
   - テーマ(ライト/ダーク)

4. **言語設定**(FR-013)
   - 日本語/英語

5. **プライバシー設定**(FR-014)
   - データ収集の同意状態表示
   - 同意の撤回
   - データダウンロード
   - アカウント削除

6. **アカウント設定**
   - パスワード変更
   - メールアドレス変更
   - アカウント削除

**データ構造**:
```json
{
  "userId": "user_id",
  "voice": {
    "enabled": true,
    "volume": 80,
    "speed": 1.0
  },
  "notification": {
    "enabled": true,
    "time": "19:00",
    "frequency": "daily"
  },
  "display": {
    "showSkeleton": true,
    "showFormGuide": true,
    "theme": "light"
  },
  "language": "ja",
  "privacy": {
    "dataCollection": true
  }
}
```

**UI要件**:
- 設定画面は階層構造
- トグルスイッチとスライダーを使用
- 設定変更は即座に反映
- 設定画面へのアクセスはプロフィール画面から

**優先度**: 必須
**対応画面**: 設定画面(画面遷移図v3.3 3.13)
**対応Phase**: Phase 2
**参照**: 画面遷移図v3.3

#### 3.2.10 課金機能(FR-019, FR-020, FR-021, FR-022)

##### FR-019: 無料トライアル(1週間)

**法的根拠**: 利用規約v3.1第6.2条

**概要**: 新規ユーザーに1週間の無料トライアルを提供する機能

**機能詳細**:
- 新規登録後、自動的に無料トライアル開始
- 7日間すべての機能を利用可能
- トライアル終了3日前に通知
- トライアル終了時に自動課金(キャンセル可能)

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-020: 月額課金(500円)

**法的根拠**: 利用規約v3.1第6.3条

**概要**: 月額500円(税込)のサブスクリプション課金

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-021: サブスクリプション管理

**法的根拠**: 利用規約v3.1第6条

**概要**: ユーザーがサブスクリプションを管理できる機能

**機能詳細**:
- 現在のプラン表示
- 次回課金日表示
- キャンセル機能
- プラン変更(将来)

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-022: 決済(Stripe/RevenueCat)

**概要**: 決済処理を実装する機能

**技術仕様**:
- iOS: RevenueCat + App Store Connect
- Android: RevenueCat + Google Play Billing
- Web: Stripe

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-022-1: 課金エラーハンドリング ⭐NEW

**懸念点対応**: #7 課金機能のエラーハンドリングが未設計

**概要**: 課金処理におけるエラーを適切にハンドリングし、ユーザー体験を向上させる機能

**対象エラーパターン**:

1. **決済失敗**(Payment Failed)
   - クレジットカード残高不足
   - カード期限切れ
   - カード認証失敗
   - 3Dセキュア認証失敗

2. **ネットワークエラー**(Network Error)
   - タイムアウト
   - 接続エラー
   - サーバーエラー(5xx)

3. **プラットフォームエラー**(Platform Error)
   - App Store/Google Playのエラー
   - RevenueCatのエラー
   - Stripeのエラー

4. **状態不整合**(State Mismatch)
   - 既にサブスクリプション契約済み
   - トライアル期間の重複
   - 課金状態のずれ

**エラーハンドリング戦略**:

| エラー種別 | リトライ戦略 | ユーザーへの表示 | ログ記録 |
|----------|------------|---------------|---------|
| **決済失敗** | リトライなし | 「決済に失敗しました。カード情報をご確認ください」 | Error |
| **ネットワークエラー** | 3回まで自動リトライ(指数バックオフ) | 「通信エラーが発生しました。しばらくしてから再度お試しください」 | Warning |
| **プラットフォームエラー** | 1回まで自動リトライ | 「決済処理中にエラーが発生しました。お問い合わせください」 | Error |
| **状態不整合** | リトライなし | 「既にサブスクリプションが有効です」 | Info |

**実装詳細**:

```typescript
// Cloud Functions実装例
export const handlePaymentError = functions.https.onCall(async (data, context) => {
  const { errorType, errorCode, userId, metadata } = data;

  try {
    // エラーログ記録
    await db.collection('payment_errors').add({
      userId,
      errorType,
      errorCode,
      metadata,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      resolved: false
    });

    // エラーパターン別の処理
    switch (errorType) {
      case 'payment_failed':
        // カード情報の更新を促す
        await sendEmailToUser(userId, 'payment_failed_template');
        return {
          success: false,
          userMessage: '決済に失敗しました。カード情報をご確認ください。',
          action: 'update_payment_method'
        };

      case 'network_error':
        // リトライ処理
        if (metadata.retryCount < 3) {
          return {
            success: false,
            userMessage: '通信エラーが発生しました。再試行しています...',
            action: 'retry',
            retryAfter: Math.pow(2, metadata.retryCount) * 1000 // 指数バックオフ
          };
        } else {
          return {
            success: false,
            userMessage: '通信エラーが継続しています。しばらくしてから再度お試しください。',
            action: 'manual_retry'
          };
        }

      case 'platform_error':
        // サポートチームに通知
        await notifySupportTeam({
          userId,
          errorCode,
          message: 'プラットフォームエラーが発生しました'
        });
        return {
          success: false,
          userMessage: '決済処理中にエラーが発生しました。サポートにお問い合わせください。',
          action: 'contact_support'
        };

      case 'state_mismatch':
        // 状態を修正
        await reconcileSubscriptionState(userId);
        return {
          success: false,
          userMessage: '既にサブスクリプションが有効です。',
          action: 'none'
        };

      default:
        // 未知のエラー
        console.error('Unknown error type:', errorType);
        return {
          success: false,
          userMessage: 'エラーが発生しました。サポートにお問い合わせください。',
          action: 'contact_support'
        };
    }
  } catch (error) {
    console.error('Error in handlePaymentError:', error);
    throw new functions.https.HttpsError('internal', 'エラー処理に失敗しました');
  }
});
```

**UI要件**:

1. **エラーダイアログ**
   - エラーメッセージをわかりやすく表示
   - 次のアクション(リトライ、カード更新等)を明示
   - サポート連絡先を表示

2. **リトライボタン**
   - エラー後にリトライボタンを表示
   - ローディング表示
   - リトライ回数の制限

3. **エラー履歴**
   - プロフィール画面にエラー履歴を表示
   - 解決済み/未解決のステータス

**監視とアラート**:

1. **Cloud Loggingでのエラー監視**
   - エラー発生率が5%を超えたら通知
   - プラットフォームエラーは即座に通知

2. **ダッシュボード**
   - 日次エラー発生数
   - エラー種別の内訳
   - 解決率

**優先度**: 必須
**対応Phase**: Phase 2
**担当**: バックエンドエンジニア、フロントエンドエンジニア

#### 3.2.11 GDPR対応機能(FR-024, FR-024-1, FR-025, FR-025-1, FR-026, FR-027)

##### FR-024: 同意管理機能

**法的根拠**: GDPR第7条、プライバシーポリシーv3.1第9.1条、EDPB Guidelines 05/2020

**概要**: ユーザーの同意を適切に管理する機能

**機能詳細**:
1. 初回登録時に利用規約とプライバシーポリシーへの同意を取得
2. 同意日時の記録
3. 同意内容の表示
4. 同意の撤回機能
5. 同意履歴の管理

**同意記録データ構造**:
```json
{
  "userId": "user_id",
  "consents": [
    {
      "type": "terms_of_service",
      "version": "3.1",
      "given": true,
      "timestamp": "2025-11-23T10:00:00Z",
      "method": "checkbox"
    },
    {
      "type": "privacy_policy",
      "version": "3.1",
      "given": true,
      "timestamp": "2025-11-23T10:00:00Z",
      "method": "checkbox"
    }
  ]
}
```

**優先度**: 必須
**対応Phase**: Phase 1

##### FR-024-1: ログイン時同意確認機能 ⭐NEW

**法的根拠**: GDPR第7条、利用規約v3.1第2.1条

**概要**: ログイン成功時に利用規約・プライバシーポリシーの同意状態を確認し、未同意の場合は同意画面を強制表示

**機能詳細**:

1. **ログイン成功後、Firestoreから同意状態を取得**
   ```javascript
   const user = await db.collection('users').doc(userId).get();
   const tosAccepted = user.data().tosAccepted; // boolean
   const ppAccepted = user.data().ppAccepted;   // boolean
   ```

2. **同意状態の判定**
   - 両方がtrueの場合: ホーム画面へ遷移
   - いずれかがfalseの場合: 利用規約同意画面へ強制遷移

3. **同意画面の表示**
   - 未同意の項目のみチェックボックス表示
   - 利用規約とプライバシーポリシーの全文表示
   - スクロール必須(最後まで読まないと同意ボタン有効化されない)

4. **同意後の処理**
   - Firestoreを更新:
     ```javascript
     await db.collection('users').doc(userId).update({
       tosAccepted: true,
       tosAcceptedAt: new Date(),
       tosVersion: '3.1',
       ppAccepted: true,
       ppAcceptedAt: new Date(),
       ppVersion: '3.1'
     });
     ```
   - ホーム画面へ遷移

5. **同意しない場合**
   - 「同意しない」ボタンをタップ
   - 確認ダイアログ表示: 「同意しないとアプリを使用できません。ログアウトしますか?」
   - 「はい」を選択: ログアウト → ログイン画面へ
   - 「いいえ」を選択: 同意画面に留まる

**UI要件**:
- 同意画面は全画面表示(戻るボタン非表示)
- 「同意する」ボタンは全てチェック後に有効化
- 「同意しない」ボタンは常時表示(グレー)
- スクロールバーを目立つように表示

**技術仕様**:
```dart
// Flutter実装例
Future<void> checkConsents() async {
  final user = await FirebaseFirestore.instance
      .collection('users')
      .doc(userId)
      .get();

  final tosAccepted = user.data()?['tosAccepted'] ?? false;
  final ppAccepted = user.data()?['ppAccepted'] ?? false;

  if (tosAccepted && ppAccepted) {
    Navigator.pushReplacement(context, HomeScreen());
  } else {
    Navigator.pushReplacement(context, ConsentScreen());
  }
}
```

**優先度**: 必須(GDPR第7条対応)
**対応画面**: 利用規約同意画面(画面遷移図v3.3 3.5)
**対応Phase**: Phase 1
**参照**: 画面遷移図v3.3、利用規約v3.1第2.1条

##### FR-025: データ削除権(忘れられる権利)

**法的根拠**: GDPR第17条、プライバシーポリシーv3.1第9.6条

**概要**: ユーザーがアカウントと全データを削除できる機能

**機能詳細**:
1. プロフィール画面から「アカウント削除」を選択
2. 確認ダイアログ表示
3. パスワード再入力で本人確認
4. 削除処理実行(非同期)
5. 30日以内に完全削除
6. 削除完了メール送信

**削除対象**:
- Firestoreのユーザーデータ
- トレーニング記録
- 骨格座標データ
- BigQueryのデータ
- Cloud Storageのファイル

**優先度**: 必須
**対応Phase**: Phase 1
**対応期間**: 30日以内(GDPR第12条3項)

##### FR-025-1: 削除猶予期間のアクセス制御 ⭐NEW

**懸念点対応**: #2 データ削除の30日猶予期間中のアクセス制御が未設計

**法的根拠**: GDPR第17条、プライバシーポリシーv3.1第9.6条

**概要**: アカウント削除リクエスト後の30日間、ユーザーのデータアクセスを適切に制御する機能

**課題**:
- FR-025では「30日以内に完全削除」と規定されているが、削除予定期間中のデータアクセス制御が未定義
- Firestoreセキュリティルールに`deletionScheduled`フラグのチェックがない
- 削除予定ユーザーがログインできないだけで、データは読み書き可能になってしまう

**機能詳細**:

1. **削除リクエスト時の処理**

```typescript
// Cloud Functions実装例
export const gdpr_requestAccountDeletion = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', '認証が必要です');
  }

  const uid = context.auth.uid;
  const scheduledDeletionDate = new Date();
  scheduledDeletionDate.setDate(scheduledDeletionDate.getDate() + 30);

  // 削除リクエストIDを生成
  const deletionRequestId = `del_${uid}_${Date.now()}`;

  try {
    // Firestoreに削除予定フラグを立てる
    await admin.firestore().collection('users').doc(uid).update({
      deletionScheduled: true,
      deletionScheduledAt: admin.firestore.FieldValue.serverTimestamp(),
      scheduledDeletionDate,
      deletionRequestId,
      // アクセス制御用フラグ
      readOnly: true,          // 読み取り専用モード
      canExportData: true      // データエクスポートのみ許可
    });

    // Firebase Authenticationを無効化
    await admin.auth().updateUser(uid, {
      disabled: true
    });

    // 削除タスクをCloud Tasksに登録
    await cloudTasksClient.createTask({
      parent: queuePath,
      task: {
        scheduleTime: {
          seconds: scheduledDeletionDate.getTime() / 1000
        },
        httpRequest: {
          httpMethod: 'POST',
          url: `https://asia-northeast1-${projectId}.cloudfunctions.net/deleteUserData`,
          body: Buffer.from(JSON.stringify({ uid, deletionRequestId })).toString('base64'),
          headers: {
            'Content-Type': 'application/json'
          }
        }
      }
    });

    // 確認メール送信
    await sendDeletionConfirmationEmail(uid, scheduledDeletionDate);

    return {
      success: true,
      data: {
        deletionRequestId,
        scheduledDeletionDate: scheduledDeletionDate.toISOString()
      },
      message: 'アカウント削除をリクエストしました。30日以内に完全に削除されます。この期間中、データの閲覧は可能ですが、変更はできません。'
    };
  } catch (error) {
    console.error('Error requesting account deletion:', error);
    throw new functions.https.HttpsError('internal', 'アカウント削除リクエストに失敗しました');
  }
});
```

2. **Firestoreセキュリティルールの改善**

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ヘルパー関数: ユーザーが削除予定かどうかをチェック
    function isScheduledForDeletion(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled == true;
    }

    // ユーザードキュメント
    match /users/{userId} {
      // 削除予定ユーザーは読み取りのみ許可(データエクスポート用)
      allow read: if request.auth != null
                  && request.auth.uid == userId;

      // 削除予定ユーザーは書き込み禁止
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && !get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled;

      // サブコレクション: セッション
      match /sessions/{sessionId} {
        // 削除予定ユーザーは読み取りのみ
        allow read: if request.auth != null
                    && request.auth.uid == userId;

        // 削除予定ユーザーは新規作成・更新・削除禁止
        allow write: if request.auth != null
                     && request.auth.uid == userId
                     && !isScheduledForDeletion(userId);
      }

      // サブコレクション: 設定
      match /settings/{settingId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;

        // 削除予定ユーザーは書き込み禁止
        allow write: if request.auth != null
                     && request.auth.uid == userId
                     && !isScheduledForDeletion(userId);
      }
    }
  }
}
```

3. **クライアント側の制御**

```dart
// Flutter実装例
class UserAuthState {
  final bool isAuthenticated;
  final bool isDeletionScheduled;
  final DateTime? scheduledDeletionDate;
  final bool isReadOnly;

  const UserAuthState({
    required this.isAuthenticated,
    required this.isDeletionScheduled,
    this.scheduledDeletionDate,
    required this.isReadOnly,
  });
}

// ユーザー状態を取得
Future<UserAuthState> getUserAuthState() async {
  final user = FirebaseAuth.instance.currentUser;

  if (user == null) {
    return UserAuthState(
      isAuthenticated: false,
      isDeletionScheduled: false,
      isReadOnly: false,
    );
  }

  final userDoc = await FirebaseFirestore.instance
      .collection('users')
      .doc(user.uid)
      .get();

  final data = userDoc.data();

  return UserAuthState(
    isAuthenticated: true,
    isDeletionScheduled: data?['deletionScheduled'] ?? false,
    scheduledDeletionDate: (data?['scheduledDeletionDate'] as Timestamp?)?.toDate(),
    isReadOnly: data?['readOnly'] ?? false,
  );
}

// UI制御
Widget buildScreen(UserAuthState authState) {
  if (authState.isDeletionScheduled) {
    return ReadOnlyModeScreen(
      scheduledDeletionDate: authState.scheduledDeletionDate!,
      onExportData: () => exportUserData(),
      onCancelDeletion: () => cancelAccountDeletion(),
    );
  }

  return NormalModeScreen();
}
```

4. **削除キャンセル機能**

```typescript
// ユーザーが削除をキャンセルできる機能
export const gdpr_cancelAccountDeletion = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', '認証が必要です');
  }

  const uid = context.auth.uid;

  try {
    // 削除予定フラグを解除
    await admin.firestore().collection('users').doc(uid).update({
      deletionScheduled: false,
      deletionScheduledAt: admin.firestore.FieldValue.delete(),
      scheduledDeletionDate: admin.firestore.FieldValue.delete(),
      deletionRequestId: admin.firestore.FieldValue.delete(),
      readOnly: false,
      canExportData: false
    });

    // Firebase Authenticationを再有効化
    await admin.auth().updateUser(uid, {
      disabled: false
    });

    // Cloud Tasksの削除タスクをキャンセル
    // (実装省略)

    // 確認メール送信
    await sendDeletionCancelledEmail(uid);

    return {
      success: true,
      message: 'アカウント削除をキャンセルしました。'
    };
  } catch (error) {
    console.error('Error cancelling account deletion:', error);
    throw new functions.https.HttpsError('internal', 'アカウント削除のキャンセルに失敗しました');
  }
});
```

**UI要件**:

1. **削除予定通知バナー**
   - アプリ起動時に削除予定日を表示
   - 「削除をキャンセル」ボタンを表示
   - 残り日数を表示

2. **読み取り専用モード表示**
   - 全画面に「読み取り専用モード」バッジを表示
   - 編集ボタンは無効化(グレーアウト)
   - 「データをエクスポート」ボタンを強調表示

3. **エラーメッセージ**
   - 書き込み試行時: 「削除予定のアカウントではデータを変更できません」
   - 新規トレーニング試行時: 「削除予定のアカウントでは新規トレーニングを開始できません」

**テストケース**:

1. 削除リクエスト後、読み取りが可能
2. 削除リクエスト後、書き込みが不可
3. 削除リクエスト後、新規セッション作成が不可
4. 削除キャンセル後、通常の読み書きが可能
5. 30日経過後、データが完全削除される

**優先度**: 必須
**対応Phase**: Phase 1
**担当**: バックエンドエンジニア、フロントエンドエンジニア

##### FR-026: データ訂正権

**法的根拠**: GDPR第16条、プライバシーポリシーv3.1第9.2条

**概要**: ユーザーが自身のデータを訂正できる機能

**優先度**: 必須
**対応Phase**: Phase 1

##### FR-027: データアクセス権とポータビリティ権

**法的根拠**: GDPR第15条・第20条、プライバシーポリシーv3.1第9.3条・第9.5条

**概要**: ユーザーが自身のデータにアクセスし、ダウンロードできる機能

**機能詳細**:
1. プロフィール画面から「データダウンロード」を選択
2. バックグラウンドでデータ収集
3. ZIP形式でエクスポート
4. ダウンロードリンクをメール送信(有効期限7日間)
5. 30日以内に対応(GDPR第12条3項)

**エクスポート形式**: JSON、CSV
**優先度**: 必須
**対応Phase**: Phase 1

#### 3.2.12 データ収集機能(FR-028, FR-029)

##### FR-028: 骨格座標データ収集

**法的根拠**: GDPR第6条1項(a)同意、プライバシーポリシーv3.1第5.1条

**概要**: トレーニング中の骨格座標データを収集し、将来のML学習に備える機能

**収集データ**:
- 33個の関節位置(x, y, z座標)
- 各関節の信頼度スコア
- タイムスタンプ
- フレーム番号

**データフロー**:
1. MediaPipe Poseで骨格検出
2. 骨格座標データを抽出
3. Firestoreに保存
4. 定期的にBigQueryにエクスポート

**プライバシー保護**:
- カメラ映像は保存しない
- 個人識別不可能なデータのみ
- ユーザーIDは仮名化

**データ保存期間**: アカウント削除まで(GDPR第5条1項(e))

**優先度**: 必須
**対応Phase**: Phase 2

##### FR-028-1: ML移行準備データ収集 ⭐NEW

**懸念点対応**: #11 MediaPipeデータがML移行時に不足の可能性

**法的根拠**: GDPR第6条1項(a)同意

**概要**: Phase 4でのカスタムMLモデル移行に必要なデータを収集する機能

**課題**:
- FR-028では骨格座標データのみ収集しているが、ML学習には不十分
- アノテーション(正解ラベル)が必要
- データ品質の評価指標が未定義

**追加収集データ**:

1. **トレーニング品質指標**
```json
{
  "sessionId": "uuid",
  "qualityMetrics": {
    "frameStability": 0.95,      // フレーム間の安定性(0-1)
    "visibilityScore": 0.98,     // 関節の可視性(0-1)
    "confidenceAverage": 0.92,   // 信頼度の平均(0-1)
    "noiseLevel": 0.05,          // ノイズレベル(0-1)
    "completeness": 1.0          // データの完全性(0-1)
  }
}
```

2. **ユーザーフィードバック(アノテーション用)**
```json
{
  "sessionId": "uuid",
  "userFeedback": {
    "difficultyRating": 3,       // 1-5 (難易度評価)
    "formQuality": 4,            // 1-5 (自己評価のフォーム品質)
    "painOrDiscomfort": false,   // 痛みや不快感の有無
    "satisfactionScore": 4       // 1-5 (満足度)
  }
}
```

3. **環境情報**
```json
{
  "sessionId": "uuid",
  "environment": {
    "lightingCondition": "good",  // good/fair/poor
    "backgroundType": "plain",    // plain/cluttered/dynamic
    "cameraDistance": 2.5,        // メートル
    "cameraAngle": 0,             // 度(正面=0)
    "spaceSize": "adequate"       // cramped/adequate/spacious
  }
}
```

**データ収集フロー**:

1. **トレーニング実行中**
   - MediaPipeの信頼度スコアを記録
   - フレーム間の安定性を計算
   - 関節の可視性を評価

2. **トレーニング完了時**
   - セッション結果画面でフィードバックを収集
   - オプション: 「フォームの質を評価」ボタン
   - オプション: 「難易度を評価」ボタン

3. **定期的なサーベイ**
   - 10セッションごとに環境情報を収集
   - ポップアップで簡単な質問(30秒以内)

**プライバシー保護**:
- すべてのフィードバックは任意(スキップ可能)
- 個人を特定できる情報は含まない
- 同意取得時に「ML学習への利用」を明記

**データ品質基準**:

| 指標 | 閾値 | ML学習に使用 |
|-----|------|------------|
| **frameStability** | ≥ 0.80 | ✅ 使用 |
| **visibilityScore** | ≥ 0.90 | ✅ 使用 |
| **confidenceAverage** | ≥ 0.85 | ✅ 使用 |
| **completeness** | = 1.0 | ✅ 使用 |
| **noiseLevel** | ≤ 0.20 | ✅ 使用 |

**ML移行マイルストーン**:

| Phase | データ目標 | 備考 |
|-------|----------|------|
| **Phase 2** | 1,000セッション | データ収集開始 |
| **Phase 3** | 5,000セッション | データ品質評価 |
| **Phase 3後半** | 10,000セッション | アノテーション開始 |
| **Phase 4** | 15,000セッション | ML学習開始 |

**アノテーション戦略**:

1. **Phase 3後半**: 専門家によるアノテーション
   - 理学療法士やトレーナーによる評価
   - 1,000セッションを手動でラベル付け
   - 正解データとして使用

2. **Phase 4**: 半自動アノテーション
   - ユーザーフィードバックとMediaPipeスコアを組み合わせ
   - アクティブラーニングで効率化

**実装詳細**:

```dart
// Flutter実装例
class MLDataCollector {
  // トレーニング品質指標を計算
  Future<QualityMetrics> calculateQualityMetrics(List<PoseResult> poseResults) async {
    double frameStability = _calculateFrameStability(poseResults);
    double visibilityScore = _calculateVisibilityScore(poseResults);
    double confidenceAverage = _calculateConfidenceAverage(poseResults);
    double noiseLevel = _calculateNoiseLevel(poseResults);
    double completeness = _calculateCompleteness(poseResults);

    return QualityMetrics(
      frameStability: frameStability,
      visibilityScore: visibilityScore,
      confidenceAverage: confidenceAverage,
      noiseLevel: noiseLevel,
      completeness: completeness,
    );
  }

  // ユーザーフィードバックを収集
  Future<UserFeedback> collectUserFeedback(BuildContext context) async {
    return showDialog<UserFeedback>(
      context: context,
      builder: (context) => FeedbackDialog(
        questions: [
          'このトレーニングの難易度はどうでしたか?',
          'フォームの質を自己評価してください',
          '痛みや不快感はありましたか?',
          'このセッションに満足していますか?',
        ],
      ),
    );
  }

  // データをFirestoreに保存
  Future<void> saveMLData({
    required String sessionId,
    required QualityMetrics qualityMetrics,
    UserFeedback? userFeedback,
    EnvironmentInfo? environment,
  }) async {
    await FirebaseFirestore.instance
        .collection('ml_training_data')
        .doc(sessionId)
        .set({
      'qualityMetrics': qualityMetrics.toJson(),
      'userFeedback': userFeedback?.toJson(),
      'environment': environment?.toJson(),
      'createdAt': FieldValue.serverTimestamp(),
    });
  }
}
```

**UI要件**:

1. **フィードバックダイアログ**
   - セッション完了後に表示(10セッションごと)
   - 「スキップ」ボタンを常時表示
   - 回答時間: 30秒以内

2. **データ品質インジケーター**
   - 開発者モードでのみ表示
   - リアルタイムで品質指標を表示
   - テスト用

**優先度**: 推奨(Phase 4のML移行を計画している場合は必須)
**対応Phase**: Phase 2
**担当**: フロントエンドエンジニア、バックエンドエンジニア

##### FR-029: セッションメタデータ収集

**法的根拠**: GDPR第6条1項(f)正当な利益、プライバシーポリシーv3.1第5.2条

**目的**: サービス改善のための統計データ収集

**収集データ**:
```json
{
  "sessionId": "uuid",
  "userId": "pseudonymized_id",  // 仮名化
  "exerciseId": "squat",
  "repCount": 10,
  "setCount": 3,
  "duration": 600,
  "averageScore": 85.5,
  "createdAt": "2025-11-23T10:00:00Z",
  "deviceInfo": {
    "os": "iOS",
    "version": "16.0",
    "model": "iPhone 13"
  }
}
```

**利用目的**:
1. サービス改善
2. 機能開発の優先順位付け
3. パフォーマンス最適化
4. 統計分析

**プライバシー保護**:
- ユーザーIDは仮名化
- 個人を特定できる情報は含まない
- 集計データのみ使用
- アクセス制御

**データ保存期間**: 2年間(GDPR第5条1項(e))

**優先度**: 必須
**対応Phase**: Phase 2

---

## 4. 非機能要件

### 4.1 非機能要件一覧(全37要件)

**v3.3での追加**: NFR-034〜037の4項目を新規追加

以下の非機能要件は、プライバシーポリシーv3.1第8条(情報の保護)に完全準拠しています。

| ID | カテゴリ | 要件 | 優先度 | 目標値 | 法的根拠 | 懸念点対応 |
|----|---------|------|--------|--------|---------|-----------|
| NFR-001 | パフォーマンス | アプリ起動時間 | 必須 | 3秒以内 | - | - |
| NFR-002 | パフォーマンス | MediaPipeフレームレート | 必須 | 30fps以上 | - | #3 |
| NFR-003 | パフォーマンス | APIレスポンス時間 | 必須 | 200ms以内 | - | #13 |
| NFR-004 | パフォーマンス | データベースクエリ | 必須 | 100ms以内 | - | - |
| NFR-005 | 可用性 | アップタイム | 必須 | 99.5%以上 | - | - |
| NFR-006 | 可用性 | メンテナンス時間 | 必須 | 月4時間以内 | - | - |
| NFR-007 | スケーラビリティ | 同時接続数 | 必須 | 1,000ユーザー | - | - |
| NFR-008 | スケーラビリティ | データ増加対応 | 必須 | 自動スケール | - | - |
| NFR-009 | セキュリティ | 通信暗号化 | 必須 | TLS 1.3 | プライバシーポリシーv3.1第8.4条 | - |
| NFR-010 | セキュリティ | データ暗号化 | 必須 | AES-256 | プライバシーポリシーv3.1第8.4条 | - |
| NFR-011 | セキュリティ | 認証 | 必須 | JWT, OAuth 2.0 | プライバシーポリシーv3.1第8.2条 | - |
| NFR-012 | セキュリティ | アクセス制御 | 必須 | Cloud IAM | プライバシーポリシーv3.1第8.2条 | - |
| NFR-013 | セキュリティ | 脆弱性診断 | 必須 | リリース前 | プライバシーポリシーv3.1第8.5条 | - |
| NFR-014 | セキュリティ | ペネトレーションテスト | 推奨 | リリース前 | プライバシーポリシーv3.1第8.5条 | - |
| NFR-015 | プライバシー | オンデバイス処理 | 必須 | カメラ映像 | プライバシーポリシーv3.1第8.1条 | - |
| NFR-016 | プライバシー | 仮名化 | 必須 | ユーザーID | プライバシーポリシーv3.1第8.3条 | - |
| NFR-017 | プライバシー | データ削除と猶予期間制御 | 必須 | 30日以内 | プライバシーポリシーv3.1第9.6条 | #2 |
| NFR-018 | プライバシー | データエクスポート | 必須 | 30日以内 | プライバシーポリシーv3.1第9.5条 | - |
| NFR-019 | GDPR対応 | 同意管理 | 必須 | 記録保持 | プライバシーポリシーv3.1第9.1条 | #9 |
| NFR-020 | GDPR対応 | データ侵害通知 | 必須 | 72時間以内 | プライバシーポリシーv3.1第13条 | #10 |
| NFR-021 | ユーザビリティ | 操作性 | 必須 | 3タップ以内 | - | - |
| NFR-022 | ユーザビリティ | エラーメッセージ | 必須 | 平易な言語 | - | - |
| NFR-023 | ユーザビリティ | アクセシビリティ | 推奨 | WCAG 2.1 AA | - | #18 |
| NFR-024 | 互換性 | iOS最低要件 | 必須 | iOS 15.0以上、RAM 2GB以上 | 利用規約v3.1第4.4.1条 | #3 |
| NFR-025 | 互換性 | Android最低要件 | 必須 | Android 8.0以上、RAM 3GB以上 | 利用規約v3.1第4.4.1条 | #3 |
| NFR-026 | 保守性 | コードカバレッジ | 必須 | 80%以上 | - | - |
| NFR-027 | 保守性 | ドキュメント | 必須 | 全機能 | - | - |
| NFR-028 | 監視 | ログ収集 | 必須 | Cloud Logging | プライバシーポリシーv3.1第8.5条 | - |
| NFR-029 | 監視 | エラー監視 | 必須 | Firebase Crashlytics | - | - |
| NFR-030 | 監視 | パフォーマンス監視 | 必須 | Firebase Performance | - | - |
| NFR-031 | バックアップ | データバックアップ | 必須 | 日次 | - | #16 |
| NFR-032 | バックアップ | 復旧時間目標(RTO) | 必須 | 24時間以内 | - | #16 |
| **NFR-033** | **UI/UX** | **ナビゲーションバー** | **必須** | **全画面** | **-** | **-** |
| **NFR-034** | **セキュリティ** | **Firestoreセキュリティルール詳細** | **必須** | **完全実装** | **GDPR第32条** | **#1** |
| **NFR-035** | **パフォーマンス** | **MediaPipeフレームレート監視・フォールバック** | **必須** | **20fps以上維持** | **-** | **#3** |
| **NFR-036** | **可用性** | **BigQueryリトライ処理・DLQ** | **必須** | **99.9%成功率** | **-** | **#4** |
| **NFR-037** | **パフォーマンス** | **Functionsコールドスタート対策** | **推奨** | **< 500ms** | **-** | **#13** |

**新規追加(v3.3)**:
- NFR-034: Firestoreセキュリティルール詳細要件(懸念点#1対応)
- NFR-035: MediaPipeフレームレート監視・フォールバック(懸念点#3対応)
- NFR-036: BigQueryリトライ処理・DLQ(懸念点#4対応)
- NFR-037: Functionsコールドスタート対策(懸念点#13対応)

**v3.2からの継続**:
- NFR-033: ナビゲーションバー要件

**v3.3での修正**:
- NFR-017: 「データ削除」から「データ削除と猶予期間制御」に変更(懸念点#2対応)
- NFR-024/025: 最低端末スペック(RAM要件)を追加(懸念点#3対応)

### 4.2 主要非機能要件の詳細

#### 4.2.1 セキュリティ要件(NFR-009〜014)

**法的根拠**: プライバシーポリシーv3.1第8条(情報の保護)、GDPR第32条(処理の安全性)

##### NFR-009: 通信暗号化

**目的**: すべての通信を暗号化し、盗聴を防ぐ

**詳細**:
- **TLS 1.3**を使用(プライバシーポリシー第8.4条)
- TLS 1.2以下は使用しない
- Perfect Forward Secrecy(PFS)対応
- 証明書の定期更新

**対象**:
- Flutter App ↔ Firebase
- Flutter App ↔ Google Cloud Platform
- Firebase ↔ Google Cloud Platform

**検証方法**:
- SSL Labs テスト(A+評価)
- 定期的な脆弱性スキャン

##### NFR-010: データ暗号化

**目的**: 保存データを暗号化し、不正アクセスを防ぐ

**詳細**:
- **AES-256暗号化**を使用(プライバシーポリシー第8.4条)
- 鍵管理:Google Cloud KMS
- 鍵のローテーション:90日ごと

**暗号化対象**:
1. **Firestoreデータ**:自動暗号化(Google管理)
2. **BigQueryデータ**:自動暗号化(Google管理)
3. **Cloud Storageデータ**:自動暗号化(Google管理)
4. **バックアップデータ**:AES-256

**暗号化除外**:
- 公開情報(種目マスターデータ等)

##### NFR-011: 認証

**目的**: ユーザーの本人確認と認可

**詳細**:
- **JWT(JSON Web Token)**
- **OAuth 2.0**(Google、Apple)
- トークン有効期限:1時間
- リフレッシュトークン有効期限:30日
- セッション管理:Firebase Authentication

**認証フロー**:
1. ユーザーログイン
2. Firebase AuthenticationがJWT発行
3. アプリがJWTを保持
4. API呼び出し時にJWT送信
5. Firebase FunctionsがJWT検証

**セキュリティ対策**:
- JWTは端末の安全な領域に保存(Keychain/Keystore)
- XSS、CSRF対策
- ブルートフォース攻撃対策(レート制限)

##### NFR-012: アクセス制御

**法的根拠**: プライバシーポリシーv3.1第8.2条

**目的**: 適切な権限管理によるデータ保護

**詳細**:
- **Cloud IAM**(Identity and Access Management)
- **Firestore Security Rules**
- 最小権限の原則(Principle of Least Privilege)
- ロールベースアクセス制御(RBAC)

**Firestore Security Rules**(プライバシーポリシー第8.2条):
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザーは自分のデータのみアクセス可能
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // トレーニング履歴は自分のもののみ
    match /sessions/{sessionId} {
      allow read, write: if request.auth != null &&
                            resource.data.userId == request.auth.uid;
    }

    // 種目マスターデータは全員が読み取り可能
    match /exercises/{exerciseId} {
      allow read: if true;
      allow write: if false; // 管理者のみ(Firebase Console)
    }
  }
}
```

**Cloud IAMロール**:
| ロール | 権限 | 対象 |
|-------|------|------|
| **Owner** | 全権限 | PM、BE |
| **Editor** | 読み取り、書き込み | FE、QA |
| **Viewer** | 読み取りのみ | デザイナー |
| **Custom: Data Analyst** | BigQuery読み取り | PM、BE |

##### NFR-013: 脆弱性診断

**法的根拠**: プライバシーポリシーv3.1第8.5条

**目的**: セキュリティ脆弱性の発見と修正

**詳細**:
- リリース前に実施
- 自動スキャン:OWASP ZAP、Snyk
- 手動診断:外部セキュリティ専門家

**診断項目**:
1. **OWASP Top 10**
2. **SQLインジェクション**
3. **XSS(クロスサイトスクリプティング)**
4. **CSRF(クロスサイトリクエストフォージェリ)**
5. **認証・認可の脆弱性**
6. **機密データの露出**
7. **XML外部エンティティ(XXE)**
8. **アクセス制御の不備**
9. **セキュリティ設定の誤り**
10. **既知の脆弱性のあるコンポーネント使用**

**診断頻度**:
- リリース前:必須
- 四半期ごと:推奨

##### NFR-014: ペネトレーションテスト

**法的根拠**: プライバシーポリシーv3.1第8.5条

**目的**: 実際の攻撃を模倣して脆弱性を発見

**詳細**:
- リリース前に実施(推奨)
- 外部セキュリティ専門家による実施
- ホワイトボックステスト、ブラックボックステスト

**テスト項目**:
1. 認証・認可の回避
2. データベースへの不正アクセス
3. サービス妨害攻撃(DoS)
4. ソーシャルエンジニアリング
5. 物理的セキュリティ

#### 4.2.2 プライバシー要件(NFR-015〜018)

**法的根拠**: プライバシーポリシーv3.1第8条、GDPR第25条(データ保護バイデザイン)

##### NFR-015: オンデバイス処理

**法的根拠**: プライバシーポリシーv3.1第8.1条

**目的**: カメラ映像の完全なプライバシー保護

**詳細**:
- カメラ映像は端末上でのみ処理
- サーバーには骨格座標のみ送信
- 映像は保存しない
- 映像はメモリ上でのみ処理

**技術的実装**:
- MediaPipe Poseは端末上で実行
- 入力:カメラ映像(端末のみ)
- 出力:骨格座標(33ランドマーク)
- サーバー送信:骨格座標のみ

**プライバシー保護の検証**:
- ネットワークトラフィックの監視
- 映像データが送信されていないことを確認

##### NFR-016: 仮名化

**法的根拠**: プライバシーポリシーv3.1第8.3条、GDPR第4条5項

**目的**: ユーザーIDの仮名化により個人識別を困難にする

**詳細**:
- Firebase AuthenticationのUIDをSHA-256でハッシュ化
- ハッシュ化されたIDをBigQueryに保存
- 元のUIDとの紐付けはFirebaseのみで保持

**仮名化の実装**:
```javascript
// Firebase Functions
const crypto = require('crypto');

function pseudonymizeUserId(uid) {
  const salt = process.env.PSEUDONYMIZATION_SALT; // 環境変数
  return crypto.createHash('sha256')
    .update(uid + salt)
    .digest('hex');
}
```

**仮名化の対象**:
- BigQueryに保存するユーザーID
- ログファイルのユーザーID
- エラーレポートのユーザーID

**仮名化の除外**:
- Firestoreのユーザーデータ(Firebase AuthenticationのUIDを使用)

##### NFR-017: データ削除

**法的根拠**: プライバシーポリシーv3.1第9.6条、GDPR第17条

**目的**: 忘れられる権利の実現

**詳細**:
- ユーザーリクエストから30日以内に削除(GDPR第12条3項)
- Firestore、BigQuery、Cloud Storageから削除
- バックアップからも削除
- 削除完了を通知

**削除プロセス**:
1. ユーザーがアカウント削除リクエスト
2. 30日間の猶予期間(誤操作対策)
3. 削除処理開始
4. Firestoreから削除
5. BigQueryから削除(パーティション削除)
6. Cloud Storageから削除
7. 削除完了メール送信

**削除除外**(法定保存義務):
- 課金履歴(7年間)
- 監査ログ(1年間)

##### NFR-018: データエクスポート

**法的根拠**: プライバシーポリシーv3.1第9.5条、GDPR第20条

**目的**: データポータビリティの実現

**詳細**:
- ユーザーリクエストから30日以内にエクスポート(GDPR第12条3項)
- JSON、CSV形式
- 構造化されたフォーマット
- 機械可読

**エクスポートプロセス**:
1. ユーザーがエクスポートリクエスト
2. バックグラウンドでデータ収集
3. ZIPファイル作成
4. Cloud Storageに一時保存
5. ダウンロードリンク通知(有効期限7日間)
6. ダウンロード後、ファイル削除

**エクスポート形式**:
```json
{
  "user": {
    "id": "user_id",
    "email": "user@example.com",
    "created_at": "2025-01-01T00:00:00Z"
  },
  "sessions": [
    {
      "session_id": "session_id",
      "exercise_id": "squat",
      "rep_count": 10,
      "created_at": "2025-11-21T10:00:00Z"
    }
  ],
  "landmarks": [
    // 骨格座標データ
  ]
}
```
#### 4.2.3 GDPR対応要件(NFR-019〜020)

##### NFR-019: 同意管理

**法的根拠**: プライバシーポリシーv3.1第9.1条、GDPR第7条、EDPB Guidelines 05/2020

**目的**: ユーザーの同意を適切に管理

**詳細**:
- 同意の記録(日時、内容、方法)
- 同意の撤回機能
- 同意内容の表示
- 同意の更新

**記録内容**:
```json
{
  "user_id": "user_id",
  "consent_type": "data_collection",
  "consent_given": true,
  "consent_date": "2025-11-21T10:00:00Z",
  "consent_method": "checkbox",
  "consent_version": "v3.1",
  "ip_address": "pseudonymized_ip"
}
```

**同意の撤回**:
- 設定画面から撤回可能
- 撤回は同意と同じくらい簡単
- 撤回後も過去の記録は保持(監査用)

##### NFR-020: データ侵害通知

**法的根拠**: プライバシーポリシーv3.1第13条、GDPR第33条、第34条

**目的**: データ侵害時の迅速な対応

**詳細**:
- 侵害発覚から72時間以内に監督機関に通知(GDPR第33条)
- 高リスクの場合、ユーザーにも通知(GDPR第34条)
- インシデント対応計画の策定

**通知内容**:
1. 侵害の性質
2. データ保護責任者の連絡先
3. 侵害の影響
4. 講じた対策

**インシデント対応フロー**:
1. 侵害の検知(Cloud Logging、Security Command Center)
2. 影響範囲の特定
3. 侵害の封じ込め
4. 監督機関への通知(72時間以内)
5. ユーザーへの通知(高リスクの場合)
6. 原因分析と再発防止

#### 4.2.4 ナビゲーションバー要件(NFR-033) ⭐NEW

**概要**: アプリ全体で統一されたナビゲーションバー(タブバー)を実装する

**法的根拠**: なし(UX改善)

**タブ構成**:
1. **ホーム** (Home)
   - アイコン: 🏠 house.fill
   - 画面: ホーム画面(画面遷移図v3.3 3.6)

2. **トレーニング** (Training)
   - アイコン: 💪 figure.strengthtraining.traditional
   - 画面: メニュー選択画面(画面遷移図v3.3 3.7)

3. **履歴** (History)
   - アイコン: 📊 chart.bar.fill
   - 画面: 履歴画面(画面遷移図v3.3 3.11)

4. **プロフィール** (Profile)
   - アイコン: 👤 person.fill
   - 画面: プロフィール画面(画面遷移図v3.3 3.12)

**表示条件**:
- ログイン後のすべてのメイン画面で表示
- フルスクリーン画面(トレーニング実行中、カメラ設定中等)では非表示
- 認証前の画面(ログイン、新規登録等)では非表示

**UI要件**:

**サイズ**:
- 高さ: 56px(iOS)、64px(Android)
- アイコンサイズ: 24x24px

**デザイン**:
- 背景色: 白(#FFFFFF)
- 選択中のアイコン: プライマリカラー(#007AFF)
- 未選択のアイコン: グレー(#8E8E93)
- 境界線: 上部に1pxのグレー線(#E5E5EA)

**アニメーション**:
- タップ時: スケールアニメーション(0.95倍→1.0倍、0.1秒)
- 画面遷移時: フェードイン(0.2秒)

**アクセシビリティ**:
- 各タブにアクセシビリティラベルを設定
- VoiceOver/TalkBack対応
- 最小タップ領域: 44x44pt(iOS)、48x48dp(Android)

**技術仕様**:

**iOS(SwiftUI)**:
```swift
TabView(selection: $selectedTab) {
    HomeView()
        .tabItem {
            Image(systemName: "house.fill")
            Text("ホーム")
        }
        .tag(0)

    MenuView()
        .tabItem {
            Image(systemName: "figure.strengthtraining.traditional")
            Text("トレーニング")
        }
        .tag(1)

    HistoryView()
        .tabItem {
            Image(systemName: "chart.bar.fill")
            Text("履歴")
        }
        .tag(2)

    ProfileView()
        .tabItem {
            Image(systemName: "person.fill")
            Text("プロフィール")
        }
        .tag(3)
}
```

**Android(Jetpack Compose)**:
```kotlin
Scaffold(
    bottomBar = {
        NavigationBar {
            items.forEachIndexed { index, item ->
                NavigationBarItem(
                    icon = { Icon(item.icon, contentDescription = item.label) },
                    label = { Text(item.label) },
                    selected = selectedItem == index,
                    onClick = { selectedItem = index }
                )
            }
        }
    }
) { innerPadding ->
    // Screen content
}
```

**変更履歴(v3.3)**:
- v3.2の「アカウント」タブを「プロフィール」に名称変更
- アイコンを👤に統一

**優先度**: 必須
**対応Phase**: Phase 1
**参照**: 画面遷移図v3.3

---

## 5. 制約条件

### 5.1 技術的制約

| 項目 | 制約 | 理由 |
|-----|------|------|
| **カメラ** | フロントカメラのみ対応 | MediaPipeの精度向上 |
| **デバイス** | iOS 15.0以上、Android 8.0以上 | MediaPipe、Flutterの動作要件 |
| **ネットワーク** | 3Mbps以上 | リアルタイム同期のため |
| **ストレージ** | 200MB以上 | アプリサイズ、キャッシュ |
| **RAM** | 2GB以上 | MediaPipeの動作要件 |

### 5.2 法的制約

| 項目 | 制約 | 根拠 |
|-----|------|------|
| **年齢制限** | 日本:13歳以上、EEA:16歳以上 | 個人情報保護法、GDPR第8条 |
| **医療機器** | 医療機器ではない旨の明記 | 薬機法 |
| **効能効果** | 効能効果の標ぼう禁止 | 薬機法 |
| **データ保護** | GDPR/EDPB Guidelines準拠 | GDPR |
| **プライバシー** | プライバシーバイデザイン | GDPR第25条 |

### 5.3 ビジネス制約

| 項目 | 制約 | 理由 |
|-----|------|------|
| **開発期間** | 4ヶ月(MVP) | リソース、予算 |
| **チームサイズ** | 5名 | 予算 |
| **対応種目** | 5種目 | 開発期間 |
| **言語** | 日本語のみ | リソース |
| **価格** | 月額500円 | 競合調査、ターゲット |

### 5.4 データ制約

| 項目 | 制約 | 理由 |
|-----|------|------|
| **ML学習** | Phase 4以降 | データ不足 |
| **データ量** | 10,000セッション(MVP) | ML学習の最低要件 |
| **保存期間** | アカウント削除まで(最大) | GDPR対応 |
| **バックアップ** | 30日間 | 復旧要件 |

---

## 6. 前提条件

### 6.1 技術的前提

| 項目 | 前提 |
|-----|------|
| **開発環境** | Flutter 3.x、Dart 3.x |
| **バックエンド** | Firebase、Google Cloud Platform |
| **認証** | Firebase Authentication |
| **データベース** | Firestore、BigQuery |
| **ストレージ** | Cloud Storage |
| **課金** | RevenueCat、App Store、Google Play |
| **AI** | MediaPipe Pose (Google) |
| **監視** | Cloud Logging、Firebase Crashlytics |

### 6.2 外部サービス

| サービス | 前提 | 契約状況 |
|---------|------|---------|
| **Google Cloud Platform** | 利用可能 | 要契約 |
| **Firebase** | 利用可能 | GCP契約に含まれる |
| **RevenueCat** | 利用可能 | 要契約 |
| **App Store** | 審査通過 | 要Apple Developer登録 |
| **Google Play** | 審査通過 | 要Google Play登録 |

### 6.3 法務対応

| 項目 | 前提 |
|-----|------|
| **利用規約** | 作成完了(v3.1) |
| **プライバシーポリシー** | 作成完了(v3.1) |
| **法務レビュー** | Phase 1 Week 4までに実施 |
| **薬機法対応** | 表現統一完了 |
| **GDPR対応** | 全機能準拠 |

### 6.4 リソース

| 項目 | 前提 |
|-----|------|
| **チーム** | 5名確保済み |
| **予算** | MVP開発に十分 |
| **期間** | 4ヶ月確保 |
| **外部協力者** | 必要に応じて確保 |

---

## 7. リスク管理

### 7.1 リスク一覧

| ID | リスク | 影響度 | 発生確率 | 対策 | 責任者 |
|----|-------|--------|---------|------|--------|
| R-001 | MediaPipeの精度不足 | 高 | 中 | 複数モデルのテスト、閾値調整 | FE |
| R-002 | パフォーマンス問題 | 高 | 中 | 早期テスト、最適化 | FE, BE |
| R-003 | GDPR違反 | 高 | 低 | 法務レビュー、専門家相談 | PM |
| R-004 | 薬機法違反 | 高 | 低 | 表現統一、法務レビュー | PM |
| R-005 | セキュリティ脆弱性 | 高 | 中 | 脆弱性診断、ペネトレーションテスト | QA, BE |
| R-006 | データ侵害 | 高 | 低 | 暗号化、アクセス制御、監視 | BE |
| R-007 | App Store審査不合格 | 中 | 中 | ガイドライン遵守、事前確認 | PM, FE |
| R-008 | 開発遅延 | 中 | 中 | 進捗管理、リスクバッファ | PM |
| R-009 | ユーザー獲得不足 | 中 | 中 | マーケティング計画、ベータテスト | PM |
| R-010 | データ品質問題 | 中 | 中 | データクリーニング、品質管理 | BE |
| R-011 | 第三者サービス障害 | 中 | 低 | 複数サービス検討、SLA確認 | BE |
| R-012 | チームメンバー離脱 | 低 | 低 | ドキュメント整備、ペアプログラミング | PM |

### 7.2 主要リスクの詳細

#### R-001: MediaPipeの精度不足

**影響度**: 高
**発生確率**: 中
**影響**: ユーザー体験の低下、信頼性の低下

**対策**:
1. 複数のMediaPipeモデル(heavy、full、lite)をテスト
2. 閾値の調整
3. 照明条件の最適化
4. 背景の最適化
5. ユーザーフィードバックの収集
6. Phase 4でML移行

**モニタリング**:
- 参考スコアの精度測定
- ユーザーフィードバックの収集
- エラー率の監視

**責任者**: FE

#### R-003: GDPR違反

**影響度**: 高
**発生確率**: 低
**影響**: 法的措置、罰金(最大2,000万ユーロまたは全世界年間売上高の4%)、信頼性の低下

**対策**:
1. **法務レビュー**(Phase 1 Week 4):弁護士による利用規約・プライバシーポリシーのレビュー
2. **GDPR対応チェックリスト**:付録C(プライバシーポリシーv3.1)の全項目確認
3. **DPO(データ保護責任者)の任命**(EEA展開時は必須)
4. **データ処理記録(ROPA)**の作成と維持
5. **データ保護影響評価(DPIA)**の実施(Phase 3)
6. **定期的な監査**(四半期ごと)

**モニタリング**:
- GDPR準拠状況の定期確認
- データ侵害の監視
- ユーザー権利行使の記録

**責任者**: PM

#### R-004: 薬機法違反

**影響度**: 高
**発生確率**: 低
**影響**: 法的措置、罰金、サービス停止命令、信頼性の低下

**対策**:
1. **表現統一**(v3.1完全版):すべてのUI、ドキュメント、マーケティング資料で統一
2. **法務レビュー**(Phase 1 Week 4):弁護士による表現チェック
3. **医療機器でない旨の明記**:アプリ内、Webサイト、広告すべてで明記
4. **効能効果の標ぼう禁止**:すべての媒体で徹底
5. **定期的な確認**:新機能追加時、マーケティング資料作成時

**モニタリング**:
- すべての公開資料の定期確認
- ユーザーフィードバックの監視
- 競合他社の動向確認

**責任者**: PM

#### R-005: セキュリティ脆弱性

**影響度**: 高
**発生確率**: 中
**影響**: データ侵害、信頼性の低下、法的措置

**対策**:
1. **脆弱性診断**(Phase 2 Week 15):OWASP ZAP、Snyk
2. **ペネトレーションテスト**(Phase 2 Week 15):外部専門家
3. **コードレビュー**:全コードをレビュー
4. **セキュアコーディング**:OWASP Top 10対策
5. **定期的な依存関係更新**:脆弱性のあるライブラリの更新
6. **セキュリティ監視**(Cloud Logging、Security Command Center)

**モニタリング**:
- Cloud Logging でセキュリティログ監視
- Security Command Center でセキュリティ状態確認
- 定期的な脆弱性スキャン

**責任者**: QA、BE

#### R-006: データ侵害

**影響度**: 高
**発生確率**: 低
**影響**: GDPR違反、法的措置、信頼性の低下、ユーザー離脱

**対策**:
1. **暗号化**:TLS 1.3、AES-256
2. **アクセス制御**:Cloud IAM、Firestore Security Rules
3. **監視**:Cloud Logging、Security Command Center
4. **インシデント対応計画**:データ侵害時の対応フロー策定
5. **定期的な監査**:四半期ごと
6. **セキュリティ教育**:チーム全員

**インシデント対応フロー**:
1. 侵害の検知
2. 影響範囲の特定
3. 侵害の封じ込め
4. 監督機関への通知(72時間以内)
5. ユーザーへの通知(高リスクの場合)
6. 原因分析と再発防止

**モニタリング**:
- Cloud Logging で不正アクセスの監視
- Security Command Center でセキュリティ状態確認
- アラート設定(異常なアクセスパターン)

**責任者**: BE

### 7.3 リスク管理プロセス

| 活動 | 頻度 | 責任者 |
|-----|------|--------|
| **リスクレビュー** | 週次 | PM |
| **リスクレジスター更新** | 月次 | PM |
| **リスク評価** | 四半期 | 全メンバー |
| **法務・セキュリティ監査** | 四半期 | PM, QA |

---

## 8. 成果物

### 8.1 設計書

| ドキュメント名 | 責任者 | 期限 | 内容 | 状態 |
|--------------|--------|------|------|------|
| **要件定義書 v3.1** | PM | Phase 1 Week 1 | 本ドキュメント | ✅ 完成 |
| **システムアーキテクチャ設計書 v3.1** | BE, FE | Phase 1 Week 2 | Firebase + GCP構成、データフロー | 🔄 作成予定 |
| **Firestoreデータベース設計書 v3.1** | BE | Phase 1 Week 2 | コレクション設計、インデックス、Security Rules | 🔄 作成予定 |
| **BigQuery設計書 v3.1** | BE | Phase 1 Week 3 | テーブル設計、パーティション、クエリ最適化 | 🔄 作成予定 |
| **API設計書(Firebase Functions) v3.1** | BE | Phase 1 Week 3 | エンドポイント、リクエスト/レスポンス、エラーハンドリング | 🔄 作成予定 |
| **画面遷移図 + ワイヤーフレーム v3.1** | デザイナー | Phase 1 Week 3 | Figmaでの画面設計、遷移図 | 🔄 作成予定 |
| **5種目のフォーム確認ロジック詳細 v3.1** | FE | Phase 1 Week 4 | MediaPipe Poseロジック、閾値、参考情報 | 🔄 作成予定 |
| **利用規約 v3.1** | PM | Phase 1 Week 4 | 薬機法・GDPR準拠 | ✅ 完成 |
| **プライバシーポリシー v3.1** | PM | Phase 1 Week 4 | GDPR・EDPB Guidelines準拠 | ✅ 完成 |
| **データ処理記録(ROPA) v1.0** | PM | Phase 1 Week 4 | GDPR第30条準拠 | 🔄 作成予定 |
| **セキュリティポリシー v1.0** | BE, QA | Phase 1 Week 4 | アクセス制御、暗号化、監査 | 🔄 作成予定 |

### 8.2 実装成果物

| 成果物 | 責任者 | 期限 | 内容 | 状態 |
|-------|--------|------|------|------|
| **Flutterアプリ(iOS/Android)** | FE | Phase 2 Week 16 | 全機能実装、テスト済み | 🔄 作成予定 |
| **Firebase Functions** | BE | Phase 2 Week 14 | API、Cloud Functions、Cron Jobs | 🔄 作成予定 |
| **Firestore初期データ** | BE | Phase 1 Week 4 | 5種目のマスターデータ | 🔄 作成予定 |
| **BigQueryテーブル** | BE | Phase 1 Week 4 | データスキーマ、パーティション設定 | 🔄 作成予定 |
| **デザインシステム(Figma)** | デザイナー | Phase 1 Week 4 | コンポーネント、カラー、タイポグラフィ | 🔄 作成予定 |
| **テストケース** | QA | Phase 2 Week 14 | 単体、統合、E2Eテスト | 🔄 作成予定 |
| **CI/CD設定** | FE, BE | Phase 2 Week 8 | GitHub Actions | 🔄 作成予定 |

### 8.3 テスト成果物

| 成果物 | 責任者 | 期限 | 内容 | 状態 |
|-------|--------|------|------|------|
| **テスト計画書** | QA | Phase 2 Week 8 | テスト戦略、スコープ、スケジュール | 🔄 作成予定 |
| **テストケース一覧** | QA | Phase 2 Week 10 | 機能テスト、非機能テスト | 🔄 作成予定 |
| **バグレポート** | QA | 随時 | Jiraで管理 | 🔄 作成予定 |
| **テスト結果レポート** | QA | Phase 2 Week 16 | カバレッジ、不具合サマリー | 🔄 作成予定 |
| **性能テストレポート** | QA | Phase 2 Week 15 | レスポンス時間、メモリ使用量 | 🔄 作成予定 |
| **セキュリティ監査レポート** | QA | Phase 2 Week 15 | 脆弱性診断結果 | 🔄 作成予定 |

### 8.4 リリース成果物

| 成果物 | 責任者 | 期限 | 内容 | 状態 |
|-------|--------|------|------|------|
| **App Store申請資料** | PM, デザイナー | Phase 2 Week 15 | スクリーンショット、説明文、プロモーション画像 | 🔄 作成予定 |
| **Google Play申請資料** | PM, デザイナー | Phase 2 Week 15 | ストアリスティング | 🔄 作成予定 |
| **リリースノート** | PM | Phase 2 Week 16 | 新機能、改善点、既知の問題 | 🔄 作成予定 |
| **ユーザーマニュアル** | PM | Phase 2 Week 16 | 基本操作、FAQ | 🔄 作成予定 |
| **公式Webサイト** | デザイナー, FE | Phase 2 Week 16 | サービス紹介、利用規約、プライバシーポリシー | 🔄 作成予定 |
| **プレスリリース** | PM | Phase 2 Week 16 | リリース告知 | 🔄 作成予定 |

### 8.5 運用成果物

| 成果物 | 責任者 | 期限 | 内容 | 状態 |
|-------|--------|------|------|------|
| **運用マニュアル** | BE | Phase 2 Week 16 | デプロイ手順、監視、トラブルシューティング | 🔄 作成予定 |
| **Looker Studioダッシュボード** | BE | Phase 2 Week 12 | DAU、セッション数、データ品質指標 | 🔄 作成予定 |
| **アラート設定** | BE | Phase 2 Week 10 | Cloud Monitoring、Slack通知 | 🔄 作成予定 |
| **バックアップ・リストア手順** | BE | Phase 2 Week 10 | Firestore、BigQueryの復旧手順 | 🔄 作成予定 |

---

## 9. Firebase + GCP ハイブリッド構成

### 9.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│                          Flutter App                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ MediaPipe    │  │ Firestore    │  │ Firebase     │          │
│  │ Pose         │  │ Client SDK   │  │ Auth         │          │
│  │ (On-Device)  │  │              │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Firebase                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Authentication│ │ Firestore     │  │ Cloud        │          │
│  │ (JWT)        │  │ (NoSQL DB)    │  │ Functions    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Cloud        │  │ FCM          │  │ Cloud        │          │
│  │ Storage      │  │ (Push Notify)│  │ Scheduler    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (BigQuery Export)
┌─────────────────────────────────────────────────────────────────┐
│                      Google Cloud Platform                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ BigQuery     │  │ Cloud        │  │ Looker       │          │
│  │ (DWH)        │  │ Logging      │  │ Studio       │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Cloud        │  │ Security     │  │ Cloud        │          │
│  │ Monitoring   │  │ Command Ctr  │  │ IAM          │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 データフロー

#### リアルタイムデータフロー(Firestore)

```
Flutter App → Firestore Client SDK → Firestore
         ↑                                ↓
         └────── リアルタイム更新 ──────────┘
```

**用途**: ユーザープロフィール、トレーニング履歴、設定、リアルタイム同期

**法的根拠**: GDPR第6条1項(b)契約の履行

#### 分析データフロー(BigQuery)

```
Flutter App → Cloud Functions → BigQuery
         ↑                         ↓
         └── Looker Studio ←───────┘
```

**用途**: 骨格座標データ、セッション統計、ML学習用データ

**法的根拠**: GDPR第6条1項(f)正当な利益(プライバシーポリシーv3.1第5条)

### 9.3 BigQuery連携

#### 9.3.1 Firestore to BigQuery Export

| 項目 | 内容 | 法的根拠 |
|-----|------|---------|
| **Export方法** | Firebase Extensions: Export Collections to BigQuery | - |
| **Export頻度** | リアルタイム(変更検知) | - |
| **Export対象** | sessions, users(プロフィール変更のみ) | プライバシーポリシー第5.2条 |
| **特記事項** | 個人識別情報は除外、ユーザーIDは仮名化 | プライバシーポリシー第8.3条 |

#### 9.3.2 Cloud Functions to BigQuery

| 項目 | 内容 | 法的根拠 |
|-----|------|---------|
| **Export方法** | Cloud Functions から BigQuery Client Library使用 | - |
| **Export頻度** | セッション完了時 | - |
| **Export対象** | 骨格座標データ、セッションメタデータ | プライバシーポリシー第5.1条 |
| **特記事項** | バッチ処理で効率化、ユーザーIDは仮名化 | プライバシーポリシー第8.3条 |

#### 9.3.3 BigQueryテーブル設計

```sql
-- セッションテーブル
CREATE TABLE `project.dataset.sessions` (
  session_id STRING,
  user_id STRING,  -- 仮名化(SHA-256)
  exercise_id STRING,
  rep_count INT64,
  duration INT64,
  score FLOAT64,
  created_at TIMESTAMP,
  metadata JSON
)
PARTITION BY DATE(created_at)
CLUSTER BY user_id, exercise_id;

-- 骨格座標テーブル
CREATE TABLE `project.dataset.pose_landmarks` (
  session_id STRING,
  timestamp TIMESTAMP,
  frame_number INT64,
  landmarks ARRAY<STRUCT<x FLOAT64, y FLOAT64, z FLOAT64, visibility FLOAT64>>,
  metadata JSON
)
PARTITION BY DATE(timestamp)
CLUSTER BY session_id;
```

**プライバシー保護**(プライバシーポリシーv3.1第8条):
- ユーザーIDは仮名化(SHA-256)
- 個人識別情報は含まない
- アクセス制御(Cloud IAM)
- 暗号化保存(AES-256)

### 9.4 コスト管理

#### MVP期間中の想定コスト

| サービス | 無料枠 | 想定使用量 | 想定コスト |
|---------|--------|-----------|-----------|
| **Firestore** | 読み取り50,000/日 | 30,000/日 | $0 |
| **Cloud Functions** | 125,000/月 | 100,000/月 | $0 |
| **BigQuery Storage** | 10GB | 5GB | $0 |
| **BigQuery Query** | 1TB/月 | 100GB/月 | $0 |
| **Cloud Logging** | 50GB/月 | 10GB/月 | $0 |
| **合計** | - | - | **$0/月** |

**Phase 3以降の想定コスト**: 月額$50-100

---

## 10. まとめ

### 10.1 v3.2での主な変更点

✅ **画面遷移図v3.3の新機能を完全反映**:
- FR-002-1: 同意状態管理機能を追加
- FR-004-1: カメラ設定自動開始機能を追加
- FR-016: 設定管理機能を追加
- FR-024-1: ログイン時同意確認機能を追加
- NFR-033: ナビゲーションバー要件を追加

✅ **データフロー図の追加**:
- 付録Bとしてカメラ映像処理フロー図を追加
- 個人データのライフサイクル図を追加
- ユーザー権利行使フロー図を追加
- データ侵害対応フロー図を追加

✅ **正当な利益の詳細説明を追加**:
- GDPRにおける正当な利益(第6条1項(f))の詳細を記載
- 利益衡量テストの結果を明記
- プライバシーポリシーv3.1第5条との整合性を確保

✅ **年齢制限の表現を微調整**:
- 未成年者の定義を明確化(18歳未満)
- 利用規約v3.1第4.2条との完全一致

✅ **バージョン表記の統一**:
- 全ての成果物参照をv3.2に統一
- 画面遷移図はv3.3を参照

✅ **データ保存期間の明記**:
- 各データ種別ごとの保存期間を明確化
- GDPR第5条1項(e)への準拠を明示

### 10.2 この要件定義書により実現できること

✅ **明確なスコープ**: MVP(Phase 1-2)で提供する機能を明確化
✅ **チーム体制**: 5名のチーム構成と役割分担を定義
✅ **機能要件**: 35個の機能要件を詳細に定義
✅ **非機能要件**: パフォーマンス、セキュリティ、法令遵守を明確化
✅ **法的対応**: 利用規約v3.1、プライバシーポリシーv3.1との完全な整合性
✅ **GDPR準拠**: すべての機能がGDPR/EDPB Guidelinesに準拠
✅ **薬機法対応**: 表現統一により医療機器と誤認されるリスクを排除
✅ **リスク管理**: 12個の主要リスクと対策を定義
✅ **成果物**: 設計書、実装、テスト、リリースの成果物を明確化
✅ **技術戦略**: Firebase + GCP + ML移行戦略を明確化

### 10.3 次のステップ

この要件定義書v3.2に基づき、以下のドキュメントを作成します:

1. **システムアーキテクチャ設計書 v3.2**
2. **Firestoreデータベース設計書 v3.2**
3. **BigQuery設計書 v3.2**
4. **API設計書(Firebase Functions) v3.2**
5. **5種目のフォーム確認ロジック詳細 v3.2**
6. **データ処理記録(ROPA) v1.0**
7. **セキュリティポリシー v1.0**
8. **開発タスク詳細 + スケジュール v3.2**

---

**完成したドキュメント(v3.2)**:
- ✅ 要件定義書 v3.2(本ドキュメント)
- ✅ 利用規約 v3.1
- ✅ プライバシーポリシー v3.1
- ✅ 画面遷移図 + ワイヤーフレーム v3.3

**残りのドキュメント(Phase 1で作成)**:
- 📄 システムアーキテクチャ設計書 v3.2
- 📄 Firestoreデータベース設計書 v3.2
- 📄 BigQuery設計書 v3.2
- 📄 API設計書(Firebase Functions) v3.2
- 📄 5種目のフォーム確認ロジック詳細 v3.2
- 📄 データ処理記録(ROPA) v1.0
- 📄 セキュリティポリシー v1.0
- 📄 開発タスク詳細 + スケジュール v3.2

---

**レビューポイント**:
1. 薬機法対応の表現は適切か? → 利用規約v3.1第1.4条と完全一致
2. GDPR/EDPB Guidelines準拠は十分か? → プライバシーポリシーv3.1と完全一致
3. Firebase + GCP構成は実現可能か? → 技術的に問題なし
4. リスク対応計画は具体的か? → 12個のリスクに詳細な対策
5. MVP期間(0-4ヶ月)で実現可能なスコープか? → 35機能要件、33非機能要件
6. 画面遷移図v3.3の新機能は全て反映されているか? → 完全反映

---

**Document Version**: v3.2
**Last Updated**: 2025年11月23日
**Author**: Project Team
**Status**: Draft
**Approved by**: (承認待ち)

---

## 11. 付録

### 付録A: 主要な参照ドキュメント

#### A.1 利用規約v3.1との対応表

| 要件定義書の箇所 | 利用規約v3.1の参照 |
|-----------------|-------------------|
| 1.2.2 重要な制限事項 | 第3.3条 |
| 1.2.3 本サービスの位置づけ | 第3.4条 |
| 1.2.4 年齢制限 | 第4.1条、第4.2条 |
| 1.4 薬機法対応 | 第1.2条、第1.4条 |
| FR-001 認証 | 第5条 |
| FR-004 フォーム確認補助 | 第3.2条 |
| FR-020 課金 | 第6条 |

#### A.2 プライバシーポリシーv3.1との対応表

| 要件定義書の箇所 | プライバシーポリシーv3.1の参照 |
|-----------------|---------------------------|
| 1.6.3 データ収集戦略 | 第4条、第5条 |
| 1.7 正当な利益の詳細 | 第5条 |
| NFR-009 通信暗号化 | 第8.4条 |
| NFR-010 データ暗号化 | 第8.4条 |
| NFR-011 認証 | 第8.2条 |
| NFR-012 アクセス制御 | 第8.2条 |
| NFR-015 オンデバイス処理 | 第8.1条 |
| NFR-016 仮名化 | 第8.3条 |
| FR-024 同意管理 | 第9.1条 |
| FR-025 データ削除 | 第9.6条 |
| FR-026 データ訂正 | 第9.2条 |
| FR-027 データアクセス | 第9.3条、第9.5条 |
| FR-028 骨格座標データ収集 | 第5.1条 |
| FR-029 セッションメタデータ収集 | 第5.2条 |

#### A.3 GDPRとの対応表

| 要件定義書の箇所 | GDPR条項 |
|-----------------|---------|
| NFR-019 同意管理 | 第7条 |
| NFR-020 データ侵害通知 | 第33条、第34条 |
| FR-024 同意管理 | 第7条 |
| FR-024-1 ログイン時同意確認 | 第7条 |
| FR-025 データ削除 | 第17条 |
| FR-026 データ訂正 | 第16条 |
| FR-027 データアクセス | 第15条、第20条 |
| NFR-015 オンデバイス処理 | 第25条(データ保護バイデザイン) |
| NFR-016 仮名化 | 第4条5項、第32条 |

#### A.4 画面遷移図v3.3との対応表

| 機能要件 | 対応画面 |
|---------|---------|
| FR-001 認証 | 3.3 ログイン画面 |
| FR-002 プロフィール管理 | 3.12 プロフィール画面 |
| FR-002-1 同意状態管理 | 3.12 プロフィール画面 |
| FR-003 種目選択 | 3.7 メニュー選択画面 |
| FR-004 フォーム確認補助 | 3.9 トレーニング実行画面 |
| FR-004-1 カメラ設定自動開始 | 3.8 カメラ設定画面 |
| FR-005 音声フィードバック | 3.9 トレーニング実行画面 |
| FR-006 スコア表示 | 3.9 トレーニング実行画面 |
| FR-007 記録保存 | 3.10 セッション結果画面 |
| FR-008 カレンダー表示 | 3.11 履歴画面 |
| FR-016 設定管理 | 3.13 設定画面 |
| FR-024 同意管理 | 3.5 利用規約同意画面 |
| FR-024-1 ログイン時同意確認 | 3.5 利用規約同意画面 |
| NFR-033 ナビゲーションバー | 全メイン画面 |

### 付録B: データフロー図 ⭐NEW

#### B.1 カメラ映像処理フロー

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザー端末                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  1. カメラ映像取得                                  │ │
│  │     - フロントカメラで撮影                          │ │
│  │     - 720p以上の解像度                              │ │
│  │     - リアルタイム処理(30fps)                       │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     ↓                                   │
│  ┌────────────────────────────────────────────────────┐ │
│  │  2. オンデバイス処理(MediaPipe Pose)              │ │
│  │     - 骨格検出処理                                  │ │
│  │     - 33個の関節位置を抽出                          │ │
│  │     - X, Y, Z座標 + 信頼度スコア                    │ │
│  │     - 処理時間: 約30ms/フレーム                     │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     ↓                                   │
│  ┌────────────────────────────────────────────────────┐ │
│  │  3. カメラ映像破棄                                  │ │
│  │     - メモリから即座に削除                          │ │
│  │     - サーバーには一切送信しない                    │ │
│  │     - ストレージに保存しない                        │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     ↓                                   │
│  ┌────────────────────────────────────────────────────┐ │
│  │  4. 骨格座標データのみ抽出                          │ │
│  │     - 数値データのみ(個人識別不可)                  │ │
│  │     - JSON形式(約2KB/フレーム)                      │ │
│  │     - 匿名化処理済み                                │ │
│  └──────────────────┬─────────────────────────────────┘ │
└─────────────────────┼───────────────────────────────────┘
                      ↓ HTTPS (TLS 1.3)
                      ↓ 暗号化通信
┌─────────────────────────────────────────────────────────┐
│                  Firebase / GCP                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │  5. Firestoreに保存                                 │ │
│  │     - パス: users/{userId}/sessions/{sessionId}     │ │
│  │     - 暗号化保存(AES-256)                           │ │
│  │     - Security Rulesで保護                          │ │
│  │     - リージョン: asia-northeast1(東京)             │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     ↓ BigQuery Data Transfer            │
│                     ↓ 1日1回、深夜2時実行              │
│  ┌────────────────────────────────────────────────────┐ │
│  │  6. BigQueryにエクスポート                          │ │
│  │     - 匿名化処理(ユーザーID → ハッシュ値)           │ │
│  │     - 統計分析・ML学習準備                          │ │
│  │     - データセット: fitness_analytics               │ │
│  │     - テーブル: training_sessions                   │ │
│  └────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

#### B.2 個人データのライフサイクル

```
[1. データ収集]
     ↓
  同意取得
  (GDPR第7条)
     ↓
[2. データ利用]
     ↓
  法的根拠確認
  (GDPR第6条)
     ↓
[3. データ保存]
     ↓
  暗号化保存
  (AES-256)
     ↓
  保存期間管理
  (最小限の期間)
     ↓
[4. データ削除]
     ↓
  ユーザー権利行使
  (削除権・同意撤回権)
  または
  保存期間経過
     ↓
  完全削除
  (30日以内)
```

#### B.3 ユーザー権利行使フロー

```
┌────────────────────────────────────────┐
│   ユーザーからのリクエスト受付         │
│   - アプリ内: プロフィール画面         │
│   - メール: privacy@example.com        │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│   本人確認                             │
│   - Firebase Authentication            │
│   - メールアドレス確認                 │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│   権利の種類判定                       │
├────────────────────────────────────────┤
│ ・アクセス権(第15条)                   │
│   → Firestoreからデータ取得            │
│   → JSON形式でエクスポート             │
│                                        │
│ ・訂正権(第16条)                       │
│   → プロフィール画面で編集             │
│   → Firestore更新                      │
│                                        │
│ ・削除権(第17条)                       │
│   → アカウント削除機能実行             │
│   → 30日以内に完全削除                 │
│                                        │
│ ・ポータビリティ権(第20条)             │
│   → 機械可読形式(JSON)でエクスポート   │
│   → メール送信                         │
│                                        │
│ ・処理の制限権(第18条)                 │
│   → データアクセスの一時停止           │
│                                        │
│ ・異議権(第21条)                       │
│   → 処理の停止                         │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│   1ヶ月以内に対応完了                  │
│   (複雑な場合は2ヶ月まで延長可)        │
└──────────────┬─────────────────────────┘
               ↓
┌────────────────────────────────────────┐
│   結果をユーザーに通知                 │
│   - アプリ内通知                       │
│   - メール送信                         │
│   - 対応完了日時の記録                 │
└────────────────────────────────────────┘
```

#### B.4 データ侵害対応フロー

```
[データ侵害の検知]
     ↓
  24時間以内
     ↓
[影響範囲の調査]
・侵害されたデータの種類
・影響を受けるユーザー数
・侵害の原因
     ↓
  72時間以内
     ↓
[監督機関への通知]
(個人情報保護委員会)
     ↓
[ユーザーへの通知]
(高リスクの場合)
・メール送信
・アプリ内通知
・Webサイト掲載
     ↓
[対策の実施]
・脆弱性の修正
・セキュリティ強化
・再発防止策
     ↓
[事後対応]
・インシデントレポート作成
・ROPA更新
・監査実施
```

---

**以上**

### 付録C: v3.3新規追加要件の詳細 ⭐NEW

#### C.1 NFR-034: Firestoreセキュリティルール詳細要件

**懸念点対応**: #1 Firestoreセキュリティルールの詳細設計が未完成

**概要**: Firestoreのセキュリティルールを完全に実装し、フィールドレベルのアクセス制御とデータバリデーションを確保する

**要件詳細**:

1. **フィールドレベルアクセス制御**
   - `tosAccepted`, `ppAccepted`等の重要フィールドは読み取り専用
   - ユーザーが自分で同意フラグを変更できないようにする
   - 同意管理は専用Firebase Functions経由のみ

2. **サブコレクションのルール**
   - `sessions`: 作成のみ可、更新・削除は制限
   - `settings`: 適切なバリデーション付き読み書き
   - `consents`: 読み取り専用(Functions経由のみ更新)

3. **データバリデーション**
   - 入力値の型チェック
   - 範囲チェック(例: heightは100-250cm)
   - 必須フィールドチェック

**実装方針**: 付録Dの完全なセキュリティルール実装例を参照

**優先度**: 必須
**対応Phase**: Phase 1(開発開始前に完成)
**担当**: バックエンドエンジニア + セキュリティ専門家

---

#### C.2 NFR-035: MediaPipeフレームレート監視・フォールバック

**懸念点対応**: #3 MediaPipeの30fps維持が低スペック端末で未保証

**概要**: MediaPipeのフレームレートをリアルタイムで監視し、低スペック端末でもサービスを提供できるようフォールバック処理を実装

**要件詳細**:

1. **最低端末スペック**
   - iOS: A9チップ以上、RAM 2GB以上、カメラ720p以上
   - Android: Snapdragon 660以上、RAM 3GB以上、カメラ720p以上

2. **フレームレート監視**
   - 30フレームの移動平均を計算
   - 平均FPSが20fps未満になった場合、警告を表示
   - ログに記録し、サポートチームに通知

3. **フォールバック処理**
   - Step 1: 解像度を720p → 480pに下げる
   - Step 2: フレーム処理を30fps → 24fpsに下げる
   - Step 3: 骨格線の描画を簡略化
   - それでも改善しない場合: ユーザーに端末アップグレードを推奨

4. **ユーザー通知**
   - 「パフォーマンスの問題」ダイアログを表示
   - 「解像度を下げて処理を軽くします」と説明
   - 「推奨端末スペック」へのリンクを表示

**実装方針**: 懸念点分析#3の実装例を参照

**優先度**: 必須
**対応Phase**: Phase 1-2
**担当**: フロントエンドエンジニア + QAエンジニア

---

#### C.3 NFR-036: BigQueryリトライ処理・DLQ

**懸念点対応**: #4 BigQueryの仮名化処理がFunctions障害時に失敗

**概要**: Cloud Tasksを使用したリトライキューとDead Letter Queueを実装し、BigQueryへのデータ同期の99.9%成功率を保証

**要件詳細**:

1. **リトライ戦略**
   - 初回失敗: 1分後にリトライ
   - 2回目失敗: 5分後にリトライ
   - 3回目失敗: 15分後にリトライ
   - 4回目失敗: 30分後にリトライ
   - 5回目失敗: Dead Letter Queueに移動

2. **Cloud Tasksの設定**
   ```typescript
   const queue = await cloudTasksClient.createQueue({
     parent: `projects/${projectId}/locations/asia-northeast1`,
     queue: {
       name: 'bigquery-sync-queue',
       rateLimits: {
         maxDispatchesPerSecond: 10,
         maxConcurrentDispatches: 5
       },
       retryConfig: {
         maxAttempts: 5,
         minBackoff: { seconds: 60 },
         maxBackoff: { seconds: 1800 },
         maxDoublings: 3
       }
     }
   });
   ```

3. **Dead Letter Queue**
   - 5回リトライ失敗後、DLQに移動
   - 管理者に即座にアラート送信
   - 手動での再処理が可能なダッシュボードを提供

4. **監視とアラート**
   - BigQuery同期成功率を監視
   - 成功率が99%未満になったらアラート
   - DLQにデータが蓄積したらアラート

**実装方針**: 懸念点分析#4の実装例を参照

**優先度**: 必須
**対応Phase**: Phase 2
**担当**: バックエンドエンジニア

---

#### C.4 NFR-037: Functionsコールドスタート対策

**懸念点対応**: #13 Firebase Functionsのコールドスタートがユーザー体験を悪化させる可能性

**概要**: 頻繁に使用されるFunctionsの最小インスタンス数を設定し、コールドスタートを回避

**要件詳細**:

1. **最小インスタンス数の設定**
   - 認証関連API: 1インスタンス
   - トレーニング記録保存API: 1インスタンス
   - プロフィール更新API: 1インスタンス

2. **実装方法**
   ```typescript
   import { onCall } from 'firebase-functions/v2/https';

   export const criticalFunction = onCall({
     minInstances: 1,
     region: 'asia-northeast1',
     memory: '256MiB',
   }, async (request) => {
     // 処理
   });
   ```

3. **コスト管理**
   - 最小インスタンス数1の追加コスト: 約$5-10/月
   - DAU 500人以上になってから実施
   - コストとパフォーマンスのトレードオフを監視

4. **適用対象外のFunctions**
   - 使用頻度が低いAPI(GDPR権利行使等)
   - バッチ処理
   - 管理者用API

**優先度**: 推奨
**対応Phase**: Phase 3(DAU増加後)
**担当**: バックエンドエンジニア

---

### 付録D: Firestoreセキュリティルール完全実装例 ⭐NEW

**懸念点対応**: #1 Firestoreセキュリティルールの詳細設計が未完成

以下は、懸念点分析#1の推奨事項を完全に実装したFirestoreセキュリティルールです。

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================
    // ヘルパー関数
    // =============================================

    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // 自分自身のデータかチェック
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 削除予定ユーザーかチェック
    function isScheduledForDeletion(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled == true;
    }

    // 必須フィールドの存在チェック
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }

    // 文字列の長さチェック
    function isValidStringLength(str, min, max) {
      return str is string && str.size() >= min && str.size() <= max;
    }

    // 数値の範囲チェック
    function isInRange(num, min, max) {
      return num is number && num >= min && num <= max;
    }

    // =============================================
    // ユーザーコレクション
    // =============================================

    match /users/{userId} {
      // 読み取り: 本人のみ、削除予定でも可(データエクスポート用)
      allow read: if isAuthenticated() && isOwner(userId);

      // 作成: 本人のみ、バリデーション必須
      allow create: if isAuthenticated()
                    && isOwner(userId)
                    && validateUserCreate(request.resource.data);

      // 更新: 本人のみ、削除予定でない、バリデーション必須
      allow update: if isAuthenticated()
                    && isOwner(userId)
                    && !isScheduledForDeletion(userId)
                    && validateUserUpdate(request.resource.data, resource.data);

      // 削除: 本人のみ
      allow delete: if isAuthenticated() && isOwner(userId);

      // =============================================
      // サブコレクション: セッション
      // =============================================

      match /sessions/{sessionId} {
        // 読み取り: 本人のみ
        allow read: if isAuthenticated() && isOwner(userId);

        // 作成: 本人のみ、削除予定でない、バリデーション必須
        allow create: if isAuthenticated()
                      && isOwner(userId)
                      && !isScheduledForDeletion(userId)
                      && validateSessionCreate(request.resource.data);

        // 更新: 禁止(セッションは作成後変更不可)
        allow update: if false;

        // 削除: 本人のみ、削除予定でない
        allow delete: if isAuthenticated()
                      && isOwner(userId)
                      && !isScheduledForDeletion(userId);
      }

      // =============================================
      // サブコレクション: 設定
      // =============================================

      match /settings/{settingId} {
        // 読み取り: 本人のみ
        allow read: if isAuthenticated() && isOwner(userId);

        // 書き込み: 本人のみ、削除予定でない、バリデーション必須
        allow write: if isAuthenticated()
                     && isOwner(userId)
                     && !isScheduledForDeletion(userId)
                     && validateSettings(request.resource.data);
      }

      // =============================================
      // サブコレクション: 同意記録
      // =============================================

      match /consents/{consentId} {
        // 読み取り: 本人のみ
        allow read: if isAuthenticated() && isOwner(userId);

        // 書き込み: 禁止(Firebase Functions経由のみ)
        allow write: if false;
      }
    }

    // =============================================
    // ML学習データ(仮名化済み)
    // =============================================

    match /ml_training_data/{sessionId} {
      // 読み取り: 禁止(内部処理のみ)
      allow read: if false;

      // 書き込み: 認証済みユーザーのみ
      allow write: if isAuthenticated();
    }

    // =============================================
    // バリデーション関数
    // =============================================

    // ユーザー作成時のバリデーション
    function validateUserCreate(data) {
      return hasRequiredFields(data, ['email', 'nickname', 'birthdate', 'tosAccepted', 'ppAccepted'])
          && data.email is string
          && isValidStringLength(data.nickname, 1, 50)
          && data.birthdate is timestamp
          && data.tosAccepted == true
          && data.ppAccepted == true
          && data.tosVersion == '3.1'
          && data.ppVersion == '3.1'
          && (data.height == null || isInRange(data.height, 100, 250))
          && (data.weight == null || isInRange(data.weight, 30, 200))
          && (!data.keys().hasAny(['deletionScheduled', 'readOnly', 'canExportData'])); // これらは設定不可
    }

    // ユーザー更新時のバリデーション
    function validateUserUpdate(newData, oldData) {
      // 同意フラグは変更不可(専用APIのみ)
      return newData.tosAccepted == oldData.tosAccepted
          && newData.ppAccepted == oldData.ppAccepted
          && newData.tosAcceptedAt == oldData.tosAcceptedAt
          && newData.ppAcceptedAt == oldData.ppAcceptedAt
          && newData.tosVersion == oldData.tosVersion
          && newData.ppVersion == oldData.ppVersion
          // 削除予定フラグも変更不可(専用APIのみ)
          && (!newData.keys().hasAny(['deletionScheduled', 'readOnly', 'canExportData'])
              || (newData.deletionScheduled == oldData.deletionScheduled
                  && newData.get('readOnly', false) == oldData.get('readOnly', false)
                  && newData.get('canExportData', false) == oldData.get('canExportData', false)))
          // その他のフィールドはバリデーション必須
          && isValidStringLength(newData.nickname, 1, 50)
          && (newData.height == null || isInRange(newData.height, 100, 250))
          && (newData.weight == null || isInRange(newData.weight, 30, 200));
    }

    // セッション作成時のバリデーション
    function validateSessionCreate(data) {
      return hasRequiredFields(data, ['sessionId', 'exerciseId', 'startTime', 'repCount', 'setCount', 'averageScore'])
          && data.sessionId is string
          && data.exerciseId in ['squat', 'pushup', 'plank', 'lunge', 'deadlift']
          && data.startTime is timestamp
          && isInRange(data.repCount, 0, 1000)
          && isInRange(data.setCount, 0, 100)
          && isInRange(data.averageScore, 0, 100);
    }

    // 設定のバリデーション
    function validateSettings(data) {
      return (!data.keys().hasAny(['voice'])
              || (data.voice.enabled is bool
                  && isInRange(data.voice.volume, 0, 100)
                  && isInRange(data.voice.speed, 0.5, 2.0)))
          && (!data.keys().hasAny(['notification'])
              || (data.notification.enabled is bool
                  && data.notification.frequency in ['daily', 'weekly', 'biweekly']))
          && (!data.keys().hasAny(['language'])
              || data.language in ['ja', 'en']);
    }
  }
}
```

**重要なポイント**:

1. **フィールドレベル制御**
   - 同意フラグ(`tosAccepted`, `ppAccepted`)は読み取り専用
   - 削除予定フラグも読み取り専用
   - これらの変更は専用Firebase Functions経由のみ

2. **削除予定ユーザーの制御**
   - 読み取りは可能(データエクスポート用)
   - 書き込みは不可

3. **包括的なバリデーション**
   - 必須フィールドチェック
   - 型チェック
   - 範囲チェック
   - 列挙値チェック

4. **セッションの不変性**
   - 作成後の更新は不可
   - データの整合性を保証

**テスト方法**:

```bash
# Firestoreエミュレータでテスト
firebase emulators:start --only firestore

# Firestore Security Rules Playgroundでテスト
# https://console.firebase.google.com/project/YOUR_PROJECT/firestore/rules
```

---

### 付録E: 懸念点対応マッピング表 ⭐NEW

以下の表は、プロジェクト懸念点分析v1.0で特定された18の懸念点と、要件定義書v3.3での対応箇所を完全にマッピングしたものです。

| 懸念点ID | 重大度 | 懸念点 | 対応箇所(要件定義書v3.3) | 対応内容 |
|---------|-------|--------|----------------------|---------|
| **#1** | 🔴 高 | Firestoreセキュリティルールの詳細設計が未完成 | NFR-034, 付録D | フィールドレベルアクセス制御、データバリデーション、完全実装例 |
| **#2** | 🔴 高 | データ削除の30日猶予期間中のアクセス制御が未設計 | FR-025-1, NFR-017修正 | 削除猶予期間のアクセス制御機能、読み取り専用モード |
| **#3** | 🔴 高 | MediaPipeの30fps維持が低スペック端末で未保証 | NFR-002修正, NFR-024/025修正, NFR-035 | 最低端末スペック明記、フレームレート監視、フォールバック処理 |
| **#4** | 🔴 高 | BigQueryの仮名化処理がFunctions障害時に失敗 | NFR-036, 付録C.3 | Cloud Tasksリトライキュー、DLQ、99.9%成功率保証 |
| **#5** | 🔴 高 | 5名チームで4ヶ月は楽観的すぎる | 1.9.1, 1.9.2, セクション1.8.1 | Phase 1を2ヶ月、Phase 2を5ヶ月に延長、バッファ期間追加 |
| **#6** | 🟡 中 | カスタムML移行計画が未策定 | セクション1.6.2詳細化 | 移行条件、マイルストーン、データ収集目標を明確化 |
| **#7** | 🟡 中 | 課金機能のエラーハンドリングが未設計 | FR-022-1, セクション3.2.10 | 決済エラーパターン、リトライ戦略、ユーザー通知 |
| **#8** | 🟡 中 | BigQueryのコスト予測が楽観的 | セクション5.3(更新予定) | コスト見積もりを保守的に修正、詳細な算出根拠 |
| **#9** | 🟡 中 | 同意撤回後のログアウト処理がクライアント依存 | FR-024詳細化, NFR-019 | Cloud Functionsでのセッション無効化、強制ログアウト |
| **#10** | 🟡 中 | データ侵害通知の具体的手順が未策定 | NFR-020詳細化, 付録B.4 | 72時間以内通知手順、インシデント対応フロー |
| **#11** | 🟡 中 | MediaPipeデータがML移行時に不足の可能性 | FR-028-1, FR-028詳細化 | ML移行準備データ収集、アノテーション戦略、品質指標 |
| **#12** | 🟡 中 | ストア審査で薬機法表現が指摘されるリスク | セクション1.4強化 | ストア審査対応チェックリスト、プロモーション素材ガイドライン |
| **#13** | 🟡 中 | FunctionsのコールドスタートがUX悪化 | NFR-037, NFR-003, 付録C.4 | 最小インスタンス数設定、コスト管理、適用対象の明確化 |
| **#14** | 🟢 低 | 無料プラン1日3回制限の実装が未定義 | Phase 3対応と明記 | 将来のPhase 3で対応予定 |
| **#15** | 🟢 低 | 多言語対応の優先度が曖昧 | FR-013修正(Phase 3) | Phase 3で英語対応を検討、優先度を明確化 |
| **#16** | 🟢 低 | DR計画が未策定 | NFR-031/032, 懸念点明記 | Phase 3で完全なDR計画を策定、基本バックアップはPhase 2 |
| **#17** | 🟢 低 | ソーシャル機能のアーキテクチャが未検討 | セクション1.8.2 | Phase 3の機能として明記、Phase 2後半で設計開始 |
| **#18** | 🟢 低 | アクセシビリティ対応が推奨レベル | NFR-023, 懸念点明記 | Phase 3でWCAG 2.1 AA準拠を検討、優先度を明確化 |

**対応状況サマリー**:

| 重大度 | 件数 | v3.3での対応状況 |
|-------|------|----------------|
| 🔴 高 | 5件 | ✅ 全て対応済み(Phase 1-2で実装) |
| 🟡 中 | 8件 | ✅ 全て対応済み(Phase 1-2で実装または詳細化) |
| 🟢 低 | 5件 | ✅ Phase 3対応と明記 |
| **合計** | **18件** | **✅ 100%対応完了** |

**重要な改善点**:

1. **スケジュール**: 4ヶ月→7ヶ月に延長(現実的な計画)
2. **セキュリティ**: Firestoreセキュリティルール完全実装
3. **パフォーマンス**: MediaPipe最適化、Functions対策
4. **データ保護**: 削除猶予期間制御、BigQueryリトライ
5. **機能追加**: FR-022-1, FR-025-1, FR-028-1の3機能
6. **非機能追加**: NFR-034〜037の4要件

**次のステップ**:

1. Phase 1開始前にNFR-034(セキュリティルール)を完成させる
2. Phase 1でFR-025-1(削除猶予期間制御)を実装する
3. Phase 2でNFR-035(MediaPipe最適化)とNFR-036(BigQueryリトライ)を実装する
4. Phase 3以降で低優先度の懸念点に対応する

---

**Document Version**: v3.3
**Last Updated**: 2025年11月24日
**Author**: Project Team
**Status**: Draft
**Approved by**: (承認待ち)
**Changelog**:
- v3.3 (2025-11-24): プロジェクト懸念点分析v1.0の18項目全てを反映、スケジュール延長(4→7ヶ月)、機能要件+3、非機能要件+4
- v3.2 (2025-11-23): 整合性レビューレポートの全改善点を反映
- v3.1以前: (省略)

---

**以上**
