# Ticket #010: 5種目フォーム確認ロジック実装

**Phase**: Phase 2 (機能実装)
**期間**: Week 5-6
**優先度**: 最高
**関連仕様書**:
- `docs/specs/08_README_form_validation_logic_v3_3.md`
- `docs/specs/00_要件定義書_v3_3.md` (FR-010～FR-018)

## 概要
スクワット、アームカール、サイドレイズ、ショルダープレス、プッシュアップの5種目について、MediaPipeで取得した姿勢データを基にフォームを評価するロジックを実装する。

## Todo リスト

### 共通基盤実装

#### FormAnalyzer基底クラス (`services/form_analyzer/base_analyzer.dart`)
- [ ] 抽象基底クラス定義
  - [ ] 角度計算メソッド（3点から角度算出）
  - [ ] 速度計算メソッド
  - [ ] 可動域チェック
  - [ ] 対称性評価
- [ ] 共通ユーティリティ
  - [ ] ベクトル演算
  - [ ] 移動平均フィルタ
  - [ ] 外れ値除去
  - [ ] カルマンフィルタ（オプション）

#### フィードバック管理 (`models/form_feedback.dart`)
- [ ] フィードバックレベル定義
  - [ ] Excellent (90-100%)
  - [ ] Good (70-89%)
  - [ ] Fair (50-69%)
  - [ ] NeedsImprovement (<50%)
- [ ] フィードバックタイプ
  - [ ] リアルタイムアラート
  - [ ] セット完了時サマリ
  - [ ] セッション終了時詳細

### スクワット実装

#### SquatAnalyzer (`services/form_analyzer/squat_analyzer.dart`)
- [ ] キーポイント取得
  - [ ] 腰 (Hip)
  - [ ] 膝 (Knee)
  - [ ] 足首 (Ankle)
  - [ ] 肩 (Shoulder)
- [ ] 深さ評価
  - [ ] 膝角度計算（目標: 90度）
  - [ ] 腰の位置追跡
  - [ ] パラレル判定
- [ ] 膝の位置チェック
  - [ ] 膝が爪先より前に出ていないか
  - [ ] 内側に入っていないか（knee valgus）
  - [ ] 左右の対称性
- [ ] 背中の角度
  - [ ] 前傾角度（適正: 15-30度）
  - [ ] 腰椎の過伸展チェック
- [ ] レップカウント
  - [ ] 下降フェーズ検出
  - [ ] 上昇フェーズ検出
  - [ ] 完全なレップ判定

### アームカール実装

#### BicepCurlAnalyzer (`services/form_analyzer/bicep_curl_analyzer.dart`)
- [ ] キーポイント取得
  - [ ] 肩 (Shoulder)
  - [ ] 肘 (Elbow)
  - [ ] 手首 (Wrist)
- [ ] 可動域評価
  - [ ] 開始位置（フル伸展）
  - [ ] 終了位置（フル収縮）
  - [ ] 肘角度追跡（0-140度）
- [ ] フォームチェック
  - [ ] 肘の固定（スイング防止）
  - [ ] 手首の角度維持
  - [ ] 肩の上昇チェック
- [ ] テンポ分析
  - [ ] コンセントリック速度
  - [ ] エキセントリック速度
  - [ ] 一定速度の維持

### サイドレイズ実装

#### LateralRaiseAnalyzer (`services/form_analyzer/lateral_raise_analyzer.dart`)
- [ ] キーポイント取得
  - [ ] 肩 (Shoulder)
  - [ ] 肘 (Elbow)
  - [ ] 手首 (Wrist)
  - [ ] 腰 (Hip)
- [ ] 挙上角度評価
  - [ ] 目標角度（80-90度）
  - [ ] 左右対称性
  - [ ] 平行維持
- [ ] 姿勢チェック
  - [ ] 体幹の安定性
  - [ ] 反動使用検出
  - [ ] 肩すくめ防止
- [ ] 動作スムーズネス
  - [ ] 加速度分析
  - [ ] ジャーク（急激な動き）検出

### ショルダープレス実装

#### ShoulderPressAnalyzer (`services/form_analyzer/shoulder_press_analyzer.dart`)
- [ ] キーポイント取得
  - [ ] 肩 (Shoulder)
  - [ ] 肘 (Elbow)
  - [ ] 手首 (Wrist)
  - [ ] 頭 (Head)
- [ ] プレス経路分析
  - [ ] 垂直性評価
  - [ ] 左右バランス
  - [ ] フルレンジ確認
- [ ] 安全性チェック
  - [ ] 肘の過伸展防止
  - [ ] 腰椎過伸展チェック
  - [ ] 首の位置確認
- [ ] 負荷バランス
  - [ ] 左右均等性
  - [ ] 速度一貫性

### プッシュアップ実装

#### PushUpAnalyzer (`services/form_analyzer/pushup_analyzer.dart`)
- [ ] キーポイント取得
  - [ ] 肩 (Shoulder)
  - [ ] 肘 (Elbow)
  - [ ] 手首 (Wrist)
  - [ ] 腰 (Hip)
  - [ ] 膝 (Knee)
  - [ ] 足首 (Ankle)
- [ ] 体のアライメント
  - [ ] プランクポジション維持
  - [ ] 腰の落ち込み検出
  - [ ] 臀部の上昇検出
- [ ] 深さ評価
  - [ ] 肘角度（目標: 90度）
  - [ ] 胸と床の距離
- [ ] 手の位置
  - [ ] 肩幅チェック
  - [ ] 前後位置の適正性

### リアルタイムフィードバック

#### FeedbackManager (`services/feedback_manager.dart`)
- [ ] 音声フィードバック
  - [ ] Text-to-Speech実装
  - [ ] タイミング制御（3秒間隔）
  - [ ] 優先度管理
- [ ] 視覚フィードバック
  - [ ] スケルトンカラーコーディング
  - [ ] 問題箇所ハイライト
  - [ ] 改善方向の矢印表示
- [ ] 触覚フィードバック
  - [ ] バイブレーション
  - [ ] パターン設定

### データ記録

#### SessionDataRecorder (`services/session_data_recorder.dart`)
- [ ] フォーム評価データ
  - [ ] 各レップのスコア
  - [ ] 問題点の記録
  - [ ] 改善傾向分析
- [ ] 統計情報
  - [ ] 平均スコア
  - [ ] 最高/最低スコア
  - [ ] 一貫性評価
- [ ] ビデオハイライト
  - [ ] ベストレップ
  - [ ] 要改善レップ
  - [ ] タイムスタンプ記録

### テスト実装

#### 単体テスト
- [ ] 角度計算精度
- [ ] 速度計算精度
- [ ] 状態遷移ロジック
- [ ] しきい値検証

#### 統合テスト
- [ ] MediaPipe→Analyzer連携
- [ ] リアルタイムパフォーマンス
- [ ] フィードバック遅延測定

#### 検証データセット
- [ ] 正しいフォームサンプル
- [ ] 一般的なエラーパターン
- [ ] エッジケース

### パフォーマンス最適化
- [ ] 計算量削減
  - [ ] 必要最小限のランドマーク使用
  - [ ] フレームスキップ戦略
  - [ ] 並列処理活用
- [ ] メモリ最適化
  - [ ] 循環バッファ使用
  - [ ] データ圧縮
- [ ] レイテンシ最小化
  - [ ] 予測アルゴリズム
  - [ ] キャッシング戦略

## 受け入れ条件
- [ ] 5種目すべてでフォーム評価が機能する
- [ ] リアルタイムフィードバック遅延 < 100ms
- [ ] 評価精度 > 85%（専門家評価との一致率）
- [ ] レップカウント精度 > 95%
- [ ] 30fps以上で安定動作

## 注意事項
- 医療機器ではないことの明示（薬機法対応）
- 個人差を考慮した柔軟な評価基準
- 初心者にも分かりやすいフィードバック
- プライバシー配慮（映像データは保存しない）

## 参考リンク
- [MediaPipe Pose Landmarks](https://google.github.io/mediapipe/solutions/pose.html#pose-landmark-model)
- [Biomechanics of Exercise](https://www.nsca.com/education/articles/)
- [Computer Vision for Sports](https://arxiv.org/abs/2301.07835)