# Ticket #008: 同意管理機能実装

**Phase**: Phase 2 (機能実装)
**期間**: Week 3-4
**優先度**: 最高
**関連仕様書**:
- `docs/specs/00_要件定義書_v3_3.md` (FR-002, FR-024)
- `docs/specs/利用規約_v3_2.md`
- `docs/specs/プライバシーポリシー_v3.1.md`
- `docs/specs/06_データ処理記録_ROPA_v1_0.md`

## 概要
GDPR準拠の同意管理機能を実装し、利用規約・プライバシーポリシーへの同意を適切に管理する。

## Todo リスト

### Flutter側実装

#### 同意画面 (`screens/legal/consent_screen.dart`)
- [ ] 初回ログイン時の同意画面
  - [ ] 利用規約全文表示（スクロール可能）
  - [ ] プライバシーポリシー全文表示
  - [ ] 個別同意チェックボックス
  - [ ] 「すべてに同意」ボタン
  - [ ] 「同意しない」オプション
- [ ] 同意状態の表示
  - [ ] 現在の同意状況
  - [ ] 同意日時
  - [ ] バージョン情報

#### 同意更新画面
- [ ] 規約更新時の再同意画面
- [ ] 変更点のハイライト表示
- [ ] 部分同意オプション
- [ ] 同意撤回の影響説明

#### 同意撤回機能
- [ ] 同意撤回ボタン
- [ ] 撤回確認ダイアログ
  - [ ] 影響の説明
  - [ ] データ削除オプション
  - [ ] 最終確認
- [ ] 撤回後の処理
  - [ ] 強制ログアウト
  - [ ] アプリ機能制限

#### プロフィール画面統合
- [ ] 同意管理セクション追加
- [ ] 同意状態の表示
- [ ] 同意履歴へのリンク
- [ ] 規約へのリンク

### Cloud Functions 実装

#### 同意記録API (`api/consent/record.ts`)
- [ ] エンドポイント実装
- [ ] 同意タイプバリデーション
  - [ ] 利用規約 (ToS)
  - [ ] プライバシーポリシー (PP)
  - [ ] マーケティング（オプション）
- [ ] Consents コレクション記録
- [ ] Users コレクション更新
  - [ ] `tosAccepted` フラグ
  - [ ] `ppAccepted` フラグ
  - [ ] `tosVersion`
  - [ ] `ppVersion`
- [ ] タイムスタンプ記録

#### 同意撤回API (`api/consent/revoke.ts`)
- [ ] エンドポイント実装
- [ ] 撤回タイプ処理
- [ ] カスタムクレーム設定
  - [ ] `forceLogout: true`
- [ ] セッション無効化
- [ ] 監査ログ記録
- [ ] データ削除リクエスト作成（該当する場合）

#### 同意状態確認API (`api/consent/status.ts`)
- [ ] 現在の同意状態取得
- [ ] 同意履歴取得
- [ ] 必要な再同意チェック

#### 同意バージョン管理
- [ ] 規約バージョン管理
- [ ] 変更履歴管理
- [ ] 自動再同意要求トリガー

### Firestore 実装

#### Consents コレクション設計
```typescript
interface ConsentRecord {
  userId: string;
  type: 'tos' | 'privacy' | 'marketing';
  version: string;
  accepted: boolean;
  timestamp: Timestamp;
  ipAddress?: string;
  userAgent?: string;
  method: 'explicit' | 'implicit';
  parentalConsent?: boolean;
}
```

#### セキュリティルール
- [ ] Consents コレクションは読み取りのみ
- [ ] 作成は Cloud Functions 経由のみ
- [ ] 不変性の保証（更新・削除不可）

### 強制ログアウト機能

#### クライアント側
- [ ] アプリ起動時のクレームチェック
- [ ] バックグラウンド復帰時のチェック
- [ ] forceLogout 検知時の処理
  - [ ] ローカルデータクリア
  - [ ] ログイン画面への遷移
  - [ ] 説明メッセージ表示

#### サーバー側
- [ ] IDトークン更新時のチェック
- [ ] API呼び出し時の検証
- [ ] 自動クレーム伝播

### GDPR準拠機能

#### 同意の記録
- [ ] 明示的同意の証跡
- [ ] タイムスタンプ
- [ ] IPアドレス（匿名化）
- [ ] 同意取得方法

#### データポータビリティ
- [ ] 同意履歴のエクスポート
- [ ] JSON/CSV形式
- [ ] 暗号化

#### 同意管理ダッシュボード（管理者用）
- [ ] ユーザー同意状態一覧
- [ ] 統計情報
- [ ] コンプライアンスレポート

### テスト実装

#### 単体テスト
- [ ] 同意記録ロジック
- [ ] 撤回処理
- [ ] バージョン比較

#### 統合テスト
- [ ] 同意フロー全体
- [ ] 強制ログアウト
- [ ] 再同意フロー

#### コンプライアンステスト
- [ ] GDPR要件チェック
- [ ] 監査ログ確認
- [ ] データ保護確認

## 受け入れ条件
- [ ] 初回ログイン時に同意画面が表示される
- [ ] 同意が正しく記録される
- [ ] 同意撤回で強制ログアウトされる
- [ ] 同意履歴が確認できる
- [ ] GDPR要件を満たす
- [ ] 監査証跡が残る

## 注意事項
- 同意は明示的でなければならない（デフォルトチェック禁止）
- 未成年者（13歳未満）の対応検討
- 同意文書のバージョン管理
- 法的要件の定期的な確認

## 参考リンク
- [GDPR同意要件](https://gdpr-info.eu/art-7-gdpr/)
- [Firebase Custom Claims](https://firebase.google.com/docs/auth/admin/custom-claims)
- [Flutter Legal Compliance](https://flutter.dev/docs/development/data-and-backend/state-mgmt/simple#legal)