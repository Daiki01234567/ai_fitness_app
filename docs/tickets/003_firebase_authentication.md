# Ticket #003: Firebase Authentication 設定

**Phase**: Phase 1 (インフラ構築)
**期間**: Week 1-2
**優先度**: 最高
**ステータス**: 基盤実装完了（95%）- プロバイダー設定待ち
**最終更新**: 2025-12-01
**関連仕様書**:
- `docs/specs/01_システムアーキテクチャ設計書_v3_2.md`
- `docs/specs/00_要件定義書_v3_3.md` (FR-001～FR-005)

## 概要
Firebase Authenticationの設定と認証フローの実装基盤を構築する。

## Todo リスト

### 認証プロバイダー設定
- [ ] メール/パスワード認証有効化
- [ ] 電話番号認証有効化（日本）
- [ ] Google OAuth 設定
  - [ ] OAuth同意画面設定
  - [ ] クライアントID/シークレット設定
- [ ] Apple Sign In 設定（iOS）
  - [ ] App ID 設定
  - [ ] サービスID設定

### カスタムクレーム設計
- [x] クレーム仕様定義
  - [x] `admin`: 管理者権限
  - [x] `forceLogout`: 強制ログアウト
  - [x] `deletionScheduled`: 削除予定フラグ
- [x] Cloud Functions でクレーム設定機能実装
- [x] クレーム検証ロジック実装

### アカウント設定
- [ ] パスワードポリシー設定
  - [ ] 最小8文字
  - [ ] 大文字・小文字・数字・記号を含む
- [ ] アカウントリカバリー設定
  - [ ] パスワードリセットメール
  - [ ] メールテンプレート（日本語）
- [ ] メール確認設定

### セッション管理
- [ ] リフレッシュトークン有効期限設定
- [ ] IDトークン有効期限設定
- [ ] マルチデバイス対応設定
- [ ] 強制ログアウト機能の実装準備

### Cloud Functions 統合
- [x] 新規ユーザー作成トリガー
  - [x] Users コレクションドキュメント作成
  - [x] デフォルト設定値の付与
- [x] アカウント削除トリガー
  - [x] 関連データのクリーンアップ
- [x] カスタムクレーム更新関数

### Flutter SDK 統合
- [x] FirebaseAuth インスタンス初期化
- [x] 認証状態リスナー実装
- [x] ログイン/ログアウトメソッド実装
- [x] トークン更新処理実装

### セキュリティ設定
- [ ] Authorized domains 設定
- [ ] reCAPTCHA 設定（Web）
- [ ] App Check 有効化
- [ ] 異常ログイン検知設定

### テスト
- [x] エミュレータでの認証テスト（ドキュメント作成済み）
- [ ] 各認証プロバイダーのテスト（実行待ち）
- [x] カスタムクレームのテスト（実装済み）
- [ ] セッション管理のテスト（実行待ち）

## 受け入れ条件
- [ ] 全ての認証プロバイダーが動作
- [ ] カスタムクレームが正しく設定・取得できる
- [ ] セキュリティ設定が完了
- [ ] エミュレータでのテストがパス

## 注意事項
- GDPR準拠（同意管理との連携）
- 日本市場向け（電話番号は+81対応）
- 将来の多要素認証対応を考慮

## 参考リンク
- [Firebase Authentication](https://firebase.google.com/docs/auth)
- [カスタムクレーム](https://firebase.google.com/docs/auth/admin/custom-claims)
- [FlutterFire Auth](https://firebase.flutter.dev/docs/auth/overview)
