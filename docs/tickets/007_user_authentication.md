# Ticket #007: ユーザー認証機能実装

**Phase**: Phase 2 (機能実装)
**期間**: Week 3-4
**優先度**: 最高
**関連仕様書**:
- `docs/specs/00_要件定義書_v3_3.md` (FR-001～FR-005)
- `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md`
- `docs/specs/03_API設計書_Firebase_Functions_v3_3.md`

## 概要
ユーザー認証機能（ログイン、新規登録、ログアウト）を実装する。

## Todo リスト

### Flutter側実装

#### 認証状態管理 (Riverpod)
- [ ] AuthNotifier クラス作成
- [ ] 認証状態の Provider 作成
- [ ] ユーザー情報の Provider 作成
- [ ] 自動ログイン機能
- [ ] トークンリフレッシュ処理

#### ログイン画面 (`screens/auth/login_screen.dart`)
- [ ] UI実装
  - [ ] メールアドレス入力フィールド
  - [ ] パスワード入力フィールド
  - [ ] ログインボタン
  - [ ] 新規登録へのリンク
  - [ ] パスワードリセットリンク
- [ ] バリデーション
  - [ ] メールフォーマットチェック
  - [ ] パスワード最小文字数チェック
- [ ] エラーハンドリング
  - [ ] 認証失敗メッセージ
  - [ ] ネットワークエラー
  - [ ] ローディング状態

#### 新規登録画面 (`screens/auth/register_screen.dart`)
- [ ] Step 1: 認証情報入力
  - [ ] メールアドレス
  - [ ] パスワード
  - [ ] パスワード確認
  - [ ] 電話番号（オプション）
- [ ] Step 2: プロフィール情報入力
  - [ ] 表示名
  - [ ] 生年月日
  - [ ] 性別
  - [ ] 身長・体重
  - [ ] フィットネス目標
- [ ] 利用規約同意チェックボックス
- [ ] プライバシーポリシー同意チェックボックス

#### パスワードリセット画面
- [ ] メールアドレス入力
- [ ] リセットメール送信
- [ ] 完了メッセージ表示

#### ソーシャルログイン
- [ ] Google Sign In 実装
  - [ ] ボタンUI
  - [ ] 認証フロー
  - [ ] エラーハンドリング
- [ ] Apple Sign In 実装（iOS）
  - [ ] ボタンUI
  - [ ] 認証フロー
  - [ ] エラーハンドリング

### Cloud Functions 実装

#### 新規登録API (`api/auth/register.ts`)
- [ ] エンドポイント実装
- [ ] 入力バリデーション
- [ ] Firebase Auth ユーザー作成
- [ ] Users コレクションドキュメント作成
- [ ] 初期同意状態の記録
- [ ] ウェルカムメール送信（オプション）

#### プロフィール更新API (`api/users/updateProfile.ts`)
- [ ] エンドポイント実装
- [ ] 認証チェック
- [ ] 入力バリデーション
- [ ] Firestore更新
- [ ] 監査ログ記録

#### カスタムクレーム設定
- [ ] 新規ユーザーのデフォルトクレーム
- [ ] 管理者クレーム設定機能
- [ ] forceLogout クレーム管理

### Firestore 実装

#### Users コレクション
- [ ] ドキュメント作成時の初期値設定
- [ ] フィールドバリデーション
- [ ] タイムスタンプ自動設定
- [ ] インデックス作成

#### Consents コレクション
- [ ] 初回同意記録
- [ ] 同意履歴の保存
- [ ] 不変性の保証

### テスト実装

#### 単体テスト
- [ ] AuthNotifier のテスト
- [ ] バリデーションロジックのテスト
- [ ] Cloud Functions のテスト

#### 統合テスト
- [ ] ログインフロー
- [ ] 新規登録フロー
- [ ] パスワードリセットフロー
- [ ] ソーシャルログインフロー

#### E2Eテスト
- [ ] 完全な認証フロー
- [ ] エラーケース
- [ ] セッション管理

### セキュリティ対策
- [ ] パスワード強度チェック
- [ ] ブルートフォース対策
- [ ] セッションハイジャック対策
- [ ] XSS対策
- [ ] CSRF対策

## 受け入れ条件
- [ ] ユーザーが新規登録できる
- [ ] ユーザーがログインできる
- [ ] ユーザーがログアウトできる
- [ ] パスワードリセットが機能する
- [ ] ソーシャルログインが機能する
- [ ] エラーが適切にハンドリングされる
- [ ] セキュリティ対策が実装されている

## 注意事項
- GDPR準拠（同意取得必須）
- 日本語のエラーメッセージ
- アクセシビリティ考慮（最小タップ領域48dp）
- レスポンシブデザイン

## 参考リンク
- [Firebase Auth Flutter](https://firebase.flutter.dev/docs/auth/usage)
- [Riverpod](https://riverpod.dev/)
- [Google Sign In Flutter](https://pub.dev/packages/google_sign_in)