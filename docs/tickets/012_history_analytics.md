# Ticket #012: 履歴・分析機能実装

**Phase**: Phase 2 (機能実装)
**期間**: Week 7-8
**優先度**: 高
**関連仕様書**:
- `docs/specs/00_要件定義書_v3_3.md` (FR-028～FR-030)
- `docs/specs/04_BigQuery設計書_v3_3.md`
- `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md`

## 概要
トレーニング履歴の表示、進捗トラッキング、パフォーマンス分析機能を実装する。

## Todo リスト

### 履歴画面

#### HistoryScreen (`screens/history/history_screen.dart`)
- [ ] カレンダービュー
  - [ ] 月表示
  - [ ] トレーニング実施日マーク
  - [ ] 強度による色分け
  - [ ] 日付タップで詳細表示
- [ ] リストビュー
  - [ ] 無限スクロール
  - [ ] 日付グルーピング
  - [ ] サムネイル表示
  - [ ] クイック統計
- [ ] フィルタリング
  - [ ] 期間選択
  - [ ] 種目フィルタ
  - [ ] スコアレンジ
  - [ ] タグ検索

#### SessionDetailScreen (`screens/history/session_detail_screen.dart`)
- [ ] セッション情報
  - [ ] 日時・時間
  - [ ] 実施種目リスト
  - [ ] 総レップ数/セット数
  - [ ] 平均フォームスコア
- [ ] 種目別詳細
  - [ ] セット毎の結果
  - [ ] フォームスコア推移
  - [ ] 問題点リスト
  - [ ] ベスト/ワーストレップ
- [ ] メモ機能
  - [ ] テキストメモ追加
  - [ ] タグ付け
  - [ ] 体調記録
  - [ ] 編集/削除
- [ ] エクスポート
  - [ ] PDF生成
  - [ ] CSV出力
  - [ ] 画像保存

### 分析画面

#### AnalyticsScreen (`screens/analytics/analytics_screen.dart`)
- [ ] 概要ダッシュボード
  - [ ] 今週の実績
  - [ ] 月間トレンド
  - [ ] 目標達成率
  - [ ] ストリーク表示
- [ ] 期間選択
  - [ ] 週/月/3ヶ月/年
  - [ ] カスタム期間
  - [ ] 比較期間設定

#### ProgressCharts (`widgets/analytics/progress_charts.dart`)
- [ ] トレーニング頻度
  - [ ] 週間ヒートマップ
  - [ ] 月間カレンダー
  - [ ] 時間帯分析
- [ ] ボリューム推移
  - [ ] 総レップ数グラフ
  - [ ] セット数グラフ
  - [ ] 運動時間グラフ
- [ ] フォームスコア推移
  - [ ] 種目別ライングラフ
  - [ ] 移動平均表示
  - [ ] 標準偏差バンド
- [ ] パーソナルレコード
  - [ ] 種目別ベストスコア
  - [ ] 最長ストリーク
  - [ ] 最多レップ数

#### ComparativeAnalysis (`widgets/analytics/comparative_analysis.dart`)
- [ ] 期間比較
  - [ ] 前週/前月比較
  - [ ] YoY比較
  - [ ] カスタム期間比較
- [ ] 種目間比較
  - [ ] レーダーチャート
  - [ ] 強み/弱み分析
  - [ ] バランススコア
- [ ] ベンチマーク比較
  - [ ] 年齢グループ平均
  - [ ] フィットネスレベル別
  - [ ] 目標との差異

### 詳細分析

#### FormAnalysisView (`widgets/analytics/form_analysis_view.dart`)
- [ ] フォーム改善トレンド
  - [ ] 各評価項目の推移
  - [ ] 改善速度分析
  - [ ] プラトー検出
- [ ] エラーパターン分析
  - [ ] よくある間違いTop5
  - [ ] 時間帯別傾向
  - [ ] 疲労による劣化分析
- [ ] 相関分析
  - [ ] レップ数とフォームの関係
  - [ ] 速度とフォームの関係
  - [ ] セット間の劣化

#### RecommendationEngine (`services/recommendation_engine.dart`)
- [ ] トレーニング推奨
  - [ ] 次回メニュー提案
  - [ ] 負荷調整アドバイス
  - [ ] 休息日提案
- [ ] フォーム改善提案
  - [ ] 重点改善ポイント
  - [ ] 補助エクササイズ
  - [ ] ストレッチ推奨
- [ ] 目標設定支援
  - [ ] 現実的な目標提案
  - [ ] マイルストーン設定
  - [ ] 達成予測

### データ同期

#### HistorySyncService (`services/history_sync_service.dart`)
- [ ] ローカルキャッシュ
  - [ ] SQLite実装
  - [ ] 最近30日分保持
  - [ ] オフライン対応
- [ ] Firestore同期
  - [ ] バックグラウンド同期
  - [ ] 競合解決
  - [ ] 差分同期
- [ ] BigQuery連携
  - [ ] 日次バッチ準備
  - [ ] 集計データ取得
  - [ ] 分析結果キャッシュ

### レポート生成

#### ReportGenerator (`services/report_generator.dart`)
- [ ] 週次レポート
  - [ ] 実績サマリ
  - [ ] 改善ポイント
  - [ ] 翌週目標
- [ ] 月次レポート
  - [ ] 詳細分析
  - [ ] 進捗評価
  - [ ] トレンド分析
- [ ] カスタムレポート
  - [ ] テンプレート選択
  - [ ] 項目カスタマイズ
  - [ ] PDF/HTML出力

### ウィジェット

#### StatsCard (`widgets/stats_card.dart`)
- [ ] 数値表示
- [ ] トレンド矢印
- [ ] ミニグラフ
- [ ] タップで詳細

#### ProgressBar (`widgets/progress_bar.dart`)
- [ ] 目標達成率
- [ ] アニメーション
- [ ] カラーコーディング

#### AchievementBadge (`widgets/achievement_badge.dart`)
- [ ] バッジアイコン
- [ ] 獲得条件表示
- [ ] シェア機能

### 実績システム

#### AchievementManager (`services/achievement_manager.dart`)
- [ ] バッジ定義
  - [ ] 初心者（初回完了）
  - [ ] 継続者（7日連続）
  - [ ] マスター（全種目90点以上）
- [ ] 実績チェック
  - [ ] セッション完了時
  - [ ] 日次/週次集計時
- [ ] 通知
  - [ ] 獲得時ポップアップ
  - [ ] プッシュ通知

### テスト実装

#### 単体テスト
- [ ] 統計計算ロジック
- [ ] フィルタリング処理
- [ ] データ集計処理

#### 統合テスト
- [ ] データ同期フロー
- [ ] レポート生成
- [ ] キャッシュ動作

#### UIテスト
- [ ] グラフ描画
- [ ] スクロールパフォーマンス
- [ ] レスポンシブ対応

## 受け入れ条件
- [ ] 履歴が正しく表示される
- [ ] グラフがスムーズに描画される
- [ ] フィルタリングが高速に動作
- [ ] オフラインでも基本機能が使える
- [ ] レポートが正しく生成される

## 注意事項
- 大量データでのパフォーマンス考慮
- グラフライブラリの選定（fl_chart推奨）
- データプライバシー（共有時の配慮）
- アクセシビリティ（グラフの代替テキスト）

## 参考リンク
- [fl_chart](https://pub.dev/packages/fl_chart)
- [SQLite Flutter](https://pub.dev/packages/sqflite)
- [PDF Generation](https://pub.dev/packages/pdf)