# Ticket #021: UI バグ修正・仕様漏れ対応 (Phase 1-2)

**Phase**: Phase 1-2 (インフラ構築・機能実装)
**期間**: Week 5-6
**優先度**: 高
**ステータス**: 未着手
**関連仕様書**:
- `docs/specs/00_要件定義書_v3_3.md` (FR-001～FR-038)
- `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md`
- `docs/specs/02_Firestoreデータベース設計書_v3_3.md`
- `docs/specs/03_API設計書_Firebase_Functions_v3_3.md`

## 概要
UIテスト結果に基づき、バグ修正と仕様漏れ機能を実装する。Phase 1（インフラ構築）とPhase 2（機能実装）の範囲で、優先度の高い問題から対応する。

---

## タスク詳細

### 1. 規約同意画面のチラつき修正

**判定**: バグ
**Phase**: Phase 1
**優先度**: 高
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.2 利用規約・プライバシーポリシー同意画面)

#### 問題点
- 新規登録後、利用規約同意画面が一瞬表示されてからホーム画面に遷移する
- ユーザー体験を損なう不要な画面表示

#### 原因
- 新規登録完了時に `tosAccepted: true`, `ppAccepted: true` でFirestoreに保存しているが、GoRouterの認証リスナーが状態変更を検知して同意画面へリダイレクトしている
- その後、Firestoreから最新の同意状態を取得してホーム画面へ再リダイレクト

#### 対応方法
1. **即座状態更新**: 新規登録完了時に、Riverpodの認証状態に同意フラグを即座に反映
2. **リダイレクトロジック修正**: GoRouterの `redirect` 関数で、同意状態のチェックを最適化
3. **オプション対応**: 同意画面へのリダイレクト前に、ローカル状態の同意フラグを確認

#### 影響ファイル
- `flutter_app/lib/core/router/app_router.dart` (GoRouter redirect)
- `flutter_app/lib/core/auth/auth_state_notifier.dart` (認証状態管理)
- `flutter_app/lib/screens/auth/register_screen.dart` (登録完了時の処理)

#### 完了条件
- [ ] 新規登録後、同意画面が一瞬も表示されず、直接ホーム画面へ遷移する
- [ ] 既存の認証フローに影響がない

---

### 2. スプラッシュ画面・オンボーディング画面の実装

**判定**: 仕様漏れ
**Phase**: Phase 1
**優先度**: 高
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.1 スプラッシュ画面, 3.15 オンボーディング画面)

#### 問題点
- スプラッシュ画面は実装済みだが、機能が不完全（Firebase初期化完了後即座に遷移）
- オンボーディング画面が未実装

#### 仕様要件

##### スプラッシュ画面 (3.1)
- アプリロゴとローディングインジケーターを表示
- Firebase初期化完了を待機
- 最低表示時間: 1秒（ブランディング目的）
- 初回起動時 → オンボーディング画面へ
- 2回目以降 → 認証状態に応じて分岐

##### オンボーディング画面 (3.15)
- 3ページのスワイプ式チュートリアル
- **ページ1**: アプリの概要（AIフォーム評価機能）
- **ページ2**: 主要機能紹介（5種目対応、リアルタイムフィードバック）
- **ページ3**: プライバシー保護（オンデバイス処理）
- 各ページに「スキップ」ボタン
- 最終ページに「始める」ボタン
- 初回表示フラグを `SharedPreferences` に保存

#### 対応方法
1. **スプラッシュ画面の改善**:
   - 最低表示時間のロジック追加
   - 初回起動判定の実装
   - `SharedPreferences` を使用した初回フラグ管理

2. **オンボーディング画面の実装**:
   - 3ページのスワイプUI（`PageView` ウィジェット使用）
   - インジケーター表示（現在のページ番号）
   - スキップ/始めるボタンの実装
   - イラスト・アイコンの配置

3. **画面遷移フローの修正**:
   ```
   スプラッシュ画面
   ├─ 初回起動 → オンボーディング画面 → ログイン画面
   └─ 2回目以降
      ├─ 未認証 → ログイン画面
      ├─ 認証済・同意なし → 同意画面
      └─ 認証済・同意済 → ホーム画面
   ```

#### 影響ファイル
- `flutter_app/lib/screens/splash/splash_screen.dart` (既存の改善)
- `flutter_app/lib/screens/onboarding/onboarding_screen.dart` (新規作成)
- `flutter_app/lib/core/router/app_router.dart` (ルーティング追加)
- `flutter_app/lib/core/utils/preferences_helper.dart` (新規作成: SharedPreferences管理)

#### 完了条件
- [ ] 初回起動時にオンボーディング画面が表示される
- [ ] オンボーディングをスキップまたは完了すると、二度と表示されない
- [ ] スプラッシュ画面が最低1秒表示される
- [ ] オンボーディング画面の3ページがスムーズにスワイプできる
- [ ] 「スキップ」「始める」ボタンが正しく動作する

---

### 3. メールアドレス重複チェックの実装

**判定**: 仕様漏れ
**Phase**: Phase 1
**優先度**: 高
**関連仕様書**: `docs/specs/00_要件定義書_v3_3.md` (FR-002), `docs/specs/03_API設計書_Firebase_Functions_v3_3.md`

#### 問題点
- 新規登録画面でメールアドレス入力時、既存ユーザーとの重複チェックが未実装
- Firebase Authのエラーが登録ボタン押下後にしか表示されない

#### 仕様要件
- メールアドレス入力フィールドからフォーカスが外れた時点で重複チェック
- 既に登録されている場合は「このメールアドレスは既に登録されています」とエラー表示
- リアルタイムバリデーションでUX向上

#### 対応方法
1. **Cloud Function実装**: `checkEmailExists` callable関数を作成
   - 入力: `{ email: string }`
   - 出力: `{ exists: boolean }`
   - Firebase Authの `getUserByEmail()` を使用
   - レート制限: 同一IPから1分間に10回まで

2. **Flutter側実装**:
   - メールアドレスフィールドの `onEditingComplete` コールバックで重複チェック
   - ローディング表示とエラーメッセージの実装
   - デバウンス処理（500ms待機後にAPI呼び出し）

#### 影響ファイル
- `functions/src/api/auth/checkEmailExists.ts` (新規作成)
- `functions/src/index.ts` (エンドポイント追加)
- `flutter_app/lib/screens/auth/register_screen.dart` (重複チェック呼び出し)
- `flutter_app/lib/core/utils/validators.dart` (メールバリデーション拡張)

#### 完了条件
- [ ] メールアドレス入力後、フォーカスを外すと自動的に重複チェックが実行される
- [ ] 重複している場合、エラーメッセージが表示される
- [ ] ローディング中は登録ボタンが無効化される
- [ ] レート制限が正しく機能する

---

### 4. ホーム画面の不足要素実装

**判定**: 仕様漏れ
**Phase**: Phase 2
**優先度**: 高
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.5 ホーム画面)

#### 問題点
現在のホーム画面は基本的なレイアウトのみで、以下の要素が未実装:
1. 今日のトレーニング回数表示（無料プラン: 残り回数、有料プラン: 無制限）
2. 最近のセッション表示（直近3件）
3. 今週の統計（週間セッション数、平均スコア）
4. 「トレーニングを始める」大きなボタン
5. クイックアクセス: 種目選択ショートカット

#### 仕様要件（3.5 ホーム画面より）

##### レイアウト構成
```
┌─────────────────────────────┐
│ おはようございます、[名前]さん│
│                             │
│  今日のトレーニング          │
│  ━━━━━━━━━━━━━━━━━━      │
│  残り 2回 / 3回（無料）      │
│  ━━━━━━━━━━━━━━━━━━      │
│                             │
│  ┌─────────────────────┐   │
│  │ 🏋️ トレーニングを    │   │
│  │    始める             │   │
│  └─────────────────────┘   │
│                             │
│  最近のセッション            │
│  ━━━━━━━━━━━━━━━━━━      │
│  [セッションカード × 3]      │
│                             │
│  今週の統計                 │
│  ━━━━━━━━━━━━━━━━━━      │
│  セッション数: 5回           │
│  平均スコア: 82点            │
│  ━━━━━━━━━━━━━━━━━━      │
└─────────────────────────────┘
```

#### 対応方法
1. **今日の利用状況**:
   - Firestore `sessions` コレクションから今日のセッション数をカウント
   - サブスクリプション状態を `users.subscriptionStatus` から取得
   - 無料プランの場合: `3 - todaySessionCount` を表示
   - 有料プランの場合: 「無制限」と表示

2. **最近のセッション**:
   - Firestore クエリ: `where('userId', '==', uid).orderBy('startTime', 'desc').limit(3)`
   - セッションカードコンポーネントの作成（種目アイコン、スコア、日時を表示）
   - タップでセッション詳細画面へ遷移

3. **今週の統計**:
   - 今週のセッションを集計（月曜日～日曜日）
   - 平均スコアを計算（全セッションの `score` フィールドの平均）

4. **トレーニング開始ボタン**:
   - メニュー選択画面（種目選択）への遷移
   - 無料プランで回数上限に達している場合は、課金画面へ誘導

5. **状態管理**:
   - Riverpod Provider で各データを管理
   - リアルタイムリスナーでデータ更新を監視

#### 影響ファイル
- `flutter_app/lib/screens/home/home_screen.dart` (大幅な拡張)
- `flutter_app/lib/core/providers/session_provider.dart` (新規作成: セッションデータ管理)
- `flutter_app/lib/core/providers/subscription_provider.dart` (新規作成: サブスク状態管理)
- `flutter_app/lib/core/widgets/session_card.dart` (新規作成: セッションカード)
- `flutter_app/lib/core/widgets/stats_card.dart` (新規作成: 統計カード)

#### 完了条件
- [ ] 今日の利用状況が正しく表示される（無料/有料プラン対応）
- [ ] 最近のセッション3件が表示される（なければ空状態を表示）
- [ ] 今週の統計が正しく計算・表示される
- [ ] トレーニング開始ボタンが正しく動作する
- [ ] 無料プラン上限時に課金画面への誘導が表示される

---

### 5. メニュー選択画面の検索・フィルタ機能

**判定**: 仕様漏れ
**Phase**: Phase 2
**優先度**: 中
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.6 メニュー選択画面)

#### 問題点
- メニュー選択画面が未実装
- 5種目の選択UIが必要

#### 仕様要件（3.6 メニュー選択画面より）

##### 表示内容
- 5種目のカード一覧（スクワット、アームカール、サイドレイズ、ショルダープレス、プッシュアップ）
- 各カードに種目アイコン、名前、簡単な説明
- タップでカメラ設定画面へ遷移

##### 検索・フィルタ（将来対応）
- 検索バーは表示するが、Phase 2では機能無効
- フィルタ機能もPhase 3で実装予定（現在は5種目のみのため不要）

#### 対応方法
1. **メニュー選択画面の実装**:
   - `GridView` で2列のカードレイアウト
   - 各種目のカードコンポーネント作成
   - 種目データを `enum` で定義

2. **種目データ構造**:
   ```dart
   enum ExerciseType {
     squat,      // スクワット
     armCurl,    // アームカール
     sideRaise,  // サイドレイズ
     shoulderPress, // ショルダープレス
     pushUp,     // プッシュアップ
   }
   ```

3. **検索バーのプレースホルダー**:
   - UI上は表示するが、`enabled: false` で無効化
   - ツールチップで「Phase 3で対応予定」と表示

#### 影響ファイル
- `flutter_app/lib/screens/training/menu_selection_screen.dart` (新規作成)
- `flutter_app/lib/core/models/exercise_type.dart` (新規作成: 種目定義)
- `flutter_app/lib/core/widgets/exercise_card.dart` (新規作成: 種目カード)
- `flutter_app/lib/core/router/app_router.dart` (ルーティング追加)

#### 完了条件
- [ ] 5種目が2列のグリッドで表示される
- [ ] 各カードをタップすると、カメラ設定画面へ遷移する
- [ ] 検索バーが無効状態で表示される（将来対応の表示）

---

### 6. カメラ設定画面のエラーハンドリング

**判定**: 仕様漏れ
**Phase**: Phase 2
**優先度**: 高
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.7 カメラ設定画面), `docs/specs/00_要件定義書_v3_3.md` (NFR-032)

#### 問題点
- カメラ設定画面が未実装
- カメラ権限エラー、カメラ未対応デバイスへの対応が必要

#### 仕様要件

##### カメラ設定画面 (3.7)
- カメラプレビュー表示
- フロント/バックカメラ切替
- 「開始」ボタン（3秒カウントダウン後にトレーニング開始）

##### エラーハンドリング（NFR-032より）
- **カメラ権限拒否**: ダイアログでアプリ設定画面への誘導
- **カメラ未対応**: エラーメッセージ表示と前画面への戻るボタン
- **カメラ初期化失敗**: 再試行ボタンとサポート連絡先の表示

#### 対応方法
1. **カメラ権限チェック**:
   - `permission_handler` パッケージを使用
   - 画面表示時に権限確認、未許可の場合は権限リクエスト
   - 拒否された場合のダイアログ表示

2. **カメラ初期化エラー**:
   - `camera` パッケージの例外ハンドリング
   - 再試行メカニズムの実装
   - エラー時のフォールバックUI

3. **デバイス互換性チェック**:
   - カメラ一覧を取得、利用可能なカメラがない場合はエラー表示

#### 影響ファイル
- `flutter_app/lib/screens/training/camera_setup_screen.dart` (新規作成)
- `flutter_app/lib/core/services/camera_service.dart` (新規作成: カメラ制御)
- `flutter_app/lib/core/utils/permission_helper.dart` (新規作成: 権限管理)
- `flutter_app/pubspec.yaml` (依存関係追加: `camera`, `permission_handler`)

#### 完了条件
- [ ] カメラプレビューが正しく表示される
- [ ] カメラ権限が拒否された場合、適切なダイアログが表示される
- [ ] カメラ初期化に失敗した場合、再試行ボタンが表示される
- [ ] カメラ未対応デバイスで、エラーメッセージと戻るボタンが表示される
- [ ] フロント/バックカメラの切替が正しく動作する

---

### 7. 履歴画面の月カレンダーUI実装

**判定**: 仕様詳細不足
**Phase**: Phase 2
**優先度**: 中
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.11 履歴画面 - 月タブカレンダーUI)

#### 問題点
- 履歴画面が未実装
- 月タブ選択時のカレンダーUIの詳細仕様が不足していた（本チケット作成と同時に仕様書に追記済み）

#### 仕様要件
- `table_calendar` パッケージを使用したカレンダー表示
- セッションがある日にマーカー表示
- 日付タップで該当日のセッション一覧を表示
- 種目フィルタとの連携

#### 対応方法
1. **履歴画面の基本実装**:
   - タブ構造（概要/日/週/月）の実装
   - 種目フィルタのドロップダウン

2. **月タブのカレンダー実装**:
   - `table_calendar: ^3.0.0` パッケージ導入
   - マーカー表示ロジックの実装
   - 日付選択時のセッション一覧表示
   - 月選択ナビゲーション（前月/次月）

3. **データ取得とキャッシュ**:
   - Firestore クエリで選択月のセッションを取得
   - 月ごとにキャッシュして無駄なクエリを削減
   - Riverpodでデータ管理

4. **パフォーマンス最適化**:
   - 遅延読み込み（セッション一覧）
   - カレンダーの最適化設定

#### 影響ファイル
- `flutter_app/lib/screens/history/history_screen.dart` (新規作成)
- `flutter_app/lib/screens/history/widgets/calendar_tab.dart` (新規作成: 月タブ)
- `flutter_app/lib/core/providers/history_provider.dart` (新規作成: 履歴データ管理)
- `flutter_app/pubspec.yaml` (依存関係追加: `table_calendar`, `intl`)

#### 完了条件
- [ ] 月タブでカレンダーが正しく表示される
- [ ] セッションがある日にマーカーが表示される
- [ ] 日付をタップすると、該当日のセッション一覧が下部に表示される
- [ ] 前月/次月ナビゲーションが正しく動作する
- [ ] 種目フィルタでマーカーとセッション一覧がフィルタされる
- [ ] カレンダーが日本語で表示される（曜日、月名）

---

### 8. ログアウト機能・同意解除機能の実装

**判定**: 仕様漏れ
**Phase**: Phase 1
**優先度**: 高
**関連仕様書**: `docs/specs/05_画面遷移図_ワイヤーフレーム_v3_3.md` (3.13 設定画面, 3.12 プロフィール画面)

#### 問題点
- ログアウト機能が未実装
- 同意解除機能が未実装
- 設定画面が未実装

#### 仕様要件

##### ログアウト（3.13 設定画面より）
- 設定画面に「ログアウト」ボタンを配置
- タップで確認ダイアログ表示
- ログアウト実行後、ログイン画面へ遷移

##### 同意解除（3.12 プロフィール画面より）
- プロフィール画面に利用規約・プライバシーポリシーの同意状況を表示
- 「同意を解除」リンクをタップで確認ダイアログ表示
- 確認ダイアログ:
  - 「同意を解除すると、サービスを利用できなくなります。」
  - 「この操作を行うと、自動的にログアウトされます。」
  - [キャンセル] [同意を解除してログアウト] ボタン
- 同意解除処理:
  1. `users.tosAccepted = false`
  2. `users.ppAccepted = false`
  3. `users.tosAcceptedAt = null`
  4. `users.ppAcceptedAt = null`
  5. 強制ログアウト
  6. ログイン画面へ遷移

#### 対応方法

##### ログアウト機能
1. **設定画面の実装**:
   - トレーニング設定（音声フィードバック）
   - 通知設定（リマインダー、お知らせ）
   - アカウント設定（サブスク管理、利用規約、PP、お問い合わせ、ログアウト、アカウント削除）
   - アプリ情報（バージョン）

2. **ログアウト処理**:
   - Firebase Authの `signOut()` を呼び出し
   - Riverpodの認証状態をクリア
   - ローカルキャッシュのクリア（オプション）
   - ログイン画面へリダイレクト

##### 同意解除機能
1. **プロフィール画面の拡張**:
   - 同意状況セクションの追加
   - 利用規約・プライバシーポリシーへのリンク
   - 同意日時の表示
   - 「同意を解除」リンク

2. **同意解除API実装** (`functions/src/api/users/revokeConsent.ts`):
   - 認証チェック
   - Firestore `users` ドキュメントの更新
   - `Consents` コレクションに解除記録
   - `forceLogout` カスタムクレームの設定

3. **確認ダイアログとログアウト処理**:
   - 確認ダイアログの実装
   - API呼び出しとログアウトの連携

#### 影響ファイル
- `flutter_app/lib/screens/settings/settings_screen.dart` (新規作成)
- `flutter_app/lib/screens/profile/profile_screen.dart` (未実装の場合は新規作成)
- `flutter_app/lib/core/auth/auth_service.dart` (ログアウト処理追加)
- `functions/src/api/users/revokeConsent.ts` (新規作成)
- `functions/src/index.ts` (エンドポイント追加)
- `flutter_app/lib/core/router/app_router.dart` (ログアウト後のリダイレクト)

#### 完了条件
- [ ] 設定画面が正しく表示される
- [ ] ログアウトボタンをタップすると、確認ダイアログが表示される
- [ ] ログアウト実行後、ログイン画面へ遷移する
- [ ] プロフィール画面に同意状況セクションが表示される
- [ ] 「同意を解除」リンクをタップすると、確認ダイアログが表示される
- [ ] 同意解除実行後、Firestoreが正しく更新される
- [ ] 同意解除後、自動的にログアウトされる
- [ ] 同意解除の記録が `Consents` コレクションに保存される

---

## 実装優先順位

### 高優先度（Phase 1: Week 5）
1. **規約同意画面のチラつき修正**（バグ）
2. **スプラッシュ・オンボーディング実装**（仕様漏れ）
3. **メールアドレス重複チェック**（仕様漏れ）
4. **ログアウト・同意解除機能**（仕様漏れ）

### 高優先度（Phase 2: Week 6）
5. **ホーム画面の不足要素実装**（仕様漏れ）
6. **カメラ設定のエラーハンドリング**（仕様漏れ）

### 中優先度（Phase 2: Week 7）
7. **履歴画面の月カレンダー**（仕様詳細不足）
8. **メニュー選択画面の検索・フィルタ**（仕様漏れ、ただし検索は無効化）

---

## テスト計画

### 単体テスト
- [ ] 認証状態管理のテスト（同意フラグの即座反映）
- [ ] バリデーションロジックのテスト（メール重複チェック）
- [ ] 統計計算のテスト（今週のセッション数、平均スコア）

### ウィジェットテスト
- [ ] スプラッシュ画面の遷移テスト
- [ ] オンボーディング画面のスワイプテスト
- [ ] ログアウト確認ダイアログのテスト
- [ ] 同意解除確認ダイアログのテスト

### 統合テスト
- [ ] 新規登録からホーム画面までのフロー（チラつきなし）
- [ ] ログアウトからログインまでのフロー
- [ ] 同意解除からログアウトまでのフロー
- [ ] カメラ権限エラーハンドリング

### 手動テスト
- [ ] 初回起動時のオンボーディング表示確認
- [ ] 2回目起動時のスキップ確認
- [ ] カメラ未対応デバイスでのエラー表示確認
- [ ] 無料プラン上限時の課金誘導確認

---

## セキュリティ考慮事項

### メール重複チェックAPI
- **レート制限**: 同一IPから1分間に10回まで
- **認証不要**: ログイン前の機能のため、公開エンドポイント
- **データ漏洩防止**: メールアドレスの存在のみを返す（ユーザー情報は返さない）

### 同意解除API
- **認証必須**: `context.auth.uid` で本人確認
- **監査ログ**: `Consents` コレクションに解除記録を残す
- **強制ログアウト**: `forceLogout` カスタムクレームを設定

---

## 関連チケット
- Ticket #007: ユーザー認証機能実装（完了）
- Ticket #012: 履歴・分析画面（本チケットで一部対応）

---

## 参考リンク
- [Flutter Camera Plugin](https://pub.dev/packages/camera)
- [Permission Handler](https://pub.dev/packages/permission_handler)
- [Table Calendar](https://pub.dev/packages/table_calendar)
- [Shared Preferences](https://pub.dev/packages/shared_preferences)
- [Firebase Auth - Check if email exists](https://firebase.google.com/docs/auth/admin/manage-users)
