# ユーザー認証機能テストガイド

**バージョン**: 1.0.0
**最終更新日**: 2025-11-26
**対象チケット**: #007 ユーザー認証機能実装

---

## 目次

1. [テストの概要](#1-テストの概要)
2. [テスト実行前の準備](#2-テスト実行前の準備)
3. [AuthNotifier テスト](#3-authnotifier-テスト)
4. [バリデーションテスト](#4-バリデーションテスト)
5. [Cloud Functions テスト](#5-cloud-functions-テスト)
6. [統合テストシナリオ](#6-統合テストシナリオ)
7. [テストチェックリスト](#7-テストチェックリスト)
8. [トラブルシューティング](#8-トラブルシューティング)
9. [参考資料](#9-参考資料)
10. [用語集](#10-用語集)

---

## 1. テストの概要

### 📋 このドキュメントの目的

このドキュメントは、AI Fitness アプリのユーザー認証機能が正しく動作することを確認するためのテスト手順書です。

### 🎯 なぜこのテストが必要か

認証機能は、アプリのセキュリティとユーザー体験の基盤です。以下の理由から、徹底したテストが必要です：

| 理由 | 説明 |
|------|------|
| **セキュリティ** | 不正アクセスを防ぐため |
| **ユーザー体験** | スムーズなログイン・登録体験を保証するため |
| **データ保護** | GDPR準拠のデータ管理を確認するため |
| **品質保証** | 本番リリース前に問題を発見するため |

### 👥 想定読者

- プロジェクトマネージャー
- QAテスター
- ステークホルダー
- 開発者（レビュー用）

### ⏱ 所要時間の目安

| テストカテゴリ | 所要時間 |
|---------------|---------|
| AuthNotifier テスト | 約30分 |
| バリデーションテスト | 約20分 |
| Cloud Functions テスト | 約40分 |
| 統合テスト | 約30分 |
| **合計** | **約2時間** |

---

## 2. テスト実行前の準備

### 2.1 必要なツール・ソフトウェア

以下がインストールされていることを確認してください：

| ツール | 確認方法 | 備考 |
|--------|----------|------|
| Node.js | `node --version` | v18以上 |
| Flutter | `flutter --version` | 3.10以上 |
| Firebase CLI | `firebase --version` | 最新版推奨 |
| Chrome ブラウザ | - | エミュレータUI表示用 |

### 2.2 環境セットアップ

#### Step 1: プロジェクトディレクトリに移動

```bash
cd C:\Users\katos\Desktop\ai_fitness_app
```

#### Step 2: 依存関係のインストール

**Flutter アプリ:**
```bash
cd flutter_app
flutter pub get
```

**Cloud Functions:**
```bash
cd ../functions
npm install
```

#### Step 3: Firebaseエミュレータの起動

プロジェクトルートに戻り、以下を実行：

```bash
cd ..
firebase emulators:start
```

**✅ 正常起動の確認:**
以下のメッセージが表示されればOKです：
```
┌─────────────────────────────────────────────────────────────┐
│ ✔  All emulators ready! It is now safe to connect your app. │
└─────────────────────────────────────────────────────────────┘
```

**エミュレータUI へのアクセス:**
ブラウザで以下を開きます：
- **http://localhost:4000** （メインUI）
- **http://localhost:4000/auth** （認証）
- **http://localhost:4000/firestore** （データベース）

#### Step 4: Flutter アプリの起動

別のターミナルを開いて：

```bash
cd flutter_app
flutter run -d chrome
```

> 💡 **ヒント**: `-d chrome` はWebブラウザで実行します。実機やエミュレータでテストする場合は、`flutter run` のみで実行できます。

### 2.3 事前確認チェックリスト

テスト開始前に以下を確認してください：

- [ ] Firebaseエミュレータが起動している（ポート4000でアクセス可能）
- [ ] エミュレータUIでAuthentication, Firestoreタブが表示される
- [ ] Flutterアプリがエラーなく起動する
- [ ] ログイン画面が表示される

---

## 3. AuthNotifier テスト

### 3.1 AuthNotifier とは？

**AuthNotifier** は、アプリ内でユーザーの「ログイン状態」を管理するコンポーネントです。

**わかりやすく例えると：**
ホテルのフロントデスクのようなものです。お客様（ユーザー）がチェックイン（ログイン）しているか、チェックアウト（ログアウト）しているかを常に把握し、その状態に応じてサービスを提供します。

**このコンポーネントが行うこと：**
- ユーザーがログインしているか確認
- ログイン・ログアウト処理の実行
- ログイン状態の変化を画面に通知
- セッションの自動更新

### 3.2 テスト項目

---

### テスト項目 3.2.1：メール/パスワードでログイン（正常系）

**目的**：有効なメールアドレスとパスワードでログインできることを確認

**前提条件**：
- テスト用ユーザーが存在する（存在しない場合は先に新規登録テストを実施）
- ログアウト状態である

**テスト手順**：

1. ログイン画面を開く
2. メールアドレス入力欄に `test@example.com` を入力
3. パスワード入力欄に `Test1234` を入力
4. 「ログイン」ボタンをタップ

**期待される結果**：
- ✅ ローディングインジケーターが表示される
- ✅ ホーム画面に遷移する
- ✅ エラーメッセージは表示されない

**確認方法**：

| 確認場所 | 確認内容 |
|----------|----------|
| アプリUI | ホーム画面が表示されている |
| エミュレータUI（Auth） | ユーザーの「Last sign-in」が更新されている |
| エミュレータUI（Firestore） | `users/{userId}` の `updatedAt` が更新されている |

**失敗時の対処**：

| 症状 | 考えられる原因 | 対処方法 |
|------|---------------|----------|
| 「ユーザーが見つかりません」 | テストユーザーが存在しない | 新規登録テストを先に実施 |
| 「パスワードが正しくありません」 | パスワード間違い | 正しいパスワードを確認 |
| 画面が変わらない | エミュレータ接続エラー | エミュレータを再起動 |

---

### テスト項目 3.2.2：ログイン失敗（無効な認証情報）

**目的**：存在しないユーザーまたは間違ったパスワードでログインが拒否されることを確認

**前提条件**：ログアウト状態である

**テスト手順**：

**パターンA: 存在しないメールアドレス**
1. メールアドレス欄に `nonexistent@example.com` を入力
2. パスワード欄に `AnyPassword123` を入力
3. 「ログイン」ボタンをタップ

**パターンB: 間違ったパスワード**
1. メールアドレス欄に `test@example.com`（既存ユーザー）を入力
2. パスワード欄に `WrongPassword123` を入力
3. 「ログイン」ボタンをタップ

**期待される結果**：
- ✅ エラーメッセージが表示される
- ✅ ログイン画面のままである
- ✅ パスワード欄がクリアされる

**表示されるべきエラーメッセージ**：
- パターンA: 「ユーザーが見つかりません」
- パターンB: 「パスワードが正しくありません」

---

### テスト項目 3.2.3：ログアウト機能

**目的**：ログアウト後にログイン画面に戻り、認証状態がクリアされることを確認

**前提条件**：ログイン状態である

**テスト手順**：

1. ホーム画面でメニューを開く（または設定画面へ移動）
2. 「ログアウト」ボタンをタップ
3. 確認ダイアログが表示されたら「ログアウト」を選択

**期待される結果**：
- ✅ ログイン画面に遷移する
- ✅ 再度アプリを開いてもログイン画面が表示される
- ✅ 保護されたページにアクセスできない

**確認方法**：

| 確認場所 | 確認内容 |
|----------|----------|
| アプリUI | ログイン画面が表示されている |
| ブラウザ | アプリをリロードしてもログイン画面のまま |

---

### テスト項目 3.2.4：新規登録（正常系）

**目的**：新規ユーザーが登録でき、必要なデータが作成されることを確認

**前提条件**：
- ログアウト状態である
- テストに使用するメールアドレスが未登録である

**テスト手順**：

**Step 1: 認証情報の入力**
1. ログイン画面で「新規登録」リンクをタップ
2. 以下の情報を入力：
   - メールアドレス: `newuser@example.com`
   - パスワード: `NewUser123!`
   - パスワード確認: `NewUser123!`
   - ニックネーム: `テストユーザー`
3. 「次へ」ボタンをタップ

**Step 2: プロフィール情報の入力**
1. 以下の情報を入力：
   - 生年月日: `2000-01-15`
   - 性別: 「男性」を選択
   - 身長: `170`
   - 体重: `65`
   - フィットネスレベル: 「初心者」を選択
   - 目標: `ダイエット`
2. 利用規約に同意するチェックボックスをON
3. プライバシーポリシーに同意するチェックボックスをON
4. 「登録」ボタンをタップ

**期待される結果**：
- ✅ ローディング表示後、ホーム画面に遷移する
- ✅ Firebase Authenticationに新規ユーザーが作成される
- ✅ Firestoreに`users`ドキュメントが作成される
- ✅ Firestoreに`consents`ドキュメント（利用規約・PP）が作成される

**エミュレータUIでの確認**：

**Authentication タブ:**
| フィールド | 期待値 |
|-----------|--------|
| Email | `newuser@example.com` |
| Provider | `password` |
| Created | 現在の日時 |

**Firestore タブ (`users` コレクション):**
```json
{
  "nickname": "テストユーザー",
  "email": "newuser@example.com",
  "tosAccepted": true,
  "ppAccepted": true,
  "deletionScheduled": false,
  "profile": {
    "birthday": "2000-01-15",
    "gender": "male",
    "height": 170,
    "weight": 65,
    "fitnessLevel": "beginner",
    "goals": ["ダイエット"]
  }
}
```

**Firestore タブ (`consents` コレクション):**
- 2つのドキュメントが作成されている（TOS と PP）
- 各ドキュメントに `action: "accept"` が設定されている

---

### テスト項目 3.2.5：新規登録失敗（既存メールアドレス）

**目的**：既に登録されているメールアドレスでの登録が拒否されることを確認

**前提条件**：`test@example.com` が既に登録されている

**テスト手順**：

1. 新規登録画面を開く
2. メールアドレスに `test@example.com`（既存）を入力
3. その他の必須項目を入力
4. 「登録」ボタンをタップ

**期待される結果**：
- ✅ エラーメッセージ「このメールアドレスは既に登録されています」が表示される
- ✅ 登録画面のままである
- ✅ 新しいユーザーは作成されない

---

### テスト項目 3.2.6：パスワードリセット

**目的**：パスワードリセットメールが送信されることを確認

**前提条件**：テスト用ユーザーが登録されている

**テスト手順**：

1. ログイン画面で「パスワードをお忘れですか？」リンクをタップ
2. メールアドレス入力欄に `test@example.com` を入力
3. 「リセットメールを送信」ボタンをタップ

**期待される結果**：
- ✅ 「パスワードリセットメールを送信しました」メッセージが表示される
- ✅ エミュレータのログにメール送信処理が記録される

**確認方法**：
エミュレータUIの **Functions** タブでログを確認：
```
Email verification link generated for user: [userId]
```

> 📝 **注意**: エミュレータ環境では実際のメールは送信されません。本番環境でのみメールが送信されます。

---

### テスト項目 3.2.7：自動ログイン（セッション維持）

**目的**：アプリを再起動してもログイン状態が維持されることを確認

**前提条件**：ログイン状態である

**テスト手順**：

1. ログイン状態であることを確認
2. ブラウザをリロード（F5キー）または アプリを再起動
3. 画面の遷移を確認

**期待される結果**：
- ✅ スプラッシュ画面が表示される
- ✅ 自動的にホーム画面に遷移する
- ✅ ログイン画面は表示されない

---

### テスト項目 3.2.8：強制ログアウト（forceLogout）

**目的**：管理者が強制ログアウトを設定した場合、ユーザーが自動的にログアウトされることを確認

**前提条件**：
- テストユーザーがログイン状態
- 管理者権限を持つユーザーが存在

**テスト手順**：

1. テストユーザーでログインし、ホーム画面にいることを確認
2. エミュレータUIで以下の操作を行う：
   - **Firestore** タブを開く
   - `users/{userId}` ドキュメントを選択
   - `forceLogout` フィールドを `true` に設定
3. アプリで何らかの操作を行う（画面遷移など）

**期待される結果**：
- ✅ 自動的にログアウトされる
- ✅ ログイン画面に遷移する
- ✅ 「セッションが無効になりました」などのメッセージが表示される

---

### 3.3 自動テストの実行

AuthNotifier の単体テストは自動化されています。

**実行コマンド**：
```bash
cd flutter_app
flutter test test/core/auth/auth_state_notifier_test.dart
```

**期待される結果**：
```
00:XX +26: All tests passed!
```

> ✅ 26個のテストが全てパスすれば成功です。

---

## 4. バリデーションテスト

### 4.1 バリデーションとは？

**バリデーション**とは、ユーザーが入力したデータが正しい形式かどうかをチェックする仕組みです。

**なぜ必要か：**
- 不正なデータがシステムに入ることを防ぐ
- ユーザーに入力ミスをすぐに知らせる
- サーバー側でのエラーを未然に防ぐ

**どこで使われているか：**
- ログイン画面（メール、パスワード）
- 新規登録画面（全ての入力項目）
- プロフィール編集画面

### 4.2 テスト対象フィールド

---

### 4.2.1 メールアドレスのバリデーション

**テスト対象画面**：ログイン画面、新規登録画面

**正常系テスト**

| 入力値 | 期待される動作 |
|--------|----------------|
| `test@example.com` | エラーなし |
| `user.name@domain.co.jp` | エラーなし |
| `test+tag@example.com` | エラーなし |

**異常系テスト**

| 入力値 | 期待されるエラーメッセージ |
|--------|----------------------------|
| `test` | 「有効なメールアドレスを入力してください」 |
| `test@` | 「有効なメールアドレスを入力してください」 |
| `@example.com` | 「有効なメールアドレスを入力してください」 |
| `` (空欄) | 「メールアドレスを入力してください」 |

**確認手順**：
1. 入力欄にテスト値を入力
2. 次の入力欄に移動（フォーカスを外す）
3. エラーメッセージの表示を確認

---

### 4.2.2 パスワードのバリデーション

**テスト対象画面**：ログイン画面、新規登録画面

**パスワード要件**：
- 最低8文字以上
- 英字を含む
- 数字を含む

**正常系テスト**

| 入力値 | 期待される動作 |
|--------|----------------|
| `Password123` | エラーなし |
| `MySecure1` | エラーなし |
| `Test12345678` | エラーなし |

**異常系テスト**

| 入力値 | 期待されるエラーメッセージ |
|--------|----------------------------|
| `pass` | 「パスワードは8文字以上で入力してください」 |
| `password` | 「パスワードには英字と数字の両方を含めてください」 |
| `12345678` | 「パスワードには英字と数字の両方を含めてください」 |
| `` (空欄) | 「パスワードを入力してください」 |

**境界値テスト**

| 入力値 | 文字数 | 期待される動作 |
|--------|--------|----------------|
| `Pass123` | 7文字 | エラー |
| `Pass1234` | 8文字 | エラーなし |
| `Pass12345` | 9文字 | エラーなし |

---

### 4.2.3 名前（ニックネーム）のバリデーション

**テスト対象画面**：新規登録画面、プロフィール編集画面

**要件**：1〜50文字

**正常系テスト**

| 入力値 | 期待される動作 |
|--------|----------------|
| `山田太郎` | エラーなし |
| `A` | エラーなし（1文字） |
| `あ` | エラーなし（1文字） |

**異常系テスト**

| 入力値 | 期待されるエラーメッセージ |
|--------|----------------------------|
| `` (空欄) | 「ニックネームを入力してください」 |
| 51文字以上の文字列 | 「ニックネームは50文字以内で入力してください」 |

---

### 4.2.4 生年月日のバリデーション

**テスト対象画面**：新規登録画面、プロフィール編集画面

**要件**：
- YYYY-MM-DD形式
- 13歳以上であること

**正常系テスト**

| 入力値 | 期待される動作 |
|--------|----------------|
| `2000-01-15` | エラーなし |
| `1990-12-31` | エラーなし |
| `2012-01-01`（13歳以上） | エラーなし |

**異常系テスト**

| 入力値 | 期待されるエラーメッセージ |
|--------|----------------------------|
| `2015-01-01`（10歳） | 「13歳以上の方のみご利用いただけます」 |
| `invalid-date` | 「生年月日の形式が不正です」 |
| `2025-13-01` | 「生年月日の形式が不正です」 |

---

### 4.2.5 身長のバリデーション

**テスト対象画面**：新規登録画面、プロフィール編集画面

**要件**：100〜250cm（任意項目）

**正常系テスト**

| 入力値 | 期待される動作 |
|--------|----------------|
| `170` | エラーなし |
| `100` | エラーなし（最小値） |
| `250` | エラーなし（最大値） |
| 未入力 | エラーなし（任意） |

**異常系テスト**

| 入力値 | 期待されるエラーメッセージ |
|--------|----------------------------|
| `99` | 「身長は100〜250cmの範囲で入力してください」 |
| `251` | 「身長は100〜250cmの範囲で入力してください」 |
| `abc` | 「身長は数値で入力してください」 |

---

### 4.2.6 体重のバリデーション

**テスト対象画面**：新規登録画面、プロフィール編集画面

**要件**：30〜200kg（任意項目）

**正常系テスト**

| 入力値 | 期待される動作 |
|--------|----------------|
| `65` | エラーなし |
| `30` | エラーなし（最小値） |
| `200` | エラーなし（最大値） |
| 未入力 | エラーなし（任意） |

**異常系テスト**

| 入力値 | 期待されるエラーメッセージ |
|--------|----------------------------|
| `29` | 「体重は30〜200kgの範囲で入力してください」 |
| `201` | 「体重は30〜200kgの範囲で入力してください」 |

---

### 4.2.7 性別のバリデーション

**テスト対象画面**：新規登録画面、プロフィール編集画面

**選択肢**：
- 男性 (male)
- 女性 (female)
- その他 (other)
- 回答しない (prefer_not_to_say)

**テスト手順**：
1. 各選択肢を選択できることを確認
2. 未選択でも登録できることを確認（任意項目）
3. 選択後に別の選択肢に変更できることを確認

---

### 4.2.8 フィットネスレベルのバリデーション

**テスト対象画面**：新規登録画面、プロフィール編集画面

**選択肢**：
- 初心者 (beginner)
- 中級者 (intermediate)
- 上級者 (advanced)

**テスト手順**：
1. 各選択肢を選択できることを確認
2. 未選択でも登録できることを確認（任意項目）

---

### 4.3 UIでの確認ポイント

バリデーションエラー時に以下を確認してください：

| 確認項目 | 期待される状態 |
|----------|----------------|
| エラーメッセージ位置 | 入力フィールドの直下 |
| エラーメッセージの色 | 赤色 |
| フィールドの枠線 | 赤色にハイライト |
| 送信ボタン | 無効（グレーアウト）または タップ時にエラー表示 |

---

## 5. Cloud Functions テスト

### 5.1 Cloud Functions とは？

**Cloud Functions** は、サーバー側で実行される処理です。アプリから直接見えませんが、重要な処理を担当しています。

**ホテルで例えると：**
バックヤードのスタッフのようなものです。フロントデスク（アプリ）からの依頼を受けて、客室の準備（ユーザーデータの作成）、清掃（データ削除）、セキュリティチェックなどを行います。

### 5.2 テスト対象の関数

---

### 5.2.1 onUserCreate（ユーザー作成トリガー）

**関数の役割**：
新規ユーザーがFirebase Authenticationに登録されたとき、自動的にFirestoreにユーザードキュメントとデフォルト設定を作成します。

**実行タイミング**：
Firebase Authで新規ユーザーが作成されたとき（自動実行）

**テスト手順**：

1. **準備**
   - Firebaseエミュレータが起動していることを確認
   - Firestoreの`users`コレクションを確認（空であることが望ましい）

2. **実行**
   - 新規登録画面から新しいユーザーを登録
   - または エミュレータUIのAuthenticationタブで「Add user」をクリック

3. **結果確認**

   **Firestore（`users`コレクション）での確認**：
   | フィールド | 期待値 |
   |-----------|--------|
   | `userId` | Firebase Auth の UID と同一 |
   | `email` | 登録したメールアドレス |
   | `deletionScheduled` | `false` |
   | `createdAt` | 登録時のタイムスタンプ |

   **Firestore（`users/{userId}/settings`コレクション）での確認**：
   - `preferences` ドキュメントが作成されている
   - デフォルト設定値が入っている

**ログでの確認**：
エミュレータUIの **Functions** タブで以下のログを確認：
```
User document created for new user: [userId]
```

---

### 5.2.2 auth_signUp（新規登録API）

**関数の役割**：
新規ユーザー登録のリクエストを処理し、Firebase AuthとFirestoreにデータを作成します。

**エンドポイント情報**：
- 種類: Callable Function
- 名前: `auth_signUp`

**入力パラメータ**：
```json
{
  "email": "user@example.com",
  "password": "Password123",
  "nickname": "ユーザー名",
  "birthYear": 2000,
  "tosAccepted": true,
  "ppAccepted": true
}
```

**テスト手順**：

1. **正常系テスト**
   - 新規登録画面から全ての必須項目を入力して登録
   - 期待: 登録成功、ホーム画面に遷移

2. **異常系テスト**
   - 既存メールアドレスで登録を試みる
   - 期待: エラーメッセージ「このメールアドレスは既に登録されています」

3. **バリデーションテスト**
   - 無効なメールアドレスで登録を試みる
   - 期待: バリデーションエラー

**期待されるレスポンス（成功時）**：
```json
{
  "success": true,
  "data": {
    "userId": "abc123...",
    "email": "user@example.com",
    "nickname": "ユーザー名",
    "createdAt": "2025-11-26T10:00:00.000Z"
  }
}
```

---

### 5.2.3 updateProfile（プロフィール更新API）

**関数の役割**：
ログインユーザーのプロフィール情報を更新します。

**エンドポイント情報**：
- 種類: Callable Function
- 名前: `updateProfile`
- 認証: 必須

**入力パラメータ**：
```json
{
  "displayName": "新しい名前",
  "dateOfBirth": "2000-01-15",
  "gender": "male",
  "height": 175,
  "weight": 70,
  "fitnessLevel": "intermediate",
  "fitnessGoal": "筋力アップ"
}
```

**テスト手順**：

1. **準備**
   - テストユーザーでログイン
   - プロフィール編集画面を開く

2. **正常系テスト**
   - ニックネームを変更して保存
   - 身長・体重を変更して保存
   - フィットネスレベルを変更して保存

3. **結果確認**

   **Firestore での確認**：
   - `users/{userId}` ドキュメントの該当フィールドが更新されている
   - `updatedAt` が更新されている

   **監査ログの確認**：
   - `auditLogs` コレクションに更新記録が作成されている

**確認すべきフィールド（Firestore）**：
```json
{
  "displayName": "新しい名前",
  "profile": {
    "height": 175,
    "weight": 70,
    "fitnessLevel": "intermediate",
    "goals": ["筋力アップ"]
  },
  "updatedAt": "[更新日時]"
}
```

---

### 5.2.4 setCustomClaims（カスタムクレーム設定）

**関数の役割**：
ユーザーに特別な権限（管理者権限、強制ログアウトなど）を設定します。

**エンドポイント情報**：
- 種類: Callable Function
- 名前: `setCustomClaims`
- 認証: 管理者権限必須

**使用場面**：
- 管理者権限の付与
- 強制ログアウトの設定
- 特別な機能へのアクセス権付与

**テスト手順**：

> ⚠️ **注意**: この機能は管理者専用です。テストには管理者権限が必要です。

1. **準備**
   - 管理者ユーザーでログイン
   - または エミュレータで直接テスト

2. **エミュレータでの直接テスト**
   - **Firestore** タブで `users/{targetUserId}` を開く
   - `forceLogout` フィールドを `true` に設定
   - 対象ユーザーが自動ログアウトされることを確認

**確認ポイント**：
- カスタムクレームの変更が `customClaimsLogs` コレクションに記録される
- 対象ユーザーの状態が正しく変更される

---

### 5.2.5 onConsentWithdrawn（同意撤回トリガー）

**関数の役割**：
ユーザーが利用規約またはプライバシーポリシーへの同意を撤回した場合、強制ログアウトを実行します。

**実行タイミング**：
`consents` コレクションに `action: "withdraw"` のドキュメントが作成されたとき

**テスト手順**：

1. **準備**
   - テストユーザーでログイン

2. **実行**
   - エミュレータUIで `consents` コレクションに以下のドキュメントを追加：
   ```json
   {
     "userId": "[テストユーザーのID]",
     "action": "withdraw",
     "documentType": "tos",
     "documentVersion": "3.1",
     "timestamp": "[現在時刻]"
   }
   ```

3. **結果確認**
   - 対象ユーザーに `forceLogout: true` が設定される
   - ユーザーが次回アクセス時にログアウトされる

---

### 5.3 エミュレータUIの使い方

#### アクセス方法
ブラウザで **http://localhost:4000** を開きます。

#### 各タブの説明

| タブ | 用途 |
|------|------|
| **Overview** | 全体の状態確認 |
| **Authentication** | ユーザー一覧、ユーザー追加・削除 |
| **Firestore** | データベースの閲覧・編集 |
| **Functions** | 関数の実行ログ確認 |

#### Authentication タブ

**確認できる情報**：
- 登録ユーザー一覧
- メールアドレス
- 作成日時
- 最終ログイン日時
- プロバイダー（password, google.com など）

**操作**：
- 「Add user」: テストユーザーの追加
- ユーザー行をクリック: 詳細表示・編集
- ゴミ箱アイコン: ユーザー削除

#### Firestore タブ

**確認できる情報**：
- コレクション一覧
- ドキュメントの内容
- サブコレクション

**操作**：
- 左側パネル: コレクション選択
- 中央パネル: ドキュメント一覧
- 右側パネル: ドキュメント詳細・編集

#### Functions タブ

**確認できる情報**：
- 関数の実行ログ
- エラーメッセージ
- 実行時間

**ログの見方**：
- `INFO`: 通常の処理ログ
- `WARN`: 警告（処理は継続）
- `ERROR`: エラー（処理失敗）

---

## 6. 統合テストシナリオ

実際のユーザーフローに沿ったテストシナリオです。

### シナリオ1：新規ユーザー登録からログインまで

**所要時間**: 約10分

**手順**：

| ステップ | 操作 | 確認ポイント |
|----------|------|-------------|
| 1 | ログイン画面で「新規登録」をタップ | 新規登録画面が表示される |
| 2 | Step 1で認証情報を入力 | 入力フィールドが機能する |
| 3 | 「次へ」をタップ | Step 2に進む |
| 4 | Step 2でプロフィール情報を入力 | 入力フィールドが機能する |
| 5 | 同意チェックボックスをON | チェックが入る |
| 6 | 「登録」をタップ | ローディング表示 |
| 7 | ホーム画面に遷移 | 登録成功 |
| 8 | エミュレータでユーザー確認 | Auth + Firestore にデータあり |
| 9 | ログアウト | ログイン画面に戻る |
| 10 | 同じ認証情報でログイン | ログイン成功 |

**チェックポイント**：
- [ ] Firebase Authにユーザー作成
- [ ] Firestoreに`users`ドキュメント作成
- [ ] Firestoreに`consents`ドキュメント作成（2件）
- [ ] ログアウト後に再ログイン可能

---

### シナリオ2：パスワードリセットフロー

**所要時間**: 約5分

**手順**：

| ステップ | 操作 | 確認ポイント |
|----------|------|-------------|
| 1 | ログイン画面で「パスワードをお忘れですか？」をタップ | パスワードリセット画面表示 |
| 2 | 登録済みメールアドレスを入力 | - |
| 3 | 「リセットメールを送信」をタップ | 成功メッセージ表示 |
| 4 | Functions ログを確認 | メール生成ログあり |

> 📝 エミュレータ環境では実際のメールは送信されません。

---

### シナリオ3：プロフィール更新フロー

**所要時間**: 約5分

**手順**：

| ステップ | 操作 | 確認ポイント |
|----------|------|-------------|
| 1 | ログイン状態でプロフィール画面を開く | 現在の情報が表示 |
| 2 | ニックネームを変更 | 入力可能 |
| 3 | 身長を変更 | 入力可能 |
| 4 | 「保存」をタップ | 成功メッセージ表示 |
| 5 | Firestoreでデータ確認 | 値が更新されている |
| 6 | `auditLogs`確認 | 更新ログが記録されている |

---

### シナリオ4：アカウント削除フロー

**所要時間**: 約10分

> ⚠️ **注意**: このテストはデータを削除します。テスト専用のアカウントで実施してください。

**手順**：

| ステップ | 操作 | 確認ポイント |
|----------|------|-------------|
| 1 | 設定画面で「アカウント削除」をタップ | 確認ダイアログ表示 |
| 2 | 確認して「削除」をタップ | 処理開始 |
| 3 | Firestoreで`users`ドキュメント確認 | `deletionScheduled: true` |
| 4 | `dataDeletionRequests`確認 | 削除リクエストが作成 |
| 5 | 30日後の削除予定日を確認 | 正しい日付が設定 |

---

## 7. テストチェックリスト

テスト実行時にこのチェックリストを使用してください。

---

### テスト実行チェックリスト

**実行日**：________________
**テスター名**：________________
**環境**：□ エミュレータ  □ 本番環境

---

#### AuthNotifier テスト

| # | テスト項目 | 結果 | 備考 |
|---|-----------|------|------|
| 1 | ログイン（正常系） | □ Pass □ Fail | |
| 2 | ログイン（無効な認証情報） | □ Pass □ Fail | |
| 3 | ログイン（存在しないユーザー） | □ Pass □ Fail | |
| 4 | ログアウト | □ Pass □ Fail | |
| 5 | 新規登録（正常系） | □ Pass □ Fail | |
| 6 | 新規登録（既存メール） | □ Pass □ Fail | |
| 7 | パスワードリセット | □ Pass □ Fail | |
| 8 | 自動ログイン（セッション維持） | □ Pass □ Fail | |
| 9 | 強制ログアウト | □ Pass □ Fail | |

---

#### バリデーションテスト

| # | フィールド | 正常系 | 異常系 | 備考 |
|---|-----------|--------|--------|------|
| 1 | メールアドレス | □ Pass □ Fail | □ Pass □ Fail | |
| 2 | パスワード | □ Pass □ Fail | □ Pass □ Fail | |
| 3 | 名前 | □ Pass □ Fail | □ Pass □ Fail | |
| 4 | 生年月日 | □ Pass □ Fail | □ Pass □ Fail | |
| 5 | 身長 | □ Pass □ Fail | □ Pass □ Fail | |
| 6 | 体重 | □ Pass □ Fail | □ Pass □ Fail | |
| 7 | 性別 | □ Pass □ Fail | □ Pass □ Fail | |
| 8 | フィットネスレベル | □ Pass □ Fail | □ Pass □ Fail | |

---

#### Cloud Functions テスト

| # | 関数名 | 結果 | 備考 |
|---|--------|------|------|
| 1 | onUserCreate | □ Pass □ Fail | |
| 2 | auth_signUp | □ Pass □ Fail | |
| 3 | updateProfile | □ Pass □ Fail | |
| 4 | setCustomClaims | □ Pass □ Fail | |
| 5 | onConsentWithdrawn | □ Pass □ Fail | |

---

#### 統合テスト

| # | シナリオ | 結果 | 備考 |
|---|----------|------|------|
| 1 | 新規登録〜ログイン | □ Pass □ Fail | |
| 2 | パスワードリセット | □ Pass □ Fail | |
| 3 | プロフィール更新 | □ Pass □ Fail | |
| 4 | アカウント削除 | □ Pass □ Fail | |

---

#### 不具合記録

| # | 項目 | 現象 | 重要度 | ステータス |
|---|------|------|--------|------------|
| 1 | | | □高 □中 □低 | □未対応 □対応中 □完了 |
| 2 | | | □高 □中 □低 | □未対応 □対応中 □完了 |
| 3 | | | □高 □中 □低 | □未対応 □対応中 □完了 |

---

## 8. トラブルシューティング

### 問題：エミュレータに接続できない

**症状**：
- `http://localhost:4000` にアクセスできない
- アプリが「接続エラー」を表示

**原因と解決方法**：

| 原因 | 解決方法 |
|------|----------|
| エミュレータが起動していない | `firebase emulators:start` を実行 |
| ポートが使用中 | 他のプロセスを終了するか、firebase.json でポートを変更 |
| ファイアウォール | ポート4000, 9099, 8080 を許可 |

---

### 問題：ログインできない

**症状**：
- 正しい認証情報でもログインできない
- エラーメッセージが表示される

**原因と解決方法**：

| 原因 | 解決方法 |
|------|----------|
| ユーザーが存在しない | 新規登録を先に実施 |
| パスワードが間違っている | エミュレータUIで確認 |
| エミュレータとの接続エラー | エミュレータを再起動 |
| アプリがエミュレータに接続していない | `main.dart` の設定を確認 |

---

### 問題：Firestoreにデータが作成されない

**症状**：
- 新規登録は成功するがFirestoreにデータがない

**原因と解決方法**：

| 原因 | 解決方法 |
|------|----------|
| Cloud Functionsがエラー | Functions タブでログを確認 |
| セキュリティルールで拒否 | ルールをデバッグモードに変更して確認 |
| エミュレータの接続先が違う | firebase.json の設定を確認 |

---

### 問題：テストが失敗する

**症状**：
- `flutter test` コマンドでエラー

**原因と解決方法**：

| 原因 | 解決方法 |
|------|----------|
| 依存関係のエラー | `flutter pub get` を実行 |
| コード生成が古い | `flutter pub run build_runner build` を実行 |
| テストファイルの構文エラー | エラーメッセージを確認 |

---

### 問題：エミュレータUIが表示されない

**症状**：
- ブラウザで `localhost:4000` を開いても何も表示されない

**解決方法**：

1. エミュレータのログを確認
2. 別のブラウザで試す
3. キャッシュをクリア
4. `firebase emulators:start --only auth,firestore,functions` で最小構成で起動

---

## 9. 参考資料

### 関連ドキュメント

| ドキュメント | パス | 説明 |
|-------------|------|------|
| チケット #007 | `docs/tickets/007_user_authentication.md` | 実装詳細 |
| Firebase設定ガイド | `docs/FIREBASE_AUTH_SETUP.md` | 認証設定手順 |
| 要件定義書 | `docs/specs/00_要件定義書_v3_3.md` | 機能要件 |
| API設計書 | `docs/specs/03_API設計書_Firebase_Functions_v3_3.md` | API仕様 |
| データベース設計書 | `docs/specs/02_Firestoreデータベース設計書_v3_3.md` | データ構造 |

### 公式ドキュメント

- [Firebase Authentication](https://firebase.google.com/docs/auth)
- [Firebase Emulator Suite](https://firebase.google.com/docs/emulator-suite)
- [Flutter Testing](https://docs.flutter.dev/testing)

---

## 10. 用語集

非エンジニア向けの用語説明です。

| 用語 | 説明 |
|------|------|
| **認証（Authentication）** | ユーザーが本人であることを確認すること。ログイン処理のこと。 |
| **エミュレータ** | 本番環境を模倣したテスト環境。実際のFirebaseに影響を与えずにテストできる。 |
| **Firestore** | Googleが提供するデータベース。ユーザー情報などを保存する場所。 |
| **Cloud Functions** | サーバー側で実行されるプログラム。アプリからは見えないが重要な処理を担当。 |
| **トリガー** | 特定のイベント（ユーザー作成など）が発生したときに自動的に実行される処理。 |
| **バリデーション** | 入力データが正しい形式かチェックすること。 |
| **セッション** | ユーザーがログインしている期間のこと。 |
| **トークン** | ユーザーの認証情報を含む特別な文字列。ログイン状態を維持するために使用。 |
| **カスタムクレーム** | ユーザーに付与される特別な権限情報。管理者権限など。 |
| **GDPR** | EUの個人情報保護規則。日本のアプリでも準拠が必要な場合がある。 |
| **監査ログ** | 誰が、いつ、何をしたかを記録したログ。セキュリティとコンプライアンスのため。 |

---

## 📞 サポート連絡先

テスト中に解決できない問題が発生した場合：

- **Slack**: #ai-fitness-dev チャンネル
- **メール**: dev-team@example.com
- **GitHub Issues**: [プロジェクトリポジトリ](https://github.com/example/ai-fitness-app/issues)

---

**ドキュメント作成者**: Claude Code
**レビュー者**: ________________
**承認日**: ________________
