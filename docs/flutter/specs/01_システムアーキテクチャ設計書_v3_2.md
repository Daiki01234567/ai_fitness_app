# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ v3.2 (Part 1/3)

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒª(ä»®ç§°)  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.2 (MVP)  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ23æ—¥  
**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´11æœˆ23æ—¥  
**å¯¾è±¡æœŸé–“**: Phase 1-2 (0-4ãƒ¶æœˆ)  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Draft

---

## ğŸ“ v3.2ã§ã®ä¸»ãªå¤‰æ›´ç‚¹

### è¦ä»¶å®šç¾©æ›¸v3.2ã¨ã®å®Œå…¨æ•´åˆ

âœ… **æ–°æ©Ÿèƒ½ã®åæ˜ **:
- FR-002-1: åŒæ„çŠ¶æ…‹ç®¡ç†æ©Ÿèƒ½ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
- FR-004-1: ã‚«ãƒ¡ãƒ©è¨­å®šè‡ªå‹•é–‹å§‹æ©Ÿèƒ½ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´å®Ÿè£…
- FR-016: è¨­å®šç®¡ç†æ©Ÿèƒ½ã®ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ
- FR-024-1: ãƒ­ã‚°ã‚¤ãƒ³æ™‚åŒæ„ç¢ºèªæ©Ÿèƒ½ã®ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ
- NFR-031: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®UI/UXã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³ã®å®Ÿè£…è©³ç´°è¿½åŠ **:
- ã‚«ãƒ¡ãƒ©æ˜ åƒå‡¦ç†ãƒ•ãƒ­ãƒ¼ã®æŠ€è¡“çš„å®Ÿè£…æ–¹æ³•
- å€‹äººãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®è‡ªå‹•åŒ–è¨­è¨ˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©åˆ©è¡Œä½¿ã®å®Ÿè£…è©³ç´°
- ãƒ‡ãƒ¼ã‚¿ä¾µå®³å¯¾å¿œã®è‡ªå‹•æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

âœ… **GDPRæº–æ‹ ã®å¼·åŒ–**:
- æ­£å½“ãªåˆ©ç›Š(GDPRç¬¬6æ¡1é …(f))ã®æŠ€è¡“çš„å®Ÿè£…
- åŒæ„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°è¨­è¨ˆ
- ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“ã®è‡ªå‹•ç®¡ç†æ©Ÿèƒ½

âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**:
- æš—å·åŒ–æ–¹å¼ã®è©³ç´°åŒ–(AES-256-GCM)
- èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å¤šå±¤é˜²å¾¡è¨­è¨ˆ
- è„†å¼±æ€§å¯¾ç­–ã®å…·ä½“çš„å®Ÿè£…æ–¹æ³•

---

## ç›®æ¬¡

### Part 1: æ¦‚è¦ã€œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
1. [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦](#1-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒ](#2-ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒ)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡](#3-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡)
4. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#4-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
5. [ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#5-ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)

### Part 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
6. [ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#6-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
7. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#7-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
8. [APIè¨­è¨ˆ](#8-apiè¨­è¨ˆ)
9. [èªè¨¼ãƒ»èªå¯](#9-èªè¨¼èªå¯)
10. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#10-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)

### Part 3: ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€œé‹ç”¨
11. [ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³](#11-ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³)
12. [ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹](#12-ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹)
13. [ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°](#13-ç›£è¦–ãƒ­ã‚®ãƒ³ã‚°)
14. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥](#14-ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥)
15. [ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£](#15-ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£)
16. [ãƒ‡ã‚£ã‚¶ã‚¹ã‚¿ãƒªã‚«ãƒãƒª](#16-ãƒ‡ã‚£ã‚¶ã‚¹ã‚¿ãƒªã‚«ãƒãƒª)

---

## 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦

### 1.1 ç›®çš„

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒª(ä»®ç§°)ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®šç¾©ã—ã¾ã™ã€‚ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã‚’æä¾›ã—ã¾ã™:

- **æ©Ÿèƒ½è¦ä»¶**: è¦ä»¶å®šç¾©æ›¸v3.2ã«å®šç¾©ã•ã‚ŒãŸ35ã®æ©Ÿèƒ½è¦ä»¶ã‚’å®Ÿç¾
- **éæ©Ÿèƒ½è¦ä»¶**: 33ã®éæ©Ÿèƒ½è¦ä»¶(ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€æ³•ä»¤éµå®ˆ)ã‚’æº€ãŸã™
- **æ³•çš„æº–æ‹ **: åˆ©ç”¨è¦ç´„v3.1ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼v3.1ã«å®Œå…¨æº–æ‹ 
- **GDPRå¯¾å¿œ**: GDPR/EDPB Guidelinesã®è¦æ±‚äº‹é …ã‚’æŠ€è¡“çš„ã«å®Ÿè£…
- **è–¬æ©Ÿæ³•å¯¾å¿œ**: åŒ»ç™‚æ©Ÿå™¨ã¨èª¤èªã•ã‚Œãªã„æŠ€è¡“çš„ãƒ»è¡¨ç¾çš„é…æ…®

### 1.2 æƒ³å®šèª­è€…

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- æ³•å‹™æ‹…å½“è€…

### 1.3 å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å‚ç…§ç›®çš„ |
|--------------|-----------|---------|
| è¦ä»¶å®šç¾©æ›¸ | v3.2 | æ©Ÿèƒ½è¦ä»¶ãƒ»éæ©Ÿèƒ½è¦ä»¶ã®è©³ç´° |
| åˆ©ç”¨è¦ç´„ | v3.1 | æ³•çš„åˆ¶ç´„ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© |
| ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ | v3.1 | ãƒ‡ãƒ¼ã‚¿å–ã‚Šæ‰±ã„ãƒ»GDPRæº–æ‹  |
| ç”»é¢é·ç§»å›³+ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  | v3.3 | UI/UXè¦ä»¶ |

### 1.4 ç”¨èªå®šç¾©

| ç”¨èª | å®šç¾© |
|-----|------|
| **MVP** | Minimum Viable Productã€‚Phase 1-2(0-4ãƒ¶æœˆ)ã§æä¾›ã™ã‚‹æœ€å°é™ã®æ©Ÿèƒ½ã‚»ãƒƒãƒˆ |
| **ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç«¯æœ«ä¸Šã§ã®ã¿å®Ÿè¡Œã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãªã„å‡¦ç† |
| **éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿** | MediaPipe PoseãŒæŠ½å‡ºã™ã‚‹33å€‹ã®é–¢ç¯€ä½ç½®(X,Y,Zåº§æ¨™+ä¿¡é ¼åº¦) |
| **å‚è€ƒæƒ…å ±** | åˆ©ç”¨è¦ç´„ç¬¬1.2æ¡ã§å®šç¾©ã•ã‚Œã‚‹ã€åŒ»å­¦çš„åˆ¤æ–­ã‚’å«ã¾ãªã„æƒ…å ± |
| **åŒæ„ç®¡ç†** | GDPRç¬¬7æ¡ã«åŸºã¥ãã€åˆ©ç”¨è€…ã®åŒæ„å–å¾—ãƒ»è¨˜éŒ²ãƒ»ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  |
| **ä»®ååŒ–** | GDPRç¬¬4æ¡5é …ã«åŸºã¥ãã€è¿½åŠ æƒ…å ±ãªã—ã«å€‹äººã‚’ç‰¹å®šã§ããªã„ãƒ‡ãƒ¼ã‚¿å‡¦ç† |
| **æ­£å½“ãªåˆ©ç›Š** | GDPRç¬¬6æ¡1é …(f)ã«åŸºã¥ãã€åˆ©ç”¨è€…ã®æ¨©åˆ©ã‚’ä¾µå®³ã—ãªã„ç¯„å›²ã§ã®å‡¦ç†æ ¹æ‹  |

---

## 2. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒ

### 2.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Flutter ã‚¢ãƒ—ãƒª (iOS/Android)                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  UIå±¤                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ç”»é¢é·ç§»å›³v3.3ã®15ç”»é¢ã‚’å®Ÿè£…                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Material Design 3æº–æ‹                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼(4ã‚¿ãƒ–)                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                     â†“                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Riverpod(çŠ¶æ…‹ç®¡ç†)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - åŒæ„çŠ¶æ…‹ç®¡ç†(FR-002-1)                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                     â†“                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†å±¤                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - MediaPipe Pose(éª¨æ ¼æ¤œå‡º)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ã‚«ãƒ¡ãƒ©æ˜ åƒå‡¦ç†(NFR-015)                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - éŸ³å£°åˆæˆ(TTS)                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                     â†“                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Firebase SDK                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸(SharedPreferences)             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTPS (TLS 1.3)
                            â†“ æš—å·åŒ–é€šä¿¡(NFR-009)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Firebase / GCPå±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Firebase Authentication                                  â”‚  â”‚
â”‚  â”‚  - Email/Passwordèªè¨¼                                     â”‚  â”‚
â”‚  â”‚  - Google/Apple Sign-In                                   â”‚  â”‚
â”‚  â”‚  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†(JWT)                                    â”‚  â”‚
â”‚  â”‚  - MFA(å°†æ¥å®Ÿè£…)                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Cloud Firestore                                          â”‚  â”‚
â”‚  â”‚  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿(users/)                                 â”‚  â”‚
â”‚  â”‚  - ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³(sessions/)                      â”‚  â”‚
â”‚  â”‚  - åŒæ„ç®¡ç†(consents/)                                    â”‚  â”‚
â”‚  â”‚  - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: asia-northeast1(æ±äº¬)                      â”‚  â”‚
â”‚  â”‚  - æš—å·åŒ–ä¿å­˜(AES-256)                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Firebase Functions (Node.js 20)                          â”‚  â”‚
â”‚  â”‚  - èª²é‡‘å‡¦ç†(Stripe Webhook)                               â”‚  â”‚
â”‚  â”‚  - ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(GDPRå¯¾å¿œ)                           â”‚  â”‚
â”‚  â”‚  - é€šçŸ¥é€ä¿¡(FCM)                                          â”‚  â”‚
â”‚  â”‚  - ãƒãƒƒãƒå‡¦ç†(ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã€çµ±è¨ˆè¨ˆç®—)                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Firebase Storage                                          â”‚  â”‚
â”‚  â”‚  - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ(åŒ¿ååŒ–)                               â”‚  â”‚
â”‚  â”‚  - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿                                     â”‚  â”‚
â”‚  â”‚  - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: asia-northeast1(æ±äº¬)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  BigQuery                                                  â”‚  â”‚
â”‚  â”‚  - çµ±è¨ˆåˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹                           â”‚  â”‚
â”‚  â”‚  - ä»®ååŒ–ãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿å­˜(NFR-016)                          â”‚  â”‚
â”‚  â”‚  - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ: fitness_analytics                        â”‚  â”‚
â”‚  â”‚  - ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: asia-northeast1(æ±äº¬)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Cloud Logging & Monitoring                                â”‚  â”‚
â”‚  â”‚  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°                                   â”‚  â”‚
â”‚  â”‚  - ã‚¨ãƒ©ãƒ¼è¿½è·¡(Sentryé€£æº)                                 â”‚  â”‚
â”‚  â”‚  - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°                             â”‚  â”‚
â”‚  â”‚  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å±¤                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Stripe (èª²é‡‘å‡¦ç†)                                         â”‚  â”‚
â”‚  â”‚  - ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†                                 â”‚  â”‚
â”‚  â”‚  - æ±ºæ¸ˆå‡¦ç†                                               â”‚  â”‚
â”‚  â”‚  - Webhookå—ä¿¡                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  RevenueCat (è³¼å…¥ç®¡ç†)                                     â”‚  â”‚
â”‚  â”‚  - App Store / Google Playé€£æº                            â”‚  â”‚
â”‚  â”‚  - ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼                                           â”‚  â”‚
â”‚  â”‚  - ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹åŒæœŸ                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SendGrid (ãƒ¡ãƒ¼ãƒ«é€ä¿¡)                                     â”‚  â”‚
â”‚  â”‚  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ãƒ«                                 â”‚  â”‚
â”‚  â”‚  - GDPRé–¢é€£é€šçŸ¥                                           â”‚  â”‚
â”‚  â”‚  - ãƒ‡ãƒ¼ã‚¿ä¾µå®³é€šçŸ¥                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ¦‚è¦

#### 2.2.1 ã‚«ãƒ¡ãƒ©æ˜ åƒå‡¦ç†ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼ç«¯æœ«] ã‚«ãƒ¡ãƒ©æ˜ åƒå–å¾—(720p, 30fps)
     â†“
[ç«¯æœ«å†…å‡¦ç†] MediaPipe Pose â†’ éª¨æ ¼æ¤œå‡º(33é–¢ç¯€)
     â†“
[ç«¯æœ«å†…å‡¦ç†] ã‚«ãƒ¡ãƒ©æ˜ åƒç ´æ£„(å³åº§ã«ãƒ¡ãƒ¢ãƒªã‹ã‚‰å‰Šé™¤)
     â†“
[ç«¯æœ«å†…å‡¦ç†] éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º(JSON, ç´„2KB)
     â†“ HTTPSæš—å·åŒ–é€šä¿¡
[Firestore] éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ä¿å­˜(æš—å·åŒ–)
     â†“ 1æ—¥1å›ãƒãƒƒãƒå‡¦ç†
[BigQuery] ä»®ååŒ–ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(çµ±è¨ˆåˆ†æç”¨)
```

**é‡è¦**: ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ä¸€åˆ‡ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“(ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼v3.1ç¬¬8.1æ¡)

#### 2.2.2 èªè¨¼ãƒ•ãƒ­ãƒ¼

```
[æ–°è¦ç™»éŒ²]
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Firebase Auth â†’ ãƒ¡ãƒ¼ãƒ«ç¢ºèª â†’ åˆ©ç”¨è¦ç´„åŒæ„ç”»é¢(FR-024) â†’ 
èº«ä½“æƒ…å ±å…¥åŠ› â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†

[ãƒ­ã‚°ã‚¤ãƒ³]
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ Firebase Auth â†’ èªè¨¼æˆåŠŸ â†’ åŒæ„çŠ¶æ…‹ç¢ºèª(FR-024-1) â†’ 
æœªåŒæ„ã®å ´åˆ: åŒæ„ç”»é¢è¡¨ç¤º(å¼·åˆ¶) â†’ åŒæ„å¾Œ: ãƒ›ãƒ¼ãƒ ç”»é¢
```

#### 2.2.3 èª²é‡‘ãƒ•ãƒ­ãƒ¼

```
[ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è³¼å…¥]
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ èª²é‡‘ç”»é¢ â†’ RevenueCat â†’ App Store/Google Play â†’ 
æ±ºæ¸ˆå®Œäº† â†’ Webhook â†’ Firebase Functions â†’ Firestoreã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° â†’ 
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
```

### 2.3 ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | è²¬å‹™ | æŠ€è¡“ |
|--------------|------|------|
| **Flutter App** | UI/UXã€çŠ¶æ…‹ç®¡ç†ã€ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç† | Flutter 3.19, Dart 3.3 |
| **Firebase Auth** | èªè¨¼ãƒ»èªå¯ | Firebase Authentication |
| **Firestore** | ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | Cloud Firestore |
| **Firebase Functions** | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ | Node.js 20, TypeScript |
| **BigQuery** | ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã€åˆ†æ | BigQuery |
| **Stripe** | æ±ºæ¸ˆå‡¦ç† | Stripe API |
| **RevenueCat** | ã‚µãƒ–ã‚¹ã‚¯ç®¡ç† | RevenueCat SDK |

---

## 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡

### 3.1 è¨­è¨ˆåŸå‰‡

#### 3.1.1 ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚¤ãƒ‡ã‚¶ã‚¤ãƒ³(Privacy by Design)

**åŸå‰‡**: GDPRç¬¬25æ¡ã«åŸºã¥ãã€ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ®µéšã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã‚’çµ„ã¿è¾¼ã‚€

**å®Ÿè£…æ–¹é‡**:
- ã‚«ãƒ¡ãƒ©æ˜ åƒã®ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†(ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—)
- ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–(å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿åé›†)
- ä»®ååŒ–ã®æ¨™æº–å®Ÿè£…(BigQueryã¸ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚)
- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å¤šå±¤é˜²å¾¡
- é€æ˜æ€§ã®ç¢ºä¿(å‡¦ç†å†…å®¹ã®æ˜ç¤º)

**æŠ€è¡“çš„å®Ÿè£…**:
```dart
// ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†ã®ä¾‹
class PoseDetectionService {
  Future<SkeletonData> processFrame(CameraImage frame) async {
    // MediaPipe Poseã§éª¨æ ¼æ¤œå‡º
    final pose = await _poseDetector.processImage(frame);
    
    // ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’å³åº§ã«ç ´æ£„(ãƒ¡ãƒ¢ãƒªã‹ã‚‰å‰Šé™¤)
    frame.dispose();
    
    // éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
    return SkeletonData.fromPose(pose);
  }
}
```

#### 3.1.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚¤ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(Security by Default)

**åŸå‰‡**: ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§æœ€å¤§é™ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿

**å®Ÿè£…æ–¹é‡**:
- é€šä¿¡ã®å®Œå…¨æš—å·åŒ–(TLS 1.3)
- ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ä¿å­˜(AES-256-GCM)
- æœ€å°æ¨©é™ã®åŸå‰‡(Firestore Security Rules)
- ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼(Firebase Auth + å°†æ¥çš„ã«MFA)
- å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

#### 3.1.3 ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–(Data Minimization)

**åŸå‰‡**: GDPRç¬¬5æ¡1é …(c)ã«åŸºã¥ãã€å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿åé›†

**åé›†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿**:
- âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹(èªè¨¼ç”¨)
- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ãƒãƒƒã‚·ãƒ¥åŒ–)
- âœ… èº«ä½“æƒ…å ±(èº«é•·ã€ä½“é‡ã€å¹´é½¢) â† å¿…é ˆ
- âœ… éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿(ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²)
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿(ç¨®ç›®ã€å›æ•°ã€æ™‚é–“)
- âœ… ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±(OSã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³) â† æ­£å½“ãªåˆ©ç›Š

**åé›†ã—ãªã„ãƒ‡ãƒ¼ã‚¿**:
- âŒ ã‚«ãƒ¡ãƒ©æ˜ åƒ(ç«¯æœ«ä¸Šã§ç ´æ£„)
- âŒ ä½ç½®æƒ…å ±(GPS)
- âŒ é€£çµ¡å…ˆ
- âŒ ãƒ‡ãƒã‚¤ã‚¹ID(UDID/IMEI)
- âŒ é›»è©±ç•ªå·

#### 3.1.4 å¯ç”¨æ€§ã¨ä¿¡é ¼æ€§

**åŸå‰‡**: ã‚·ã‚¹ãƒ†ãƒ ã®é«˜å¯ç”¨æ€§ã¨ä¿¡é ¼æ€§ã‚’ç¢ºä¿

**å®Ÿè£…æ–¹é‡**:
- Firebase ã® 99.95% SLAæ´»ç”¨
- è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°(Cloud Firestore)
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¾¹åº•
- ãƒªãƒˆãƒ©ã‚¤ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
- ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

#### 3.1.5 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

**åŸå‰‡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°å¢—åŠ ã«æŸ”è»Ÿã«å¯¾å¿œ

**å®Ÿè£…æ–¹é‡**:
- ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(Firebase Functions)
- æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
- éåŒæœŸå‡¦ç†ã®æ´»ç”¨

### 3.2 æŠ€è¡“é¸å®šã®ç†ç”±

#### 3.2.1 Flutter

**é¸å®šç†ç”±**:
- âœ… ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™º(iOS/AndroidåŒæ™‚å¯¾å¿œ)
- âœ… é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹(ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)
- âœ… è±Šå¯ŒãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ(Material Design 3)
- âœ… ã‚«ãƒ¡ãƒ©ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å……å®Ÿ
- âœ… Firebaseé€£æºãŒå®¹æ˜“

**ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ**:
| æŠ€è¡“ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | é¸å®šçµæœ |
|-----|---------|-----------|---------|
| Flutter | ã‚¯ãƒ­ã‚¹å¯¾å¿œã€é«˜æ€§èƒ½ | å­¦ç¿’ã‚³ã‚¹ãƒˆ | âœ… æ¡ç”¨ |
| React Native | é–‹ç™ºè€…å¤šæ•° | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£ã‚‹ | âŒ ä¸æ¡ç”¨ |
| ãƒã‚¤ãƒ†ã‚£ãƒ–(Swift/Kotlin) | æœ€é«˜æ€§èƒ½ | é–‹ç™ºã‚³ã‚¹ãƒˆ2å€ | âŒ ä¸æ¡ç”¨ |

#### 3.2.2 Firebase

**é¸å®šç†ç”±**:
- âœ… è¿…é€Ÿãªé–‹ç™º(BaaS)
- âœ… è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
- âœ… èªè¨¼æ©Ÿèƒ½ã®å……å®Ÿ
- âœ… GDPRå¯¾å¿œæ©Ÿèƒ½(ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ)

**ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ**:
| æŠ€è¡“ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | é¸å®šçµæœ |
|-----|---------|-----------|---------|
| Firebase | é–‹ç™ºé€Ÿåº¦ã€é‹ç”¨ã‚³ã‚¹ãƒˆ | ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ | âœ… æ¡ç”¨ |
| AWS | æŸ”è»Ÿæ€§é«˜ã„ | å­¦ç¿’ã‚³ã‚¹ãƒˆé«˜ã€é‹ç”¨è¤‡é›‘ | âŒ ä¸æ¡ç”¨ |
| è‡ªå‰ã‚µãƒ¼ãƒãƒ¼ | å®Œå…¨åˆ¶å¾¡ | é‹ç”¨ã‚³ã‚¹ãƒˆæ¥µå¤§ | âŒ ä¸æ¡ç”¨ |

#### 3.2.3 MediaPipe Pose (MVPæœŸ)

**é¸å®šç†ç”±**:
- âœ… ç„¡æ–™(ã‚³ã‚¹ãƒˆå‰Šæ¸›)
- âœ… ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†(ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·)
- âœ… æ¯ã‚ŒãŸæŠ€è¡“(ä¿¡é ¼æ€§)
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†(30fps)
- âœ… è¿…é€Ÿãªå¸‚å ´æŠ•å…¥

**Phase 4ä»¥é™ã®ç§»è¡Œè¨ˆç”»**:
- ã‚«ã‚¹ã‚¿ãƒ MLãƒ¢ãƒ‡ãƒ«ã¸ã®æ®µéšçš„ç§»è¡Œ
- 10,000ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿è“„ç©å¾Œ
- TensorFlow Lite + on-device training

---

## 4. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 4.1 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ(Flutter App)

#### 4.1.1 ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»è¨€èª

| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----|-----------|------|
| **Flutter** | 3.19.0+ | UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| **Dart** | 3.3.0+ | ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª |

#### 4.1.2 çŠ¶æ…‹ç®¡ç†

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|-----------|------|
| **riverpod** | 2.5.0+ | çŠ¶æ…‹ç®¡ç†(Provider) |
| **flutter_riverpod** | 2.5.0+ | Riverpod Flutterçµ±åˆ |
| **hooks_riverpod** | 2.5.0+ | Hooks API |

**æ¡ç”¨ç†ç”±**:
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å‹å®‰å…¨æ€§
- ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ãŒé«˜ã„
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè‰¯ã„
- å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„

#### 4.1.3 Firebaseé€£æº

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|-----------|------|
| **firebase_core** | 2.24.0+ | FirebaseåˆæœŸåŒ– |
| **firebase_auth** | 4.16.0+ | èªè¨¼ |
| **cloud_firestore** | 4.14.0+ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ |
| **firebase_storage** | 11.6.0+ | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| **firebase_messaging** | 14.7.0+ | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ |
| **firebase_analytics** | 10.8.0+ | åˆ†æ |
| **firebase_crashlytics** | 3.4.0+ | ã‚¯ãƒ©ãƒƒã‚·ãƒ¥å ±å‘Š |

#### 4.1.4 ã‚«ãƒ¡ãƒ©ãƒ»ç”»åƒå‡¦ç†

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|-----------|------|
| **camera** | 0.10.5+ | ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ |
| **google_mlkit_pose_detection** | 0.11.0+ | MediaPipe Pose |
| **image** | 4.1.0+ | ç”»åƒå‡¦ç† |

#### 4.1.5 UI/UXãƒ©ã‚¤ãƒ–ãƒ©ãƒª

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|-----------|------|
| **go_router** | 13.0.0+ | ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| **flutter_localizations** | - | å¤šè¨€èªå¯¾å¿œ |
| **intl** | 0.18.0+ | å›½éš›åŒ– |
| **table_calendar** | 3.0.9+ | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º |
| **fl_chart** | 0.66.0+ | ã‚°ãƒ©ãƒ•è¡¨ç¤º |
| **flutter_tts** | 3.8.0+ | éŸ³å£°åˆæˆ |

#### 4.1.6 èª²é‡‘

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|-----------|------|
| **purchases_flutter** | 6.20.0+ | RevenueCat SDK |

#### 4.1.7 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|-----------|------|
| **shared_preferences** | 2.2.0+ | ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| **freezed** | 2.4.0+ | ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã‚¯ãƒ©ã‚¹ç”Ÿæˆ |
| **json_serializable** | 6.7.0+ | JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º |
| **dio** | 5.4.0+ | HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| **logger** | 2.0.0+ | ãƒ­ã‚®ãƒ³ã‚° |

### 4.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(Firebase/GCP)

#### 4.2.1 Firebase

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| **Firebase Authentication** | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ | ã‚°ãƒ­ãƒ¼ãƒãƒ« |
| **Cloud Firestore** | NoSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | asia-northeast1(æ±äº¬) |
| **Firebase Functions** | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ | asia-northeast1(æ±äº¬) |
| **Firebase Storage** | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | asia-northeast1(æ±äº¬) |
| **Firebase Cloud Messaging** | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ | ã‚°ãƒ­ãƒ¼ãƒãƒ« |
| **Firebase Analytics** | ã‚¢ãƒ—ãƒªåˆ†æ | ã‚°ãƒ­ãƒ¼ãƒãƒ« |
| **Firebase Crashlytics** | ã‚¯ãƒ©ãƒƒã‚·ãƒ¥åˆ†æ | ã‚°ãƒ­ãƒ¼ãƒãƒ« |

#### 4.2.2 GCP

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| **BigQuery** | ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ | asia-northeast1(æ±äº¬) |
| **Cloud Logging** | ãƒ­ã‚°ç®¡ç† | asia-northeast1(æ±äº¬) |
| **Cloud Monitoring** | ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ | asia-northeast1(æ±äº¬) |
| **Secret Manager** | æ©Ÿå¯†æƒ…å ±ç®¡ç† | asia-northeast1(æ±äº¬) |

#### 4.2.3 Firebase Functions

| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----|-----------|------|
| **Node.js** | 20 LTS | ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  |
| **TypeScript** | 5.3.0+ | ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª |
| **Firebase Admin SDK** | 12.0.0+ | Firebaseæ“ä½œ |
| **Stripe SDK** | 14.0.0+ | æ±ºæ¸ˆå‡¦ç† |

#### 4.2.4 ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(Functions)

```json
{
  "dependencies": {
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^4.5.0",
    "stripe": "^14.0.0",
    "@google-cloud/bigquery": "^7.3.0",
    "nodemailer": "^6.9.0",
    "express": "^4.18.0",
    "cors": "^2.8.5",
    "helmet": "^7.1.0"
  },
  "devDependencies": {
    "typescript": "^5.3.0",
    "@types/node": "^20.10.0",
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

### 4.3 å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹

#### 4.3.1 æ±ºæ¸ˆãƒ»èª²é‡‘

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | æ–™é‡‘ |
|---------|------|------|
| **Stripe** | æ±ºæ¸ˆå‡¦ç† | 3.6% + ç„¡æ–™ |
| **RevenueCat** | ã‚µãƒ–ã‚¹ã‚¯ç®¡ç† | ç„¡æ–™(MAU 10,000ã¾ã§) |

#### 4.3.2 é€šä¿¡

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | æ–™é‡‘ |
|---------|------|------|
| **SendGrid** | ãƒ¡ãƒ¼ãƒ«é€ä¿¡ | $19.95/æœˆ(40,000é€š) |

#### 4.3.3 ç›£è¦–ãƒ»åˆ†æ

| ã‚µãƒ¼ãƒ“ã‚¹ | ç”¨é€” | æ–™é‡‘ |
|---------|------|------|
| **Sentry** | ã‚¨ãƒ©ãƒ¼è¿½è·¡ | $26/æœˆ(100,000ã‚¤ãƒ™ãƒ³ãƒˆ) |

### 4.4 é–‹ç™ºãƒ„ãƒ¼ãƒ«

#### 4.4.1 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

| ãƒ„ãƒ¼ãƒ« | ç”¨é€” |
|-------|------|
| **Git** | ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç† |
| **GitHub** | ãƒªãƒã‚¸ãƒˆãƒªãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚° |
| **GitHub Actions** | CI/CD |

#### 4.4.2 ãƒ†ã‚¹ãƒˆ

| ãƒ„ãƒ¼ãƒ« | ç”¨é€” |
|-------|------|
| **flutter_test** | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ |
| **integration_test** | çµ±åˆãƒ†ã‚¹ãƒˆ |
| **mockito** | ãƒ¢ãƒƒã‚¯ç”Ÿæˆ |

#### 4.4.3 ã‚³ãƒ¼ãƒ‰å“è³ª

| ãƒ„ãƒ¼ãƒ« | ç”¨é€” |
|-------|------|
| **flutter_lints** | Linter |
| **dart analyze** | é™çš„è§£æ |
| **dart format** | ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ |

---

## 5. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 5.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

**æ¡ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³**: Clean Architecture + MVVM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentationå±¤                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UI (Widgets)                                    â”‚   â”‚
â”‚  â”‚  - ç”»é¢é·ç§»å›³v3.3ã®15ç”»é¢                        â”‚   â”‚
â”‚  â”‚  - Material Design 3æº–æ‹                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ViewModel (Riverpod Providers)                  â”‚   â”‚
â”‚  â”‚  - çŠ¶æ…‹ç®¡ç†                                       â”‚   â”‚
â”‚  â”‚  - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å‘¼ã³å‡ºã—                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Domainå±¤                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Use Cases                                       â”‚   â”‚
â”‚  â”‚  - ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ                               â”‚   â”‚
â”‚  â”‚  - è¨˜éŒ²ä¿å­˜                                       â”‚   â”‚
â”‚  â”‚  - åŒæ„ç®¡ç†                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Entities                                        â”‚   â”‚
â”‚  â”‚  - User, Session, Exercise                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Repository Interfaces                           â”‚   â”‚
â”‚  â”‚  - æŠ½è±¡åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dataå±¤                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Repository Implementations                      â”‚   â”‚
â”‚  â”‚  - FirestoreRepository                           â”‚   â”‚
â”‚  â”‚  - LocalStorageRepository                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Data Sources                                    â”‚   â”‚
â”‚  â”‚  - Firebase SDK                                  â”‚   â”‚
â”‚  â”‚  - SharedPreferences                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
lib/
â”œâ”€â”€ main.dart                          # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ app.dart                           # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆ
â”‚
â”œâ”€â”€ core/                              # ã‚³ã‚¢æ©Ÿèƒ½
â”‚   â”œâ”€â”€ config/                        # è¨­å®š
â”‚   â”‚   â”œâ”€â”€ env.dart                   # ç’°å¢ƒå¤‰æ•°
â”‚   â”‚   â””â”€â”€ firebase_options.dart     # Firebaseè¨­å®š
â”‚   â”œâ”€â”€ constants/                     # å®šæ•°
â”‚   â”‚   â”œâ”€â”€ app_constants.dart         # ã‚¢ãƒ—ãƒªå®šæ•°
â”‚   â”‚   â””â”€â”€ api_constants.dart         # APIå®šæ•°
â”‚   â”œâ”€â”€ errors/                        # ã‚¨ãƒ©ãƒ¼å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ exceptions.dart
â”‚   â”‚   â””â”€â”€ failures.dart
â”‚   â”œâ”€â”€ utils/                         # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ logger.dart
â”‚   â”‚   â””â”€â”€ validators.dart
â”‚   â””â”€â”€ extensions/                    # æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰
â”‚       â”œâ”€â”€ string_extensions.dart
â”‚       â””â”€â”€ datetime_extensions.dart
â”‚
â”œâ”€â”€ features/                          # æ©Ÿèƒ½åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”œâ”€â”€ auth/                          # èªè¨¼æ©Ÿèƒ½(FR-001)
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth_remote_datasource.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ user_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”‚       â””â”€â”€ auth_repository_impl.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ user.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth_repository.dart
â”‚   â”‚   â”‚   â””â”€â”€ usecases/
â”‚   â”‚   â”‚       â”œâ”€â”€ sign_in.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ sign_up.dart
â”‚   â”‚   â”‚       â””â”€â”€ sign_out.dart
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â”‚   â”œâ”€â”€ login_page.dart        # 3.3 ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
â”‚   â”‚       â”‚   â”œâ”€â”€ signup_page.dart       # 3.4 æ–°è¦ç™»éŒ²ç”»é¢
â”‚   â”‚       â”‚   â””â”€â”€ consent_page.dart      # 3.5 åŒæ„ç”»é¢
â”‚   â”‚       â”œâ”€â”€ providers/
â”‚   â”‚       â”‚   â””â”€â”€ auth_provider.dart
â”‚   â”‚       â””â”€â”€ widgets/
â”‚   â”‚           â”œâ”€â”€ login_form.dart
â”‚   â”‚           â””â”€â”€ social_login_buttons.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ profile/                       # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½(FR-002)
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ profile_model.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ consent_model.dart  # FR-002-1
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ profile.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ consent.dart        # FR-002-1
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ usecases/
â”‚   â”‚   â”‚       â”œâ”€â”€ get_profile.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ update_profile.dart
â”‚   â”‚   â”‚       â””â”€â”€ manage_consent.dart # FR-002-1
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â”‚   â”œâ”€â”€ profile_page.dart     # 3.12 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢
â”‚   â”‚       â”‚   â””â”€â”€ settings_page.dart    # 3.13 è¨­å®šç”»é¢(FR-016)
â”‚   â”‚       â”œâ”€â”€ providers/
â”‚   â”‚       â””â”€â”€ widgets/
â”‚   â”‚
â”‚   â”œâ”€â”€ training/                      # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½(FR-003-007)
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pose_detection_datasource.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ training_remote_datasource.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ exercise_model.dart
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ session_model.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ skeleton_data_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ exercise.dart
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ session.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ skeleton_data.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ usecases/
â”‚   â”‚   â”‚       â”œâ”€â”€ start_training.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ process_pose.dart
â”‚   â”‚   â”‚       â”œâ”€â”€ save_session.dart
â”‚   â”‚   â”‚       â””â”€â”€ provide_feedback.dart
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â”‚   â”œâ”€â”€ home_page.dart          # 3.6 ãƒ›ãƒ¼ãƒ ç”»é¢
â”‚   â”‚       â”‚   â”œâ”€â”€ menu_page.dart          # 3.7 ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠç”»é¢
â”‚   â”‚       â”‚   â”œâ”€â”€ camera_setup_page.dart  # 3.8 ã‚«ãƒ¡ãƒ©è¨­å®šç”»é¢(FR-004-1)
â”‚   â”‚       â”‚   â”œâ”€â”€ training_page.dart      # 3.9 ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œç”»é¢
â”‚   â”‚       â”‚   â””â”€â”€ result_page.dart        # 3.10 ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœç”»é¢
â”‚   â”‚       â”œâ”€â”€ providers/
â”‚   â”‚       â”‚   â”œâ”€â”€ training_provider.dart
â”‚   â”‚       â”‚   â””â”€â”€ pose_detection_provider.dart
â”‚   â”‚       â””â”€â”€ widgets/
â”‚   â”‚           â”œâ”€â”€ pose_overlay.dart
â”‚   â”‚           â”œâ”€â”€ feedback_widget.dart
â”‚   â”‚           â””â”€â”€ countdown_timer.dart    # FR-004-1
â”‚   â”‚
â”‚   â”œâ”€â”€ history/                       # å±¥æ­´æ©Ÿèƒ½(FR-008)
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ pages/
â”‚   â”‚       â”‚   â””â”€â”€ history_page.dart       # 3.11 å±¥æ­´ç”»é¢
â”‚   â”‚       â”œâ”€â”€ providers/
â”‚   â”‚       â””â”€â”€ widgets/
â”‚   â”‚           â”œâ”€â”€ calendar_view.dart
â”‚   â”‚           â””â”€â”€ chart_view.dart
â”‚   â”‚
â”‚   â””â”€â”€ billing/                       # èª²é‡‘æ©Ÿèƒ½(FR-020-023)
â”‚       â”œâ”€â”€ data/
â”‚       â”‚   â”œâ”€â”€ datasources/
â”‚       â”‚   â”‚   â””â”€â”€ revenue_cat_datasource.dart
â”‚       â”‚   â”œâ”€â”€ models/
â”‚       â”‚   â””â”€â”€ repositories/
â”‚       â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ entities/
â”‚       â”‚   â”œâ”€â”€ repositories/
â”‚       â”‚   â””â”€â”€ usecases/
â”‚       â”‚       â”œâ”€â”€ purchase_subscription.dart
â”‚       â”‚       â”œâ”€â”€ restore_purchase.dart
â”‚       â”‚       â””â”€â”€ cancel_subscription.dart
â”‚       â””â”€â”€ presentation/
â”‚           â”œâ”€â”€ pages/
â”‚           â”‚   â”œâ”€â”€ billing_page.dart         # 3.14 èª²é‡‘ç”»é¢
â”‚           â”‚   â””â”€â”€ subscription_page.dart    # 3.15 ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ç”»é¢
â”‚           â”œâ”€â”€ providers/
â”‚           â””â”€â”€ widgets/
â”‚
â”œâ”€â”€ shared/                            # å…±æœ‰ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ»ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”œâ”€â”€ bottom_navigation.dart     # NFR-031
â”‚   â”‚   â”œâ”€â”€ custom_button.dart
â”‚   â”‚   â””â”€â”€ loading_indicator.dart
â”‚   â””â”€â”€ providers/
â”‚       â””â”€â”€ app_lifecycle_provider.dart
â”‚
â””â”€â”€ l10n/                              # å¤šè¨€èªå¯¾å¿œ
    â”œâ”€â”€ app_ja.arb
    â””â”€â”€ app_en.arb
```

### 5.3 çŠ¶æ…‹ç®¡ç†è¨­è¨ˆ(Riverpod)

#### 5.3.1 Provideræ§‹æˆ

```dart
// èªè¨¼çŠ¶æ…‹
final authStateProvider = StreamProvider<User?>((ref) {
  return FirebaseAuth.instance.authStateChanges();
});

// åŒæ„çŠ¶æ…‹(FR-002-1, FR-024-1)
final consentStateProvider = FutureProvider<ConsentState>((ref) async {
  final user = ref.watch(authStateProvider).value;
  if (user == null) return ConsentState.notRequired();
  
  final consentRepo = ref.read(consentRepositoryProvider);
  return await consentRepo.getConsentState(user.uid);
});

// ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³
final trainingSessionProvider = StateNotifierProvider<TrainingSessionNotifier, TrainingSession?>((ref) {
  return TrainingSessionNotifier();
});

// ãƒãƒ¼ã‚ºæ¤œå‡º
final poseDetectionProvider = StateNotifierProvider<PoseDetectionNotifier, PoseState>((ref) {
  return PoseDetectionNotifier();
});
```

#### 5.3.2 åŒæ„çŠ¶æ…‹ç®¡ç†(FR-002-1, FR-024-1)

```dart
@freezed
class ConsentState with _$ConsentState {
  const factory ConsentState({
    required bool termsAccepted,
    required bool privacyPolicyAccepted,
    required DateTime? acceptedAt,
    required String? termsVersion,      // åˆ©ç”¨è¦ç´„v3.1
    required String? privacyVersion,    // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼v3.1
  }) = _ConsentState;
  
  // æœ€æ–°ç‰ˆã«åŒæ„æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  bool get isConsentedToLatest {
    return termsAccepted && 
           privacyPolicyAccepted &&
           termsVersion == '3.1' &&
           privacyVersion == '3.1';
  }
}
```

### 5.4 ã‚«ãƒ¡ãƒ©æ˜ åƒå‡¦ç†(NFR-015)

#### 5.4.1 ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†ãƒ•ãƒ­ãƒ¼

```dart
class PoseDetectionService {
  final PoseDetector _poseDetector;
  
  Future<SkeletonData?> processFrame(CameraImage image) async {
    try {
      // 1. MediaPipe Poseã§éª¨æ ¼æ¤œå‡º
      final inputImage = _convertToInputImage(image);
      final poses = await _poseDetector.processImage(inputImage);
      
      // 2. ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’å³åº§ã«ç ´æ£„(ãƒ¡ãƒ¢ãƒªã‹ã‚‰å‰Šé™¤)
      image.dispose();  // âš ï¸ é‡è¦: ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãªã„
      
      if (poses.isEmpty) return null;
      
      // 3. éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
      final pose = poses.first;
      final skeletonData = SkeletonData(
        landmarks: pose.landmarks.map((landmark) => LandmarkData(
          x: landmark.x,
          y: landmark.y,
          z: landmark.z,
          confidence: landmark.likelihood,
        )).toList(),
        timestamp: DateTime.now(),
      );
      
      return skeletonData;
    } catch (e) {
      _logger.error('Pose detection failed', error: e);
      return null;
    }
  }
  
  InputImage _convertToInputImage(CameraImage image) {
    // CameraImageã‚’InputImageã«å¤‰æ›
    // å®Ÿè£…è©³ç´°ã¯çœç•¥
  }
}
```

#### 5.4.2 ãƒ‡ãƒ¼ã‚¿é€ä¿¡(éª¨æ ¼åº§æ¨™ã®ã¿)

```dart
class TrainingRepository {
  final FirebaseFirestore _firestore;
  
  Future<void> saveSkeletonData({
    required String userId,
    required String sessionId,
    required SkeletonData skeletonData,
  }) async {
    // éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’Firestoreã«ä¿å­˜
    await _firestore
        .collection('users')
        .doc(userId)
        .collection('sessions')
        .doc(sessionId)
        .collection('skeleton_data')
        .add({
      'landmarks': skeletonData.landmarks.map((l) => {
        'x': l.x,
        'y': l.y,
        'z': l.z,
        'confidence': l.confidence,
      }).toList(),
      'timestamp': FieldValue.serverTimestamp(),
    });
    
    // âš ï¸ ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ä¸€åˆ‡é€ä¿¡ã—ãªã„
  }
}
```

### 5.5 è‡ªå‹•é–‹å§‹æ©Ÿèƒ½(FR-004-1)

#### 5.5.1 ã‚«ãƒ¡ãƒ©è¨­å®šç”»é¢ã®è‡ªå‹•é–‹å§‹ãƒ­ã‚¸ãƒƒã‚¯

```dart
class CameraSetupProvider extends StateNotifier<CameraSetupState> {
  Timer? _countdownTimer;
  
  // ãƒã‚§ãƒƒã‚¯é …ç›®ã®çŠ¶æ…‹
  void updateCheckItem(CheckItemType type, bool isChecked) {
    state = state.copyWith(
      checkItems: {...state.checkItems, type: isChecked},
    );
    
    // å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯é …ç›®ãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸã‹ç¢ºèª
    if (state.allChecksPassed) {
      _startCountdown();
    } else {
      _cancelCountdown();
    }
  }
  
  // 3ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
  void _startCountdown() {
    state = state.copyWith(countdown: 3);
    
    _countdownTimer = Timer.periodic(
      const Duration(seconds: 1),
      (timer) {
        if (state.countdown == 1) {
          timer.cancel();
          _startTraining();  // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è‡ªå‹•é–‹å§‹
        } else {
          state = state.copyWith(countdown: state.countdown - 1);
        }
      },
    );
  }
  
  void _cancelCountdown() {
    _countdownTimer?.cancel();
    state = state.copyWith(countdown: null);
  }
  
  void _startTraining() {
    // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œç”»é¢ã«é·ç§»
    ref.read(routerProvider).push('/training');
  }
}

@freezed
class CameraSetupState with _$CameraSetupState {
  const factory CameraSetupState({
    required Map<CheckItemType, bool> checkItems,
    int? countdown,  // null: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãªã—, 1-3: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­
  }) = _CameraSetupState;
  
  bool get allChecksPassed => checkItems.values.every((v) => v);
}

enum CheckItemType {
  cameraPermission,
  positioning,
  lighting,
}
```

---

**ç¶šãã¯Part 2ã§...**

ã“ã®Part 1ã§ã¯ã€ä»¥ä¸‹ã‚’è©³ç´°ã«è¨­è¨ˆã—ã¾ã—ãŸ:
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦ã¨ç›®çš„
- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡(ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒã‚¤ãƒ‡ã‚¶ã‚¤ãƒ³ç­‰)
- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯(Flutter, Firebase, å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹)
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(Clean Architecture + MVVM)

Part 2ã§ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã€APIè¨­è¨ˆã€èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è©³ç´°ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ v3.2 (Part 2/3)

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒª(ä»®ç§°)  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.2 (MVP)

---

## 6. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 6.1 Firebase Functionsæ§‹æˆ

#### 6.1.1 Functionsä¸€è¦§

| Functionå | ãƒˆãƒªã‚¬ãƒ¼ | å‡¦ç†å†…å®¹ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒ¡ãƒ¢ãƒª |
|-----------|---------|---------|------------|--------|
| **onUserCreate** | Auth Trigger | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã®åˆæœŸè¨­å®š | 60s | 256MB |
| **onUserDelete** | Auth Trigger | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— | 300s | 512MB |
| **stripeWebhook** | HTTPS | Stripe Webhookå‡¦ç† | 60s | 256MB |
| **exportUserData** | HTTPS | GDPRå¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | 300s | 512MB |
| **deleteUserData** | HTTPS | GDPRå¯¾å¿œãƒ‡ãƒ¼ã‚¿å‰Šé™¤ | 300s | 512MB |
| **sendNotification** | HTTPS | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡ | 30s | 128MB |
| **dailyBigQueryExport** | Scheduled | BigQueryã¸ã®ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | 540s | 1GB |
| **cleanupExpiredData** | Scheduled | æœŸé™åˆ‡ã‚Œãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ | 540s | 512MB |
| **checkSubscriptionStatus** | Scheduled | ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹ã®åŒæœŸ | 300s | 256MB |

#### 6.1.2 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
functions/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                      # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ firebase.ts               # FirebaseåˆæœŸåŒ–
â”‚   â”‚   â””â”€â”€ stripe.ts                 # Stripeè¨­å®š
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ onCreate.ts               # onUserCreate
â”‚   â”‚   â””â”€â”€ onDelete.ts               # onUserDelete
â”‚   â”œâ”€â”€ billing/
â”‚   â”‚   â”œâ”€â”€ stripeWebhook.ts          # Stripe Webhook
â”‚   â”‚   â””â”€â”€ subscriptionService.ts    # ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†
â”‚   â”œâ”€â”€ gdpr/
â”‚   â”‚   â”œâ”€â”€ exportUserData.ts         # ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ deleteUserData.ts         # ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
â”‚   â”‚   â””â”€â”€ consentService.ts         # åŒæ„ç®¡ç†(FR-024, FR-024-1)
â”‚   â”œâ”€â”€ notifications/
â”‚   â”‚   â””â”€â”€ sendNotification.ts       # é€šçŸ¥é€ä¿¡
â”‚   â”œâ”€â”€ scheduled/
â”‚   â”‚   â”œâ”€â”€ bigqueryExport.ts         # BigQueryã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ cleanupExpiredData.ts     # ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
â”‚   â”‚   â””â”€â”€ checkSubscriptionStatus.ts # ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”œâ”€â”€ validators.ts
â”‚   â”‚   â””â”€â”€ encryption.ts             # æš—å·åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ user.ts
â”‚       â”œâ”€â”€ session.ts
â”‚       â””â”€â”€ subscription.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ .eslintrc.js
```

#### 6.1.3 ä¸»è¦Functionå®Ÿè£…ä¾‹

##### onUserCreate (ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚)

```typescript
import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';

export const onUserCreate = functions.auth.user().onCreate(async (user) => {
  const userId = user.uid;
  const email = user.email;
  
  try {
    // 1. Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
    await admin.firestore().collection('users').doc(userId).set({
      email: email,
      displayName: user.displayName || null,
      photoURL: user.photoURL || null,
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åˆæœŸå€¤(å¾Œã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›)
      profile: {
        height: null,
        weight: null,
        age: null,
        gender: null,
      },
      
      // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åˆæœŸå€¤
      subscription: {
        status: 'trial',  // 1é€±é–“ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«
        trialStartedAt: admin.firestore.FieldValue.serverTimestamp(),
        trialEndsAt: admin.firestore.Timestamp.fromDate(
          new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)  // 7æ—¥å¾Œ
        ),
        plan: null,
        revenueCatId: null,
      },
      
      // åŒæ„çŠ¶æ…‹åˆæœŸå€¤(FR-002-1, FR-024, FR-024-1)
      consents: {
        terms: {
          accepted: false,
          version: null,
          acceptedAt: null,
        },
        privacyPolicy: {
          accepted: false,
          version: null,
          acceptedAt: null,
        },
      },
    });
    
    // 2. ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡(SendGrid)
    await sendWelcomeEmail(email);
    
    functions.logger.info(`User created: ${userId}`);
  } catch (error) {
    functions.logger.error('Error creating user document', { error, userId });
    throw error;
  }
});
```

##### exportUserData (GDPRå¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)

```typescript
import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';

export const exportUserData = functions.https.onCall(async (request) => {
  const userId = request.auth?.uid;
  if (!userId) {
    throw new functions.https.HttpsError('unauthenticated', 'User not authenticated');
  }
  
  try {
    const db = admin.firestore();
    
    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
    const userDoc = await db.collection('users').doc(userId).get();
    const userData = userDoc.data();
    
    // 2. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—
    const sessionsSnapshot = await db
      .collection('users')
      .doc(userId)
      .collection('sessions')
      .orderBy('createdAt', 'desc')
      .get();
    
    const sessions = sessionsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
    }));
    
    // 3. åŒæ„å±¥æ­´å–å¾—
    const consentsSnapshot = await db
      .collection('users')
      .doc(userId)
      .collection('consent_history')
      .orderBy('timestamp', 'desc')
      .get();
    
    const consents = consentsSnapshot.docs.map(doc => doc.data());
    
    // 4. JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    const exportData = {
      user: userData,
      sessions: sessions,
      consents: consents,
      exportedAt: new Date().toISOString(),
      dataSubject: 'GDPR Article 15 & 20',
    };
    
    // 5. ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡(SendGrid)
    await sendDataExportEmail(userData.email, exportData);
    
    // 6. ãƒ­ã‚°è¨˜éŒ²
    await db.collection('gdpr_requests').add({
      userId: userId,
      type: 'export',
      requestedAt: admin.firestore.FieldValue.serverTimestamp(),
      status: 'completed',
    });
    
    return { success: true, message: 'Data export sent to your email' };
  } catch (error) {
    functions.logger.error('Error exporting user data', { error, userId });
    throw new functions.https.HttpsError('internal', 'Failed to export data');
  }
});
```

##### dailyBigQueryExport (BigQueryã¸ã®æ—¥æ¬¡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)

```typescript
import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';
import { BigQuery } from '@google-cloud/bigquery';

export const dailyBigQueryExport = functions.scheduler
  .onSchedule('0 2 * * *', async (event) => {  // æ¯æ—¥2:00 JST
    const db = admin.firestore();
    const bigquery = new BigQuery();
    
    try {
      // å‰æ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.setHours(0, 0, 0, 0);
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const sessionsSnapshot = await db
        .collectionGroup('sessions')
        .where('createdAt', '>=', admin.firestore.Timestamp.fromDate(yesterday))
        .where('createdAt', '<', admin.firestore.Timestamp.fromDate(today))
        .get();
      
      if (sessionsSnapshot.empty) {
        functions.logger.info('No sessions to export');
        return;
      }
      
      // BigQueryã«æŒ¿å…¥ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™(ä»®ååŒ–)
      const rows = sessionsSnapshot.docs.map(doc => {
        const data = doc.data();
        const userId = doc.ref.parent.parent?.id;
        
        return {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒãƒƒã‚·ãƒ¥åŒ–(ä»®ååŒ–ã€NFR-016)
          user_id_hash: hashUserId(userId),
          session_id: doc.id,
          exercise_type: data.exerciseType,
          duration_seconds: data.durationSeconds,
          total_reps: data.totalReps,
          average_score: data.averageScore,
          created_at: data.createdAt.toDate(),
          
          // éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã¯å«ã‚ãªã„(ã‚µã‚¤ã‚ºãŒå¤§ãã„ãŸã‚åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«)
        };
      });
      
      // BigQueryã«ã‚¤ãƒ³ã‚µãƒ¼ãƒˆ
      const datasetId = 'fitness_analytics';
      const tableId = 'training_sessions';
      
      await bigquery
        .dataset(datasetId)
        .table(tableId)
        .insert(rows);
      
      functions.logger.info(`Exported ${rows.length} sessions to BigQuery`);
    } catch (error) {
      functions.logger.error('Error exporting to BigQuery', error);
      throw error;
    }
  });

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãƒãƒƒã‚·ãƒ¥åŒ–(ä»®ååŒ–)
function hashUserId(userId: string): string {
  const crypto = require('crypto');
  return crypto.createHash('sha256').update(userId).digest('hex');
}
```

##### stripeWebhook (Stripe Webhookå‡¦ç†)

```typescript
import * as functions from 'firebase-functions/v2';
import * as admin from 'firebase-admin';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16',
});

export const stripeWebhook = functions.https.onRequest(async (req, res) => {
  const sig = req.headers['stripe-signature'] as string;
  const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET!;
  
  let event: Stripe.Event;
  
  try {
    event = stripe.webhooks.constructEvent(req.rawBody, sig, endpointSecret);
  } catch (err) {
    functions.logger.error('Webhook signature verification failed', err);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }
  
  const db = admin.firestore();
  
  try {
    switch (event.type) {
      case 'customer.subscription.created':
      case 'customer.subscription.updated': {
        const subscription = event.data.object as Stripe.Subscription;
        const customerId = subscription.customer as string;
        
        // ã‚«ã‚¹ã‚¿ãƒãƒ¼IDã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
        const userId = await getUserIdFromCustomerId(customerId);
        if (!userId) {
          throw new Error('User not found for customer');
        }
        
        // Firestoreã®ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹ã‚’æ›´æ–°
        await db.collection('users').doc(userId).update({
          'subscription.status': subscription.status,
          'subscription.currentPeriodStart': admin.firestore.Timestamp.fromDate(
            new Date(subscription.current_period_start * 1000)
          ),
          'subscription.currentPeriodEnd': admin.firestore.Timestamp.fromDate(
            new Date(subscription.current_period_end * 1000)
          ),
          'subscription.stripeSubscriptionId': subscription.id,
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        });
        
        break;
      }
      
      case 'customer.subscription.deleted': {
        const subscription = event.data.object as Stripe.Subscription;
        const customerId = subscription.customer as string;
        const userId = await getUserIdFromCustomerId(customerId);
        
        if (userId) {
          await db.collection('users').doc(userId).update({
            'subscription.status': 'canceled',
            'subscription.canceledAt': admin.firestore.FieldValue.serverTimestamp(),
            updatedAt: admin.firestore.FieldValue.serverTimestamp(),
          });
        }
        
        break;
      }
      
      case 'invoice.payment_failed': {
        const invoice = event.data.object as Stripe.Invoice;
        const customerId = invoice.customer as string;
        const userId = await getUserIdFromCustomerId(customerId);
        
        if (userId) {
          // æ”¯æ‰•ã„å¤±æ•—é€šçŸ¥ã‚’é€ä¿¡
          await sendPaymentFailedNotification(userId);
        }
        
        break;
      }
      
      default:
        functions.logger.info(`Unhandled event type: ${event.type}`);
    }
    
    res.json({ received: true });
  } catch (error) {
    functions.logger.error('Error processing webhook', error);
    res.status(500).send('Webhook processing failed');
  }
});

async function getUserIdFromCustomerId(customerId: string): Promise<string | null> {
  const db = admin.firestore();
  const snapshot = await db
    .collection('users')
    .where('subscription.stripeCustomerId', '==', customerId)
    .limit(1)
    .get();
  
  return snapshot.empty ? null : snapshot.docs[0].id;
}
```

---

## 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 7.1 Firestore ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### 7.1.1 ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ 

```
firestore/
â”œâ”€â”€ users/                                    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
â”‚   â””â”€â”€ {userId}/
â”‚       â”œâ”€â”€ (document)                        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚       â”œâ”€â”€ sessions/                         # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³
â”‚       â”‚   â””â”€â”€ {sessionId}/
â”‚       â”‚       â”œâ”€â”€ (document)                # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚       â”‚       â””â”€â”€ skeleton_data/            # éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿
â”‚       â”‚           â””â”€â”€ {frameId}/
â”‚       â”‚               â””â”€â”€ (document)
â”‚       â”œâ”€â”€ consent_history/                  # åŒæ„å±¥æ­´(FR-024)
â”‚       â”‚   â””â”€â”€ {consentId}/
â”‚       â”‚       â””â”€â”€ (document)
â”‚       â””â”€â”€ gdpr_requests/                    # GDPRæ¨©åˆ©è¡Œä½¿å±¥æ­´
â”‚           â””â”€â”€ {requestId}/
â”‚               â””â”€â”€ (document)
â”œâ”€â”€ exercises/                                # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç¨®ç›®ãƒã‚¹ã‚¿
â”‚   â””â”€â”€ {exerciseId}/
â”‚       â””â”€â”€ (document)
â””â”€â”€ notifications/                            # é€šçŸ¥å±¥æ­´
    â””â”€â”€ {notificationId}/
        â””â”€â”€ (document)
```

#### 7.1.2 users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface User {
  // åŸºæœ¬æƒ…å ±
  email: string;
  displayName: string | null;
  photoURL: string | null;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«(FR-002)
  profile: {
    height: number | null;           // cm
    weight: number | null;           // kg
    age: number | null;              // æ­³
    gender: 'male' | 'female' | 'other' | null;
  };
  
  // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³(FR-020-023)
  subscription: {
    status: 'trial' | 'active' | 'past_due' | 'canceled' | 'inactive';
    trialStartedAt: Timestamp | null;
    trialEndsAt: Timestamp | null;
    currentPeriodStart: Timestamp | null;
    currentPeriodEnd: Timestamp | null;
    plan: 'basic' | null;            // MVPæœŸã¯1ãƒ—ãƒ©ãƒ³ã®ã¿
    stripeCustomerId: string | null;
    stripeSubscriptionId: string | null;
    revenueCatId: string | null;
  };
  
  // åŒæ„çŠ¶æ…‹(FR-002-1, FR-024, FR-024-1)
  consents: {
    terms: {
      accepted: boolean;
      version: string | null;        // ä¾‹: "3.1"
      acceptedAt: Timestamp | null;
    };
    privacyPolicy: {
      accepted: boolean;
      version: string | null;        // ä¾‹: "3.1"
      acceptedAt: Timestamp | null;
    };
  };
  
  // è¨­å®š(FR-016)
  settings: {
    voiceFeedbackEnabled: boolean;   // éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    voiceVolume: number;             // éŸ³é‡(0.0-1.0)
    notificationsEnabled: boolean;   // é€šçŸ¥
    language: 'ja' | 'en';           // è¨€èª
  };
  
  // çµ±è¨ˆæƒ…å ±(ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
  stats: {
    totalSessions: number;
    totalDuration: number;           // ç§’
    lastTrainingDate: Timestamp | null;
    favoriteExercise: string | null;
  };
}
```

**Security Rules**:

```javascript
match /users/{userId} {
  // è‡ªåˆ†ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿èª­ã¿æ›¸ãå¯èƒ½
  allow read, write: if request.auth != null && request.auth.uid == userId;
  
  // åŒæ„çŠ¶æ…‹ã®æ›´æ–°ã¯å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
  allow update: if request.auth.uid == userId &&
    request.resource.data.consents.terms.accepted is bool &&
    request.resource.data.consents.privacyPolicy.accepted is bool;
}
```

**ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‹ã‚‰30æ—¥ä»¥å†…ã«å®Œå…¨å‰Šé™¤(GDPRç¬¬17æ¡)

#### 7.1.3 sessions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface Session {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
  exerciseType: string;             // ç¨®ç›®ID
  exerciseName: string;             // ç¨®ç›®å
  startedAt: Timestamp;
  endedAt: Timestamp | null;
  durationSeconds: number;
  
  // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœ
  totalReps: number;                // ç·å›æ•°
  completedReps: number;            // å®Œäº†å›æ•°
  targetReps: number;               // ç›®æ¨™å›æ•°
  
  // ã‚¹ã‚³ã‚¢(å‚è€ƒæƒ…å ±ã€åˆ©ç”¨è¦ç´„ç¬¬1.2æ¡)
  averageScore: number;             // å¹³å‡ã‚¹ã‚³ã‚¢(0-100)
  bestScore: number;                // æœ€é«˜ã‚¹ã‚³ã‚¢
  scoreHistory: number[];           // å„ãƒ¬ãƒƒãƒ—ã®ã‚¹ã‚³ã‚¢
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  deviceInfo: {
    platform: 'iOS' | 'Android';
    osVersion: string;
    appVersion: string;
  };
  
  // åŒæ„ç¢ºèª(ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«åŒæ„æ¸ˆã¿ã‹è¨˜éŒ²)
  consentVersion: {
    terms: string;                  // ä¾‹: "3.1"
    privacyPolicy: string;          // ä¾‹: "3.1"
  };
  
  createdAt: Timestamp;
}
```

**Security Rules**:

```javascript
match /users/{userId}/sessions/{sessionId} {
  // è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿èª­ã¿æ›¸ãå¯èƒ½
  allow read, write: if request.auth != null && request.auth.uid == userId;
  
  // ä½œæˆæ™‚ã¯å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
  allow create: if request.auth.uid == userId &&
    request.resource.data.exerciseType is string &&
    request.resource.data.startedAt is timestamp;
}
```

**ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“**: 
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: ç„¡æœŸé™(GDPRç¬¬6æ¡1é …(a)åŒæ„)
- é€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼: 30æ—¥ä»¥å†…ã«å‰Šé™¤

#### 7.1.4 skeleton_data ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface SkeletonData {
  // éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿(33å€‹ã®é–¢ç¯€)
  landmarks: Array<{
    x: number;                      // 0.0-1.0(æ­£è¦åŒ–åº§æ¨™)
    y: number;                      // 0.0-1.0(æ­£è¦åŒ–åº§æ¨™)
    z: number;                      // æ·±åº¦æƒ…å ±
    confidence: number;             // ä¿¡é ¼åº¦(0.0-1.0)
  }>;
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  frameIndex: number;               // ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·
  timestamp: Timestamp;             // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  
  // å‚è€ƒæƒ…å ±(åˆ©ç”¨è¦ç´„ç¬¬1.2æ¡)
  formScore: number | null;         // ãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚³ã‚¢(0-100)
  feedback: string | null;          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
}
```

**Security Rules**:

```javascript
match /users/{userId}/sessions/{sessionId}/skeleton_data/{frameId} {
  // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  allow read, write: if request.auth != null && request.auth.uid == userId;
}
```

**ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨åŒã˜

**ã‚µã‚¤ã‚ºè¦‹ç©ã‚‚ã‚Š**:
- 1ãƒ•ãƒ¬ãƒ¼ãƒ : ç´„2KB
- 30fps Ã— 600ç§’(10åˆ†) = 18,000ãƒ•ãƒ¬ãƒ¼ãƒ 
- 18,000 Ã— 2KB = 36MB/ã‚»ãƒƒã‚·ãƒ§ãƒ³

#### 7.1.5 consent_history ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

```typescript
interface ConsentHistory {
  // åŒæ„ç¨®åˆ¥
  type: 'terms' | 'privacy_policy';
  
  // åŒæ„å†…å®¹
  version: string;                  // ä¾‹: "3.1"
  accepted: boolean;                // true: åŒæ„, false: åŒæ„è§£é™¤
  
  // æ³•çš„æ ¹æ‹ 
  legalBasis: 'consent' | 'legitimate_interest';  // GDPRç¬¬6æ¡
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  timestamp: Timestamp;
  ipAddress: string | null;         // åŒ¿ååŒ–
  userAgent: string | null;
  
  // èª¬æ˜
  description: string;              // ä¾‹: "åˆ©ç”¨è¦ç´„v3.1ã«åŒæ„"
}
```

**Security Rules**:

```javascript
match /users/{userId}/consent_history/{consentId} {
  // èª­ã¿å–ã‚Šå°‚ç”¨(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®åŒæ„å±¥æ­´ã‚’ç¢ºèªå¯èƒ½)
  allow read: if request.auth != null && request.auth.uid == userId;
  
  // æ›¸ãè¾¼ã¿ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿
  allow write: if false;
}
```

**ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“**: 
- åŒæ„å±¥æ­´ã¯å‰Šé™¤ã—ãªã„(æ³•çš„ç¾©å‹™ã€GDPRç¬¬7æ¡3é …)
- ãŸã ã—ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä»®ååŒ–

#### 7.1.6 exercises ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³(ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿)

```typescript
interface Exercise {
  // åŸºæœ¬æƒ…å ±
  id: string;                       // ä¾‹: "squat"
  name: {
    ja: string;                     // æ—¥æœ¬èªå
    en: string;                     // è‹±èªå
  };
  description: {
    ja: string;
    en: string;
  };
  
  // ã‚«ãƒ†ã‚´ãƒª
  category: 'lower_body' | 'upper_body' | 'core' | 'full_body';
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  
  // MVPæœŸã®5ç¨®ç›®
  isAvailableInMVP: boolean;
  
  // ç”»åƒãƒ»å‹•ç”»
  thumbnailURL: string;
  demoVideoURL: string | null;
  
  // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  defaultReps: number;              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›æ•°
  defaultSets: number;              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆæ•°
  restTime: number;                 // ä¼‘æ†©æ™‚é–“(ç§’)
  
  // MediaPipe Poseè¨­å®š
  keyLandmarks: number[];           // é‡è¦ãªé–¢ç¯€ç•ªå·
  
  // å‚è€ƒæƒ…å ±(åˆ©ç”¨è¦ç´„ç¬¬1.2æ¡)
  formCheckpoints: Array<{
    name: string;
    description: string;
    threshold: number;              // ã‚¹ã‚³ã‚¢é–¾å€¤
  }>;
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  createdAt: Timestamp;
  updatedAt: Timestamp;
  order: number;                    // è¡¨ç¤ºé †åº
}
```

**MVPæœŸã®5ç¨®ç›®**:
1. ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ(squat)
2. ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—(push_up)
3. ãƒ—ãƒ©ãƒ³ã‚¯(plank)
4. ãƒ©ãƒ³ã‚¸(lunge)
5. ãƒã‚¦ãƒ³ãƒ†ãƒ³ã‚¯ãƒ©ã‚¤ãƒãƒ¼(mountain_climber)

**Security Rules**:

```javascript
match /exercises/{exerciseId} {
  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã¿å–ã‚Šå¯èƒ½
  allow read: if request.auth != null;
  
  // æ›¸ãè¾¼ã¿ã¯ç®¡ç†è€…ã®ã¿
  allow write: if false;
}
```

### 7.2 Firestore ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

#### 7.2.1 è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```yaml
# firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION_GROUP",
      "fields": [
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "consent_history",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "type", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ]
    }
  ]
}
```

### 7.3 BigQuery ã‚¹ã‚­ãƒ¼ãƒ

#### 7.3.1 ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ§‹æˆ

```
fitness_analytics/              # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
â”œâ”€â”€ training_sessions           # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³(æ—¥æ¬¡ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)
â”œâ”€â”€ user_stats                  # ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ(é€±æ¬¡é›†è¨ˆ)
â””â”€â”€ exercise_performance        # ç¨®ç›®åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹(é€±æ¬¡é›†è¨ˆ)
```

#### 7.3.2 training_sessions ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE fitness_analytics.training_sessions (
  -- ä»®ååŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  user_id_hash STRING NOT NULL,
  
  -- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
  session_id STRING NOT NULL,
  exercise_type STRING NOT NULL,
  duration_seconds INT64 NOT NULL,
  
  -- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœ
  total_reps INT64 NOT NULL,
  completed_reps INT64 NOT NULL,
  average_score FLOAT64,
  best_score FLOAT64,
  
  -- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±
  platform STRING,              -- 'iOS' or 'Android'
  os_version STRING,
  app_version STRING,
  
  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMP NOT NULL,
  
  -- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ»ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
  _PARTITIONTIME DATE,
)
PARTITION BY DATE(created_at)
CLUSTER BY user_id_hash, exercise_type;
```

**ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æˆ¦ç•¥**: æ—¥æ¬¡ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³(created_at)
**ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°**: user_id_hash, exercise_type
**ä¿å­˜æœŸé–“**: 3å¹´(è‡ªå‹•å‰Šé™¤)

---

## 8. APIè¨­è¨ˆ

### 8.1 Firebase Functions HTTP API

#### 8.1.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èªè¨¼ | èª¬æ˜ |
|--------------|---------|------|------|
| `/exportUserData` | POST | å¿…é ˆ | GDPRå¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ |
| `/deleteUserData` | POST | å¿…é ˆ | GDPRå¯¾å¿œãƒ‡ãƒ¼ã‚¿å‰Šé™¤ |
| `/updateConsent` | POST | å¿…é ˆ | åŒæ„çŠ¶æ…‹æ›´æ–°(FR-024) |
| `/sendNotification` | POST | å¿…é ˆ | é€šçŸ¥é€ä¿¡ |
| `/stripeWebhook` | POST | ä¸è¦ | Stripe Webhookå—ä¿¡ |
| `/getExercises` | GET | å¿…é ˆ | ç¨®ç›®ãƒã‚¹ã‚¿å–å¾— |
| `/getSessionHistory` | GET | å¿…é ˆ | ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´å–å¾— |

#### 8.1.2 APIä»•æ§˜

##### POST /exportUserData

**èª¬æ˜**: GDPRç¬¬15æ¡(ã‚¢ã‚¯ã‚»ã‚¹æ¨©)ã¨ç¬¬20æ¡(ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£æ¨©)ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```typescript
{
  // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿(Firebase Auth)
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  success: boolean;
  message: string;
  estimatedTime: string;  // ä¾‹: "5-10 minutes"
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. èªè¨¼ç¢ºèª
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åé›†(Firestore)
3. JSONå½¢å¼ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
4. ãƒ¡ãƒ¼ãƒ«é€ä¿¡(SendGrid)
5. GDPRå±¥æ­´è¨˜éŒ²

**ã‚¨ãƒ©ãƒ¼**:
- 401: èªè¨¼ã‚¨ãƒ©ãƒ¼
- 500: å†…éƒ¨ã‚¨ãƒ©ãƒ¼

##### POST /deleteUserData

**èª¬æ˜**: GDPRç¬¬17æ¡(å‰Šé™¤æ¨©)ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿å‰Šé™¤

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```typescript
{
  confirmation: string;  // "DELETE" ã‚’å…¥åŠ›
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  success: boolean;
  message: string;
  deletionScheduled: string;  // ISO 8601å½¢å¼ã®æ—¥æ™‚
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. èªè¨¼ç¢ºèª
2. ç¢ºèªæ–‡å­—åˆ—ãƒã‚§ãƒƒã‚¯
3. Firebase Authã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
4. Firestoreãƒ‡ãƒ¼ã‚¿å‰Šé™¤(30æ—¥ä»¥å†…)
5. BigQueryãƒ‡ãƒ¼ã‚¿ä»®ååŒ–

**ã‚¨ãƒ©ãƒ¼**:
- 400: ç¢ºèªæ–‡å­—åˆ—ä¸æ­£
- 401: èªè¨¼ã‚¨ãƒ©ãƒ¼
- 500: å†…éƒ¨ã‚¨ãƒ©ãƒ¼

##### POST /updateConsent (FR-024, FR-024-1)

**èª¬æ˜**: åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„çŠ¶æ…‹ã‚’æ›´æ–°

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```typescript
{
  type: 'terms' | 'privacy_policy';
  accepted: boolean;
  version: string;  // ä¾‹: "3.1"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  success: boolean;
  consent: {
    type: string;
    accepted: boolean;
    version: string;
    acceptedAt: string;  // ISO 8601
  }
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. èªè¨¼ç¢ºèª
2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œè¨¼
3. Firestoreæ›´æ–°(users/{userId})
4. åŒæ„å±¥æ­´è¨˜éŒ²(consent_history)
5. åŒæ„è§£é™¤ã®å ´åˆ: å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

**ã‚¨ãƒ©ãƒ¼**:
- 400: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸æ­£
- 401: èªè¨¼ã‚¨ãƒ©ãƒ¼
- 500: å†…éƒ¨ã‚¨ãƒ©ãƒ¼

### 8.2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆâ†’Firebaseç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹

ä»¥ä¸‹ã¯Firebase SDKã‚’é€šã˜ã¦ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹:

- Firebase Authentication(èªè¨¼)
- Cloud Firestore(ãƒ‡ãƒ¼ã‚¿èª­ã¿æ›¸ã)
- Firebase Storage(ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
- Firebase Cloud Messaging(ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥å—ä¿¡)

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Security Rulesã§ä¿è­·

---

## 9. èªè¨¼ãƒ»èªå¯

### 9.1 èªè¨¼ãƒ•ãƒ­ãƒ¼

#### 9.1.1 æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```
[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]                [Firebase Auth]              [Firestore]
     â”‚                              â”‚                            â”‚
     â”œâ”€ ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› â”€â”€â”€â”€â†’â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”œâ”€ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ            â”‚
     â”‚                              â”‚   (onUserCreate trigger)   â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                              â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ    â”‚
     â”‚                              â”‚  - consentsåˆæœŸå€¤(æœªåŒæ„)  â”‚
     â”‚                              â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚                            â”‚
     â”‚â†â”€ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³(JWT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”œâ”€ åˆ©ç”¨è¦ç´„åŒæ„ç”»é¢è¡¨ç¤º         â”‚                            â”‚
     â”‚   (FR-024, å¼·åˆ¶è¡¨ç¤º)          â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”œâ”€ åŒæ„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                              â”‚  consentsæ›´æ–°              â”‚
     â”‚                              â”‚  consent_historyè¨˜éŒ²       â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚                            â”‚
     â”œâ”€ èº«ä½“æƒ…å ±å…¥åŠ›ç”»é¢è¡¨ç¤º         â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”œâ”€ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                              â”‚  profileæ›´æ–°               â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚                            â”‚
     â””â”€ ãƒ›ãƒ¼ãƒ ç”»é¢ã¸é·ç§»             â”‚                            â”‚
```

#### 9.1.2 ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼(FR-024-1)

```
[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]                [Firebase Auth]              [Firestore]
     â”‚                              â”‚                            â”‚
     â”œâ”€ ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› â”€â”€â”€â”€â†’â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”œâ”€ èªè¨¼å‡¦ç†                  â”‚
     â”‚                              â”‚                            â”‚
     â”‚â†â”€ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³(JWT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”œâ”€ åŒæ„çŠ¶æ…‹ç¢ºèª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                              â”‚  consentså–å¾—              â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                              â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”œâ”€ æœªåŒæ„ã®å ´åˆ:                â”‚                            â”‚
     â”‚   åˆ©ç”¨è¦ç´„åŒæ„ç”»é¢è¡¨ç¤º(å¼·åˆ¶)   â”‚                            â”‚
     â”‚                              â”‚                            â”‚
     â”‚   åŒæ„æ¸ˆã¿ã®å ´åˆ:              â”‚                            â”‚
     â”‚   ãƒ›ãƒ¼ãƒ ç”»é¢ã¸é·ç§»             â”‚                            â”‚
     â”‚                              â”‚                            â”‚
```

**é‡è¦**: ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å¿…ãšæœ€æ–°ç‰ˆã®åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ã‚’ç¢ºèª(FR-024-1)

#### 9.1.3 ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³(Google/Apple)

```dart
// Google Sign-In
Future<UserCredential> signInWithGoogle() async {
  final GoogleSignInAccount? googleUser = await GoogleSignIn().signIn();
  if (googleUser == null) return;
  
  final GoogleSignInAuthentication googleAuth = await googleUser.authentication;
  final credential = GoogleAuthProvider.credential(
    accessToken: googleAuth.accessToken,
    idToken: googleAuth.idToken,
  );
  
  return await FirebaseAuth.instance.signInWithCredential(credential);
}

// Apple Sign-In
Future<UserCredential> signInWithApple() async {
  final appleCredential = await SignInWithApple.getAppleIDCredential(
    scopes: [
      AppleIDAuthorizationScopes.email,
      AppleIDAuthorizationScopes.fullName,
    ],
  );
  
  final oauthCredential = OAuthProvider("apple.com").credential(
    idToken: appleCredential.identityToken,
    accessToken: appleCredential.authorizationCode,
  );
  
  return await FirebaseAuth.instance.signInWithCredential(oauthCredential);
}
```

### 9.2 èªå¯(Firestore Security Rules)

#### 9.2.1 åŸºæœ¬ãƒ«ãƒ¼ãƒ«

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasValidConsent() {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return user.data.consents.terms.accepted == true &&
             user.data.consents.privacyPolicy.accepted == true &&
             user.data.consents.terms.version == '3.1' &&
             user.data.consents.privacyPolicy.version == '3.1';
    }
    
    // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated();
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
      
      // sessionsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      match /sessions/{sessionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidConsent();
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
        
        // skeleton_dataã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        match /skeleton_data/{frameId} {
          allow read, write: if isOwner(userId);
        }
      }
      
      // consent_historyã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      match /consent_history/{consentId} {
        allow read: if isOwner(userId);
        allow write: if false;  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿
      }
    }
    
    // exercisesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³(ãƒã‚¹ã‚¿)
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if false;  // ç®¡ç†è€…ã®ã¿
    }
  }
}
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**:
- `hasValidConsent()`: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã«æœ€æ–°ç‰ˆã¸ã®åŒæ„ã‚’ç¢ºèª(FR-024-1)
- åŒæ„å±¥æ­´ã¯èª­ã¿å–ã‚Šå°‚ç”¨(æ”¹ã–ã‚“é˜²æ­¢)
- å…¨ã¦ã®æ“ä½œã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’å¿…é ˆåŒ–

---

**ç¶šãã¯Part 3ã§...**

ã“ã®Part 2ã§ã¯ã€ä»¥ä¸‹ã‚’è©³ç´°ã«è¨­è¨ˆã—ã¾ã—ãŸ:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(Firebase Functions)
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ(Firestore, BigQuery)
- APIè¨­è¨ˆ(HTTP APIã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
- èªè¨¼ãƒ»èªå¯(ãƒ•ãƒ­ãƒ¼ã€Security Rules)

Part 3ã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ v3.2 (Part 3/3)

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒª(ä»®ç§°)  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.2 (MVP)

---

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 10.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¤šå±¤é˜²å¾¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 7: ç›£è¦–ãƒ»æ¤œçŸ¥                      â”‚
â”‚  - Cloud Logging / Monitoring                               â”‚
â”‚  - Sentry(ã‚¨ãƒ©ãƒ¼è¿½è·¡)                                        â”‚
â”‚  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 6: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³                â”‚
â”‚  - å…¥åŠ›å€¤æ¤œè¨¼                                                â”‚
â”‚  - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–                                   â”‚
â”‚  - XSSå¯¾ç­–                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 5: èªå¯                            â”‚
â”‚  - Firestore Security Rules                                 â”‚
â”‚  - ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)                                        â”‚
â”‚  - æœ€å°æ¨©é™ã®åŸå‰‡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 4: èªè¨¼                            â”‚
â”‚  - Firebase Authentication                                   â”‚
â”‚  - JWTæ¤œè¨¼                                                   â”‚
â”‚  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 3: ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–                    â”‚
â”‚  - ä¿å­˜æ™‚æš—å·åŒ–(AES-256-GCM)                                â”‚
â”‚  - ä»®ååŒ–ãƒ»åŒ¿ååŒ–                                            â”‚
â”‚  - æ©Ÿå¯†æƒ…å ±ç®¡ç†(Secret Manager)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 2: é€šä¿¡æš—å·åŒ–                      â”‚
â”‚  - TLS 1.3                                                   â”‚
â”‚  - è¨¼æ˜æ›¸æ¤œè¨¼                                                â”‚
â”‚  - Certificate Pinning(å°†æ¥)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Layer 1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯                    â”‚
â”‚  - Firewall(GCP)                                             â”‚
â”‚  - DDoSä¿è­·                                                  â”‚
â”‚  - ãƒ¬ãƒ¼ãƒˆåˆ¶é™                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 æš—å·åŒ–æˆ¦ç•¥

#### 10.2.1 é€šä¿¡æš—å·åŒ–(NFR-009)

**ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: TLS 1.3

**è¨­å®š**:
```typescript
// Firebase Functions
import * as functions from 'firebase-functions/v2';

export const secureFunction = functions.https.onRequest({
  cors: true,
  enforceAppCheck: true,  // App Checkå¼·åˆ¶
}, async (req, res) => {
  // TLS 1.3ã¯è‡ªå‹•çš„ã«å¼·åˆ¶ã•ã‚Œã‚‹
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œè¨¼
  if (req.header('X-Requested-With') !== 'XMLHttpRequest') {
    res.status(403).send('Forbidden');
    return;
  }
  
  // å‡¦ç†...
});
```

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´**:
```dart
import 'package:dio/dio.dart';

final dio = Dio(BaseOptions(
  connectTimeout: const Duration(seconds: 10),
  receiveTimeout: const Duration(seconds: 30),
  // TLS 1.3ã¯è‡ªå‹•çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹
));

// è¨¼æ˜æ›¸ãƒ”ãƒ³ãƒ‹ãƒ³ã‚°(å°†æ¥å®Ÿè£…)
// dio.httpClientAdapter = HttpClientAdapter()
//   ..onHttpClientCreate = (client) {
//     client.badCertificateCallback = (cert, host, port) => false;
//   };
```

#### 10.2.2 ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–(NFR-010)

**ä¿å­˜æ™‚æš—å·åŒ–**: AES-256-GCM

**Firestore**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æš—å·åŒ–(Googleç®¡ç†ã‚­ãƒ¼)

**è¿½åŠ æš—å·åŒ–**(æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿):
```typescript
import * as crypto from 'crypto';

class EncryptionService {
  private algorithm = 'aes-256-gcm';
  private key: Buffer;
  
  constructor() {
    // Secret Managerã‹ã‚‰å–å¾—
    this.key = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex');
  }
  
  encrypt(plaintext: string): {
    encrypted: string;
    iv: string;
    tag: string;
  } {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(this.algorithm, this.key, iv);
    
    let encrypted = cipher.update(plaintext, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const tag = cipher.getAuthTag();
    
    return {
      encrypted,
      iv: iv.toString('hex'),
      tag: tag.toString('hex'),
    };
  }
  
  decrypt(encrypted: string, iv: string, tag: string): string {
    const decipher = crypto.createDecipheriv(
      this.algorithm,
      this.key,
      Buffer.from(iv, 'hex')
    );
    
    decipher.setAuthTag(Buffer.from(tag, 'hex'));
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}
```

**ä½¿ç”¨ä¾‹**:
```typescript
// æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
const encryptionService = new EncryptionService();
const sensitiveData = 'user-sensitive-info';

const { encrypted, iv, tag } = encryptionService.encrypt(sensitiveData);

await firestore.collection('users').doc(userId).update({
  'sensitiveField.encrypted': encrypted,
  'sensitiveField.iv': iv,
  'sensitiveField.tag': tag,
});
```

#### 10.2.3 ä»®ååŒ–(NFR-016)

**å®Ÿè£…**:
```typescript
import * as crypto from 'crypto';

class PseudonymizationService {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãƒãƒƒã‚·ãƒ¥åŒ–
  hashUserId(userId: string): string {
    return crypto
      .createHash('sha256')
      .update(userId)
      .digest('hex');
  }
  
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä»®ååŒ–
  pseudonymizeEmail(email: string): string {
    const [local, domain] = email.split('@');
    const hashedLocal = crypto
      .createHash('sha256')
      .update(local)
      .digest('hex')
      .substring(0, 8);
    
    return `${hashedLocal}@${domain}`;
  }
  
  // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®åŒ¿ååŒ–
  anonymizeIP(ip: string): string {
    const parts = ip.split('.');
    return `${parts[0]}.${parts[1]}.0.0`;
  }
}
```

**BigQueryã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«é©ç”¨**:
```typescript
const pseudonymization = new PseudonymizationService();

const anonymizedData = {
  user_id_hash: pseudonymization.hashUserId(userId),
  ip_address: pseudonymization.anonymizeIP(ipAddress),
  // ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿...
};
```

### 10.3 èªè¨¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### 10.3.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼

**è¦ä»¶**:
- æœ€å°é•·: 8æ–‡å­—
- è¤‡é›‘æ€§: è‹±å¤§æ–‡å­—ã€è‹±å°æ–‡å­—ã€æ•°å­—ã€è¨˜å·ã®ã†ã¡3ç¨®é¡ä»¥ä¸Š
- ç¦æ­¢: ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(è¾æ›¸æ”»æ’ƒå¯¾ç­–)

**Firebase Authenticationè¨­å®š**:
```typescript
// Firebase Consoleã§è¨­å®š
// - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·: 8æ–‡å­—ä»¥ä¸Š
// - ãƒ¡ãƒ¼ãƒ«ç¢ºèª: å¿…é ˆ
// - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯: 5å›å¤±æ•—ã§30åˆ†ãƒ­ãƒƒã‚¯
```

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¤œè¨¼**:
```dart
class PasswordValidator {
  static String? validate(String password) {
    if (password.length < 8) {
      return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
    }
    
    int complexity = 0;
    if (RegExp(r'[A-Z]').hasMatch(password)) complexity++;
    if (RegExp(r'[a-z]').hasMatch(password)) complexity++;
    if (RegExp(r'[0-9]').hasMatch(password)) complexity++;
    if (RegExp(r'[!@#$%^&*(),.?":{}|<>]').hasMatch(password)) complexity++;
    
    if (complexity < 3) {
      return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è‹±å¤§æ–‡å­—ã€è‹±å°æ–‡å­—ã€æ•°å­—ã€è¨˜å·ã®ã†ã¡3ç¨®é¡ä»¥ä¸Šã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™';
    }
    
    // ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
    final commonPasswords = ['password', '12345678', 'password123'];
    if (commonPasswords.contains(password.toLowerCase())) {
      return 'ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“';
    }
    
    return null;
  }
}
```

#### 10.3.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

**JWT**:
- æœ‰åŠ¹æœŸé™: 1æ™‚é–“
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³: 30æ—¥é–“
- è‡ªå‹•æ›´æ–°: æœ‰åŠ¹æœŸé™ã®15åˆ†å‰

**å®Ÿè£…**:
```dart
class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  Timer? _tokenRefreshTimer;
  
  Future<void> startTokenRefresh() async {
    _tokenRefreshTimer?.cancel();
    
    _tokenRefreshTimer = Timer.periodic(
      const Duration(minutes: 45),  // 45åˆ†ã”ã¨ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      (timer) async {
        final user = _auth.currentUser;
        if (user != null) {
          await user.getIdToken(true);  // å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        }
      },
    );
  }
  
  void stopTokenRefresh() {
    _tokenRefreshTimer?.cancel();
  }
}
```

#### 10.3.3 å¤šè¦ç´ èªè¨¼(MFA) - Phase 3ä»¥é™

**è¨ˆç”»**:
- SMSèªè¨¼
- èªè¨¼ã‚¢ãƒ—ãƒª(TOTP)
- ãƒã‚¤ã‚ªãƒ¡ãƒˆãƒªã‚¯ã‚¹(æŒ‡ç´‹ã€é¡”èªè¨¼)

**å®Ÿè£…ä¾‹**(å°†æ¥):
```dart
// SMSèªè¨¼
Future<void> enableSMSMFA() async {
  final user = FirebaseAuth.instance.currentUser!;
  await user.multiFactor.enrollPhone(
    phoneNumber: '+81-90-1234-5678',
  );
}
```

### 10.4 å…¥åŠ›å€¤æ¤œè¨¼

#### 10.4.1 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¤œè¨¼

```dart
class InputValidators {
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  static String? validateEmail(String? email) {
    if (email == null || email.isEmpty) {
      return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    final regex = RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$');
    if (!regex.hasMatch(email)) {
      return 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    return null;
  }
  
  // èº«é•·(cm)
  static String? validateHeight(String? height) {
    if (height == null || height.isEmpty) {
      return 'èº«é•·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    final value = int.tryParse(height);
    if (value == null || value < 100 || value > 250) {
      return 'èº«é•·ã¯100ã€œ250cmã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    return null;
  }
  
  // ä½“é‡(kg)
  static String? validateWeight(String? weight) {
    if (weight == null || weight.isEmpty) {
      return 'ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    final value = double.tryParse(weight);
    if (value == null || value < 30 || value > 200) {
      return 'ä½“é‡ã¯30ã€œ200kgã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    return null;
  }
  
  // å¹´é½¢
  static String? validateAge(String? age) {
    if (age == null || age.isEmpty) {
      return 'å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    final value = int.tryParse(age);
    if (value == null || value < 13 || value > 120) {
      return 'å¹´é½¢ã¯13ã€œ120æ­³ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
    }
    
    return null;
  }
}
```

#### 10.4.2 ã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼

```typescript
class ServerValidators {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ¤œè¨¼
  static validateUserId(userId: string): boolean {
    return /^[a-zA-Z0-9]{28}$/.test(userId);  // Firebase Auth UIDå½¢å¼
  }
  
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼
  static validateEmail(email: string): boolean {
    const regex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
    return regex.test(email);
  }
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®æ¤œè¨¼
  static validateSessionId(sessionId: string): boolean {
    return /^[a-zA-Z0-9]{20}$/.test(sessionId);  // Firestoreè‡ªå‹•ç”ŸæˆIDå½¢å¼
  }
  
  // å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
  static sanitize(input: string): string {
    return input
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;')
      .replace(/\//g, '&#x2F;');
  }
}
```

### 10.5 è„†å¼±æ€§å¯¾ç­–

#### 10.5.1 XSS(ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°)å¯¾ç­–

**å¯¾ç­–**:
- å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- å‡ºåŠ›æ™‚ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
- Content Security Policy(CSP)

**å®Ÿè£…**:
```dart
// Flutter: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§XSSã«å¼·ã„(Dartã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)
// HTMLãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„ãŸã‚åŸºæœ¬çš„ã«å®‰å…¨

// WebViewä½¿ç”¨æ™‚ã®ã¿æ³¨æ„
class SecureWebView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return WebView(
      javascriptMode: JavascriptMode.disabled,  // JSç„¡åŠ¹åŒ–
      // ã¾ãŸã¯é©åˆ‡ãªã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
    );
  }
}
```

#### 10.5.2 CSRF(ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª)å¯¾ç­–

**å¯¾ç­–**:
- Firebase Authentication ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¦æ±‚

**å®Ÿè£…**:
```typescript
export const secureEndpoint = functions.https.onCall(async (data, context) => {
  // Firebase Authenticationãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•æ¤œè¨¼
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'User not authenticated');
  }
  
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
  const appCheckToken = context.app;
  if (!appCheckToken) {
    throw new functions.https.HttpsError('failed-precondition', 'App Check verification failed');
  }
  
  // å‡¦ç†...
});
```

#### 10.5.3 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

**å¯¾ç­–**: Firestoreã¯NoSQLã®ãŸã‚åŸºæœ¬çš„ã«å®‰å…¨

**æ³¨æ„ç‚¹**: ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼

```typescript
// âŒ å±é™ºãªä¾‹
const userInput = request.query.userId;
const snapshot = await firestore.collection('users').doc(userInput).get();

// âœ… å®‰å…¨ãªä¾‹
const userId = ServerValidators.validateUserId(request.query.userId);
if (!userId) {
  throw new Error('Invalid user ID');
}
const snapshot = await firestore.collection('users').doc(userId).get();
```

#### 10.5.4 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**Firebase Functions**:
```typescript
import * as admin from 'firebase-admin';

class RateLimiter {
  private static readonly MAX_REQUESTS = 100;
  private static readonly WINDOW_MS = 60 * 60 * 1000;  // 1æ™‚é–“
  
  static async checkRateLimit(userId: string, endpoint: string): Promise<boolean> {
    const db = admin.firestore();
    const rateLimitRef = db
      .collection('rate_limits')
      .doc(`${userId}_${endpoint}`);
    
    const doc = await rateLimitRef.get();
    const now = Date.now();
    
    if (!doc.exists) {
      await rateLimitRef.set({
        count: 1,
        windowStart: now,
      });
      return true;
    }
    
    const data = doc.data()!;
    const windowStart = data.windowStart;
    const count = data.count;
    
    if (now - windowStart > this.WINDOW_MS) {
      // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚»ãƒƒãƒˆ
      await rateLimitRef.set({
        count: 1,
        windowStart: now,
      });
      return true;
    }
    
    if (count >= this.MAX_REQUESTS) {
      return false;  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
    }
    
    await rateLimitRef.update({
      count: admin.firestore.FieldValue.increment(1),
    });
    
    return true;
  }
}
```

---

## 11. ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### 11.1 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³

```
[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]
     â”‚
     â”œâ”€ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ
     â”‚   â””â”€ ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‡¦ç†(MediaPipe Pose)
     â”‚       â””â”€ éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
     â”‚
     â†“ HTTPS
[Firestore]
     â”‚
     â”œâ”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜(users/{userId}/sessions/{sessionId})
     â”‚   â””â”€ æš—å·åŒ–ä¿å­˜(AES-256)
     â”‚
     â†“ 1æ—¥1å›(2:00 JST)
[BigQuery]
     â”‚
     â”œâ”€ ä»®ååŒ–ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
     â”‚   â””â”€ user_id_hash = SHA256(userId)
     â”‚
     â†“ é€±æ¬¡ãƒãƒƒãƒ
[ãƒ‡ãƒ¼ã‚¿åˆ†æ]
     â”‚
     â”œâ”€ çµ±è¨ˆé›†è¨ˆ
     â”œâ”€ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
     â””â”€ MLå­¦ç¿’æº–å‚™(Phase 4ä»¥é™)
```

### 11.2 ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

#### 11.2.1 ä¿å­˜æœŸé–“ãƒãƒªã‚·ãƒ¼

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿å­˜æœŸé–“ | å‰Šé™¤æ–¹æ³• | æ³•çš„æ ¹æ‹  |
|-----------|---------|---------|---------|
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ä¸­ | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ | GDPRç¬¬17æ¡ |
| **ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³** | ç„¡æœŸé™(åŒæ„ãƒ™ãƒ¼ã‚¹) | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ | GDPRç¬¬6æ¡1é …(a) |
| **éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿** | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨åŒã˜ | ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æ™‚ | GDPRç¬¬6æ¡1é …(a) |
| **åŒæ„å±¥æ­´** | å‰Šé™¤ã—ãªã„ | ä»®ååŒ–ã®ã¿ | GDPRç¬¬7æ¡3é … |
| **BigQueryãƒ‡ãƒ¼ã‚¿** | 3å¹´é–“ | è‡ªå‹•å‰Šé™¤ | æ­£å½“ãªåˆ©ç›Š |
| **ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿** | 90æ—¥é–“ | è‡ªå‹•å‰Šé™¤ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›®çš„ |

#### 11.2.2 è‡ªå‹•å‰Šé™¤ãƒãƒƒãƒ

```typescript
export const cleanupExpiredData = functions.scheduler
  .onSchedule('0 3 * * *', async (event) => {  // æ¯æ—¥3:00 JST
    const db = admin.firestore();
    const now = admin.firestore.Timestamp.now();
    
    try {
      // 1. é€€ä¼šå¾Œ30æ—¥çµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      const deletedUsersSnapshot = await db
        .collection('deleted_users')
        .where('deletedAt', '<=', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))
        .get();
      
      for (const doc of deletedUsersSnapshot.docs) {
        const userId = doc.data().userId;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤
        await deleteUserDataCompletely(userId);
        
        // deleted_usersã‹ã‚‰å‰Šé™¤
        await doc.ref.delete();
        
        functions.logger.info(`Deleted user data: ${userId}`);
      }
      
      // 2. 90æ—¥ä»¥ä¸Šå‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤(Cloud Loggingå´ã§è‡ªå‹•è¨­å®š)
      
      functions.logger.info('Cleanup completed');
    } catch (error) {
      functions.logger.error('Cleanup failed', error);
      throw error;
    }
  });

async function deleteUserDataCompletely(userId: string): Promise<void> {
  const db = admin.firestore();
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
  const sessionsSnapshot = await db
    .collection('users')
    .doc(userId)
    .collection('sessions')
    .get();
  
  const batch = db.batch();
  sessionsSnapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });
  
  await batch.commit();
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
  await db.collection('users').doc(userId).delete();
  
  // Firebase Storageã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
  const bucket = admin.storage().bucket();
  await bucket.deleteFiles({
    prefix: `users/${userId}/`,
  });
}
```

### 11.3 BigQueryãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

#### 11.3.1 ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†

```typescript
import { BigQuery } from '@google-cloud/bigquery';

export const dailyBigQueryExport = functions.scheduler
  .onSchedule('0 2 * * *', async (event) => {
    const db = admin.firestore();
    const bigquery = new BigQuery();
    
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0);
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // å‰æ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const sessionsSnapshot = await db
      .collectionGroup('sessions')
      .where('createdAt', '>=', admin.firestore.Timestamp.fromDate(yesterday))
      .where('createdAt', '<', admin.firestore.Timestamp.fromDate(today))
      .get();
    
    if (sessionsSnapshot.empty) {
      functions.logger.info('No sessions to export');
      return;
    }
    
    // ä»®ååŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const rows = sessionsSnapshot.docs.map(doc => {
      const data = doc.data();
      const userId = doc.ref.parent.parent?.id;
      
      return {
        user_id_hash: hashUserId(userId!),
        session_id: doc.id,
        exercise_type: data.exerciseType,
        duration_seconds: data.durationSeconds,
        total_reps: data.totalReps,
        completed_reps: data.completedReps,
        average_score: data.averageScore,
        best_score: data.bestScore,
        platform: data.deviceInfo.platform,
        os_version: data.deviceInfo.osVersion,
        app_version: data.deviceInfo.appVersion,
        created_at: data.createdAt.toDate(),
      };
    });
    
    // BigQueryã«æŒ¿å…¥
    await bigquery
      .dataset('fitness_analytics')
      .table('training_sessions')
      .insert(rows);
    
    functions.logger.info(`Exported ${rows.length} sessions to BigQuery`);
  });
```

#### 11.3.2 çµ±è¨ˆé›†è¨ˆã‚¯ã‚¨ãƒª

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®é€±æ¬¡çµ±è¨ˆ
CREATE OR REPLACE VIEW fitness_analytics.weekly_user_stats AS
SELECT
  user_id_hash,
  DATE_TRUNC(created_at, WEEK) AS week,
  COUNT(DISTINCT session_id) AS total_sessions,
  SUM(duration_seconds) AS total_duration_seconds,
  AVG(average_score) AS avg_score,
  COUNT(DISTINCT exercise_type) AS unique_exercises
FROM
  fitness_analytics.training_sessions
GROUP BY
  user_id_hash,
  week;

-- ç¨®ç›®åˆ¥ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¨ç§»
CREATE OR REPLACE VIEW fitness_analytics.exercise_performance AS
SELECT
  exercise_type,
  DATE_TRUNC(created_at, MONTH) AS month,
  COUNT(DISTINCT user_id_hash) AS active_users,
  AVG(average_score) AS avg_score,
  AVG(duration_seconds) AS avg_duration,
  PERCENTILE_CONT(average_score, 0.5) OVER(PARTITION BY exercise_type, month) AS median_score
FROM
  fitness_analytics.training_sessions
GROUP BY
  exercise_type,
  month;
```

---

## 12. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### 12.1 GDPRæº–æ‹ å®Ÿè£…

#### 12.1.1 åŒæ„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ (FR-024, FR-024-1)

**ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«**:
```typescript
interface ConsentManagement {
  // åŒæ„çŠ¶æ…‹
  consents: {
    terms: ConsentRecord;
    privacyPolicy: ConsentRecord;
  };
  
  // åŒæ„å±¥æ­´
  history: ConsentHistoryRecord[];
}

interface ConsentRecord {
  accepted: boolean;
  version: string;           // ä¾‹: "3.1"
  acceptedAt: Timestamp | null;
  ipAddress: string | null;  // åŒ¿ååŒ–
  userAgent: string | null;
}

interface ConsentHistoryRecord {
  type: 'terms' | 'privacy_policy';
  action: 'accept' | 'withdraw';
  version: string;
  timestamp: Timestamp;
  ipAddress: string | null;
  userAgent: string | null;
  description: string;
}
```

**å®Ÿè£…**:
```typescript
class ConsentService {
  async recordConsent(
    userId: string,
    type: 'terms' | 'privacy_policy',
    version: string,
    ipAddress: string,
    userAgent: string
  ): Promise<void> {
    const db = admin.firestore();
    
    // åŒæ„çŠ¶æ…‹ã‚’æ›´æ–°
    await db.collection('users').doc(userId).update({
      [`consents.${type}.accepted`]: true,
      [`consents.${type}.version`]: version,
      [`consents.${type}.acceptedAt`]: admin.firestore.FieldValue.serverTimestamp(),
    });
    
    // åŒæ„å±¥æ­´ã‚’è¨˜éŒ²(æ”¹ã–ã‚“é˜²æ­¢)
    await db
      .collection('users')
      .doc(userId)
      .collection('consent_history')
      .add({
        type,
        action: 'accept',
        version,
        timestamp: admin.firestore.FieldValue.serverTimestamp(),
        ipAddress: this.anonymizeIP(ipAddress),
        userAgent,
        description: `${type === 'terms' ? 'åˆ©ç”¨è¦ç´„' : 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼'}v${version}ã«åŒæ„`,
      });
  }
  
  async withdrawConsent(
    userId: string,
    type: 'terms' | 'privacy_policy'
  ): Promise<void> {
    const db = admin.firestore();
    
    // åŒæ„è§£é™¤ã‚’è¨˜éŒ²
    await db
      .collection('users')
      .doc(userId)
      .collection('consent_history')
      .add({
        type,
        action: 'withdraw',
        version: null,
        timestamp: admin.firestore.FieldValue.serverTimestamp(),
        ipAddress: null,
        userAgent: null,
        description: `${type === 'terms' ? 'åˆ©ç”¨è¦ç´„' : 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼'}ã®åŒæ„ã‚’è§£é™¤`,
      });
    
    // åŒæ„è§£é™¤å¾Œã¯å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿè£…
  }
  
  private anonymizeIP(ip: string): string {
    const parts = ip.split('.');
    return `${parts[0]}.${parts[1]}.0.0`;
  }
}
```

#### 12.1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©åˆ©è¡Œä½¿

**å®Ÿè£…å¯èƒ½ãªæ¨©åˆ©**(GDPR):
1. ã‚¢ã‚¯ã‚»ã‚¹æ¨©(ç¬¬15æ¡) - ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
2. è¨‚æ­£æ¨©(ç¬¬16æ¡) - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
3. å‰Šé™¤æ¨©(ç¬¬17æ¡) - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
4. ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£æ¨©(ç¬¬20æ¡) - ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
5. å‡¦ç†ã®åˆ¶é™æ¨©(ç¬¬18æ¡) - ãƒ‡ãƒ¼ã‚¿å‡¦ç†åœæ­¢
6. ç•°è­°æ¨©(ç¬¬21æ¡) - å‡¦ç†ã¸ã®ç•°è­°

**ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè£…**:
```typescript
export const exportUserData = functions.https.onCall(async (request) => {
  const userId = request.auth?.uid;
  if (!userId) {
    throw new functions.https.HttpsError('unauthenticated', 'User not authenticated');
  }
  
  const db = admin.firestore();
  
  // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿åé›†
  const userData = await collectUserData(userId);
  
  // 2. JSONå½¢å¼ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
  const exportData = {
    user: userData.user,
    sessions: userData.sessions,
    consents: userData.consents,
    exportedAt: new Date().toISOString(),
    format: 'JSON',
    dataSubject: 'GDPR Article 15 & 20',
  };
  
  // 3. ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  await sendDataExportEmail(userData.user.email, exportData);
  
  // 4. å±¥æ­´è¨˜éŒ²
  await db.collection('gdpr_requests').add({
    userId,
    type: 'export',
    status: 'completed',
    requestedAt: admin.firestore.FieldValue.serverTimestamp(),
    completedAt: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  return { success: true, message: 'Data export sent to your email' };
});
```

### 12.2 ãƒ‡ãƒ¼ã‚¿ä¾µå®³å¯¾å¿œ

#### 12.2.1 æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

```typescript
class DataBreachDetection {
  // ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œçŸ¥
  static async detectAnomalousAccess(userId: string): Promise<boolean> {
    const db = admin.firestore();
    
    // éå»1æ™‚é–“ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’å–å¾—
    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
    const logsSnapshot = await db
      .collection('access_logs')
      .where('userId', '==', userId)
      .where('timestamp', '>', oneHourAgo)
      .get();
    
    if (logsSnapshot.size > 1000) {
      // ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹é »åº¦
      await this.raiseSecurityAlert(userId, 'High access frequency');
      return true;
    }
    
    // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ€¥æ¿€ãªå¤‰åŒ–
    const ips = new Set(logsSnapshot.docs.map(doc => doc.data().ipAddress));
    if (ips.size > 10) {
      await this.raiseSecurityAlert(userId, 'Multiple IP addresses');
      return true;
    }
    
    return false;
  }
  
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆç™ºè¡Œ
  static async raiseSecurityAlert(userId: string, reason: string): Promise<void> {
    const db = admin.firestore();
    
    await db.collection('security_alerts').add({
      userId,
      reason,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      status: 'open',
      severity: 'high',
    });
    
    // ç®¡ç†è€…ã«é€šçŸ¥
    await sendSecurityAlert(userId, reason);
    
    functions.logger.warn(`Security alert: ${reason}`, { userId });
  }
}
```

#### 12.2.2 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ•ãƒ­ãƒ¼

```typescript
class IncidentResponse {
  // ãƒ‡ãƒ¼ã‚¿ä¾µå®³ç™ºç”Ÿæ™‚ã®å¯¾å¿œ
  static async handleDataBreach(
    breachType: string,
    affectedUsers: string[],
    severity: 'low' | 'medium' | 'high'
  ): Promise<void> {
    const db = admin.firestore();
    
    // 1. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè¨˜éŒ²
    const incidentRef = await db.collection('security_incidents').add({
      type: breachType,
      severity,
      affectedUserCount: affectedUsers.length,
      detectedAt: admin.firestore.FieldValue.serverTimestamp(),
      status: 'investigating',
    });
    
    // 2. å½±éŸ¿ç¯„å›²ã®èª¿æŸ»(24æ™‚é–“ä»¥å†…)
    const impactAssessment = await this.assessImpact(affectedUsers);
    
    // 3. ç›£ç£æ©Ÿé–¢ã¸ã®é€šçŸ¥(72æ™‚é–“ä»¥å†…ã€GDPRç¬¬33æ¡)
    if (severity === 'high' || impactAssessment.highRisk) {
      await this.notifySupervisoryAuthority(incidentRef.id, impactAssessment);
    }
    
    // 4. å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥(é«˜ãƒªã‚¹ã‚¯ã®å ´åˆã€GDPRç¬¬34æ¡)
    if (impactAssessment.highRisk) {
      await this.notifyAffectedUsers(affectedUsers, breachType);
    }
    
    // 5. å¯¾ç­–ã®å®Ÿæ–½
    await this.implementCountermeasures(breachType);
    
    // 6. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚¯ãƒ­ãƒ¼ã‚º
    await incidentRef.update({
      status: 'resolved',
      resolvedAt: admin.firestore.FieldValue.serverTimestamp(),
    });
  }
  
  // å½±éŸ¿è©•ä¾¡
  private static async assessImpact(affectedUsers: string[]): Promise<{
    highRisk: boolean;
    dataTypes: string[];
    severity: string;
  }> {
    // å½±éŸ¿ã‚’å—ã‘ãŸãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã‚’åˆ†æ
    const dataTypes: Set<string> = new Set();
    
    for (const userId of affectedUsers) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã‚’ç¢ºèª
      const userData = await admin.firestore()
        .collection('users')
        .doc(userId)
        .get();
      
      if (userData.exists) {
        const data = userData.data()!;
        if (data.email) dataTypes.add('email');
        if (data.profile) dataTypes.add('profile');
        if (data.subscription) dataTypes.add('subscription');
      }
    }
    
    // é«˜ãƒªã‚¹ã‚¯ã®åˆ¤å®š
    const highRisk = dataTypes.has('email') || dataTypes.has('subscription');
    
    return {
      highRisk,
      dataTypes: Array.from(dataTypes),
      severity: highRisk ? 'high' : 'medium',
    };
  }
  
  // ç›£ç£æ©Ÿé–¢ã¸ã®é€šçŸ¥
  private static async notifySupervisoryAuthority(
    incidentId: string,
    assessment: any
  ): Promise<void> {
    // å€‹äººæƒ…å ±ä¿è­·å§”å“¡ä¼šã¸ã®é€šçŸ¥
    const notification = {
      incidentId,
      organization: 'äº‹æ¥­è€…å',
      contactEmail: 'privacy@example.com',
      incidentType: assessment.dataTypes.join(', '),
      affectedUserCount: assessment.affectedUserCount,
      occuredAt: new Date().toISOString(),
      reportedAt: new Date().toISOString(),
    };
    
    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¾ãŸã¯å°‚ç”¨ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å ±å‘Š
    await sendNotificationToAuthority(notification);
    
    functions.logger.info('Notified supervisory authority', { incidentId });
  }
  
  // å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥
  private static async notifyAffectedUsers(
    affectedUsers: string[],
    breachType: string
  ): Promise<void> {
    for (const userId of affectedUsers) {
      const user = await admin.firestore()
        .collection('users')
        .doc(userId)
        .get();
      
      if (user.exists) {
        const email = user.data()!.email;
        
        await sendDataBreachNotification(email, {
          type: breachType,
          date: new Date().toISOString(),
          actions: [
            'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„',
            'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä¸å¯©ãªæ´»å‹•ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
          ],
        });
      }
    }
    
    functions.logger.info(`Notified ${affectedUsers.length} affected users`);
  }
  
  // å¯¾ç­–ã®å®Ÿæ–½
  private static async implementCountermeasures(breachType: string): Promise<void> {
    switch (breachType) {
      case 'unauthorized_access':
        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
        await this.invalidateAllSessions();
        break;
      
      case 'data_leak':
        // å½±éŸ¿ã‚’å—ã‘ãŸãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–å¼·åŒ–
        await this.strengthenEncryption();
        break;
      
      default:
        functions.logger.warn(`Unknown breach type: ${breachType}`);
    }
  }
  
  private static async invalidateAllSessions(): Promise<void> {
    // Firebase Authenticationã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
    functions.logger.info('Invalidating all user sessions');
  }
  
  private static async strengthenEncryption(): Promise<void> {
    // æš—å·åŒ–ã‚­ãƒ¼ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
    functions.logger.info('Strengthening encryption');
  }
}
```

---

## 13. ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°

### 13.1 ç›£è¦–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç›£è¦–å¯¾è±¡                                â”‚
â”‚  - Flutter App(ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)                                 â”‚
â”‚  - Firebase Functions(ã‚µãƒ¼ãƒãƒ¼)                              â”‚
â”‚  - Firestore(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹)                                   â”‚
â”‚  - BigQuery(ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åé›†ã‚·ã‚¹ãƒ†ãƒ                             â”‚
â”‚  - Firebase Crashlytics(ã‚¯ãƒ©ãƒƒã‚·ãƒ¥)                          â”‚
â”‚  - Firebase Analytics(ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•)                          â”‚
â”‚  - Cloud Logging(ãƒ­ã‚°)                                       â”‚
â”‚  - Cloud Monitoring(ãƒ¡ãƒˆãƒªã‚¯ã‚¹)                              â”‚
â”‚  - Sentry(ã‚¨ãƒ©ãƒ¼è¿½è·¡)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åˆ†æãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ                          â”‚
â”‚  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰                            â”‚
â”‚  - ç•°å¸¸æ¤œçŸ¥                                                  â”‚
â”‚  - ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥(Slack/Email)                                 â”‚
â”‚  - SLO/SLIè¿½è·¡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2 ãƒ­ã‚°è¨­è¨ˆ

#### 13.2.1 ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | ç”¨é€” | ä¾‹ |
|-------|------|---|
| **ERROR** | ã‚¨ãƒ©ãƒ¼ãƒ»éšœå®³ | APIå‘¼ã³å‡ºã—å¤±æ•—ã€ãƒ‡ãƒ¼ã‚¿ç ´æ |
| **WARN** | è­¦å‘Šãƒ»ç•°å¸¸ | ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éã€ãƒªãƒˆãƒ©ã‚¤ç™ºç”Ÿ |
| **INFO** | é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| **DEBUG** | ãƒ‡ãƒãƒƒã‚°æƒ…å ± | é–¢æ•°å‘¼ã³å‡ºã—ã€å¤‰æ•°å€¤ |

#### 13.2.2 ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```typescript
interface LogEntry {
  timestamp: string;          // ISO 8601
  level: 'ERROR' | 'WARN' | 'INFO' | 'DEBUG';
  message: string;
  userId?: string;            // åŒ¿ååŒ–
  sessionId?: string;
  functionName?: string;
  duration?: number;          // ms
  error?: {
    code: string;
    message: string;
    stack?: string;
  };
  metadata?: Record<string, any>;
}
```

**å®Ÿè£…**:
```typescript
class Logger {
  private static structuredLog(
    level: string,
    message: string,
    metadata?: Record<string, any>
  ): void {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level: level as any,
      message,
      ...metadata,
    };
    
    console.log(JSON.stringify(entry));
  }
  
  static info(message: string, metadata?: Record<string, any>): void {
    this.structuredLog('INFO', message, metadata);
  }
  
  static warn(message: string, metadata?: Record<string, any>): void {
    this.structuredLog('WARN', message, metadata);
  }
  
  static error(message: string, error?: Error, metadata?: Record<string, any>): void {
    this.structuredLog('ERROR', message, {
      ...metadata,
      error: {
        code: error?.name,
        message: error?.message,
        stack: error?.stack,
      },
    });
  }
}
```

### 13.3 ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

#### 13.3.1 ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | é–¾å€¤ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|-----------|------|-----------|
| **ã‚¨ãƒ©ãƒ¼ç‡** | > 5% (5åˆ†é–“) | Slacké€šçŸ¥ + Email |
| **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·** | P95 > 3ç§’ | Slacké€šçŸ¥ |
| **Functionså¤±æ•—ç‡** | > 10% | Email + ã‚ªãƒ³ã‚³ãƒ¼ãƒ« |
| **Firestoreæ›¸ãè¾¼ã¿å¤±æ•—** | > 1% | Email |
| **èªè¨¼å¤±æ•—** | > 20å›/åˆ†(åŒä¸€IP) | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ |

#### 13.3.2 SLO/SLIå®šç¾©

**SLO(Service Level Objective)**:
- å¯ç”¨æ€§: 99.9% (æœˆé–“43åˆ†ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã¾ã§è¨±å®¹)
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: P95 < 2ç§’
- ã‚¨ãƒ©ãƒ¼ç‡: < 1%

**SLI(Service Level Indicator)**:
```
å¯ç”¨æ€§ = (æˆåŠŸãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° / ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°) Ã— 100
ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· = P95(ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“)
ã‚¨ãƒ©ãƒ¼ç‡ = (ã‚¨ãƒ©ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° / ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°) Ã— 100
```

---

## 14. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥

### 14.1 CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é–‹ç™ºãƒ•ãƒ­ãƒ¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
              [Git Push to main]
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GitHub Actions                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. ãƒ“ãƒ«ãƒ‰                                           â”‚   â”‚
â”‚  â”‚     - Flutter build                                  â”‚   â”‚
â”‚  â”‚     - Firebase Functions build                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. ãƒ†ã‚¹ãƒˆ                                           â”‚   â”‚
â”‚  â”‚     - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ                                 â”‚   â”‚
â”‚  â”‚     - çµ±åˆãƒ†ã‚¹ãƒˆ                                     â”‚   â”‚
â”‚  â”‚     - Linter                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. ãƒ‡ãƒ—ãƒ­ã‚¤(Staging)                                â”‚   â”‚
â”‚  â”‚     - Firebase Hosting                               â”‚   â”‚
â”‚  â”‚     - Firebase Functions                             â”‚   â”‚
â”‚  â”‚     - Firestore Rules                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. E2Eãƒ†ã‚¹ãƒˆ(Staging)                               â”‚   â”‚
â”‚  â”‚     - Maestro                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  5. æ‰‹å‹•æ‰¿èª                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  6. ãƒ‡ãƒ—ãƒ­ã‚¤(Production)                             â”‚   â”‚
â”‚  â”‚     - Blue-Green Deployment                          â”‚   â”‚
â”‚  â”‚     - ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.2 ç’°å¢ƒæ§‹æˆ

| ç’°å¢ƒ | ç”¨é€” | Firebase Project | æ‰¿èª |
|-----|------|-----------------|------|
| **Development** | é–‹ç™º | fitness-dev | ä¸è¦ |
| **Staging** | QA | fitness-staging | ä¸è¦ |
| **Production** | æœ¬ç•ª | fitness-prod | å¿…è¦ |

### 14.3 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

**æ‰‹é †**:
1. å•é¡Œã®æ¤œçŸ¥(ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ )
2. ç·Šæ€¥åˆ¤æ–­(5åˆ†ä»¥å†…)
3. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ(10åˆ†ä»¥å†…)
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥
5. åŸå› èª¿æŸ»ãƒ»ä¿®æ­£

**å®Ÿè£…**:
```bash
# Firebase Functionsã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
firebase functions:rollback functionName --project=fitness-prod

# Firestoreãƒ«ãƒ¼ãƒ«ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
firebase deploy --only firestore:rules --project=fitness-prod
```

---

## 15. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### 15.1 ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

#### 15.1.1 Firestore

**è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: FirebaseãŒè‡ªå‹•å¯¾å¿œ

**æœ€é©åŒ–**:
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
- ã‚¯ã‚¨ãƒªåŠ¹ç‡åŒ–
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ­£è¦åŒ–

#### 15.1.2 Firebase Functions

**è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: åŒæ™‚å®Ÿè¡Œæ•°ã«å¿œã˜ã¦è‡ªå‹•

**è¨­å®š**:
```typescript
export const scalableFunction = functions
  .runWith({
    minInstances: 1,        // æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°
    maxInstances: 100,      // æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°
    memory: '512MB',
    timeoutSeconds: 60,
  })
  .https.onCall(async (data, context) => {
    // å‡¦ç†...
  });
```

---

## 16. ãƒ‡ã‚£ã‚¶ã‚¹ã‚¿ãƒªã‚«ãƒãƒª

### 16.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

**Firestore**: è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(æ—¥æ¬¡)

**æ‰‹å‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**(é€±æ¬¡):
```bash
gcloud firestore export gs://fitness-backups/$(date +%Y%m%d) \
  --project=fitness-prod
```

### 16.2 å¾©æ—§æ‰‹é †

**RTO(Recovery Time Objective)**: 4æ™‚é–“  
**RPO(Recovery Point Objective)**: 24æ™‚é–“

---

**å®Œäº†**

ä»¥ä¸Šã€ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸v3.2(Part 1-3)ã®å®Œæˆã§ã™ã€‚
