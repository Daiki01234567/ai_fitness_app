# 技術スタック v1.0 (Flutter版)

**プロジェクト名**: AIフィットネスアプリ（Flutter版）
**バージョン**: 1.0.0
**作成日**: 2025年12月10日
**最終更新日**: 2025年12月10日
**対象読者**: 開発チーム、技術担当者

---

## 目次

1. [概要](#1-概要)
2. [フロントエンド技術スタック](#2-フロントエンド技術スタック)
3. [バックエンド技術スタック](#3-バックエンド技術スタック)
4. [データベース](#4-データベース)
5. [AI処理（姿勢検出）](#5-ai処理姿勢検出)
6. [認証・課金](#6-認証課金)
7. [開発環境セットアップ](#7-開発環境セットアップ)
8. [主要ライブラリ詳細](#8-主要ライブラリ詳細)
9. [MediaPipe統合方法](#9-mediapipe統合方法)
10. [変更履歴](#10-変更履歴)

---

## 1. 概要

### 1.1 Flutter選択の理由（Expo版との比較）

| 理由 | 説明 | メリット |
|-----|------|---------|
| **高いパフォーマンス** | ネイティブコードにコンパイルされる | 姿勢検出のリアルタイム処理に有利 |
| **統一された開発体験** | Dartによる一貫した開発 | コードベースの管理が容易 |
| **成熟したエコシステム** | Googleが開発・サポート | 長期的なサポートが期待できる |
| **ウィジェットの自由度** | 高度なカスタマイズが可能 | UIの細かい調整が容易 |

**Expo版との比較**:

| 項目 | Flutter版 | Expo版 |
|-----|----------|--------|
| **言語** | Dart | TypeScript/JavaScript |
| **パフォーマンス** | ネイティブに近い | JavaScript Bridge経由 |
| **姿勢検出ライブラリ** | google_mlkit_pose_detection | MediaPipeネイティブモジュール |
| **開発者の多さ** | 増加傾向 | Web開発者が参入しやすい |
| **学習コスト** | Dart習得が必要 | React経験者は低い |

### 1.2 技術スタックサマリー

```
【クライアント】
Flutter
  ├── Dart 3.10+
  ├── Riverpod (状態管理)
  ├── GoRouter (ルーティング)
  ├── Material 3 (UI)
  └── google_mlkit_pose_detection (姿勢検出)

【バックエンド】
Firebase
  ├── Cloud Functions (Node.js 20, TypeScript)
  ├── Cloud Firestore (データベース)
  ├── Firebase Storage (ファイル保存)
  ├── Firebase Auth (認証)
  └── BigQuery (分析)

【課金】
Stripe (メイン)、RevenueCat (代替)
```

---

## 2. フロントエンド技術スタック

### 2.1 フレームワーク（Flutter/Dart）

| 技術 | バージョン | 説明 |
|-----|-----------|------|
| **Flutter** | 3.10+ | Googleが開発した、iOSとAndroid両方のアプリを一度に作れるフレームワーク |
| **Dart** | 3.10+ | Flutterで使用する言語。型安全でコードが書きやすい |

**Flutterの特徴**:
- **ウィジェット**: 画面の部品（ボタン、テキストなど）を組み合わせてUIを作る
- **ホットリロード**: コードを変更するとすぐに画面に反映される（開発が速い）
- **ネイティブコンパイル**: 実行時にネイティブコードに変換されるため高速
- **シングルコードベース**: 1つのコードでiOS/Android両方のアプリを作成

**Dartの特徴**:
- **型安全（Sound null safety）**: 「null」によるエラーを防ぐ仕組み
- **非同期処理**: `async`/`await`で待ち時間のある処理を簡単に書ける
- **クラスベース**: オブジェクト指向プログラミングに対応

### 2.2 状態管理（Riverpod）

**Riverpod**（リバーポッド）は、アプリ内のデータ（状態）を管理するためのライブラリです。

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';

// ログイン状態を管理する例
final authStateProvider = StateNotifierProvider<AuthNotifier, AuthState>((ref) {
  return AuthNotifier();
});

class AuthState {
  final bool isLoggedIn;
  final String? userId;

  AuthState({required this.isLoggedIn, this.userId});
}

class AuthNotifier extends StateNotifier<AuthState> {
  AuthNotifier() : super(AuthState(isLoggedIn: false));

  void login(String userId) {
    state = AuthState(isLoggedIn: true, userId: userId);
  }

  void logout() {
    state = AuthState(isLoggedIn: false);
  }
}
```

**特徴**:
- コンパイル時の型安全性（間違いを早く見つけられる）
- テストしやすい設計
- ProviderScope でアプリ全体のデータを管理
- DevToolsでデバッグ可能

**管理するデータ**:
- ログイン状態
- ユーザー情報
- トレーニングセッション中の一時データ
- UI設定（音声ON/OFFなど）

### 2.3 ルーティング（GoRouter）

**GoRouter**は、画面遷移を管理するためのライブラリです。

```dart
import 'package:go_router/go_router.dart';

final appRouter = GoRouter(
  routes: [
    // スプラッシュ画面
    GoRoute(
      path: '/',
      builder: (context, state) => const SplashScreen(),
    ),
    // 認証画面
    GoRoute(
      path: '/auth/login',
      builder: (context, state) => const LoginScreen(),
    ),
    GoRoute(
      path: '/auth/register',
      builder: (context, state) => const RegisterScreen(),
    ),
    // ホーム画面（タブ付き）
    GoRoute(
      path: '/home',
      builder: (context, state) => const HomeScreen(),
    ),
  ],
);

// 画面遷移の使い方
context.push('/auth/login');   // 画面を追加
context.go('/home');           // 画面を置き換え
context.pop();                 // 前の画面に戻る
```

**特徴**:
- 宣言的なルート定義（どの画面にどうやって行くかを明確に書ける）
- 認証状態に応じたリダイレクト
- ディープリンク対応（URLから直接画面を開ける）
- ネストしたルーティング（タブの中の画面なども管理）

### 2.4 UIライブラリ（Material 3）

**Material 3**（マテリアル3）は、Googleが作ったデザインシステムです。Flutterには最初から入っています。

```dart
import 'package:flutter/material.dart';

// テーマ設定
final appTheme = ThemeData(
  useMaterial3: true,
  colorScheme: ColorScheme.fromSeed(
    seedColor: const Color(0xFF4CAF50), // アプリのメインカラー
    brightness: Brightness.light,
  ),
);

// ボタン
ElevatedButton(
  onPressed: () {
    // ボタンが押されたときの処理
  },
  child: const Text('トレーニング開始'),
)

// カード
Card(
  child: ListTile(
    title: const Text('スクワット'),
    subtitle: const Text('下半身 | 初級'),
    trailing: const Icon(Icons.arrow_forward),
  ),
)

// テキスト入力
TextField(
  decoration: const InputDecoration(
    labelText: 'メールアドレス',
    border: OutlineInputBorder(),
  ),
)
```

**主要コンポーネント**:
- `ElevatedButton`（ボタン）
- `Card`（カード）
- `TextField`（入力フォーム）
- `BottomNavigationBar`（ボトムナビゲーション）
- `AlertDialog`（ダイアログ）
- `Switch`（スイッチ）
- `Checkbox`（チェックボックス）
- `LinearProgressIndicator`（進捗バー）
- `SnackBar`（スナックバー）

### 2.5 バリデーション（Freezed + Dart標準）

**Freezed**は、不変（変更できない）なデータクラスを自動生成するライブラリです。

```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'user.freezed.dart';

@freezed
class User with _$User {
  const factory User({
    required String email,
    required String displayName,
    int? age,
  }) = _User;
}

// 使用例：コピーして一部だけ変更
final user = User(email: 'test@example.com', displayName: '田中太郎');
final updatedUser = user.copyWith(displayName: '山田花子');
```

**バリデーションの例**:

```dart
// 入力値のチェック関数
String? validateEmail(String? value) {
  if (value == null || value.isEmpty) {
    return 'メールアドレスを入力してください';
  }
  final emailRegex = RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$');
  if (!emailRegex.hasMatch(value)) {
    return '正しいメールアドレスを入力してください';
  }
  return null; // エラーなし
}

String? validatePassword(String? value) {
  if (value == null || value.isEmpty) {
    return 'パスワードを入力してください';
  }
  if (value.length < 8) {
    return 'パスワードは8文字以上で入力してください';
  }
  if (!RegExp(r'[A-Za-z]').hasMatch(value)) {
    return 'パスワードには英字を含めてください';
  }
  if (!RegExp(r'[0-9]').hasMatch(value)) {
    return 'パスワードには数字を含めてください';
  }
  return null;
}
```

**特徴**:
- Freezedによる不変データクラス生成
- Dart標準のバリデーション関数
- Form ウィジェットとの統合
- エラーメッセージのカスタマイズ

---

## 3. バックエンド技術スタック

### 3.1 Cloud Functions for Firebase（Node.js 20, TypeScript）

| 項目 | 内容 |
|-----|------|
| **ランタイム** | Node.js 20 |
| **言語** | TypeScript 5.0+ |
| **リージョン** | asia-northeast1（東京） |
| **最大インスタンス数** | 10（コスト制御） |
| **メモリ** | 256MiB |
| **タイムアウト** | 60秒 |

**グローバル設定**:

```typescript
import { setGlobalOptions } from 'firebase-functions/v2';

setGlobalOptions({
  region: 'asia-northeast1',
  maxInstances: 10,
  memory: '256MiB',
  timeoutSeconds: 60,
});
```

**主要な関数**:
- **Auth triggers**: ユーザー作成・削除時の処理
- **HTTP callable関数**: ユーザー情報更新など（クライアントから呼び出す）
- **Firestore triggers**: データ変更時の処理
- **Scheduled functions**: 定期実行処理（クリーンアップなど）

### 3.2 TypeScriptコーディング規約

- **ESLint**: Google Style Guide
- **Prettier**: ダブルクォート、セミコロンあり
- **strict mode**: 有効

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "esModuleInterop": true
  }
}
```

---

## 4. データベース

| 項目 | 技術 | 説明 | リージョン |
|-----|------|------|-----------|
| **メインDB** | Cloud Firestore | NoSQLデータベース、リアルタイム同期 | asia-northeast1 |
| **分析用DB** | BigQuery | 大規模データ分析 | asia-northeast1 |
| **ファイル保存** | Firebase Storage | 画像などのファイル保存 | asia-northeast1 |

**主要コレクション**:
- `users`: ユーザー情報
- `sessions`: トレーニングセッション
- `consents`: 同意履歴（不変の監査ログ）
- `dataDeletionRequests`: データ削除リクエスト（30日猶予）
- `bigQuerySyncFailures`: BigQuery同期エラー

**Firestoreのセキュリティルール**:
詳細は `02_Firestoreデータベース設計書_v3_3.md` を参照してください。

---

## 5. AI処理（姿勢検出）

### 5.1 カメラ処理（`camera`パッケージ）

**`camera`パッケージ**は、Flutterでカメラを使うための公式パッケージです。

```dart
import 'package:camera/camera.dart';

class CameraScreen extends StatefulWidget {
  @override
  State<CameraScreen> createState() => _CameraScreenState();
}

class _CameraScreenState extends State<CameraScreen> {
  CameraController? _controller;

  @override
  void initState() {
    super.initState();
    _initCamera();
  }

  Future<void> _initCamera() async {
    // 利用可能なカメラを取得
    final cameras = await availableCameras();
    final backCamera = cameras.firstWhere(
      (camera) => camera.lensDirection == CameraLensDirection.back,
    );

    // カメラコントローラを初期化
    _controller = CameraController(
      backCamera,
      ResolutionPreset.high,
      enableAudio: false,
    );
    await _controller?.initialize();
    setState(() {});
  }

  @override
  Widget build(BuildContext context) {
    if (_controller == null || !_controller!.value.isInitialized) {
      return const Center(child: CircularProgressIndicator());
    }
    return CameraPreview(_controller!);
  }

  @override
  void dispose() {
    _controller?.dispose();
    super.dispose();
  }
}
```

**特徴**:
- iOS/Android両対応
- 前面・背面カメラの切り替え
- 解像度の設定
- ストリーミング（リアルタイム）処理対応

### 5.2 姿勢検出（`google_mlkit_pose_detection`）

**`google_mlkit_pose_detection`**は、Google ML Kitを使った姿勢検出パッケージです。Expo版のMediaPipeネイティブモジュールとは異なりますが、同じ精度の姿勢検出が可能です。

**Expo版との違い**:

| 項目 | Flutter版 | Expo版 |
|-----|----------|--------|
| **パッケージ** | google_mlkit_pose_detection | MediaPipeネイティブモジュール |
| **ベース技術** | ML Kit (MediaPipeベース) | MediaPipe直接使用 |
| **セットアップ** | pubspec.yamlに追加するだけ | ネイティブモジュール作成が必要 |
| **検出精度** | 同等 | 同等 |
| **パフォーマンス** | 30fps以上 | 30fps以上 |

```dart
import 'package:google_mlkit_pose_detection/google_mlkit_pose_detection.dart';

// 姿勢検出器を作成
final poseDetector = PoseDetector(
  options: PoseDetectorOptions(
    mode: PoseDetectionMode.stream, // リアルタイム検出
    model: PoseDetectionModel.accurate, // 高精度モデル
  ),
);

// カメラ映像から姿勢を検出
Future<void> detectPose(CameraImage image) async {
  // カメラ画像をInputImage形式に変換
  final inputImage = InputImage.fromBytes(
    bytes: _convertCameraImage(image),
    inputImageData: InputImageData(
      size: Size(image.width.toDouble(), image.height.toDouble()),
      imageRotation: InputImageRotation.rotation0deg,
      inputImageFormat: InputImageFormat.bgra8888,
      planeData: null,
    ),
  );

  // 姿勢を検出
  final poses = await poseDetector.processImage(inputImage);

  // 検出結果を処理
  for (final pose in poses) {
    // 33個の関節データにアクセス
    final leftShoulder = pose.landmarks[PoseLandmarkType.leftShoulder];
    if (leftShoulder != null) {
      print('左肩: x=${leftShoulder.x}, y=${leftShoulder.y}');
    }
  }
}
```

**検出可能な関節（33箇所）**:
- **顔**: 鼻、左目内側、左目、左目外側、右目内側、右目、右目外側、左耳、右耳、左口角、右口角
- **上半身**: 左肩、右肩、左肘、右肘、左手首、右手首、左小指、右小指、左人差し指、右人差し指、左親指、右親指
- **下半身**: 左腰、右腰、左膝、右膝、左足首、右足首、左かかと、右かかと、左つま先、右つま先

**性能目標**:
- **通常デバイス**: 30fps以上
- **低スペックデバイス**: 15fps以上（フレームスキップ使用）

**オンデバイス処理**:
- カメラ映像はスマホ内で処理
- 映像そのものはサーバーに送信しない
- 骨格データ（33関節の位置）のみを保存

### 5.3 代替手段（TensorFlow Lite、クラウドAPI）

| 代替手段 | メリット | デメリット | 使用条件 |
|---------|---------|-----------|---------|
| **TensorFlow Lite** | Dartで直接使える | モデル管理が必要 | ML Kitが使えない場合 |
| **クラウドAPI** | 高精度、最新モデル | 通信が必要、コストがかかる | 最終手段 |

---

## 6. 認証・課金

### 6.1 認証（Firebase Auth）

```dart
import 'package:firebase_auth/firebase_auth.dart';

// メール/パスワードログイン
Future<void> login(String email, String password) async {
  try {
    final result = await FirebaseAuth.instance.signInWithEmailAndPassword(
      email: email,
      password: password,
    );
    print('ログイン成功: ${result.user?.uid}');
  } on FirebaseAuthException catch (e) {
    print('ログイン失敗: ${e.message}');
  }
}

// 新規登録
Future<void> register(String email, String password) async {
  try {
    final result = await FirebaseAuth.instance.createUserWithEmailAndPassword(
      email: email,
      password: password,
    );
    print('登録成功: ${result.user?.uid}');
  } on FirebaseAuthException catch (e) {
    print('登録失敗: ${e.message}');
  }
}

// Googleログイン
import 'package:google_sign_in/google_sign_in.dart';

Future<void> signInWithGoogle() async {
  final googleUser = await GoogleSignIn().signIn();
  final googleAuth = await googleUser?.authentication;

  final credential = GoogleAuthProvider.credential(
    accessToken: googleAuth?.accessToken,
    idToken: googleAuth?.idToken,
  );

  await FirebaseAuth.instance.signInWithCredential(credential);
}
```

**サポート認証方式**:

| 認証方式 | Phase | パッケージ |
|---------|-------|----------|
| メール/パスワード | Phase 1 | firebase_auth |
| Googleログイン | Phase 1 | google_sign_in |
| Apple認証 | Phase 3 | sign_in_with_apple |

### 6.2 課金（Stripe統一方針）

**Stripeをメイン決済サービスとして使用**します。

**Stripe選定理由**:
- **Web版との統一が容易**: 将来Webアプリを作る場合も同じシステムを使える
- **柔軟な価格設定**: 月額、年額、従量課金など様々な料金プランに対応
- **日本での豊富な実績**: 日本円決済、日本のクレジットカードに対応
- **ドキュメントが充実**: 日本語ドキュメントあり
- **開発者フレンドリー**: APIが使いやすく、テスト環境も充実

```dart
import 'package:flutter_stripe/flutter_stripe.dart';

// Stripe初期化
void initStripe() {
  Stripe.publishableKey = 'pk_test_xxxxx'; // 公開キー
}

// サブスクリプション購入フロー
Future<void> purchaseSubscription() async {
  try {
    // 1. Cloud Functionからclient secretを取得
    final response = await FirebaseFunctions.instance
        .httpsCallable('createSubscription')
        .call();
    final clientSecret = response.data['clientSecret'];

    // 2. Payment Sheetを初期化
    await Stripe.instance.initPaymentSheet(
      paymentSheetParameters: SetupPaymentSheetParameters(
        paymentIntentClientSecret: clientSecret,
        merchantDisplayName: 'AIフィットネスアプリ',
      ),
    );

    // 3. Payment Sheetを表示
    await Stripe.instance.presentPaymentSheet();

    print('課金成功');
  } on StripeException catch (e) {
    print('課金エラー: ${e.error.localizedMessage}');
  }
}
```

**RevenueCat（代替手段）**:

RevenueCatはStripe導入に問題が生じた場合の緊急時代替手段として位置づけます。

```dart
import 'package:purchases_flutter/purchases_flutter.dart';

// 初期化
Future<void> initRevenueCat() async {
  await Purchases.configure(PurchasesConfiguration('YOUR_API_KEY'));
}

// 購入
Future<void> purchase() async {
  try {
    final offerings = await Purchases.getOfferings();
    final package = offerings.current?.availablePackages.first;
    if (package != null) {
      await Purchases.purchasePackage(package);
    }
  } catch (e) {
    print('購入エラー: $e');
  }
}
```

**使用条件**: Stripe導入に技術的な問題が発生した場合のみ検討

---

## 7. 開発環境セットアップ

### 7.1 前提条件（Flutter SDK 3.10+、Dart 3.10+）

| ソフトウェア | バージョン | 備考 |
|------------|-----------|------|
| Flutter SDK | 3.10+ | 必須 |
| Dart | 3.10+ | Flutter SDKに含まれる |
| Git | 2.x | 必須 |
| Xcode | 15.x | iOS開発の場合（macOSのみ） |
| Android Studio | 2024.x | Android開発の場合 |
| VS Code | 最新版 | 推奨エディタ（Flutter拡張機能） |

### 7.2 セットアップ手順

#### ステップ1: Flutter SDKのインストール

**Windows**:
1. [Flutter公式サイト](https://flutter.dev/)からSDKをダウンロード
2. 任意の場所に展開（例: `C:\flutter`）
3. 環境変数PATHに追加（例: `C:\flutter\bin`）

**macOS/Linux**:
```bash
# Homebrewでインストール（macOS）
brew install flutter

# または公式サイトからダウンロードして展開
export PATH="$PATH:`pwd`/flutter/bin"
```

#### ステップ2: 環境確認

```bash
# Flutter Doctorで環境をチェック
flutter doctor
```

出力に問題がある場合は、指示に従って修正してください。

#### ステップ3: リポジトリのクローン

```bash
git clone https://github.com/your-org/ai-fitness-app.git
cd ai-fitness-app/flutter_app
```

#### ステップ4: 依存関係のインストール

```bash
flutter pub get
```

#### ステップ5: Firebase設定

1. [Firebase Console](https://console.firebase.google.com/)でプロジェクトを作成
2. iOS/Androidアプリを登録
3. Firebase CLIでFlutter用設定を生成:

```bash
# Firebase CLIをインストール
npm install -g firebase-tools

# ログイン
firebase login

# FlutterFire CLIをインストール
dart pub global activate flutterfire_cli

# 設定ファイルを生成
flutterfire configure --project=tokyo-list-478804-e5
```

#### ステップ6: コード生成（Freezed/Riverpod）

```bash
dart run build_runner build
```

#### ステップ7: 実行

```bash
# iOSシミュレータで実行
flutter run -d ios

# Androidエミュレータで実行
flutter run -d android

# 接続されたデバイスで実行
flutter run
```

### 7.3 開発コマンド

| コマンド | 説明 |
|---------|------|
| `flutter pub get` | 依存関係をインストール |
| `flutter analyze` | 静的解析（コードの問題をチェック） |
| `flutter run` | アプリを実行 |
| `flutter test` | テストを実行 |
| `flutter build apk` | Android APKをビルド |
| `flutter build ios` | iOSアプリをビルド |
| `dart run build_runner build` | Freezed/Riverpodのコード生成 |
| `dart run build_runner watch` | コード生成（変更を監視） |

---

## 8. 主要ライブラリ詳細

### 8.1 必須ライブラリ（`pubspec.yaml`ベース）

現在の`pubspec.yaml`に定義されているライブラリ:

```yaml
dependencies:
  flutter:
    sdk: flutter
  flutter_localizations:
    sdk: flutter

  # UI関連
  cupertino_icons: ^1.0.8
  intl: ^0.20.2

  # Firebase
  firebase_core: ^3.8.0
  firebase_auth: ^5.3.3
  cloud_firestore: ^5.5.0
  cloud_functions: ^5.1.4

  # 状態管理・ルーティング
  flutter_riverpod: ^2.4.9
  freezed_annotation: ^2.4.1
  go_router: ^14.6.2

  # 認証
  google_sign_in: ^6.2.1

  # 姿勢検出（MediaPipe）
  google_mlkit_pose_detection: ^0.11.0+1
  camera: ^0.10.5+9
  image: ^4.2.0
  permission_handler: ^11.3.1

  # オフラインサポート
  connectivity_plus: ^6.0.5
  shared_preferences: ^2.3.2

  # PDF出力（GDPR対応）
  pdf: ^3.11.1
  path_provider: ^2.1.4
  share_plus: ^10.1.2
  open_filex: ^4.5.0

  # その他
  url_launcher: ^6.2.6
```

### 8.2 オプションライブラリ

今後の機能拡張で追加を検討するライブラリ:

```yaml
dependencies:
  # 課金（Phase 2）
  flutter_stripe: ^11.0.0       # Stripe決済
  purchases_flutter: ^8.0.0     # RevenueCat（代替）

  # グラフ表示
  fl_chart: ^0.70.0             # チャート・グラフ

  # 音声
  flutter_tts: ^4.0.0           # 音声合成

  # Apple認証（Phase 3）
  sign_in_with_apple: ^6.0.0
```

### 8.3 ライブラリの役割

| ライブラリ | 役割 | 使用箇所 |
|----------|------|---------|
| flutter_riverpod | 状態管理 | アプリ全体 |
| go_router | 画面遷移 | アプリ全体 |
| freezed_annotation | 不変データクラス | モデル定義 |
| firebase_auth | 認証 | ログイン/登録画面 |
| google_sign_in | Googleログイン | ログイン画面 |
| google_mlkit_pose_detection | 姿勢検出 | トレーニング画面 |
| camera | カメラ制御 | トレーニング画面 |
| permission_handler | 権限管理 | カメラ権限取得 |
| connectivity_plus | ネットワーク状態確認 | オフライン対応 |
| shared_preferences | ローカルストレージ | 設定保存 |
| pdf | PDF生成 | データエクスポート |
| share_plus | ファイル共有 | PDFシェア |

---

## 9. MediaPipe統合方法

### 9.1 `google_mlkit_pose_detection`のセットアップ

`pubspec.yaml`に以下を追加（すでに追加済み）:

```yaml
dependencies:
  google_mlkit_pose_detection: ^0.11.0+1
  camera: ^0.10.5+9
```

依存関係をインストール:

```bash
flutter pub get
```

### 9.2 カメラ権限の設定

#### iOS (`ios/Runner/Info.plist`)

```xml
<dict>
  <!-- カメラ権限 -->
  <key>NSCameraUsageDescription</key>
  <string>トレーニング中のフォームをチェックするためにカメラを使用します</string>

  <!-- カメラ使用 (バックグラウンド) -->
  <key>UIBackgroundModes</key>
  <array>
    <string>processing</string>
  </array>
</dict>
```

#### Android (`android/app/src/main/AndroidManifest.xml`)

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
  <!-- カメラ権限 -->
  <uses-permission android:name="android.permission.CAMERA" />
  <uses-feature android:name="android.hardware.camera" android:required="true" />
  <uses-feature android:name="android.hardware.camera.autofocus" />

  <!-- minSdkVersionを21以上に設定 -->
  <!-- android/app/build.gradle で設定 -->
</manifest>
```

`android/app/build.gradle`:

```groovy
android {
    defaultConfig {
        minSdkVersion 21  // ML Kit requires API 21+
    }
}
```

### 9.3 リアルタイム姿勢検出コード例

以下は、中高生でも理解できるシンプルなコード例です。

```dart
import 'package:flutter/material.dart';
import 'package:camera/camera.dart';
import 'package:google_mlkit_pose_detection/google_mlkit_pose_detection.dart';
import 'package:permission_handler/permission_handler.dart';

class PoseDetectionScreen extends StatefulWidget {
  const PoseDetectionScreen({super.key});

  @override
  State<PoseDetectionScreen> createState() => _PoseDetectionScreenState();
}

class _PoseDetectionScreenState extends State<PoseDetectionScreen> {
  CameraController? _cameraController;
  PoseDetector? _poseDetector;
  bool _isDetecting = false;
  List<Pose> _detectedPoses = [];

  @override
  void initState() {
    super.initState();
    _initializeCamera();
    _initializePoseDetector();
  }

  /// カメラを初期化する
  Future<void> _initializeCamera() async {
    // カメラ権限をリクエスト
    final status = await Permission.camera.request();
    if (!status.isGranted) {
      // 権限が拒否された場合
      return;
    }

    // 利用可能なカメラを取得
    final cameras = await availableCameras();
    if (cameras.isEmpty) return;

    // 背面カメラを選択
    final backCamera = cameras.firstWhere(
      (camera) => camera.lensDirection == CameraLensDirection.back,
      orElse: () => cameras.first,
    );

    // カメラコントローラを作成
    _cameraController = CameraController(
      backCamera,
      ResolutionPreset.medium, // 中画質（パフォーマンスとのバランス）
      enableAudio: false,
      imageFormatGroup: ImageFormatGroup.bgra8888,
    );

    // カメラを初期化
    await _cameraController!.initialize();

    // リアルタイムで画像を取得
    await _cameraController!.startImageStream(_processImage);

    setState(() {});
  }

  /// 姿勢検出器を初期化する
  void _initializePoseDetector() {
    _poseDetector = PoseDetector(
      options: PoseDetectorOptions(
        mode: PoseDetectionMode.stream, // リアルタイム用
        model: PoseDetectionModel.base, // 基本モデル（高速）
      ),
    );
  }

  /// カメラ画像を処理して姿勢を検出する
  Future<void> _processImage(CameraImage image) async {
    // 処理中なら次のフレームをスキップ
    if (_isDetecting) return;
    _isDetecting = true;

    try {
      // カメラ画像をML Kit用に変換
      final inputImage = _convertCameraImage(image);
      if (inputImage == null) return;

      // 姿勢を検出
      final poses = await _poseDetector!.processImage(inputImage);

      // 結果を保存
      setState(() {
        _detectedPoses = poses;
      });

      // 検出結果を処理（例：スクワットの角度チェック）
      _analyzePose(poses);
    } finally {
      _isDetecting = false;
    }
  }

  /// カメラ画像をInputImage形式に変換する
  InputImage? _convertCameraImage(CameraImage image) {
    // 画像のバイトデータを取得
    final bytes = image.planes.first.bytes;

    // InputImageを作成
    return InputImage.fromBytes(
      bytes: bytes,
      inputImageData: InputImageData(
        size: Size(image.width.toDouble(), image.height.toDouble()),
        imageRotation: InputImageRotation.rotation0deg,
        inputImageFormat: InputImageFormat.bgra8888,
        planeData: [
          InputImagePlaneMetadata(
            bytesPerRow: image.planes.first.bytesPerRow,
            height: image.height,
            width: image.width,
          ),
        ],
      ),
    );
  }

  /// 検出した姿勢を分析する
  void _analyzePose(List<Pose> poses) {
    if (poses.isEmpty) return;

    final pose = poses.first;

    // 例：左膝の角度を計算（スクワット用）
    final leftHip = pose.landmarks[PoseLandmarkType.leftHip];
    final leftKnee = pose.landmarks[PoseLandmarkType.leftKnee];
    final leftAnkle = pose.landmarks[PoseLandmarkType.leftAnkle];

    if (leftHip != null && leftKnee != null && leftAnkle != null) {
      final angle = _calculateAngle(
        leftHip.x, leftHip.y,
        leftKnee.x, leftKnee.y,
        leftAnkle.x, leftAnkle.y,
      );

      // 角度に基づいてフィードバック
      if (angle < 90) {
        print('もう少し浅くしゃがんでみてください');
      } else if (angle > 110) {
        print('もう少し深くしゃがんでみてください');
      } else {
        print('良いフォームです！');
      }
    }
  }

  /// 3点間の角度を計算する（度数法）
  double _calculateAngle(
    double x1, double y1, // 点1（腰）
    double x2, double y2, // 点2（膝）- 角度の頂点
    double x3, double y3, // 点3（足首）
  ) {
    final radians = (atan2(y3 - y2, x3 - x2) - atan2(y1 - y2, x1 - x2)).abs();
    var degrees = radians * 180 / pi;
    if (degrees > 180) {
      degrees = 360 - degrees;
    }
    return degrees;
  }

  @override
  Widget build(BuildContext context) {
    if (_cameraController == null || !_cameraController!.value.isInitialized) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    return Scaffold(
      appBar: AppBar(title: const Text('姿勢検出')),
      body: Stack(
        children: [
          // カメラプレビュー
          CameraPreview(_cameraController!),

          // 検出した姿勢を描画
          CustomPaint(
            painter: PosePainter(_detectedPoses),
            size: Size.infinite,
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _cameraController?.dispose();
    _poseDetector?.close();
    super.dispose();
  }
}

/// 検出した姿勢を画面に描画するクラス
class PosePainter extends CustomPainter {
  final List<Pose> poses;

  PosePainter(this.poses);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.green
      ..strokeWidth = 4
      ..style = PaintingStyle.stroke;

    for (final pose in poses) {
      // 各関節を点で描画
      for (final landmark in pose.landmarks.values) {
        canvas.drawCircle(
          Offset(landmark.x, landmark.y),
          5,
          paint,
        );
      }
    }
  }

  @override
  bool shouldRepaint(PosePainter oldDelegate) => true;
}
```

### 9.4 トラブルシューティング

| 問題 | 原因 | 解決策 |
|-----|------|------|
| カメラが起動しない | 権限が許可されていない | アプリの設定からカメラ権限を許可 |
| 検出が遅い（fpsが低い） | 解像度が高すぎる | `ResolutionPreset.medium`に変更 |
| 検出精度が低い | 照明が暗い | 明るい場所で使用 |
| ビルドエラー（Android） | minSdkVersionが低い | `minSdkVersion 21`に設定 |
| ビルドエラー（iOS） | 権限設定がない | Info.plistにカメラ権限を追加 |
| `_isDetecting`フラグ無視 | フレームが溜まる | フレームスキップを実装 |

**パフォーマンス改善のコツ**:

1. **解像度を下げる**: `ResolutionPreset.medium`または`low`を使用
2. **検出モデル**: `PoseDetectionModel.base`を使用（高速）
3. **フレームスキップ**: 処理中は次のフレームをスキップ
4. **非同期処理**: `async/await`で処理をブロックしない

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0.0 | 2025年12月10日 | 初版作成 | Documentation Engineer |

---

**Document Version**: v1.0.0
**Last Updated**: 2025年12月10日
**Author**: AIフィットネスアプリ開発チーム

---

**以上**
