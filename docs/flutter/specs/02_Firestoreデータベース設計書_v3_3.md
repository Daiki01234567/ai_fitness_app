# Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ v3.3 (Part 1/4)

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒª(ä»®ç§°)  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.3 (MVP)  
**ä½œæˆæ—¥**: 2025å¹´11æœˆ24æ—¥  
**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´11æœˆ24æ—¥  
**å¯¾è±¡æœŸé–“**: Phase 1-2 (0-7ãƒ¶æœˆ)  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Draft

---

## ğŸ“ v3.3ã§ã®ä¸»ãªå¤‰æ›´ç‚¹

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹åˆ†æv1.0ã«åŸºã¥ãé‡è¦ãªæ›´æ–°

âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å®Œå…¨å®Ÿè£…**:
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è©³ç´°åŒ–
- `tosAccepted`ã€`ppAccepted`ãªã©ã®é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«åˆ¶é™
- ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’å…¨ã¦ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
- ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã‚’å®Œå…¨å®Ÿè£…

âœ… **ãƒ‡ãƒ¼ã‚¿å‰Šé™¤30æ—¥çŒ¶äºˆæœŸé–“ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**:
- `deletionScheduled`ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’å®Ÿè£…
- å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª­ã¿å–ã‚Šã®ã¿è¨±å¯ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰
- æ–°è¦ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ»æ›´æ–°ã‚’å®Œå…¨ã«ç¦æ­¢
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§çŒ¶äºˆæœŸé–“ä¸­ã®åˆ¶å¾¡ã‚’å¼·åŒ–

âœ… **åŒæ„æ’¤å›å¾Œã®å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½**:
- `forceLogout`ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã®è¿½åŠ 
- `forceLogoutAt`ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®å³åº§ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ä¿è¨¼

âœ… **MediaPipeãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾å¿œ**:
- `sessionMetadata`ã«`deviceInfo`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
- `averageFps`ã€`frameDropCount`ãªã©ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã‚’è¨˜éŒ²
- ä½ã‚¹ãƒšãƒƒã‚¯ç«¯æœ«ã®æ¤œå‡ºã¨åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿åé›†

âœ… **BigQueryãƒªãƒˆãƒ©ã‚¤å‡¦ç†å¯¾å¿œ**:
- `bigquerySyncFailures`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
- åŒæœŸå¤±æ•—ã®è¿½è·¡ã¨Dead Letter Queueå®Ÿè£…
- ãƒªãƒˆãƒ©ã‚¤å›æ•°ã¨å¤±æ•—ç†ç”±ã®è¨˜éŒ²

âœ… **ãƒ‡ãƒ¼ã‚¿ä¾µå®³é€šçŸ¥å¯¾å¿œ**:
- `securityIncidents`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
- GDPRç¬¬33æ¡ãƒ»34æ¡ã«åŸºã¥ãã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†
- é€šçŸ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®è¿½è·¡

âœ… **ç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ¶é™å¯¾å¿œ**:
- `dailyUsageCount`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼ˆå°†æ¥ã®Phase 3å®Ÿè£…ç”¨ï¼‰
- `lastUsageResetDate`ã§æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆã‚’ç®¡ç†
- èª²é‡‘ãƒ—ãƒ©ãƒ³ã¨ã®é€£æºã‚’è¨­è¨ˆ

âœ… **ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæº–å‚™**:
- `sessionMetadata`ã«è¿½åŠ ã®MLå­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
- ãƒ•ãƒ¬ãƒ¼ãƒ é–“é€Ÿåº¦ãƒ»åŠ é€Ÿåº¦ã®è¨ˆç®—çµæœã‚’ä¿å­˜
- ã‚«ãƒ¡ãƒ©è¨­å®šæƒ…å ±ã¨ãƒ‡ãƒã‚¤ã‚¹å‚¾ããƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€

âœ… **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¦‹ç›´ã—ã«å¯¾å¿œ**:
- Phase 1-2ã®æœŸé–“ã‚’4ãƒ¶æœˆâ†’7ãƒ¶æœˆã«æ›´æ–°
- å®Ÿè£…ã®å„ªå…ˆé †ä½ã‚’æ˜ç¢ºåŒ–
- ãƒ†ã‚¹ãƒˆæœŸé–“ã¨ãƒãƒƒãƒ•ã‚¡ã‚’è€ƒæ…®

---

## ç›®æ¬¡

### Part 1: æ¦‚è¦ã¨Usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
1. [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦](#1-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦)
2. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆåŸå‰‡](#2-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆåŸå‰‡)
3. [Firestoreæ§‹æˆæ¦‚è¦](#3-firestoreæ§‹æˆæ¦‚è¦)
4. [Usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#4-usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)

### Part 2: Sessionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
5. [Sessionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#5-sessionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)

### Part 3: ãã®ä»–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
6. [Consentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#6-consentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
7. [Subscriptionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#7-subscriptionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
8. [Notificationsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#8-notificationsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
9. [DataDeletionRequestsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#9-datadeletionrequestsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
10. [BigQuerySyncFailuresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#10-bigquerysyncfailuresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
11. [SecurityIncidentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³](#11-securityincidentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)

### Part 4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
12. [Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«](#12-firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«)
13. [ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ](#13-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ)
14. [ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼](#14-ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼)
15. [ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢æˆ¦ç•¥](#15-ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚¢æˆ¦ç•¥)

---

## 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦

### 1.1 ç›®çš„

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€AIãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒª(ä»®ç§°)ã®Cloud Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã‚’å®šç¾©ã—ã¾ã™ã€‚ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã‚’æä¾›ã—ã¾ã™:

- **æ©Ÿèƒ½è¦ä»¶**: è¦ä»¶å®šç¾©æ›¸v3.3ã«å®šç¾©ã•ã‚ŒãŸ39é …ç›®ã®æ©Ÿèƒ½è¦ä»¶ã‚’å®Ÿç¾
- **æ³•çš„æº–æ‹ **: åˆ©ç”¨è¦ç´„v3.2ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼v3.1ã«å®Œå…¨æº–æ‹ 
- **GDPRå¯¾å¿œ**: GDPR/EDPB Guidelinesã®è¦æ±‚äº‹é …ã‚’æŠ€è¡“çš„ã«å®Ÿè£…
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹åˆ†æv1.0ã§ç‰¹å®šã•ã‚ŒãŸ18ã®æ‡¸å¿µç‚¹ã«å¯¾å¿œ
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: éæ©Ÿèƒ½è¦ä»¶NFR-001~008ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã‚’æº€ãŸã™
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: 7ãƒ¶æœˆã®é–‹ç™ºæœŸé–“ã¨MVPå¾Œã®æ‹¡å¼µã‚’è€ƒæ…®

### 1.2 æƒ³å®šèª­è€…

- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- æ³•å‹™æ‹…å½“è€…
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼

### 1.3 å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å‚ç…§ç›®çš„ |
|--------------|-----------|---------|
| è¦ä»¶å®šç¾©æ›¸ | v3.3 | æ©Ÿèƒ½è¦ä»¶ãƒ»éæ©Ÿèƒ½è¦ä»¶ã®è©³ç´° |
| åˆ©ç”¨è¦ç´„ | v3.2 | æ³•çš„åˆ¶ç´„ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© |
| ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ | v3.1 | ãƒ‡ãƒ¼ã‚¿å–ã‚Šæ‰±ã„ãƒ»GDPRæº–æ‹  |
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹åˆ†æ | v1.0 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å®Ÿè£…ä¸Šã®æ‡¸å¿µç‚¹ |
| ç”»é¢é·ç§»å›³+ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  | v3.3 | UI/UXè¦ä»¶ |
| ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ | v3.2 | æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ |

### 1.4 ç”¨èªå®šç¾©

| ç”¨èª | å®šç¾© |
|-----|------|
| **MVP** | Minimum Viable Productã€‚Phase 1-2(0-7ãƒ¶æœˆ)ã§æä¾›ã™ã‚‹æœ€å°é™ã®æ©Ÿèƒ½ã‚»ãƒƒãƒˆ |
| **éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿** | MediaPipe PoseãŒæŠ½å‡ºã™ã‚‹33å€‹ã®é–¢ç¯€ä½ç½®(X,Y,Zåº§æ¨™+ä¿¡é ¼åº¦) |
| **ä»®ååŒ–** | å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã‚’å‰Šé™¤ãƒ»å¤‰æ›ã—ã¦åŒ¿ååŒ–ã™ã‚‹å‡¦ç† |
| **åŒæ„ç®¡ç†** | åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹æ©Ÿèƒ½ |
| **å‰Šé™¤çŒ¶äºˆæœŸé–“** | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰å®Ÿéš›ã®å‰Šé™¤ã¾ã§30æ—¥é–“ã®çŒ¶äºˆæœŸé–“ |
| **å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ** | åŒæ„æ’¤å›æ™‚ã«ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å¼·åˆ¶çš„ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã‚‹æ©Ÿèƒ½ |

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆåŸå‰‡

### 2.1 åŸºæœ¬åŸå‰‡

#### 2.1.1 GDPRæº–æ‹ è¨­è¨ˆ

**ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–ã®åŸå‰‡**:
- å¿…è¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’åé›†ãƒ»ä¿å­˜
- å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åé›†ç›®çš„ã‚’æ˜ç¢ºåŒ–
- ä¸è¦ã«ãªã£ãŸãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å‰Šé™¤

**ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ»ãƒã‚¤ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·
- ä»®ååŒ–ãƒ‡ãƒ¼ã‚¿ã¨å€‹äººãƒ‡ãƒ¼ã‚¿ã®åˆ†é›¢
- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’Firestoreãƒ«ãƒ¼ãƒ«ã§å®Ÿè£…

**ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ¨©åˆ©ä¿éšœ**:
- ã‚¢ã‚¯ã‚»ã‚¹æ¨©ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼‰
- å‰Šé™¤æ¨©ï¼ˆ30æ—¥çŒ¶äºˆæœŸé–“ä»˜ãå®Œå…¨å‰Šé™¤ï¼‰
- è¨‚æ­£æ¨©ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°æ©Ÿèƒ½ï¼‰
- åŒæ„æ’¤å›æ¨©ï¼ˆå¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ï¼‰

#### 2.1.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡

**ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**:
- å…¨ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªè¨¼ãƒ»èªå¯
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¿è­·

**å¤šå±¤é˜²å¾¡**:
- Firebase Authenticationï¼ˆèªè¨¼å±¤ï¼‰
- Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆèªå¯å±¤ï¼‰
- Cloud Functionsï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼‰
- BigQueryï¼ˆåˆ†æå±¤ãƒ»ä»®ååŒ–å‡¦ç†ï¼‰

**ç›£æŸ»ã¨ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£**:
- å…¨ã¦ã®é‡è¦æ“ä½œã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
- ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è¿½è·¡
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®è¨˜éŒ²

#### 2.1.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸå‰‡

**åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªè¨­è¨ˆ**:
- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ´»ç”¨
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
- N+1å•é¡Œã®å›é¿

**ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æœ€é©åŒ–**:
- é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«
- å¤§ããªãƒ‡ãƒ¼ã‚¿ã¯ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†é›¢
- é…åˆ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é©åˆ‡ãªä½¿ç”¨

**ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥**:
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- å¤‰æ›´é »åº¦ã®ä½ã„ãƒ‡ãƒ¼ã‚¿ã®ç©æ¥µçš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã®æœ€å°åŒ–

### 2.2 å‘½åè¦å‰‡

#### 2.2.1 ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å

- **è¤‡æ•°å½¢**ã‚’ä½¿ç”¨ï¼ˆä¾‹: `users`, `sessions`, `consents`ï¼‰
- **PascalCase**ã‚’ä½¿ç”¨ï¼ˆä¾‹: `DataDeletionRequests`, `BigQuerySyncFailures`ï¼‰
- **æ˜ç¢ºã§èª¬æ˜çš„**ãªåå‰ã‚’ä½¿ç”¨

#### 2.2.2 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å

- **camelCase**ã‚’ä½¿ç”¨ï¼ˆä¾‹: `createdAt`, `tosAccepted`ï¼‰
- **boolean**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`is`ã¾ãŸã¯å‹•è©ã®éå»åˆ†è©ã§å§‹ã‚ã‚‹ï¼ˆä¾‹: `isActive`, `deletionScheduled`ï¼‰
- **æ—¥æ™‚**ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`~At`ã¾ãŸã¯`~Date`ã§çµ‚ã‚ã‚‹ï¼ˆä¾‹: `createdAt`, `scheduledDeletionDate`ï¼‰

#### 2.2.3 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID

- **è‡ªå‹•ç”ŸæˆID**ã‚’åŸºæœ¬ã¨ã™ã‚‹ï¼ˆFirestoreã®`auto-generated ID`ï¼‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ã®ã¿Firebase Authentication UIDã‚’ä½¿ç”¨
- **äºˆæ¸¬ä¸å¯èƒ½**ã§**ä¸€æ„**ãªIDã‚’ä¿è¨¼

### 2.3 ãƒ‡ãƒ¼ã‚¿å‹ã®ä½¿ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

| ãƒ‡ãƒ¼ã‚¿å‹ | ä½¿ç”¨å ´é¢ | æ³¨æ„äº‹é … |
|---------|---------|---------|
| `string` | ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å…¨èˆ¬ | æœ€å¤§1MBã€‚é•·æ–‡ã¯åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ |
| `number` | æ•°å€¤ãƒ‡ãƒ¼ã‚¿ | 64ãƒ“ãƒƒãƒˆæµ®å‹•å°æ•°ç‚¹æ•° |
| `boolean` | ãƒ•ãƒ©ã‚°ãƒ»çŠ¶æ…‹ç®¡ç† | `null`ã§ã¯ãªãæ˜ç¤ºçš„ã«`false`ã‚’ä½¿ç”¨ |
| `timestamp` | æ—¥æ™‚ãƒ‡ãƒ¼ã‚¿ | `FieldValue.serverTimestamp()`ã‚’ä½¿ç”¨ |
| `map` | æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ | ãƒã‚¹ãƒˆã¯æµ…ãï¼ˆ2-3å±¤ã¾ã§ï¼‰ |
| `array` | ãƒªã‚¹ãƒˆãƒ»ã‚»ãƒƒãƒˆ | æœ€å¤§è¦ç´ æ•°ã«æ³¨æ„ï¼ˆæ¨å¥¨: 100æœªæº€ï¼‰ |
| `reference` | ä»–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®å‚ç…§ | ä½¿ç”¨ã¯æœ€å°é™ã« |
| `geopoint` | ä½ç½®æƒ…å ± | ç¾åœ¨ã®MVPã§ã¯æœªä½¿ç”¨ |

---

## 3. Firestoreæ§‹æˆæ¦‚è¦

### 3.1 ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³éšå±¤

```
firestore/
â”œâ”€â”€ users/                                    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”œâ”€â”€ {userId}/                             # Firebase Auth UID
â”‚   â”‚   â”œâ”€â”€ sessions/                         # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ {sessionId}/                  # è‡ªå‹•ç”ŸæˆID
â”‚   â”‚   â”‚       â””â”€â”€ frames/                   # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”‚   â”‚           â””â”€â”€ {frameId}/            # è‡ªå‹•ç”ŸæˆID
â”‚   â”‚   â”œâ”€â”€ settings/                         # ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ {settingId}/                  # è‡ªå‹•ç”ŸæˆID
â”‚   â”‚   â””â”€â”€ subscriptions/                    # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”‚       â””â”€â”€ {subscriptionId}/             # RevenueCat ID
â”‚
â”œâ”€â”€ consents/                                 # åŒæ„ç®¡ç†ï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â””â”€â”€ {consentId}/                          # è‡ªå‹•ç”ŸæˆID
â”‚
â”œâ”€â”€ notifications/                            # é€šçŸ¥ï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â””â”€â”€ {notificationId}/                     # è‡ªå‹•ç”ŸæˆID
â”‚
â”œâ”€â”€ dataDeletionRequests/                     # ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â””â”€â”€ {requestId}/                          # è‡ªå‹•ç”ŸæˆID
â”‚
â”œâ”€â”€ bigquerySyncFailures/                     # BigQueryåŒæœŸå¤±æ•—ï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â””â”€â”€ {failureId}/                          # è‡ªå‹•ç”ŸæˆID
â”‚
â””â”€â”€ securityIncidents/                        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    â””â”€â”€ {incidentId}/                         # è‡ªå‹•ç”ŸæˆID
```

### 3.2 ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§

| ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å | ç¨®é¡ | ç›®çš„ | ã‚¢ã‚¯ã‚»ã‚¹æ¨© |
|--------------|-----|-----|----------|
| `users` | ãƒ«ãƒ¼ãƒˆ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± | æœ¬äººã®ã¿èª­ã¿æ›¸ã |
| `users/{userId}/sessions` | ã‚µãƒ– | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ² | æœ¬äººã®ã¿èª­ã¿æ›¸ã |
| `users/{userId}/sessions/{sessionId}/frames` | ã‚µãƒ– | ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã®éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ | æœ¬äººã®ã¿èª­ã¿å–ã‚Š |
| `users/{userId}/settings` | ã‚µãƒ– | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š | æœ¬äººã®ã¿èª­ã¿æ›¸ã |
| `users/{userId}/subscriptions` | ã‚µãƒ– | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ± | æœ¬äººã®ã¿èª­ã¿å–ã‚Š |
| `consents` | ãƒ«ãƒ¼ãƒˆ | åŒæ„å±¥æ­´ç®¡ç† | æœ¬äººã®ã¿èª­ã¿å–ã‚Š |
| `notifications` | ãƒ«ãƒ¼ãƒˆ | é€šçŸ¥ç®¡ç† | æœ¬äººã®ã¿èª­ã¿æ›¸ã |
| `dataDeletionRequests` | ãƒ«ãƒ¼ãƒˆ | ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | æœ¬äººã®ã¿èª­ã¿å–ã‚Š |
| `bigquerySyncFailures` | ãƒ«ãƒ¼ãƒˆ | BigQueryåŒæœŸå¤±æ•—è¨˜éŒ² | ç®¡ç†è€…ã®ã¿ |
| `securityIncidents` | ãƒ«ãƒ¼ãƒˆ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç† | ç®¡ç†è€…ã®ã¿ |

### 3.3 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ¦‚è¦

```mermaid
graph TB
    A[Flutter App] -->|èªè¨¼| B[Firebase Auth]
    A -->|CRUDæ“ä½œ| C[Firestore]
    C -->|Firestore Trigger| D[Cloud Functions]
    D -->|ä»®ååŒ–å‡¦ç†| E[BigQuery]
    D -->|èª²é‡‘ç®¡ç†| F[RevenueCat]
    D -->|é€šçŸ¥é€ä¿¡| G[FCM]
    
    style C fill:#ffa,stroke:#333,stroke-width:4px
    style D fill:#aff,stroke:#333,stroke-width:2px
    style E fill:#faf,stroke:#333,stroke-width:2px
```

---

## 4. Usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 4.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/users/{userId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: Firebase Authentication UID  
**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŸºæœ¬æƒ…å ±ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç®¡ç†

### 4.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface UserDocument {
  // === åŸºæœ¬æƒ…å ± ===
  userId: string;                    // Firebase Auth UIDï¼ˆå¿…é ˆï¼‰
  email: string;                     // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå¿…é ˆï¼‰
  displayName: string | null;        // è¡¨ç¤ºåï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  photoURL: string | null;           // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURLï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  
  // === ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± ===
  profile: {
    height: number | null;           // èº«é•·ï¼ˆcmã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    weight: number | null;           // ä½“é‡ï¼ˆkgã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    birthday: Timestamp | null;      // ç”Ÿå¹´æœˆæ—¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    gender: 'male' | 'female' | 'other' | 'prefer_not_to_say' | null;  // æ€§åˆ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    fitnessLevel: 'beginner' | 'intermediate' | 'advanced' | null;  // ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ¬ãƒ™ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    goals: string[];                 // ç›®æ¨™ãƒªã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ç©ºé…åˆ—å¯ï¼‰
  };
  
  // === åŒæ„ç®¡ç†ï¼ˆGDPRå¯¾å¿œï¼‰ ===
  tosAccepted: boolean;              // åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ï¼ˆå¿…é ˆã€èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  tosAcceptedAt: Timestamp | null;   // åˆ©ç”¨è¦ç´„åŒæ„æ—¥æ™‚ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  tosVersion: string | null;         // åŒæ„ã—ãŸåˆ©ç”¨è¦ç´„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  ppAccepted: boolean;               // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ï¼ˆå¿…é ˆã€èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  ppAcceptedAt: Timestamp | null;    // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„æ—¥æ™‚ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  ppVersion: string | null;          // åŒæ„ã—ãŸãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
  
  // === ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ç®¡ç† ===
  isActive: boolean;                 // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰
  deletionScheduled: boolean;        // å‰Šé™¤äºˆå®šãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰
  deletionScheduledAt: Timestamp | null;  // å‰Šé™¤äºˆå®šæ—¥æ™‚
  scheduledDeletionDate: Timestamp | null;  // å®Ÿéš›ã®å‰Šé™¤äºˆå®šæ—¥ï¼ˆ30æ—¥å¾Œï¼‰
  
  // === å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ï¼ˆåŒæ„æ’¤å›å¯¾å¿œï¼‰ ===
  forceLogout: boolean;              // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰
  forceLogoutAt: Timestamp | null;   // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¨­å®šæ—¥æ™‚
  
  // === ç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ¶é™ï¼ˆPhase 3å®Ÿè£…äºˆå®šï¼‰ ===
  dailyUsageCount: number;           // æœ¬æ—¥ã®ä½¿ç”¨å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰
  lastUsageResetDate: Timestamp | null;  // æœ€çµ‚ãƒªã‚»ãƒƒãƒˆæ—¥æ™‚
  
  // === ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ± ===
  subscriptionStatus: 'free' | 'premium' | 'trial';  // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ï¼ˆå¿…é ˆï¼‰
  subscriptionPlan: string | null;   // ãƒ—ãƒ©ãƒ³åï¼ˆä¾‹: 'monthly_500'ï¼‰
  subscriptionStartDate: Timestamp | null;  // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–‹å§‹æ—¥
  subscriptionEndDate: Timestamp | null;    // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çµ‚äº†æ—¥
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  lastLoginAt: Timestamp | null;     // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚
  
  // === ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ç®¡ç†ï¼ˆGDPRå¯¾å¿œï¼‰ ===
  dataRetentionDate: Timestamp | null;  // ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥
}
```

### 4.3 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è©³ç´°

#### 4.3.1 åŸºæœ¬æƒ…å ±

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `userId` | string | âœ… | Firebase Auth UID | èª­ã¿å–ã‚Šå°‚ç”¨ã€å¤‰æ›´ä¸å¯ |
| `email` | string | âœ… | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«å½¢å¼ã€èª­ã¿å–ã‚Šå°‚ç”¨ |
| `displayName` | string \| null | âŒ | è¡¨ç¤ºå | æœ€å¤§100æ–‡å­— |
| `photoURL` | string \| null | âŒ | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL | æœ‰åŠ¹ãªURLå½¢å¼ |

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- `userId`ã¨`email`ã¯**Firebase Authenticationã‹ã‚‰åŒæœŸ**ã•ã‚Œã€Firestoreä¸Šã§ã¯**èª­ã¿å–ã‚Šå°‚ç”¨**
- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã¯**Firebase Storage**ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€URLã‚’ä¿å­˜
- è¡¨ç¤ºåã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„è¨­å®šå¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®@å‰éƒ¨åˆ†ï¼‰

#### 4.3.2 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `profile.height` | number \| null | âŒ | èº«é•·ï¼ˆcmï¼‰ | 100 â‰¤ height â‰¤ 250 |
| `profile.weight` | number \| null | âŒ | ä½“é‡ï¼ˆkgï¼‰ | 30 â‰¤ weight â‰¤ 300 |
| `profile.birthday` | Timestamp \| null | âŒ | ç”Ÿå¹´æœˆæ—¥ | 13æ­³ä»¥ä¸Š |
| `profile.gender` | string \| null | âŒ | æ€§åˆ¥ | 'male', 'female', 'other', 'prefer_not_to_say' |
| `profile.fitnessLevel` | string \| null | âŒ | ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ¬ãƒ™ãƒ« | 'beginner', 'intermediate', 'advanced' |
| `profile.goals` | string[] | âŒ | ç›®æ¨™ãƒªã‚¹ãƒˆ | å„è¦ç´ æœ€å¤§100æ–‡å­—ã€æœ€å¤§5ä»¶ |

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- å…¨ã¦ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã¯**ã‚ªãƒ—ã‚·ãƒ§ãƒ³**ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
- èº«é•·ãƒ»ä½“é‡ã¯**ãƒ•ã‚©ãƒ¼ãƒ ç¢ºèªè£œåŠ©ã®ç²¾åº¦å‘ä¸Š**ã«ä½¿ç”¨å¯èƒ½ï¼ˆPhase 3ä»¥é™ï¼‰
- ç”Ÿå¹´æœˆæ—¥ã¯**13æ­³æœªæº€ã®åˆ©ç”¨ã‚’é˜²ã**ãŸã‚ã«ä½¿ç”¨
- æ€§åˆ¥æƒ…å ±ã¯**çµ±è¨ˆåˆ†æç”¨**ï¼ˆä»®ååŒ–å¾Œã«BigQueryã¸ï¼‰
- ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ãƒ¬ãƒ™ãƒ«ã¯**æ¨å¥¨ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºå¼·åº¦ã®èª¿æ•´**ã«ä½¿ç”¨
- ç›®æ¨™ã¯**ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º**ã«ä½¿ç”¨

#### 4.3.3 åŒæ„ç®¡ç†ï¼ˆGDPRå¯¾å¿œï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `tosAccepted` | boolean | âœ… | åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ | èª­ã¿å–ã‚Šå°‚ç”¨ã€trueå¿…é ˆ |
| `tosAcceptedAt` | Timestamp \| null | âŒ | åˆ©ç”¨è¦ç´„åŒæ„æ—¥æ™‚ | èª­ã¿å–ã‚Šå°‚ç”¨ |
| `tosVersion` | string \| null | âŒ | åŒæ„ã—ãŸåˆ©ç”¨è¦ç´„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª­ã¿å–ã‚Šå°‚ç”¨ã€ä¾‹: "3.2" |
| `ppAccepted` | boolean | âœ… | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ | èª­ã¿å–ã‚Šå°‚ç”¨ã€trueå¿…é ˆ |
| `ppAcceptedAt` | Timestamp \| null | âŒ | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„æ—¥æ™‚ | èª­ã¿å–ã‚Šå°‚ç”¨ |
| `ppVersion` | string \| null | âŒ | åŒæ„ã—ãŸãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª­ã¿å–ã‚Šå°‚ç”¨ã€ä¾‹: "3.1" |

**CRITICAL - èª­ã¿å–ã‚Šå°‚ç”¨ã®å®Ÿè£…**:
```javascript
// Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§å¼·åˆ¶
allow update: if request.auth != null 
              && request.auth.uid == userId
              // åŒæ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¤‰æ›´ç¦æ­¢
              && request.resource.data.tosAccepted == resource.data.tosAccepted
              && request.resource.data.tosAcceptedAt == resource.data.tosAcceptedAt
              && request.resource.data.tosVersion == resource.data.tosVersion
              && request.resource.data.ppAccepted == resource.data.ppAccepted
              && request.resource.data.ppAcceptedAt == resource.data.ppAcceptedAt
              && request.resource.data.ppVersion == resource.data.ppVersion;
```

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- åŒæ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯**Cloud Functionsã®ã¿ãŒæ›´æ–°å¯èƒ½**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›´æ¥å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’**Firestoreãƒ«ãƒ¼ãƒ«ã§ç¦æ­¢**
- åŒæ„æ’¤å›ã¯`user_revokeConsent` Cloud FunctionçµŒç”±ã§ã®ã¿å¯èƒ½
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#1ã€ŒFirestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è©³ç´°è¨­è¨ˆãŒæœªå®Œæˆã€ã«å¯¾å¿œ

#### 4.3.4 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ç®¡ç†

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `isActive` | boolean | âœ… | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹ãƒ•ãƒ©ã‚° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: true |
| `deletionScheduled` | boolean | âœ… | å‰Šé™¤äºˆå®šãƒ•ãƒ©ã‚° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false |
| `deletionScheduledAt` | Timestamp \| null | âŒ | å‰Šé™¤äºˆå®šæ—¥æ™‚ | å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è¨­å®š |
| `scheduledDeletionDate` | Timestamp \| null | âŒ | å®Ÿéš›ã®å‰Šé™¤äºˆå®šæ—¥ | deletionScheduledAt + 30æ—¥ |

**ãƒ‡ãƒ¼ã‚¿å‰Šé™¤30æ—¥çŒ¶äºˆæœŸé–“ã®å®Ÿè£…**:
```javascript
// Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
match /users/{userId} {
  // å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª­ã¿å–ã‚Šã®ã¿è¨±å¯ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰
  allow read: if request.auth != null 
              && request.auth.uid == userId
              && (!resource.data.deletionScheduled || resource.data.deletionScheduled == false);
  
  // å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ›¸ãè¾¼ã¿ç¦æ­¢
  allow write: if request.auth != null 
               && request.auth.uid == userId
               && !resource.data.deletionScheduled
               && !request.resource.data.deletionScheduled;
}
```

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- `deletionScheduled`ãŒ`true`ã®å ´åˆã€**æ–°è¦ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ»æ›´æ–°ã‚’å®Œå…¨ç¦æ­¢**
- å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ã¿å¯èƒ½**ï¼ˆGDPRç¬¬20æ¡å¯¾å¿œï¼‰
- 30æ—¥å¾Œã«`gdpr_executeScheduledDeletions` Cloud FunctionãŒè‡ªå‹•å®Ÿè¡Œ
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#2ã€Œãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®30æ—¥çŒ¶äºˆæœŸé–“ä¸­ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãŒæœªè¨­è¨ˆã€ã«å¯¾å¿œ

#### 4.3.5 å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ï¼ˆåŒæ„æ’¤å›å¯¾å¿œï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `forceLogout` | boolean | âœ… | å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ©ã‚° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false |
| `forceLogoutAt` | Timestamp \| null | âŒ | å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¨­å®šæ—¥æ™‚ | åŒæ„æ’¤å›æ™‚ã«è¨­å®š |

**åŒæ„æ’¤å›å¾Œã®å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè£…**:
```typescript
// Cloud Function: user_revokeConsent
export const user_revokeConsent = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
  }

  const uid = context.auth.uid;

  try {
    // 1. Firestoreã§åŒæ„ã‚’æ’¤å›
    await admin.firestore().collection('users').doc(uid).update({
      tosAccepted: false,
      tosAcceptedAt: null,
      tosVersion: null,
      ppAccepted: false,
      ppAcceptedAt: null,
      ppVersion: null,
      forceLogout: true,  // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ©ã‚°
      forceLogoutAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    });

    // 2. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–
    await admin.auth().revokeRefreshTokens(uid);

    // 3. ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã§å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    await admin.auth().setCustomUserClaims(uid, {
      forceLogout: true,
      forceLogoutAt: Date.now()
    });

    return {
      success: true,
      message: 'åŒæ„ã‚’æ’¤å›ã—ã¾ã—ãŸã€‚å³åº§ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã™ã€‚',
      forceLogout: true
    };
  } catch (error) {
    console.error('Error revoking consent:', error);
    throw new functions.https.HttpsError('internal', 'åŒæ„æ’¤å›ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
});
```

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å®Ÿè£…**:
```dart
// Flutterå´ã§å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’æ¤œå‡º
Future<void> checkForceLogout() async {
  final user = FirebaseAuth.instance.currentUser;
  if (user == null) return;

  final idTokenResult = await user.getIdTokenResult();
  if (idTokenResult.claims?['forceLogout'] == true) {
    // å³åº§ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    await FirebaseAuth.instance.signOut();
    
    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸å¼·åˆ¶é·ç§»
    Navigator.of(context).pushAndRemoveUntil(
      MaterialPageRoute(builder: (context) => LoginScreen()),
      (route) => false,
    );
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('åŒæ„ã‚’æ’¤å›ã—ã¾ã—ãŸ'),
        content: Text('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦åˆ©ç”¨ã™ã‚‹ã«ã¯ã€åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('OK'),
          ),
        ],
      ),
    );
  }
}
```

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- `forceLogout`ãƒ•ãƒ©ã‚°ã¯**Cloud Functionsã®ã¿ãŒè¨­å®šå¯èƒ½**
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯**èµ·å‹•æ™‚ã¨ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚**ã«ãƒã‚§ãƒƒã‚¯
- Firebase Authã®**ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ **ã¨**Firestoreãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**ã®ä¸¡æ–¹ã§ç®¡ç†
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#9ã€ŒåŒæ„æ’¤å›å¾Œã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¾å­˜ã€ã«å¯¾å¿œ

#### 4.3.6 ç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ¶é™ï¼ˆPhase 3å®Ÿè£…äºˆå®šï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `dailyUsageCount` | number | âœ… | æœ¬æ—¥ã®ä½¿ç”¨å›æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0 |
| `lastUsageResetDate` | Timestamp \| null | âŒ | æœ€çµ‚ãƒªã‚»ãƒƒãƒˆæ—¥æ™‚ | æ—¥æ¬¡ã§è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ |

**Phase 3å®Ÿè£…äºˆå®šã®æ©Ÿèƒ½**:
```typescript
// Cloud Function: training_startSession ã§ä½¿ç”¨å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
export const training_startSession = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
  }

  const uid = context.auth.uid;
  const userDoc = await admin.firestore().collection('users').doc(uid).get();
  const userData = userDoc.data();

  // ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®å ´åˆã€1æ—¥3å›åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
  if (userData.subscriptionStatus === 'free') {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const lastReset = userData.lastUsageResetDate?.toDate() || new Date(0);
    lastReset.setHours(0, 0, 0, 0);
    
    // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
    if (today > lastReset) {
      await admin.firestore().collection('users').doc(uid).update({
        dailyUsageCount: 0,
        lastUsageResetDate: admin.firestore.FieldValue.serverTimestamp()
      });
    }
    
    // ä½¿ç”¨å›æ•°ãƒã‚§ãƒƒã‚¯
    if (userData.dailyUsageCount >= 3) {
      throw new functions.https.HttpsError(
        'resource-exhausted',
        'æœ¬æ—¥ã®ç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ©ç”¨å›æ•°ï¼ˆ3å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚'
      );
    }
    
    // ä½¿ç”¨å›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    await admin.firestore().collection('users').doc(uid).update({
      dailyUsageCount: admin.firestore.FieldValue.increment(1)
    });
  }
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å‡¦ç†...
});
```

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- Phase 3ï¼ˆ6-7ãƒ¶æœˆå¾Œï¼‰ã§ã®å®Ÿè£…ã‚’äºˆå®š
- ç„¡æ–™ãƒ—ãƒ©ãƒ³ã¯**1æ—¥3å›**ã¾ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¯èƒ½
- **UTC 00:00**ã§æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯è€ƒæ…®ã—ãªã„ç°¡æ˜“å®Ÿè£…ï¼‰
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã¯**å›æ•°åˆ¶é™ãªã—**
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#14ã€Œç„¡æ–™ãƒ—ãƒ©ãƒ³1æ—¥3å›åˆ¶é™ã®å®Ÿè£…ãŒæœªå®šç¾©ã€ã«å¯¾å¿œ

#### 4.3.7 ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `subscriptionStatus` | string | âœ… | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ | 'free', 'premium', 'trial' |
| `subscriptionPlan` | string \| null | âŒ | ãƒ—ãƒ©ãƒ³å | ä¾‹: 'monthly_500' |
| `subscriptionStartDate` | Timestamp \| null | âŒ | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–‹å§‹æ—¥ | - |
| `subscriptionEndDate` | Timestamp \| null | âŒ | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çµ‚äº†æ—¥ | - |

**RevenueCatã¨ã®é€£æº**:
- RevenueCatã®Webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã¦Firestoreã‚’æ›´æ–°
- `subscriptionStatus`ã¯**RevenueCatã®çŠ¶æ…‹ã¨åŒæœŸ**
- èª²é‡‘çŠ¶æ…‹ã®å¤‰æ›´ã¯**Cloud FunctionsçµŒç”±ã§ã®ã¿æ›´æ–°**

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- åˆå›ç™»éŒ²æ™‚ã¯`subscriptionStatus: 'free'`
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³è³¼å…¥å¾Œã«`'premium'`ã«å¤‰æ›´
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã¯`'free'`ã«æˆ»ã‚‹
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#7ã€Œèª²é‡‘æ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ãŒæœªè¨­è¨ˆã€ã«å¯¾å¿œ

#### 4.3.8 ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `createdAt` | Timestamp | âœ… | ä½œæˆæ—¥æ™‚ | ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€èª­ã¿å–ã‚Šå°‚ç”¨ |
| `updatedAt` | Timestamp | âœ… | æ›´æ–°æ—¥æ™‚ | ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€è‡ªå‹•æ›´æ–° |
| `lastLoginAt` | Timestamp \| null | âŒ | æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ | Cloud FunctionsãŒæ›´æ–° |

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- `createdAt`ã¯**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ™‚ã«1åº¦ã ã‘è¨­å®š**
- `updatedAt`ã¯**å…¨ã¦ã®æ›´æ–°æ™‚ã«è‡ªå‹•æ›´æ–°**
- `lastLoginAt`ã¯**ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«Cloud FunctionsãŒæ›´æ–°**

#### 4.3.9 ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ç®¡ç†ï¼ˆGDPRå¯¾å¿œï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `dataRetentionDate` | Timestamp \| null | âŒ | ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥ | createdAt + 3å¹´ |

**è‡ªå‹•å‰Šé™¤ã®å®Ÿè£…**:
```typescript
// æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†ã§3å¹´ä»¥ä¸ŠçµŒéã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
export const maintenance_deleteExpiredData = functions
  .pubsub
  .schedule('0 3 * * *')  // æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰
  .timeZone('Asia/Tokyo')
  .onRun(async (context) => {
    const threeYearsAgo = new Date();
    threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);
    
    const expiredUsers = await admin.firestore()
      .collection('users')
      .where('dataRetentionDate', '<=', threeYearsAgo)
      .get();
    
    for (const doc of expiredUsers.docs) {
      await deleteUserDataCompletely(doc.id);
    }
  });
```

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- GDPRæº–æ‹ ã®ãŸã‚ã€**3å¹´é–“**ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å‰Šé™¤
- `dataRetentionDate`ã¯**æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥ + 3å¹´**ã§è¨ˆç®—
- å‰Šé™¤å‰ã«**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥**ï¼ˆNFR-015å¯¾å¿œï¼‰

### 4.4 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "userId": "abc123xyz789",
  "email": "user@example.com",
  "displayName": "å±±ç”°å¤ªéƒ",
  "photoURL": "https://storage.googleapis.com/bucket/photos/abc123.jpg",
  
  "profile": {
    "height": 175,
    "weight": 70,
    "birthday": "1990-01-01T00:00:00Z",
    "gender": "male"
  },
  
  "tosAccepted": true,
  "tosAcceptedAt": "2025-05-01T10:00:00Z",
  "tosVersion": "3.2",
  "ppAccepted": true,
  "ppAcceptedAt": "2025-05-01T10:00:00Z",
  "ppVersion": "3.1",
  
  "isActive": true,
  "deletionScheduled": false,
  "deletionScheduledAt": null,
  "scheduledDeletionDate": null,
  
  "forceLogout": false,
  "forceLogoutAt": null,
  
  "dailyUsageCount": 2,
  "lastUsageResetDate": "2025-11-24T00:00:00Z",
  
  "subscriptionStatus": "free",
  "subscriptionPlan": null,
  "subscriptionStartDate": null,
  "subscriptionEndDate": null,
  
  "createdAt": "2025-05-01T10:00:00Z",
  "updatedAt": "2025-11-24T15:30:00Z",
  "lastLoginAt": "2025-11-24T15:30:00Z",
  
  "dataRetentionDate": "2028-11-24T15:30:00Z"
}
```

### 4.5 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«**ï¼ˆè©³ç´°ã¯Part 4ã§èª¬æ˜ï¼‰:
```javascript
match /users/{userId} {
  // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  allow read: if request.auth != null 
              && request.auth.uid == userId
              && !resource.data.deletionScheduled;
  
  // æ›¸ãè¾¼ã¿ã¯åˆ¶é™ä»˜ã
  allow create: if request.auth != null 
                && request.auth.uid == userId
                && validateUserCreate(request.resource.data);
  
  allow update: if request.auth != null 
                && request.auth.uid == userId
                && !resource.data.deletionScheduled
                && validateUserUpdate(request.resource.data, resource.data);
  
  allow delete: if false;  // å‰Šé™¤ã¯Cloud Functionsã®ã¿
}
```

---

**Part 1 çµ‚äº†**

æ¬¡ã®Part 2ã§ã¯ã€Sessionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°è¨­è¨ˆã‚’è¡Œã„ã¾ã™ã€‚
# Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ v3.3 (Part 2/4)

## 5. Sessionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 5.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/users/{userId}/sessions/{sessionId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: è‡ªå‹•ç”ŸæˆID  
**ç›®çš„**: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¨˜éŒ²ã¨éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†

### 5.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface SessionDocument {
  // === åŸºæœ¬æƒ…å ± ===
  sessionId: string;                 // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  userId: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆã€è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
  exerciseType: 'squat' | 'push_up' | 'lunge' | 'plank' | 'bridge';  // ç¨®ç›®ï¼ˆå¿…é ˆï¼‰
  
  // === ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´° ===
  startTime: Timestamp;              // é–‹å§‹æ™‚åˆ»ï¼ˆå¿…é ˆï¼‰
  endTime: Timestamp | null;         // çµ‚äº†æ™‚åˆ»ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã«è¨­å®šï¼‰
  duration: number | null;           // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆç§’ã€endTimeè¨­å®šæ™‚ã«è¨ˆç®—ï¼‰
  status: 'active' | 'completed' | 'cancelled';  // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ï¼ˆå¿…é ˆï¼‰
  
  // === ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœ ===
  repCount: number;                  // å›æ•°ï¼ˆå¿…é ˆï¼‰
  setCount: number;                  // ã‚»ãƒƒãƒˆæ•°ï¼ˆå¿…é ˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
  maxHoldTime: number | null;        // æœ€å¤§ãƒ›ãƒ¼ãƒ«ãƒ‰æ™‚é–“ï¼ˆç§’ã€plank/bridgeã®ã¿ï¼‰
  
  // === ãƒ•ã‚©ãƒ¼ãƒ ç¢ºèªè£œåŠ©çµæœ ===
  formFeedback: {
    overallScore: number;            // ç·åˆã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
    goodFrames: number;              // è‰¯å¥½ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
    warningFrames: number;           // è­¦å‘Šãƒ•ãƒ¬ãƒ¼ãƒ æ•°
    errorFrames: number;             // ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
    warnings: Array<{
      type: string;                  // è­¦å‘Šã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: 'knee_over_toe', 'back_not_straight'ï¼‰
      count: number;                 // ç™ºç”Ÿå›æ•°
      severity: 'low' | 'medium' | 'high';  // é‡å¤§åº¦
    }>;
  };
  
  // === ã‚«ãƒ¡ãƒ©è¨­å®š ===
  cameraSettings: {
    position: 'front' | 'side';      // ã‚«ãƒ¡ãƒ©ä½ç½®ï¼ˆå¿…é ˆï¼‰
    resolution: string;              // è§£åƒåº¦ï¼ˆä¾‹: '1280x720'ï¼‰
    fps: number;                     // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆï¼ˆä¾‹: 30ï¼‰
  };
  
  // === ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æç”¨ï¼‰ ===
  sessionMetadata: {
    totalFrames: number;             // ç·ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
    processedFrames: number;         // å‡¦ç†å®Œäº†ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
    averageFps: number;              // å¹³å‡FPS
    frameDropCount: number;          // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‰ãƒ­ãƒƒãƒ—æ•°
    averageConfidence: number;       // å¹³å‡ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0-1ï¼‰
    
    // MediaPipeãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#3å¯¾å¿œï¼‰
    mediapipePerformance: {
      averageInferenceTime: number;  // å¹³å‡æ¨è«–æ™‚é–“ï¼ˆmsï¼‰
      maxInferenceTime: number;      // æœ€å¤§æ¨è«–æ™‚é–“ï¼ˆmsï¼‰
      minInferenceTime: number;      // æœ€å°æ¨è«–æ™‚é–“ï¼ˆmsï¼‰
    };
    
    // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ï¼ˆä½ã‚¹ãƒšãƒƒã‚¯ç«¯æœ«ã®æ¤œå‡ºç”¨ï¼‰
    deviceInfo: {
      platform: 'iOS' | 'Android';   // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
      osVersion: string;             // OSãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: 'iOS 17.1', 'Android 13'ï¼‰
      deviceModel: string;           // ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: 'iPhone 14', 'Pixel 7'ï¼‰
      deviceMemory: number | null;   // ãƒ‡ãƒã‚¤ã‚¹ãƒ¡ãƒ¢ãƒªï¼ˆGBï¼‰
      cpuArchitecture: string | null;  // CPUã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆä¾‹: 'arm64', 'x86_64'ï¼‰
    };
    
    // ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæº–å‚™ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#11å¯¾å¿œï¼‰
    mlPreparationData: {
      frameLevelVelocity: boolean;   // ãƒ•ãƒ¬ãƒ¼ãƒ é–“é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ãŸã‹
      frameLevelAcceleration: boolean;  // ãƒ•ãƒ¬ãƒ¼ãƒ é–“åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ãŸã‹
      deviceOrientationTracked: boolean;  // ãƒ‡ãƒã‚¤ã‚¹å‚¾ãã‚’è¿½è·¡ã—ãŸã‹
      lightingCondition: string | null;  // ç…§æ˜æ¡ä»¶ï¼ˆä¾‹: 'bright', 'normal', 'dim'ï¼‰
    };
  };
  
  // === BigQueryåŒæœŸçŠ¶æ…‹ ===
  bigquerySyncStatus: 'pending' | 'synced' | 'failed';  // åŒæœŸçŠ¶æ…‹ï¼ˆå¿…é ˆï¼‰
  bigquerySyncedAt: Timestamp | null;  // åŒæœŸå®Œäº†æ—¥æ™‚
  bigquerySyncError: string | null;    // åŒæœŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  bigquerySyncRetryCount: number;      // ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  
  // === ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ç®¡ç† ===
  dataRetentionDate: Timestamp | null;  // ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥ï¼ˆcreatedAt + 3å¹´ï¼‰
}
```

### 5.3 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è©³ç´°

#### 5.3.1 åŸºæœ¬æƒ…å ±

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `sessionId` | string | âœ… | ã‚»ãƒƒã‚·ãƒ§ãƒ³ID | è‡ªå‹•ç”Ÿæˆã€å¤‰æ›´ä¸å¯ |
| `userId` | string | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã€å¤‰æ›´ä¸å¯ |
| `exerciseType` | string | âœ… | ç¨®ç›® | 'squat', 'push_up', 'lunge', 'plank', 'bridge' |

#### 5.3.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `startTime` | Timestamp | âœ… | é–‹å§‹æ™‚åˆ» | ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| `endTime` | Timestamp \| null | âŒ | çµ‚äº†æ™‚åˆ» | startTimeã‚ˆã‚Šå¾Œ |
| `duration` | number \| null | âŒ | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆç§’ï¼‰ | endTime - startTime |
| `status` | string | âœ… | ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ | 'active', 'completed', 'cancelled' |

**ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®é·ç§»**:
```
active â†’ completed (æ­£å¸¸çµ‚äº†)
active â†’ cancelled (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«)
```

#### 5.3.3 ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœ

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `repCount` | number | âœ… | å›æ•° | 0 â‰¤ repCount â‰¤ 1000 |
| `setCount` | number | âœ… | ã‚»ãƒƒãƒˆæ•° | 1 â‰¤ setCount â‰¤ 10 |
| `maxHoldTime` | number \| null | âŒ | æœ€å¤§ãƒ›ãƒ¼ãƒ«ãƒ‰æ™‚é–“ï¼ˆç§’ï¼‰ | plank/bridgeã®ã¿ |

#### 5.3.4 ãƒ•ã‚©ãƒ¼ãƒ ç¢ºèªè£œåŠ©çµæœ

```typescript
interface FormFeedback {
  overallScore: number;              // ç·åˆã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
  goodFrames: number;                // è‰¯å¥½ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
  warningFrames: number;             // è­¦å‘Šãƒ•ãƒ¬ãƒ¼ãƒ æ•°
  errorFrames: number;               // ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
  warnings: Array<{
    type: string;                    // è­¦å‘Šã‚¿ã‚¤ãƒ—
    count: number;                   // ç™ºç”Ÿå›æ•°
    severity: 'low' | 'medium' | 'high';  // é‡å¤§åº¦
  }>;
}
```

**è­¦å‘Šã‚¿ã‚¤ãƒ—ã®ä¾‹**:
- ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ: `'knee_over_toe'`, `'back_not_straight'`, `'depth_insufficient'`
- ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—: `'elbow_angle_too_wide'`, `'back_not_straight'`, `'neck_not_neutral'`
- ãƒ©ãƒ³ã‚¸: `'knee_over_toe'`, `'balance_poor'`, `'depth_insufficient'`
- ãƒ—ãƒ©ãƒ³ã‚¯: `'hip_too_low'`, `'hip_too_high'`, `'back_not_straight'`
- ãƒ–ãƒªãƒƒã‚¸: `'hip_too_low'`, `'back_overarched'`, `'feet_not_flat'`

#### 5.3.5 ã‚«ãƒ¡ãƒ©è¨­å®š

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `cameraSettings.position` | string | âœ… | ã‚«ãƒ¡ãƒ©ä½ç½® | 'front', 'side' |
| `cameraSettings.resolution` | string | âœ… | è§£åƒåº¦ | ä¾‹: '1280x720' |
| `cameraSettings.fps` | number | âœ… | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ | 15 â‰¤ fps â‰¤ 60 |

#### 5.3.6 ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æç”¨ï¼‰

**MediaPipeãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–**ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#3å¯¾å¿œï¼‰:

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ç›®çš„ |
|-----------|---|-----|------|-----|
| `averageFps` | number | âœ… | å¹³å‡FPS | 30fpsç¶­æŒã®æ¤œè¨¼ |
| `frameDropCount` | number | âœ… | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‰ãƒ­ãƒƒãƒ—æ•° | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã®æ¤œå‡º |
| `mediapipePerformance.averageInferenceTime` | number | âœ… | å¹³å‡æ¨è«–æ™‚é–“ï¼ˆmsï¼‰ | MediaPipeå‡¦ç†é€Ÿåº¦ã®æ¸¬å®š |

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- å¹³å‡FPSãŒ**25fpsæœªæº€**ã®å ´åˆã€ä½ã‚¹ãƒšãƒƒã‚¯ç«¯æœ«ã¨ã—ã¦è¨˜éŒ²
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‰ãƒ­ãƒƒãƒ—æ•°ãŒ**ç·ãƒ•ãƒ¬ãƒ¼ãƒ ã®10%è¶…**ã®å ´åˆã€è­¦å‘Šã‚’è¡¨ç¤º
- BigQueryã§é›†è¨ˆã—ã€**ä½ã‚¹ãƒšãƒƒã‚¯ç«¯æœ«ã®å‰²åˆ**ã‚’åˆ†æ

**ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ï¼ˆä½ã‚¹ãƒšãƒƒã‚¯ç«¯æœ«ã®æ¤œå‡ºç”¨ï¼‰**:

```typescript
deviceInfo: {
  platform: 'iOS' | 'Android';       // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
  osVersion: string;                 // OSãƒãƒ¼ã‚¸ãƒ§ãƒ³
  deviceModel: string;               // ãƒ‡ãƒã‚¤ã‚¹ãƒ¢ãƒ‡ãƒ«
  deviceMemory: number | null;       // ãƒ‡ãƒã‚¤ã‚¹ãƒ¡ãƒ¢ãƒªï¼ˆGBï¼‰
  cpuArchitecture: string | null;    // CPUã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
}
```

**å®Ÿè£…ä¾‹**:
```dart
// Flutterå´ã§ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
import 'package:device_info_plus/device_info_plus.dart';

Future<Map<String, dynamic>> getDeviceInfo() async {
  final deviceInfo = DeviceInfoPlugin();
  
  if (Platform.isIOS) {
    final iosInfo = await deviceInfo.iosInfo;
    return {
      'platform': 'iOS',
      'osVersion': iosInfo.systemVersion,
      'deviceModel': iosInfo.model,
      'deviceMemory': null,  // iOSã§ã¯å–å¾—å›°é›£
      'cpuArchitecture': null,
    };
  } else if (Platform.isAndroid) {
    final androidInfo = await deviceInfo.androidInfo;
    return {
      'platform': 'Android',
      'osVersion': androidInfo.version.release,
      'deviceModel': androidInfo.model,
      'deviceMemory': await _getAndroidMemoryGB(),
      'cpuArchitecture': androidInfo.supported64BitAbis.isNotEmpty ? 'arm64' : 'arm32',
    };
  }
  
  return {};
}
```

**ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæº–å‚™ãƒ‡ãƒ¼ã‚¿**ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#11å¯¾å¿œï¼‰:

```typescript
mlPreparationData: {
  frameLevelVelocity: boolean;       // ãƒ•ãƒ¬ãƒ¼ãƒ é–“é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ãŸã‹
  frameLevelAcceleration: boolean;   // ãƒ•ãƒ¬ãƒ¼ãƒ é–“åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ãŸã‹
  deviceOrientationTracked: boolean; // ãƒ‡ãƒã‚¤ã‚¹å‚¾ãã‚’è¿½è·¡ã—ãŸã‹
  lightingCondition: string | null;  // ç…§æ˜æ¡ä»¶
}
```

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- Phase 2ã‹ã‚‰ãƒ•ãƒ¬ãƒ¼ãƒ é–“é€Ÿåº¦ãƒ»åŠ é€Ÿåº¦ã®è¨ˆç®—ã‚’é–‹å§‹
- Phase 4ã®ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæ™‚ã«**è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã‹åˆ¤æ–­**
- ç…§æ˜æ¡ä»¶ã¯**ã‚«ãƒ¡ãƒ©ã®éœ²å‡ºå€¤ã‹ã‚‰æ¨å®š**

#### 5.3.7 BigQueryåŒæœŸçŠ¶æ…‹ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#4å¯¾å¿œï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `bigquerySyncStatus` | string | âœ… | åŒæœŸçŠ¶æ…‹ | 'pending', 'synced', 'failed' |
| `bigquerySyncedAt` | Timestamp \| null | âŒ | åŒæœŸå®Œäº†æ—¥æ™‚ | - |
| `bigquerySyncError` | string \| null | âŒ | åŒæœŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | - |
| `bigquerySyncRetryCount` | number | âœ… | ãƒªãƒˆãƒ©ã‚¤å›æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ã€æœ€å¤§: 3 |

**BigQueryãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã®å®Ÿè£…**:
```typescript
// Cloud Function: sessions_onCreate (Firestore Trigger)
export const sessions_onCreate = functions.firestore
  .document('users/{userId}/sessions/{sessionId}')
  .onCreate(async (snap, context) => {
    const sessionData = snap.data();
    const { userId, sessionId } = context.params;
    
    try {
      // BigQueryã«ä»®ååŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
      await insertToBigQuery(sessionData);
      
      // æˆåŠŸã—ãŸã‚‰åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      await snap.ref.update({
        bigquerySyncStatus: 'synced',
        bigquerySyncedAt: admin.firestore.FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('BigQuery sync failed:', error);
      
      // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
      const retryCount = (sessionData.bigquerySyncRetryCount || 0) + 1;
      
      if (retryCount <= 3) {
        // Cloud Tasksã§ãƒªãƒˆãƒ©ã‚¤ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        await addToRetryQueue({
          userId,
          sessionId,
          sessionData,
          retryCount,
          error: error.message
        });
        
        await snap.ref.update({
          bigquerySyncStatus: 'failed',
          bigquerySyncError: error.message,
          bigquerySyncRetryCount: retryCount
        });
      } else {
        // 3å›å¤±æ•—ã—ãŸã‚‰Dead Letter Queueã¸
        await addToDeadLetterQueue({
          userId,
          sessionId,
          sessionData,
          error: error.message
        });
        
        // Slackã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
        await sendSlackAlert({
          severity: 'error',
          message: `ğŸš¨ BigQuery sync permanently failed for session ${sessionId}`,
          details: { userId, sessionId, error: error.message }
        });
      }
    }
  });
```

#### 5.3.8 ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `createdAt` | Timestamp | âœ… | ä½œæˆæ—¥æ™‚ | ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| `updatedAt` | Timestamp | âœ… | æ›´æ–°æ—¥æ™‚ | ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| `dataRetentionDate` | Timestamp \| null | âŒ | ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥ | createdAt + 3å¹´ |

### 5.4 ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: Frames

**ãƒ‘ã‚¹**: `/users/{userId}/sessions/{sessionId}/frames/{frameId}`  
**ç›®çš„**: ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã®éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜

#### 5.4.1 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface FrameDocument {
  // === åŸºæœ¬æƒ…å ± ===
  frameId: string;                   // ãƒ•ãƒ¬ãƒ¼ãƒ IDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  sessionId: string;                 // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆå¿…é ˆï¼‰
  frameNumber: number;               // ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ï¼ˆå¿…é ˆã€0ã‹ã‚‰é–‹å§‹ï¼‰
  timestamp: Timestamp;              // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆå¿…é ˆï¼‰
  
  // === éª¨æ ¼åº§æ¨™ãƒ‡ãƒ¼ã‚¿ï¼ˆMediaPipe Pose 33é–¢ç¯€ç‚¹ï¼‰ ===
  landmarks: Array<{
    x: number;                       // Xåº§æ¨™ï¼ˆ0-1ã®æ­£è¦åŒ–åº§æ¨™ï¼‰
    y: number;                       // Yåº§æ¨™ï¼ˆ0-1ã®æ­£è¦åŒ–åº§æ¨™ï¼‰
    z: number;                       // Zåº§æ¨™ï¼ˆæ·±åº¦ã€ç›¸å¯¾å€¤ï¼‰
    visibility: number;              // å¯è¦–æ€§ã‚¹ã‚³ã‚¢ï¼ˆ0-1ï¼‰
  }>;  // é…åˆ—é•·: 33
  
  // === ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
  frameMetadata: {
    confidence: number;              // å…¨ä½“ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0-1ï¼‰
    processingTime: number;          // MediaPipeå‡¦ç†æ™‚é–“ï¼ˆmsï¼‰
    cameraTimestamp: number;         // ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆmsï¼‰
  };
  
  // === ãƒ•ã‚©ãƒ¼ãƒ è©•ä¾¡ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ï¼‰ ===
  formEvaluation: {
    status: 'good' | 'warning' | 'error';  // ãƒ•ãƒ¬ãƒ¼ãƒ è©•ä¾¡
    warnings: string[];              // è­¦å‘Šãƒªã‚¹ãƒˆï¼ˆä¾‹: ['knee_over_toe']ï¼‰
  };
  
  // === ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæº–å‚™ãƒ‡ãƒ¼ã‚¿ï¼ˆPhase 2ä»¥é™ï¼‰ ===
  velocityData?: {                   // ãƒ•ãƒ¬ãƒ¼ãƒ é–“é€Ÿåº¦ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    velocities: Array<{
      jointIndex: number;            // é–¢ç¯€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0-32ï¼‰
      vx: number;                    // Xæ–¹å‘é€Ÿåº¦
      vy: number;                    // Yæ–¹å‘é€Ÿåº¦
      vz: number;                    // Zæ–¹å‘é€Ÿåº¦
    }>;
  };
  
  accelerationData?: {               // ãƒ•ãƒ¬ãƒ¼ãƒ é–“åŠ é€Ÿåº¦ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    accelerations: Array<{
      jointIndex: number;            // é–¢ç¯€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0-32ï¼‰
      ax: number;                    // Xæ–¹å‘åŠ é€Ÿåº¦
      ay: number;                    // Yæ–¹å‘åŠ é€Ÿåº¦
      az: number;                    // Zæ–¹å‘åŠ é€Ÿåº¦
    }>;
  };
  
  deviceOrientation?: {              // ãƒ‡ãƒã‚¤ã‚¹å‚¾ãï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    pitch: number;                   // ãƒ”ãƒƒãƒè§’ï¼ˆåº¦ï¼‰
    roll: number;                    // ãƒ­ãƒ¼ãƒ«è§’ï¼ˆåº¦ï¼‰
    yaw: number;                     // ãƒ¨ãƒ¼è§’ï¼ˆåº¦ï¼‰
  };
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
}
```

#### 5.4.2 ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã®è€ƒæ…®

**1ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºæ¦‚ç®—**:
- `landmarks`: 33é–¢ç¯€ Ã— 4ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ Ã— 8ãƒã‚¤ãƒˆ = ç´„1KB
- `frameMetadata`: ç´„0.1KB
- `formEvaluation`: ç´„0.1KB
- **åˆè¨ˆ**: ç´„1.2KB/ãƒ•ãƒ¬ãƒ¼ãƒ 

**30ç§’ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ30fpsï¼‰**:
- ç·ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: 30ç§’ Ã— 30fps = 900ãƒ•ãƒ¬ãƒ¼ãƒ 
- ç·ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: 900ãƒ•ãƒ¬ãƒ¼ãƒ  Ã— 1.2KB = **ç´„1.08MB**

**å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹**:
- Firestoreã®**1ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ€å¤§ã‚µã‚¤ã‚ºã¯1MB**ã®ãŸã‚ã€ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†é›¢
- Phase 4ã§ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæ™‚ã«**é€Ÿåº¦ãƒ»åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ **ã™ã‚‹å ´åˆã€ã•ã‚‰ã«å¢—åŠ 
- BigQueryã«ã¯**ä»®ååŒ–å¾Œã®ãƒ‡ãƒ¼ã‚¿ã®ã¿**ã‚’åŒæœŸï¼ˆå€‹äººæƒ…å ±ã¯å«ã¾ãªã„ï¼‰

#### 5.4.3 MediaPipe Pose 33é–¢ç¯€ç‚¹ã®å®šç¾©

| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | é–¢ç¯€å | èª¬æ˜ |
|------------|-------|------|
| 0 | nose | é¼» |
| 1-2 | left_eye, right_eye | å·¦ç›®ã€å³ç›® |
| 3-4 | left_ear, right_ear | å·¦è€³ã€å³è€³ |
| 5-6 | left_shoulder, right_shoulder | å·¦è‚©ã€å³è‚© |
| 7-8 | left_elbow, right_elbow | å·¦è‚˜ã€å³è‚˜ |
| 9-10 | left_wrist, right_wrist | å·¦æ‰‹é¦–ã€å³æ‰‹é¦– |
| 11-12 | left_hip, right_hip | å·¦è…°ã€å³è…° |
| 13-14 | left_knee, right_knee | å·¦è†ã€å³è† |
| 15-16 | left_ankle, right_ankle | å·¦è¶³é¦–ã€å³è¶³é¦– |
| 17-22 | hand landmarks | æ‰‹ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆ6ç‚¹ï¼‰ |
| 23-28 | foot landmarks | è¶³ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆ6ç‚¹ï¼‰ |

**ãƒ•ã‚©ãƒ¼ãƒ ç¢ºèªè£œåŠ©ã§é‡è¦ãªé–¢ç¯€**:
- ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ: è…°(11-12)ã€è†(13-14)ã€è¶³é¦–(15-16)
- ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—: è‚©(5-6)ã€è‚˜(7-8)ã€æ‰‹é¦–(9-10)
- ãƒ©ãƒ³ã‚¸: è…°(11-12)ã€è†(13-14)ã€è¶³é¦–(15-16)
- ãƒ—ãƒ©ãƒ³ã‚¯: è‚©(5-6)ã€è…°(11-12)ã€è¶³é¦–(15-16)
- ãƒ–ãƒªãƒƒã‚¸: è‚©(5-6)ã€è…°(11-12)ã€è†(13-14)ã€è¶³é¦–(15-16)

### 5.5 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

#### 5.5.1 Sessionãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```json
{
  "sessionId": "session_abc123",
  "userId": "user_xyz789",
  "exerciseType": "squat",
  
  "startTime": "2025-11-24T10:00:00Z",
  "endTime": "2025-11-24T10:00:30Z",
  "duration": 30,
  "status": "completed",
  
  "repCount": 15,
  "setCount": 1,
  "maxHoldTime": null,
  
  "formFeedback": {
    "overallScore": 85,
    "goodFrames": 800,
    "warningFrames": 100,
    "errorFrames": 0,
    "warnings": [
      {
        "type": "knee_over_toe",
        "count": 5,
        "severity": "low"
      }
    ]
  },
  
  "cameraSettings": {
    "position": "side",
    "resolution": "1280x720",
    "fps": 30
  },
  
  "sessionMetadata": {
    "totalFrames": 900,
    "processedFrames": 900,
    "averageFps": 30,
    "frameDropCount": 0,
    "averageConfidence": 0.92,
    
    "mediapipePerformance": {
      "averageInferenceTime": 25,
      "maxInferenceTime": 35,
      "minInferenceTime": 20
    },
    
    "deviceInfo": {
      "platform": "iOS",
      "osVersion": "iOS 17.1",
      "deviceModel": "iPhone 14",
      "deviceMemory": null,
      "cpuArchitecture": "arm64"
    },
    
    "mlPreparationData": {
      "frameLevelVelocity": true,
      "frameLevelAcceleration": true,
      "deviceOrientationTracked": true,
      "lightingCondition": "normal"
    }
  },
  
  "bigquerySyncStatus": "synced",
  "bigquerySyncedAt": "2025-11-24T10:01:00Z",
  "bigquerySyncError": null,
  "bigquerySyncRetryCount": 0,
  
  "createdAt": "2025-11-24T10:00:00Z",
  "updatedAt": "2025-11-24T10:00:30Z",
  "dataRetentionDate": "2028-11-24T10:00:00Z"
}
```

#### 5.5.2 Frameãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```json
{
  "frameId": "frame_001",
  "sessionId": "session_abc123",
  "frameNumber": 0,
  "timestamp": "2025-11-24T10:00:00.033Z",
  
  "landmarks": [
    {"x": 0.5, "y": 0.3, "z": -0.1, "visibility": 0.95},
    {"x": 0.48, "y": 0.28, "z": -0.1, "visibility": 0.90},
    // ... 31å€‹ã®é–¢ç¯€ç‚¹ãƒ‡ãƒ¼ã‚¿
  ],
  
  "frameMetadata": {
    "confidence": 0.92,
    "processingTime": 25,
    "cameraTimestamp": 1700821200033
  },
  
  "formEvaluation": {
    "status": "good",
    "warnings": []
  },
  
  "velocityData": {
    "velocities": [
      {"jointIndex": 13, "vx": 0.01, "vy": -0.02, "vz": 0.0},
      {"jointIndex": 14, "vx": 0.02, "vy": -0.01, "vz": 0.0}
    ]
  },
  
  "deviceOrientation": {
    "pitch": 85.0,
    "roll": 0.5,
    "yaw": 0.0
  },
  
  "createdAt": "2025-11-24T10:00:00.033Z"
}
```

### 5.6 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«**:
```javascript
match /users/{userId}/sessions/{sessionId} {
  // æœ¬äººã®ã¿èª­ã¿æ›¸ãå¯èƒ½
  allow read: if request.auth != null 
              && request.auth.uid == userId
              && !get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled;
  
  allow create: if request.auth != null 
                && request.auth.uid == userId
                && !get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled
                && validateSessionCreate(request.resource.data);
  
  allow update: if request.auth != null 
                && request.auth.uid == userId
                && !get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled
                && validateSessionUpdate(request.resource.data, resource.data);
  
  allow delete: if false;  // å‰Šé™¤ã¯Cloud Functionsã®ã¿
  
  // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
  match /frames/{frameId} {
    allow read: if request.auth != null 
                && request.auth.uid == userId
                && !get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled;
    
    allow create: if request.auth != null 
                  && request.auth.uid == userId
                  && !get(/databases/$(database)/documents/users/$(userId)).data.deletionScheduled
                  && validateFrameCreate(request.resource.data);
    
    allow update, delete: if false;  // ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ä½œæˆå¾Œå¤‰æ›´ä¸å¯
  }
}

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
function validateSessionCreate(data) {
  return data.keys().hasAll(['sessionId', 'userId', 'exerciseType', 'startTime', 'status'])
         && data.exerciseType in ['squat', 'push_up', 'lunge', 'plank', 'bridge']
         && data.status == 'active'
         && data.bigquerySyncStatus == 'pending'
         && data.repCount >= 0
         && data.setCount >= 1;
}

function validateSessionUpdate(newData, oldData) {
  return newData.sessionId == oldData.sessionId
         && newData.userId == oldData.userId
         && newData.exerciseType == oldData.exerciseType
         && newData.startTime == oldData.startTime
         && (newData.status in ['active', 'completed', 'cancelled']);
}

function validateFrameCreate(data) {
  return data.keys().hasAll(['frameId', 'sessionId', 'frameNumber', 'timestamp', 'landmarks'])
         && data.landmarks.size() == 33
         && data.frameNumber >= 0;
}
```

### 5.7 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

**è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆè©³ç´°ã¯Part 4ã§èª¬æ˜ï¼‰**:
```javascript
// 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ï¼ˆæœ€æ–°é †ï¼‰
Collection: users/{userId}/sessions
Fields: userId (Ascending), createdAt (Descending)

// 2. ç¨®ç›®åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢
Collection: users/{userId}/sessions
Fields: userId (Ascending), exerciseType (Ascending), createdAt (Descending)

// 3. BigQueryåŒæœŸå¤±æ•—ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢
Collection: users/{userId}/sessions
Fields: userId (Ascending), bigquerySyncStatus (Ascending), bigquerySyncRetryCount (Ascending)

// 4. ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™ãŒè¿‘ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢
Collection: users/{userId}/sessions
Fields: userId (Ascending), dataRetentionDate (Ascending)
```

---

**Part 2 çµ‚äº†**

æ¬¡ã®Part 3ã§ã¯ã€ãã®ä»–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆConsentsã€Subscriptionsã€Notificationsã€DataDeletionRequestsã€BigQuerySyncFailuresã€SecurityIncidentsï¼‰ã®è©³ç´°è¨­è¨ˆã‚’è¡Œã„ã¾ã™ã€‚
# Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ v3.3 (Part 3/4)

## 6. Consentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 6.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/consents/{consentId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: è‡ªå‹•ç”ŸæˆID  
**ç›®çš„**: åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„å±¥æ­´ã‚’ç®¡ç†ï¼ˆGDPRç¬¬7æ¡å¯¾å¿œï¼‰

### 6.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface ConsentDocument {
  // === åŸºæœ¬æƒ…å ± ===
  consentId: string;                 // åŒæ„IDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  userId: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
  
  // === åŒæ„å†…å®¹ ===
  consentType: 'tos' | 'privacy_policy';  // åŒæ„ã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰
  documentVersion: string;           // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆå¿…é ˆã€ä¾‹: "3.2"ï¼‰
  action: 'accept' | 'revoke';       // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¿…é ˆï¼‰
  
  // === åŒæ„æ™‚ã®è©³ç´°æƒ…å ± ===
  consentDetails: {
    ipAddress: string;               // IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»®ååŒ–ï¼‰
    userAgent: string;               // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    deviceType: 'mobile' | 'tablet' | 'desktop';  // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—
    platform: 'iOS' | 'Android' | 'Web';  // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
  };
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  
  // === ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ç®¡ç† ===
  dataRetentionDate: Timestamp | null;  // ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥ï¼ˆcreatedAt + 7å¹´ï¼‰
}
```

### 6.3 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è©³ç´°

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `consentId` | string | âœ… | åŒæ„ID | è‡ªå‹•ç”Ÿæˆã€å¤‰æ›´ä¸å¯ |
| `userId` | string | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | Firebase Auth UID |
| `consentType` | string | âœ… | åŒæ„ã‚¿ã‚¤ãƒ— | 'tos', 'privacy_policy' |
| `documentVersion` | string | âœ… | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ä¾‹: "3.2" |
| `action` | string | âœ… | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | 'accept', 'revoke' |
| `consentDetails.ipAddress` | string | âœ… | IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»®ååŒ–ï¼‰ | ãƒãƒƒã‚·ãƒ¥åŒ–æ¸ˆã¿ |
| `consentDetails.userAgent` | string | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | - |
| `consentDetails.deviceType` | string | âœ… | ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ— | 'mobile', 'tablet', 'desktop' |
| `consentDetails.platform` | string | âœ… | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | 'iOS', 'Android', 'Web' |
| `createdAt` | Timestamp | âœ… | ä½œæˆæ—¥æ™‚ | ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| `dataRetentionDate` | Timestamp \| null | âŒ | ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥ | createdAt + 7å¹´ |

### 6.4 å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹

**GDPRç¬¬7æ¡å¯¾å¿œ**:
- åŒæ„ã®è¨¼æ‹ ã¨ã—ã¦**7å¹´é–“ä¿æŒ**ï¼ˆæ³•çš„è¦ä»¶ï¼‰
- IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯**SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–**ã—ã¦ä¿å­˜
- åŒæ„æ’¤å›ã®è¨˜éŒ²ã‚‚åŒæ§˜ã«ä¿å­˜

**IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒƒã‚·ãƒ¥åŒ–å®Ÿè£…**:
```typescript
import * as crypto from 'crypto';

function hashIpAddress(ipAddress: string): string {
  return crypto.createHash('sha256').update(ipAddress).digest('hex');
}

// Cloud Functionä½¿ç”¨ä¾‹
export const consent_recordConsent = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
  }

  const hashedIp = hashIpAddress(context.rawRequest.ip || 'unknown');
  
  await admin.firestore().collection('consents').add({
    consentId: admin.firestore().collection('consents').doc().id,
    userId: context.auth.uid,
    consentType: data.consentType,
    documentVersion: data.documentVersion,
    action: 'accept',
    consentDetails: {
      ipAddress: hashedIp,
      userAgent: context.rawRequest.headers['user-agent'] || 'unknown',
      deviceType: detectDeviceType(context.rawRequest.headers['user-agent']),
      platform: data.platform
    },
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    dataRetentionDate: getDataRetentionDate(7)  // 7å¹´å¾Œ
  });
});
```

### 6.5 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "consentId": "consent_abc123",
  "userId": "user_xyz789",
  
  "consentType": "tos",
  "documentVersion": "3.2",
  "action": "accept",
  
  "consentDetails": {
    "ipAddress": "5d41402abc4b2a76b9719d911017c592",
    "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_1 like Mac OS X)",
    "deviceType": "mobile",
    "platform": "iOS"
  },
  
  "createdAt": "2025-11-24T10:00:00Z",
  "dataRetentionDate": "2032-11-24T10:00:00Z"
}
```

### 6.6 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```javascript
match /consents/{consentId} {
  // æœ¬äººã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
  allow read: if request.auth != null 
              && resource.data.userId == request.auth.uid;
  
  // ä½œæˆã¯Cloud Functionsã®ã¿
  allow create, update, delete: if false;
}
```

---

## 7. Subscriptionsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 7.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/users/{userId}/subscriptions/{subscriptionId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: RevenueCat Subscription ID  
**ç›®çš„**: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã®ç®¡ç†

### 7.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface SubscriptionDocument {
  // === åŸºæœ¬æƒ…å ± ===
  subscriptionId: string;            // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDï¼ˆå¿…é ˆã€RevenueCat IDï¼‰
  userId: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
  
  // === ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è©³ç´° ===
  productId: string;                 // å•†å“IDï¼ˆå¿…é ˆã€ä¾‹: 'monthly_500'ï¼‰
  status: 'active' | 'cancelled' | 'expired' | 'in_grace_period' | 'on_hold';  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¿…é ˆï¼‰
  platform: 'app_store' | 'play_store';  // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰
  
  // === æœŸé–“æƒ…å ± ===
  startDate: Timestamp;              // é–‹å§‹æ—¥ï¼ˆå¿…é ˆï¼‰
  currentPeriodStart: Timestamp;     // ç¾åœ¨ã®èª²é‡‘æœŸé–“é–‹å§‹æ—¥ï¼ˆå¿…é ˆï¼‰
  currentPeriodEnd: Timestamp;       // ç¾åœ¨ã®èª²é‡‘æœŸé–“çµ‚äº†æ—¥ï¼ˆå¿…é ˆï¼‰
  expirationDate: Timestamp | null;  // æœ‰åŠ¹æœŸé™ï¼ˆnullã®å ´åˆã¯ç„¡æœŸé™ï¼‰
  
  // === èª²é‡‘æƒ…å ± ===
  price: number;                     // ä¾¡æ ¼ï¼ˆå††ï¼‰
  currency: string;                  // é€šè²¨ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: 'JPY'ï¼‰
  billingIssue: boolean;             // èª²é‡‘å•é¡Œãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
  
  // === è‡ªå‹•æ›´æ–°æƒ…å ± ===
  autoRenewEnabled: boolean;         // è‡ªå‹•æ›´æ–°æœ‰åŠ¹ãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰
  autoRenewDisabledAt: Timestamp | null;  // è‡ªå‹•æ›´æ–°ç„¡åŠ¹åŒ–æ—¥æ™‚
  
  // === ã‚­ãƒ£ãƒ³ã‚»ãƒ«æƒ…å ± ===
  cancellationDate: Timestamp | null;  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥æ™‚
  cancellationReason: string | null;   // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±
  
  // === RevenueCaté€£æº ===
  revenuecatCustomerId: string;      // RevenueCaté¡§å®¢IDï¼ˆå¿…é ˆï¼‰
  originalTransactionId: string;     // å…ƒã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³IDï¼ˆå¿…é ˆï¼‰
  latestTransactionId: string;       // æœ€æ–°ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³IDï¼ˆå¿…é ˆï¼‰
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
}
```

### 7.3 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è©³ç´°

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----------|---|-----|------|--------------|
| `subscriptionId` | string | âœ… | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ID | RevenueCat ID |
| `userId` | string | âœ… | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | Firebase Auth UID |
| `productId` | string | âœ… | å•†å“ID | ä¾‹: 'monthly_500' |
| `status` | string | âœ… | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | 'active', 'cancelled', 'expired', 'in_grace_period', 'on_hold' |
| `platform` | string | âœ… | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | 'app_store', 'play_store' |
| `price` | number | âœ… | ä¾¡æ ¼ï¼ˆå††ï¼‰ | 500 |
| `autoRenewEnabled` | boolean | âœ… | è‡ªå‹•æ›´æ–°æœ‰åŠ¹ãƒ•ãƒ©ã‚° | - |
| `billingIssue` | boolean | âœ… | èª²é‡‘å•é¡Œãƒ•ãƒ©ã‚° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: false |

### 7.4 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»

```
active â†’ cancelledï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
active â†’ in_grace_periodï¼ˆèª²é‡‘å¤±æ•—ã€çŒ¶äºˆæœŸé–“ä¸­ï¼‰
active â†’ on_holdï¼ˆèª²é‡‘å¤±æ•—ã€ä¸€æ™‚åœæ­¢ï¼‰
in_grace_period â†’ activeï¼ˆèª²é‡‘æˆåŠŸï¼‰
in_grace_period â†’ expiredï¼ˆçŒ¶äºˆæœŸé–“çµ‚äº†ï¼‰
on_hold â†’ activeï¼ˆèª²é‡‘æˆåŠŸï¼‰
on_hold â†’ expiredï¼ˆä¸€æ™‚åœæ­¢æœŸé–“çµ‚äº†ï¼‰
cancelled â†’ expiredï¼ˆæœŸé–“çµ‚äº†ï¼‰
```

### 7.5 RevenueCat Webhooké€£æº

```typescript
// Cloud Function: subscriptions_revenuecatWebhook
export const subscriptions_revenuecatWebhook = functions.https.onRequest(async (req, res) => {
  // Webhookæ¤œè¨¼
  const signature = req.headers['x-revenuecat-signature'];
  if (!verifyRevenueCatSignature(req.body, signature)) {
    res.status(401).send('Unauthorized');
    return;
  }

  const event = req.body;
  const userId = event.app_user_id;
  
  switch (event.type) {
    case 'INITIAL_PURCHASE':
    case 'RENEWAL':
      await handleSubscriptionActivation(userId, event);
      break;
    
    case 'CANCELLATION':
      await handleSubscriptionCancellation(userId, event);
      break;
    
    case 'BILLING_ISSUE':
      await handleBillingIssue(userId, event);
      break;
    
    case 'EXPIRATION':
      await handleSubscriptionExpiration(userId, event);
      break;
  }
  
  res.status(200).send('OK');
});

async function handleBillingIssue(userId: string, event: any) {
  // Firestoreã‚’æ›´æ–°
  await admin.firestore()
    .collection('users').doc(userId)
    .collection('subscriptions').doc(event.id)
    .update({
      status: 'in_grace_period',
      billingIssue: true,
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    });
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥é€ä¿¡
  await sendNotification(userId, {
    type: 'billing_issue',
    title: 'èª²é‡‘ã‚¨ãƒ©ãƒ¼',
    message: 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®èª²é‡‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
    priority: 'high'
  });
  
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#7ã€Œèª²é‡‘æ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ã«å¯¾å¿œ
}
```

### 7.6 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "subscriptionId": "rc_sub_abc123",
  "userId": "user_xyz789",
  
  "productId": "monthly_500",
  "status": "active",
  "platform": "app_store",
  
  "startDate": "2025-11-01T00:00:00Z",
  "currentPeriodStart": "2025-11-01T00:00:00Z",
  "currentPeriodEnd": "2025-12-01T00:00:00Z",
  "expirationDate": null,
  
  "price": 500,
  "currency": "JPY",
  "billingIssue": false,
  
  "autoRenewEnabled": true,
  "autoRenewDisabledAt": null,
  
  "cancellationDate": null,
  "cancellationReason": null,
  
  "revenuecatCustomerId": "rc_customer_xyz",
  "originalTransactionId": "1000000123456789",
  "latestTransactionId": "1000000987654321",
  
  "createdAt": "2025-11-01T00:00:00Z",
  "updatedAt": "2025-11-24T10:00:00Z"
}
```

### 7.7 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```javascript
match /users/{userId}/subscriptions/{subscriptionId} {
  // æœ¬äººã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
  allow read: if request.auth != null 
              && request.auth.uid == userId;
  
  // ä½œæˆãƒ»æ›´æ–°ã¯Cloud Functionsã®ã¿
  allow create, update, delete: if false;
}
```

---

## 8. Notificationsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 8.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/notifications/{notificationId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: è‡ªå‹•ç”ŸæˆID  
**ç›®çš„**: ã‚¢ãƒ—ãƒªå†…é€šçŸ¥ã®ç®¡ç†

### 8.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface NotificationDocument {
  // === åŸºæœ¬æƒ…å ± ===
  notificationId: string;            // é€šçŸ¥IDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  userId: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
  
  // === é€šçŸ¥å†…å®¹ ===
  type: 'info' | 'warning' | 'error' | 'success' | 'billing_issue' | 'consent_update';  // é€šçŸ¥ã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰
  title: string;                     // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰
  message: string;                   // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ï¼ˆå¿…é ˆï¼‰
  priority: 'low' | 'normal' | 'high';  // å„ªå…ˆåº¦ï¼ˆå¿…é ˆï¼‰
  
  // === ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ± ===
  actionRequired: boolean;           // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¿…è¦ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
  actionUrl: string | null;          // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³URLï¼ˆç”»é¢é·ç§»å…ˆï¼‰
  actionLabel: string | null;        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹: 'ç¢ºèªã™ã‚‹'ï¼‰
  
  // === é€šçŸ¥çŠ¶æ…‹ ===
  isRead: boolean;                   // æ—¢èª­ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
  readAt: Timestamp | null;          // æ—¢èª­æ—¥æ™‚
  
  // === é…ä¿¡æƒ…å ± ===
  deliveryMethod: 'in_app' | 'push' | 'email';  // é…ä¿¡æ–¹æ³•ï¼ˆå¿…é ˆï¼‰
  deliveryStatus: 'pending' | 'sent' | 'failed';  // é…ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¿…é ˆï¼‰
  deliveryError: string | null;      // é…ä¿¡ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  expiresAt: Timestamp | null;       // æœ‰åŠ¹æœŸé™ï¼ˆnullã®å ´åˆã¯ç„¡æœŸé™ï¼‰
  
  // === ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ç®¡ç† ===
  dataRetentionDate: Timestamp | null;  // ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™æ—¥ï¼ˆcreatedAt + 90æ—¥ï¼‰
}
```

### 8.3 é€šçŸ¥ã‚¿ã‚¤ãƒ—ã®è©³ç´°

| ã‚¿ã‚¤ãƒ— | èª¬æ˜ | å„ªå…ˆåº¦ | ä¾‹ |
|-------|------|--------|---|
| `info` | ä¸€èˆ¬æƒ…å ± | low | æ–°æ©Ÿèƒ½ã®ãŠçŸ¥ã‚‰ã› |
| `warning` | è­¦å‘Š | normal | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœŸé™ãŒè¿‘ã„ |
| `error` | ã‚¨ãƒ©ãƒ¼ | high | ãƒ‡ãƒ¼ã‚¿åŒæœŸå¤±æ•— |
| `success` | æˆåŠŸé€šçŸ¥ | normal | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ä¿å­˜å®Œäº† |
| `billing_issue` | èª²é‡‘å•é¡Œ | high | æ±ºæ¸ˆå¤±æ•— |
| `consent_update` | åŒæ„æ›´æ–° | high | åˆ©ç”¨è¦ç´„æ›´æ–° |

### 8.4 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "notificationId": "notif_abc123",
  "userId": "user_xyz789",
  
  "type": "billing_issue",
  "title": "èª²é‡‘ã‚¨ãƒ©ãƒ¼",
  "message": "ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®èª²é‡‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
  "priority": "high",
  
  "actionRequired": true,
  "actionUrl": "/settings/subscription",
  "actionLabel": "ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’ç¢ºèª",
  
  "isRead": false,
  "readAt": null,
  
  "deliveryMethod": "in_app",
  "deliveryStatus": "sent",
  "deliveryError": null,
  
  "createdAt": "2025-11-24T10:00:00Z",
  "updatedAt": "2025-11-24T10:00:00Z",
  "expiresAt": "2025-12-24T10:00:00Z",
  "dataRetentionDate": "2026-02-22T10:00:00Z"
}
```

### 8.5 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```javascript
match /notifications/{notificationId} {
  // æœ¬äººã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
  allow read: if request.auth != null 
              && resource.data.userId == request.auth.uid;
  
  // æ—¢èª­ãƒ•ãƒ©ã‚°ã®ã¿æ›´æ–°å¯èƒ½
  allow update: if request.auth != null 
                && resource.data.userId == request.auth.uid
                && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt', 'updatedAt']);
  
  // ä½œæˆãƒ»å‰Šé™¤ã¯Cloud Functionsã®ã¿
  allow create, delete: if false;
}
```

---

## 9. DataDeletionRequestsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 9.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/dataDeletionRequests/{requestId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: è‡ªå‹•ç”ŸæˆID  
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç®¡ç†ï¼ˆGDPRç¬¬17æ¡å¯¾å¿œï¼‰

### 9.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface DataDeletionRequestDocument {
  // === åŸºæœ¬æƒ…å ± ===
  requestId: string;                 // ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  userId: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
  
  // === ãƒªã‚¯ã‚¨ã‚¹ãƒˆè©³ç´° ===
  requestType: 'full_account_deletion' | 'specific_data_deletion';  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰
  requestReason: string | null;      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆç†ç”±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  
  // === å‰Šé™¤å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ ===
  dataToDelete: string[];            // å‰Šé™¤å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ï¼ˆä¾‹: ['profile', 'sessions', 'consents']ï¼‰
  
  // === å‡¦ç†çŠ¶æ…‹ ===
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¿…é ˆï¼‰
  scheduledDeletionDate: Timestamp;  // äºˆå®šå‰Šé™¤æ—¥ï¼ˆrequestedAt + 30æ—¥ï¼‰
  actualDeletionDate: Timestamp | null;  // å®Ÿéš›ã®å‰Šé™¤æ—¥
  
  // === å‡¦ç†è©³ç´° ===
  deletionProgress: {
    totalSteps: number;              // ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°
    completedSteps: number;          // å®Œäº†ã‚¹ãƒ†ãƒƒãƒ—æ•°
    currentStep: string;             // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆä¾‹: 'Deleting sessions'ï¼‰
  };
  
  // === ã‚¨ãƒ©ãƒ¼æƒ…å ± ===
  deletionError: string | null;      // å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  
  // === ç¢ºèªæƒ…å ± ===
  confirmationCode: string;          // ç¢ºèªã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ã®æ•°å­—ï¼‰
  confirmationCodeSentAt: Timestamp | null;  // ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡æ—¥æ™‚
  confirmedAt: Timestamp | null;     // ç¢ºèªæ—¥æ™‚
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  requestedAt: Timestamp;            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  processedAt: Timestamp | null;     // å‡¦ç†å®Œäº†æ—¥æ™‚
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
}
```

### 9.3 å‰Šé™¤ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ•ãƒ­ãƒ¼

```typescript
// Cloud Function: gdpr_requestAccountDeletion
export const gdpr_requestAccountDeletion = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
  }

  const uid = context.auth.uid;
  
  // 1. ç¢ºèªã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  const confirmationCode = generateConfirmationCode();
  
  // 2. ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
  const scheduledDeletionDate = new Date();
  scheduledDeletionDate.setDate(scheduledDeletionDate.getDate() + 30);
  
  const requestId = admin.firestore().collection('dataDeletionRequests').doc().id;
  
  await admin.firestore().collection('dataDeletionRequests').doc(requestId).set({
    requestId,
    userId: uid,
    requestType: 'full_account_deletion',
    requestReason: data.reason || null,
    dataToDelete: ['profile', 'sessions', 'consents', 'subscriptions', 'notifications'],
    status: 'pending',
    scheduledDeletionDate,
    actualDeletionDate: null,
    deletionProgress: {
      totalSteps: 5,
      completedSteps: 0,
      currentStep: 'Awaiting confirmation'
    },
    deletionError: null,
    confirmationCode,
    confirmationCodeSentAt: admin.firestore.FieldValue.serverTimestamp(),
    confirmedAt: null,
    requestedAt: admin.firestore.FieldValue.serverTimestamp(),
    processedAt: null,
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  });
  
  // 3. Usersãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å‰Šé™¤äºˆå®šãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
  await admin.firestore().collection('users').doc(uid).update({
    deletionScheduled: true,
    deletionScheduledAt: admin.firestore.FieldValue.serverTimestamp(),
    scheduledDeletionDate,
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  });
  
  // 4. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–
  await admin.auth().updateUser(uid, {
    disabled: true
  });
  
  // 5. ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  await sendConfirmationEmail(uid, confirmationCode);
  
  return {
    success: true,
    data: {
      requestId,
      scheduledDeletionDate: scheduledDeletionDate.toISOString(),
      message: 'å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ã¾ã—ãŸã€‚30æ—¥ä»¥å†…ã«å®Œå…¨å‰Šé™¤ã•ã‚Œã¾ã™ã€‚'
    }
  };
});

// ç¢ºèªã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
function generateConfirmationCode(): string {
  return Math.floor(100000 + Math.random() * 900000).toString();
}
```

### 9.4 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "requestId": "deletion_abc123",
  "userId": "user_xyz789",
  
  "requestType": "full_account_deletion",
  "requestReason": "ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã—ãªããªã£ãŸãŸã‚",
  
  "dataToDelete": ["profile", "sessions", "consents", "subscriptions", "notifications"],
  
  "status": "pending",
  "scheduledDeletionDate": "2025-12-24T10:00:00Z",
  "actualDeletionDate": null,
  
  "deletionProgress": {
    "totalSteps": 5,
    "completedSteps": 0,
    "currentStep": "Awaiting confirmation"
  },
  
  "deletionError": null,
  
  "confirmationCode": "123456",
  "confirmationCodeSentAt": "2025-11-24T10:00:00Z",
  "confirmedAt": null,
  
  "requestedAt": "2025-11-24T10:00:00Z",
  "processedAt": null,
  "updatedAt": "2025-11-24T10:00:00Z"
}
```

### 9.5 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```javascript
match /dataDeletionRequests/{requestId} {
  // æœ¬äººã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
  allow read: if request.auth != null 
              && resource.data.userId == request.auth.uid;
  
  // ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯Cloud Functionsã®ã¿
  allow create, update, delete: if false;
}
```

---

## 10. BigQuerySyncFailuresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 10.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/bigquerySyncFailures/{failureId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: è‡ªå‹•ç”ŸæˆID  
**ç›®çš„**: BigQueryåŒæœŸå¤±æ•—ã®è¨˜éŒ²ã¨Dead Letter Queueç®¡ç†ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#4å¯¾å¿œï¼‰

### 10.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface BigQuerySyncFailureDocument {
  // === åŸºæœ¬æƒ…å ± ===
  failureId: string;                 // å¤±æ•—IDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  userId: string;                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
  sessionId: string;                 // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆå¿…é ˆï¼‰
  
  // === å¤±æ•—è©³ç´° ===
  errorType: 'network' | 'quota_exceeded' | 'invalid_data' | 'authentication' | 'unknown';  // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰
  errorMessage: string;              // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¿…é ˆï¼‰
  errorStack: string | null;         // ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
  
  // === ãƒªãƒˆãƒ©ã‚¤æƒ…å ± ===
  retryCount: number;                // ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆå¿…é ˆï¼‰
  maxRetries: number;                // æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
  lastRetryAt: Timestamp | null;     // æœ€çµ‚ãƒªãƒˆãƒ©ã‚¤æ—¥æ™‚
  nextRetryAt: Timestamp | null;     // æ¬¡å›ãƒªãƒˆãƒ©ã‚¤äºˆå®šæ—¥æ™‚
  
  // === ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ===
  status: 'pending_retry' | 'retrying' | 'failed_permanently' | 'resolved';  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¿…é ˆï¼‰
  
  // === ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ ===
  sessionDataSnapshot: {
    exerciseType: string;
    startTime: Timestamp;
    repCount: number;
    // ... ãã®ä»–ã®é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  };
  
  // === æ‰‹å‹•ä»‹å…¥æƒ…å ± ===
  needsManualIntervention: boolean;  // æ‰‹å‹•ä»‹å…¥å¿…è¦ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
  manualInterventionNote: string | null;  // æ‰‹å‹•ä»‹å…¥ãƒ¡ãƒ¢
  resolvedBy: string | null;         // è§£æ±ºè€…ï¼ˆç®¡ç†è€…UIDï¼‰
  resolvedAt: Timestamp | null;      // è§£æ±ºæ—¥æ™‚
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
}
```

### 10.3 ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã®å®Ÿè£…

```typescript
// Cloud Function: bigquery_retryFailedSyncsï¼ˆæ¯æ™‚å®Ÿè¡Œï¼‰
export const bigquery_retryFailedSyncs = functions
  .pubsub
  .schedule('0 * * * *')  // æ¯æ™‚0åˆ†
  .timeZone('Asia/Tokyo')
  .onRun(async (context) => {
    const now = admin.firestore.Timestamp.now();
    
    // ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã®å¤±æ•—è¨˜éŒ²ã‚’å–å¾—
    const failuresSnapshot = await admin.firestore()
      .collection('bigquerySyncFailures')
      .where('status', '==', 'pending_retry')
      .where('nextRetryAt', '<=', now)
      .limit(100)
      .get();
    
    for (const doc of failuresSnapshot.docs) {
      const failure = doc.data();
      
      // ãƒªãƒˆãƒ©ã‚¤å›æ•°ãƒã‚§ãƒƒã‚¯
      if (failure.retryCount >= failure.maxRetries) {
        // Dead Letter Queueã¸ç§»å‹•
        await doc.ref.update({
          status: 'failed_permanently',
          needsManualIntervention: true,
          updatedAt: admin.firestore.FieldValue.serverTimestamp()
        });
        
        // Slackã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
        await sendSlackAlert({
          severity: 'error',
          message: `ğŸš¨ BigQuery sync permanently failed for session ${failure.sessionId}`,
          details: failure
        });
        
        continue;
      }
      
      // ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ
      try {
        await retryBigQuerySync(failure);
        
        // æˆåŠŸã—ãŸã‚‰ resolved ã«æ›´æ–°
        await doc.ref.update({
          status: 'resolved',
          resolvedAt: admin.firestore.FieldValue.serverTimestamp(),
          updatedAt: admin.firestore.FieldValue.serverTimestamp()
        });
        
        // å…ƒã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚æ›´æ–°
        await admin.firestore()
          .collection('users').doc(failure.userId)
          .collection('sessions').doc(failure.sessionId)
          .update({
            bigquerySyncStatus: 'synced',
            bigquerySyncedAt: admin.firestore.FieldValue.serverTimestamp()
          });
      } catch (error) {
        // å¤±æ•—ã—ãŸã‚‰ãƒªãƒˆãƒ©ã‚¤æƒ…å ±ã‚’æ›´æ–°
        const nextRetryDelay = calculateExponentialBackoff(failure.retryCount + 1);
        const nextRetryAt = new Date(Date.now() + nextRetryDelay);
        
        await doc.ref.update({
          retryCount: admin.firestore.FieldValue.increment(1),
          lastRetryAt: admin.firestore.FieldValue.serverTimestamp(),
          nextRetryAt: admin.firestore.Timestamp.fromDate(nextRetryAt),
          errorMessage: error.message,
          updatedAt: admin.firestore.FieldValue.serverTimestamp()
        });
      }
    }
  });

// ã‚¨ã‚¯ã‚¹ãƒãƒãƒ³ã‚·ãƒ£ãƒ«ãƒãƒƒã‚¯ã‚ªãƒ•è¨ˆç®—
function calculateExponentialBackoff(retryCount: number): number {
  // 1å›ç›®: 5åˆ†ã€2å›ç›®: 15åˆ†ã€3å›ç›®: 45åˆ†
  return Math.pow(3, retryCount) * 5 * 60 * 1000;
}
```

### 10.4 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "failureId": "failure_abc123",
  "userId": "user_xyz789",
  "sessionId": "session_abc123",
  
  "errorType": "network",
  "errorMessage": "Connection timeout: Unable to reach BigQuery API",
  "errorStack": "Error: Connection timeout...",
  
  "retryCount": 1,
  "maxRetries": 3,
  "lastRetryAt": "2025-11-24T10:05:00Z",
  "nextRetryAt": "2025-11-24T10:20:00Z",
  
  "status": "pending_retry",
  
  "sessionDataSnapshot": {
    "exerciseType": "squat",
    "startTime": "2025-11-24T10:00:00Z",
    "repCount": 15
  },
  
  "needsManualIntervention": false,
  "manualInterventionNote": null,
  "resolvedBy": null,
  "resolvedAt": null,
  
  "createdAt": "2025-11-24T10:00:30Z",
  "updatedAt": "2025-11-24T10:05:00Z"
}
```

### 10.5 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```javascript
match /bigquerySyncFailures/{failureId} {
  // ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  allow read, write: if request.auth != null 
                     && request.auth.token.admin == true;
}
```

---

## 11. SecurityIncidentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

### 11.1 æ¦‚è¦

**ãƒ‘ã‚¹**: `/securityIncidents/{incidentId}`  
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID**: è‡ªå‹•ç”ŸæˆID  
**ç›®çš„**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®è¨˜éŒ²ã¨ç®¡ç†ï¼ˆGDPRç¬¬33æ¡ãƒ»34æ¡å¯¾å¿œã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹#10å¯¾å¿œï¼‰

### 11.2 ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```typescript
interface SecurityIncidentDocument {
  // === åŸºæœ¬æƒ…å ± ===
  incidentId: string;                // ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆIDï¼ˆå¿…é ˆã€è‡ªå‹•ç”Ÿæˆï¼‰
  
  // === ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè©³ç´° ===
  incidentType: 'data_breach' | 'unauthorized_access' | 'system_vulnerability' | 'malware' | 'other';  // ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰
  severity: 'low' | 'medium' | 'high' | 'critical';  // é‡å¤§åº¦ï¼ˆå¿…é ˆï¼‰
  title: string;                     // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰
  description: string;               // è©³ç´°èª¬æ˜ï¼ˆå¿…é ˆï¼‰
  
  // === å½±éŸ¿ç¯„å›² ===
  affectedUserCount: number;         // å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  affectedUsers: string[];           // å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒªã‚¹ãƒˆï¼ˆæœ€å¤§100ä»¶ã€ãã‚Œä»¥ä¸Šã¯åˆ¥é€”ç®¡ç†ï¼‰
  affectedDataTypes: string[];       // å½±éŸ¿ã‚’å—ã‘ãŸãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ï¼ˆä¾‹: ['email', 'sessions']ï¼‰
  
  // === ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ===
  status: 'detected' | 'investigating' | 'notified' | 'resolved' | 'closed';  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¿…é ˆï¼‰
  
  // === æ¤œå‡ºæƒ…å ± ===
  detectedAt: Timestamp;             // æ¤œå‡ºæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  detectedBy: string;                // æ¤œå‡ºè€…ï¼ˆä¾‹: 'automated_system', 'admin_uid'ï¼‰
  detectionMethod: string;           // æ¤œå‡ºæ–¹æ³•ï¼ˆä¾‹: 'log_analysis', 'user_report'ï¼‰
  
  // === é€šçŸ¥æƒ…å ±ï¼ˆGDPRç¬¬33æ¡ãƒ»34æ¡å¯¾å¿œï¼‰ ===
  notificationRequired: boolean;     // é€šçŸ¥å¿…è¦ãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼‰
  
  // ç›£ç£æ©Ÿé–¢ã¸ã®é€šçŸ¥ï¼ˆGDPRç¬¬33æ¡ï¼‰
  supervisoryAuthorityNotification: {
    required: boolean;               // é€šçŸ¥å¿…è¦ã‹ï¼ˆ72æ™‚é–“ä»¥å†…ï¼‰
    notifiedAt: Timestamp | null;    // é€šçŸ¥æ—¥æ™‚
    notificationMethod: string | null;  // é€šçŸ¥æ–¹æ³•
    confirmationReceived: boolean;   // ç¢ºèªå—ä¿¡ãƒ•ãƒ©ã‚°
  };
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ï¼ˆGDPRç¬¬34æ¡ï¼‰
  userNotification: {
    required: boolean;               // é€šçŸ¥å¿…è¦ã‹
    notifiedAt: Timestamp | null;    // é€šçŸ¥æ—¥æ™‚
    notificationMethod: 'email' | 'in_app' | 'both' | null;  // é€šçŸ¥æ–¹æ³•
    notificationSent: boolean;       // é€šçŸ¥é€ä¿¡å®Œäº†ãƒ•ãƒ©ã‚°
  };
  
  // === å¯¾å¿œæªç½® ===
  responseActions: Array<{
    action: string;                  // å¯¾å¿œæªç½®ï¼ˆä¾‹: 'Password reset enforced'ï¼‰
    takenAt: Timestamp;              // å®Ÿæ–½æ—¥æ™‚
    takenBy: string;                 // å®Ÿæ–½è€…
  }>;
  
  // === æ ¹æœ¬åŸå› åˆ†æ ===
  rootCause: string | null;          // æ ¹æœ¬åŸå› 
  preventiveMeasures: string | null; // äºˆé˜²æªç½®
  
  // === ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† ===
  createdAt: Timestamp;              // ä½œæˆæ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  updatedAt: Timestamp;              // æ›´æ–°æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰
  resolvedAt: Timestamp | null;      // è§£æ±ºæ—¥æ™‚
  closedAt: Timestamp | null;        // ã‚¯ãƒ­ãƒ¼ã‚ºæ—¥æ™‚
}
```

### 11.3 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ•ãƒ­ãƒ¼

```typescript
// Cloud Function: security_reportIncident
export const security_reportIncident = functions.https.onCall(async (data, context) => {
  // ç®¡ç†è€…ã®ã¿å®Ÿè¡Œå¯èƒ½
  if (!context.auth || !context.auth.token.admin) {
    throw new functions.https.HttpsError('permission-denied', 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™');
  }

  const incidentId = admin.firestore().collection('securityIncidents').doc().id;
  
  // ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè¨˜éŒ²ã‚’ä½œæˆ
  await admin.firestore().collection('securityIncidents').doc(incidentId).set({
    incidentId,
    incidentType: data.incidentType,
    severity: data.severity,
    title: data.title,
    description: data.description,
    affectedUserCount: data.affectedUserCount || 0,
    affectedUsers: data.affectedUsers || [],
    affectedDataTypes: data.affectedDataTypes || [],
    status: 'detected',
    detectedAt: admin.firestore.FieldValue.serverTimestamp(),
    detectedBy: context.auth.uid,
    detectionMethod: data.detectionMethod,
    notificationRequired: determineNotificationRequired(data),
    supervisoryAuthorityNotification: {
      required: data.severity === 'critical' || data.severity === 'high',
      notifiedAt: null,
      notificationMethod: null,
      confirmationReceived: false
    },
    userNotification: {
      required: data.affectedUserCount > 0,
      notifiedAt: null,
      notificationMethod: null,
      notificationSent: false
    },
    responseActions: [],
    rootCause: null,
    preventiveMeasures: null,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    resolvedAt: null,
    closedAt: null
  });
  
  // é‡å¤§ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®å ´åˆã€å³åº§ã«Slackã‚¢ãƒ©ãƒ¼ãƒˆ
  if (data.severity === 'critical' || data.severity === 'high') {
    await sendSlackAlert({
      severity: 'critical',
      message: `ğŸš¨ğŸš¨ SECURITY INCIDENT: ${data.title}`,
      details: {
        incidentId,
        severity: data.severity,
        affectedUserCount: data.affectedUserCount
      }
    });
  }
  
  return {
    success: true,
    data: { incidentId }
  };
});

function determineNotificationRequired(data: any): boolean {
  // GDPRç¬¬33æ¡ãƒ»34æ¡ã«åŸºã¥ãé€šçŸ¥å¿…è¦æ€§ã‚’åˆ¤æ–­
  return data.severity === 'critical' || data.severity === 'high' || data.affectedUserCount > 0;
}
```

### 11.4 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```json
{
  "incidentId": "incident_abc123",
  
  "incidentType": "data_breach",
  "severity": "high",
  "title": "ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ä¾µå®³",
  "description": "å¤–éƒ¨ã‹ã‚‰ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚Šã€ä¸€éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒé–²è¦§ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
  
  "affectedUserCount": 50,
  "affectedUsers": ["user_001", "user_002", "..."],
  "affectedDataTypes": ["sessions", "profile"],
  
  "status": "investigating",
  
  "detectedAt": "2025-11-24T10:00:00Z",
  "detectedBy": "automated_system",
  "detectionMethod": "log_analysis",
  
  "notificationRequired": true,
  
  "supervisoryAuthorityNotification": {
    "required": true,
    "notifiedAt": "2025-11-24T12:00:00Z",
    "notificationMethod": "email",
    "confirmationReceived": true
  },
  
  "userNotification": {
    "required": true,
    "notifiedAt": "2025-11-24T14:00:00Z",
    "notificationMethod": "both",
    "notificationSent": true
  },
  
  "responseActions": [
    {
      "action": "Password reset enforced for affected users",
      "takenAt": "2025-11-24T10:30:00Z",
      "takenBy": "admin_uid_001"
    }
  ],
  
  "rootCause": "è„†å¼±ãªFirestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«",
  "preventiveMeasures": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å¼·åŒ–ã¨ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½",
  
  "createdAt": "2025-11-24T10:00:00Z",
  "updatedAt": "2025-11-24T14:00:00Z",
  "resolvedAt": "2025-11-25T10:00:00Z",
  "closedAt": null
}
```

### 11.5 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

```javascript
match /securityIncidents/{incidentId} {
  // ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  allow read, write: if request.auth != null 
                     && request.auth.token.admin == true;
}
```

---

**Part 3 çµ‚äº†**

æ¬¡ã®Part 4ã§ã¯ã€Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å®Œå…¨å®Ÿè£…ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã€ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢æˆ¦ç•¥ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚
# Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ v3.3 (Part 4/4)

## 12. Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

### 12.1 æ¦‚è¦

æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹åˆ†æv1.0ã§ç‰¹å®šã•ã‚ŒãŸ**æ‡¸å¿µç‚¹#1ã€ŒFirestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è©³ç´°è¨­è¨ˆãŒæœªå®Œæˆã€**ã«å®Œå…¨å¯¾å¿œã—ãŸã€åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

**è¨­è¨ˆåŸå‰‡**:
1. **ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆåŒæ„ãƒ•ãƒ©ã‚°ãªã©ï¼‰ã¯èª­ã¿å–ã‚Šå°‚ç”¨
2. **ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: å…¨ã¦ã®æ›¸ãè¾¼ã¿æ“ä½œã§å‹ãƒã‚§ãƒƒã‚¯ã¨ç¯„å›²ãƒã‚§ãƒƒã‚¯
3. **å‰Šé™¤çŒ¶äºˆæœŸé–“ã®åˆ¶å¾¡**: `deletionScheduled`ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
4. **ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆ**: å…¨ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èªè¨¼ãƒ»èªå¯

### 12.2 å®Œå…¨ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å®Ÿè£…

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==============================================
    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // ==============================================
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒã‚§ãƒƒã‚¯
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æœ¬äººãƒã‚§ãƒƒã‚¯
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤äºˆå®šã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    function isNotScheduledForDeletion(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return !userDoc.data.deletionScheduled;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    function isNotForcedLogout(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return !userDoc.data.forceLogout;
    }
    
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function isValidTimestamp(timestamp) {
      return timestamp is timestamp;
    }
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    function isValidEmail(email) {
      return email is string && email.matches('.+@.+\\..+');
    }
    
    // ==============================================
    // Usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // ==============================================
    
    match /users/{userId} {
      // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„ã€å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ãªã„
      allow read: if isAuthenticated()
                  && isOwner(userId)
                  && isNotScheduledForDeletion(userId)
                  && isNotForcedLogout(userId);
      
      // ä½œæˆ: æœ¬äººã®ã¿ã€å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
      allow create: if isAuthenticated()
                    && isOwner(userId)
                    && validateUserCreate(request.resource.data);
      
      // æ›´æ–°: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã®æ¤œè¨¼
      allow update: if isAuthenticated()
                    && isOwner(userId)
                    && isNotScheduledForDeletion(userId)
                    && validateUserUpdate(request.resource.data, resource.data);
      
      // å‰Šé™¤: Cloud Functionsã®ã¿ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‰Šé™¤ä¸å¯ï¼‰
      allow delete: if false;
      
      // ========================================
      // Sessionsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      // ========================================
      
      match /sessions/{sessionId} {
        // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„
        allow read: if isAuthenticated()
                    && isOwner(userId)
                    && isNotScheduledForDeletion(userId);
        
        // ä½œæˆ: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        allow create: if isAuthenticated()
                      && isOwner(userId)
                      && isNotScheduledForDeletion(userId)
                      && validateSessionCreate(request.resource.data);
        
        // æ›´æ–°: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        allow update: if isAuthenticated()
                      && isOwner(userId)
                      && isNotScheduledForDeletion(userId)
                      && validateSessionUpdate(request.resource.data, resource.data);
        
        // å‰Šé™¤: Cloud Functionsã®ã¿
        allow delete: if false;
        
        // ========================================
        // Framesã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        // ========================================
        
        match /frames/{frameId} {
          // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„
          allow read: if isAuthenticated()
                      && isOwner(userId)
                      && isNotScheduledForDeletion(userId);
          
          // ä½œæˆ: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          allow create: if isAuthenticated()
                        && isOwner(userId)
                        && isNotScheduledForDeletion(userId)
                        && validateFrameCreate(request.resource.data);
          
          // æ›´æ–°ãƒ»å‰Šé™¤: ä¸å¯ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã¯ä½œæˆå¾Œå¤‰æ›´ä¸å¯ï¼‰
          allow update, delete: if false;
        }
      }
      
      // ========================================
      // Settingsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      // ========================================
      
      match /settings/{settingId} {
        // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿
        allow read: if isAuthenticated() && isOwner(userId);
        
        // ä½œæˆãƒ»æ›´æ–°: æœ¬äººã®ã¿ã€å‰Šé™¤äºˆå®šã§ãªã„
        allow create, update: if isAuthenticated()
                              && isOwner(userId)
                              && isNotScheduledForDeletion(userId)
                              && validateSettingData(request.resource.data);
        
        // å‰Šé™¤: æœ¬äººã®ã¿
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ========================================
      // Subscriptionsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      // ========================================
      
      match /subscriptions/{subscriptionId} {
        // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿
        allow read: if isAuthenticated() && isOwner(userId);
        
        // ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤: Cloud Functionsã®ã¿ï¼ˆRevenueCat Webhookï¼‰
        allow create, update, delete: if false;
      }
    }
    
    // ==============================================
    // Consentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // ==============================================
    
    match /consents/{consentId} {
      // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      
      // ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤: Cloud Functionsã®ã¿
      allow create, update, delete: if false;
    }
    
    // ==============================================
    // Notificationsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // ==============================================
    
    match /notifications/{notificationId} {
      // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      
      // æ›´æ–°: æœ¬äººã®ã¿ã€æ—¢èª­ãƒ•ãƒ©ã‚°ã®ã¿å¤‰æ›´å¯èƒ½
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && onlyUpdatingReadStatus(request.resource.data, resource.data);
      
      // ä½œæˆãƒ»å‰Šé™¤: Cloud Functionsã®ã¿
      allow create, delete: if false;
    }
    
    // ==============================================
    // DataDeletionRequestsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // ==============================================
    
    match /dataDeletionRequests/{requestId} {
      // èª­ã¿å–ã‚Š: æœ¬äººã®ã¿
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      
      // ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤: Cloud Functionsã®ã¿
      allow create, update, delete: if false;
    }
    
    // ==============================================
    // BigQuerySyncFailuresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // ==============================================
    
    match /bigquerySyncFailures/{failureId} {
      // èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿: ç®¡ç†è€…ã®ã¿
      allow read, write: if isAdmin();
    }
    
    // ==============================================
    // SecurityIncidentsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // ==============================================
    
    match /securityIncidents/{incidentId} {
      // èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿: ç®¡ç†è€…ã®ã¿
      allow read, write: if isAdmin();
    }
    
    // ==============================================
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    // ==============================================
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateUserCreate(data) {
      return data.keys().hasAll(['userId', 'email', 'tosAccepted', 'ppAccepted', 'isActive', 'createdAt', 'updatedAt'])
             && data.userId is string
             && data.userId == request.auth.uid
             && isValidEmail(data.email)
             && data.tosAccepted == true
             && data.ppAccepted == true
             && data.isActive == true
             && data.deletionScheduled == false
             && data.forceLogout == false
             && isValidTimestamp(data.createdAt)
             && isValidTimestamp(data.updatedAt);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateUserUpdate(newData, oldData) {
      // å¤‰æ›´ä¸å¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      return newData.userId == oldData.userId
             && newData.email == oldData.email
             && newData.createdAt == oldData.createdAt
             // åŒæ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¤‰æ›´ä¸å¯ï¼ˆCloud Functionsã®ã¿ãŒå¤‰æ›´å¯èƒ½ï¼‰
             && newData.tosAccepted == oldData.tosAccepted
             && newData.tosAcceptedAt == oldData.tosAcceptedAt
             && newData.tosVersion == oldData.tosVersion
             && newData.ppAccepted == oldData.ppAccepted
             && newData.ppAcceptedAt == oldData.ppAcceptedAt
             && newData.ppVersion == oldData.ppVersion
             // å‰Šé™¤äºˆå®šãƒ•ãƒ©ã‚°ã¯å¤‰æ›´ä¸å¯ï¼ˆCloud Functionsã®ã¿ãŒå¤‰æ›´å¯èƒ½ï¼‰
             && newData.deletionScheduled == oldData.deletionScheduled
             && newData.deletionScheduledAt == oldData.deletionScheduledAt
             && newData.scheduledDeletionDate == oldData.scheduledDeletionDate
             // å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ©ã‚°ã¯å¤‰æ›´ä¸å¯ï¼ˆCloud Functionsã®ã¿ãŒå¤‰æ›´å¯èƒ½ï¼‰
             && newData.forceLogout == oldData.forceLogout
             && newData.forceLogoutAt == oldData.forceLogoutAt
             // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
             && validateProfileData(newData.profile);
    }
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateProfileData(profile) {
      return (!('height' in profile) || (profile.height >= 100 && profile.height <= 250))
             && (!('weight' in profile) || (profile.weight >= 30 && profile.weight <= 300))
             && (!('birthday' in profile) || isValidTimestamp(profile.birthday))
             && (!('gender' in profile) || (profile.gender in ['male', 'female', 'other', 'prefer_not_to_say', null]));
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateSessionCreate(data) {
      return data.keys().hasAll(['sessionId', 'userId', 'exerciseType', 'startTime', 'status', 'repCount', 'setCount', 'bigquerySyncStatus', 'createdAt', 'updatedAt'])
             && data.sessionId is string
             && data.userId is string
             && data.exerciseType in ['squat', 'push_up', 'lunge', 'plank', 'bridge']
             && isValidTimestamp(data.startTime)
             && data.status == 'active'
             && data.repCount is number && data.repCount >= 0 && data.repCount <= 1000
             && data.setCount is number && data.setCount >= 1 && data.setCount <= 10
             && data.bigquerySyncStatus == 'pending'
             && isValidTimestamp(data.createdAt)
             && isValidTimestamp(data.updatedAt);
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateSessionUpdate(newData, oldData) {
      // å¤‰æ›´ä¸å¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      return newData.sessionId == oldData.sessionId
             && newData.userId == oldData.userId
             && newData.exerciseType == oldData.exerciseType
             && newData.startTime == oldData.startTime
             && newData.createdAt == oldData.createdAt
             // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
             && newData.status in ['active', 'completed', 'cancelled']
             // endTimeãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€startTimeã‚ˆã‚Šå¾Œã§ã‚ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯
             && (!('endTime' in newData) || newData.endTime > newData.startTime)
             // repCountã®ç¯„å›²ãƒã‚§ãƒƒã‚¯
             && newData.repCount >= 0 && newData.repCount <= 1000
             // setCountã®ç¯„å›²ãƒã‚§ãƒƒã‚¯
             && newData.setCount >= 1 && newData.setCount <= 10;
    }
    
    // ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateFrameCreate(data) {
      return data.keys().hasAll(['frameId', 'sessionId', 'frameNumber', 'timestamp', 'landmarks', 'createdAt'])
             && data.frameId is string
             && data.sessionId is string
             && data.frameNumber is number && data.frameNumber >= 0
             && isValidTimestamp(data.timestamp)
             && data.landmarks is list
             && data.landmarks.size() == 33
             && validateLandmarks(data.landmarks)
             && isValidTimestamp(data.createdAt);
    }
    
    // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateLandmarks(landmarks) {
      // å…¨ã¦ã®è¦ç´ ãŒãƒãƒƒãƒ—å‹ã§ã€x, y, z, visibilityã‚’æŒã¤ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯
      return landmarks.size() == 33;
      // æ³¨: ãƒã‚¹ãƒˆã—ãŸé…åˆ—ã®å…¨è¦ç´ æ¤œè¨¼ã¯Firestoreãƒ«ãƒ¼ãƒ«ã§ã¯å›°é›£ãªãŸã‚ã€
      // è©³ç´°ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯Cloud Functionsã§å®Ÿæ–½
    }
    
    // è¨­å®šãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateSettingData(data) {
      return data.keys().hasAll(['settingId', 'userId'])
             && data.settingId is string
             && data.userId is string;
    }
    
    // é€šçŸ¥ã®æ—¢èª­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã®ã¿è¨±å¯
    function onlyUpdatingReadStatus(newData, oldData) {
      let changedFields = newData.diff(oldData).affectedKeys();
      return changedFields.hasOnly(['isRead', 'readAt', 'updatedAt'])
             && newData.isRead == true
             && isValidTimestamp(newData.readAt)
             && isValidTimestamp(newData.updatedAt);
    }
  }
}
```

### 12.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ

```javascript
// Firestore Emulatorã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

import { assertFails, assertSucceeds } from '@firebase/rules-unit-testing';

describe('Firestore Security Rules', () => {
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã®ãƒ†ã‚¹ãƒˆ
  test('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã§ãã‚‹', async () => {
    const db = getFirestore('user123');
    await assertSucceeds(
      setDoc(doc(db, 'users', 'user123'), {
        userId: 'user123',
        email: 'test@example.com',
        tosAccepted: true,
        ppAccepted: true,
        isActive: true,
        deletionScheduled: false,
        forceLogout: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      })
    );
  });
  
  // ä»–äººã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆã‚’æ‹’å¦
  test('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»–äººã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã§ããªã„', async () => {
    const db = getFirestore('user123');
    await assertFails(
      setDoc(doc(db, 'users', 'user456'), {
        userId: 'user456',
        email: 'other@example.com',
        // ...
      })
    );
  });
  
  // åŒæ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’æ‹’å¦
  test('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åŒæ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤‰æ›´ã§ããªã„', async () => {
    const db = getFirestore('user123');
    await assertFails(
      updateDoc(doc(db, 'users', 'user123'), {
        tosAccepted: false  // å¤‰æ›´ä¸å¯
      })
    );
  });
  
  // å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›¸ãè¾¼ã¿ã‚’æ‹’å¦
  test('å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã§ããªã„', async () => {
    // å‰Šé™¤äºˆå®šãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼
    const db = getFirestore('user789');
    await assertFails(
      addDoc(collection(db, 'users', 'user789', 'sessions'), {
        exerciseType: 'squat',
        // ...
      })
    );
  });
  
  // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‚’æ‹’å¦
  test('ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ä½œæˆå¾Œå¤‰æ›´ä¸å¯', async () => {
    const db = getFirestore('user123');
    await assertFails(
      updateDoc(doc(db, 'users', 'user123', 'sessions', 'session1', 'frames', 'frame1'), {
        confidence: 0.95
      })
    );
  });
});
```

### 12.4 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# Firestore Rulesãƒ•ã‚¡ã‚¤ãƒ«: firestore.rules

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
firebase deploy --only firestore:rules

# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
firebase emulators:start --only firestore

# ãƒ«ãƒ¼ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
firebase firestore:rules:validate firestore.rules
```

---

## 13. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

### 13.1 æ¦‚è¦

Firestoreã®åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªã®ãŸã‚ã«ã€è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­è¨ˆã—ã¾ã™ã€‚

### 13.2 å¿…è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§

```json
{
  "indexes": [
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "exerciseType", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "bigquerySyncStatus", "order": "ASCENDING" },
        { "fieldPath": "bigquerySyncRetryCount", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "sessions",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "dataRetentionDate", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "consents",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "consentType", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "notifications",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "isRead", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "notifications",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "priority", "order": "DESCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "dataDeletionRequests",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "scheduledDeletionDate", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "bigquerySyncFailures",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "nextRetryAt", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "securityIncidents",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "severity", "order": "DESCENDING" },
        { "fieldPath": "detectedAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

### 13.3 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½¿ç”¨ä¾‹

```typescript
// 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æœ€æ–°é †ã§å–å¾—
const sessionsQuery = query(
  collection(db, 'users', userId, 'sessions'),
  where('userId', '==', userId),
  orderBy('createdAt', 'desc'),
  limit(20)
);

// 2. ç‰¹å®šç¨®ç›®ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
const squatSessionsQuery = query(
  collection(db, 'users', userId, 'sessions'),
  where('userId', '==', userId),
  where('exerciseType', '==', 'squat'),
  orderBy('createdAt', 'desc')
);

// 3. BigQueryåŒæœŸå¤±æ•—ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
const failedSyncsQuery = query(
  collection(db, 'users', userId, 'sessions'),
  where('userId', '==', userId),
  where('bigquerySyncStatus', '==', 'failed'),
  orderBy('bigquerySyncRetryCount', 'asc')
);

// 4. æœªèª­é€šçŸ¥ã‚’å„ªå…ˆåº¦é †ã§å–å¾—
const unreadNotificationsQuery = query(
  collection(db, 'notifications'),
  where('userId', '==', userId),
  where('isRead', '==', false),
  orderBy('priority', 'desc'),
  orderBy('createdAt', 'desc')
);
```

### 13.4 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# firestore.indexes.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆå¾Œ

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
firebase deploy --only firestore:indexes

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆçŠ¶æ³ã®ç¢ºèª
firebase firestore:indexes
```

---

## 14. ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

### 14.1 æ¦‚è¦

GDPRæº–æ‹ ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ã‚’æ˜ç¢ºã«å®šç¾©ã—ã€è‡ªå‹•å‰Šé™¤ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### 14.2 ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ä¸€è¦§

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿æŒæœŸé–“ | è‡ªå‹•å‰Šé™¤ | ç†ç”± |
|-----------|---------|---------|------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« | æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œ3å¹´ | âœ… | GDPRç¬¬5æ¡1é …(e) |
| ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ | ä½œæˆå¾Œ3å¹´ | âœ… | GDPRç¬¬5æ¡1é …(e) |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ | ä½œæˆå¾Œ3å¹´ | âœ… | GDPRç¬¬5æ¡1é …(e) |
| åŒæ„å±¥æ­´ | ä½œæˆå¾Œ7å¹´ | âœ… | æ³•çš„è¦ä»¶ï¼ˆè¨¼æ‹ ä¿å…¨ï¼‰ |
| ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ | çµ‚äº†å¾Œ7å¹´ | âœ… | ä¼šè¨ˆæ³•ãƒ»ç¨æ³•è¦ä»¶ |
| é€šçŸ¥ | ä½œæˆå¾Œ90æ—¥ | âœ… | é‹ç”¨ä¸Šã®å¿…è¦æ€§ã®ã¿ |
| ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | å‡¦ç†å¾Œ7å¹´ | âœ… | æ³•çš„è¦ä»¶ï¼ˆè¨¼æ‹ ä¿å…¨ï¼‰ |
| BigQueryåŒæœŸå¤±æ•—è¨˜éŒ² | è§£æ±ºå¾Œ1å¹´ | âœ… | é‹ç”¨ä¸Šã®å¿…è¦æ€§ã®ã¿ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ | ã‚¯ãƒ­ãƒ¼ã‚ºå¾Œ10å¹´ | âœ… | æ³•çš„è¦ä»¶ï¼ˆè¨¼æ‹ ä¿å…¨ï¼‰ |

### 14.3 è‡ªå‹•å‰Šé™¤ã®å®Ÿè£…

```typescript
// Cloud Function: maintenance_deleteExpiredDataï¼ˆæ—¥æ¬¡å®Ÿè¡Œï¼‰
export const maintenance_deleteExpiredData = functions
  .pubsub
  .schedule('0 3 * * *')  // æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰
  .timeZone('Asia/Tokyo')
  .onRun(async (context) => {
    const now = new Date();
    
    // 1. 3å¹´ä»¥ä¸ŠçµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    await deleteExpiredUsers(now);
    
    // 2. 3å¹´ä»¥ä¸ŠçµŒéã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    await deleteExpiredSessions(now);
    
    // 3. 7å¹´ä»¥ä¸ŠçµŒéã—ãŸåŒæ„å±¥æ­´ã‚’å‰Šé™¤
    await deleteExpiredConsents(now);
    
    // 4. 90æ—¥ä»¥ä¸ŠçµŒéã—ãŸé€šçŸ¥ã‚’å‰Šé™¤
    await deleteExpiredNotifications(now);
    
    // 5. 1å¹´ä»¥ä¸ŠçµŒéã—ãŸBigQueryåŒæœŸå¤±æ•—è¨˜éŒ²ã‚’å‰Šé™¤
    await deleteExpiredSyncFailures(now);
    
    console.log('Data retention policy executed successfully');
  });

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
async function deleteExpiredUsers(now: Date) {
  const threeYearsAgo = new Date(now);
  threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);
  
  const expiredUsersQuery = admin.firestore()
    .collection('users')
    .where('dataRetentionDate', '<=', threeYearsAgo);
  
  const snapshot = await expiredUsersQuery.get();
  
  for (const doc of snapshot.docs) {
    const userId = doc.id;
    
    // å®Œå…¨å‰Šé™¤å‡¦ç†
    await deleteUserDataCompletely(userId);
    
    console.log(`Deleted expired user data: ${userId}`);
  }
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
async function deleteExpiredSessions(now: Date) {
  const threeYearsAgo = new Date(now);
  threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);
  
  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
  const usersSnapshot = await admin.firestore().collection('users').get();
  
  for (const userDoc of usersSnapshot.docs) {
    const userId = userDoc.id;
    
    const expiredSessionsQuery = admin.firestore()
      .collection('users').doc(userId)
      .collection('sessions')
      .where('dataRetentionDate', '<=', threeYearsAgo);
    
    const sessionsSnapshot = await expiredSessionsQuery.get();
    
    for (const sessionDoc of sessionsSnapshot.docs) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å‰Šé™¤
      await deleteSessionAndFrames(userId, sessionDoc.id);
      
      console.log(`Deleted expired session: ${userId}/${sessionDoc.id}`);
    }
  }
}

// é€šçŸ¥ã®å‰Šé™¤
async function deleteExpiredNotifications(now: Date) {
  const ninetyDaysAgo = new Date(now);
  ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
  
  const expiredNotificationsQuery = admin.firestore()
    .collection('notifications')
    .where('dataRetentionDate', '<=', ninetyDaysAgo);
  
  const snapshot = await expiredNotificationsQuery.get();
  
  const batch = admin.firestore().batch();
  snapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });
  
  await batch.commit();
  console.log(`Deleted ${snapshot.size} expired notifications`);
}

// BigQueryåŒæœŸå¤±æ•—è¨˜éŒ²ã®å‰Šé™¤
async function deleteExpiredSyncFailures(now: Date) {
  const oneYearAgo = new Date(now);
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  
  const expiredFailuresQuery = admin.firestore()
    .collection('bigquerySyncFailures')
    .where('status', '==', 'resolved')
    .where('resolvedAt', '<=', oneYearAgo);
  
  const snapshot = await expiredFailuresQuery.get();
  
  const batch = admin.firestore().batch();
  snapshot.docs.forEach(doc => {
    batch.delete(doc.ref);
  });
  
  await batch.commit();
  console.log(`Deleted ${snapshot.size} expired sync failure records`);
}
```

### 14.4 ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé™ã®è¨ˆç®—

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚
function calculateUserRetentionDate(): Date {
  const now = new Date();
  now.setFullYear(now.getFullYear() + 3);  // 3å¹´å¾Œ
  return now;
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚
function calculateSessionRetentionDate(): Date {
  const now = new Date();
  now.setFullYear(now.getFullYear() + 3);  // 3å¹´å¾Œ
  return now;
}

// åŒæ„è¨˜éŒ²ä½œæˆæ™‚
function calculateConsentRetentionDate(): Date {
  const now = new Date();
  now.setFullYear(now.getFullYear() + 7);  // 7å¹´å¾Œ
  return now;
}

// é€šçŸ¥ä½œæˆæ™‚
function calculateNotificationRetentionDate(): Date {
  const now = new Date();
  now.setDate(now.getDate() + 90);  // 90æ—¥å¾Œ
  return now;
}
```

---

## 15. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢æˆ¦ç•¥

### 15.1 æ¦‚è¦

éæ©Ÿèƒ½è¦ä»¶NFR-031, NFR-032ã«åŸºã¥ãã€æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨RTO 24æ™‚é–“ä»¥å†…ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### 15.2 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

#### 15.2.1 Firestoreã®æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

```typescript
// Cloud Function: backup_firestoreDailyï¼ˆæ—¥æ¬¡å®Ÿè¡Œï¼‰
export const backup_firestoreDaily = functions
  .pubsub
  .schedule('0 2 * * *')  // æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰
  .timeZone('Asia/Tokyo')
  .onRun(async (context) => {
    const projectId = process.env.GCLOUD_PROJECT;
    const bucket = `gs://${projectId}-firestore-backups`;
    
    const client = new admin.firestore.v1.FirestoreAdminClient();
    
    const databaseName = client.databasePath(projectId, '(default)');
    
    const responses = await client.exportDocuments({
      name: databaseName,
      outputUriPrefix: bucket,
      collectionIds: []  // å…¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    });
    
    const response = responses[0];
    console.log(`Firestore backup started: ${response.name}`);
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«è¨˜éŒ²
    await admin.firestore().collection('_system').doc('backups').collection('history').add({
      backupId: response.name,
      startedAt: admin.firestore.FieldValue.serverTimestamp(),
      status: 'in_progress',
      bucket
    });
    
    return response;
  });

// ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ã®ç›£è¦–
export const backup_monitorCompletion = functions
  .pubsub
  .schedule('*/30 * * * *')  // 30åˆ†ã”ã¨
  .timeZone('Asia/Tokyo')
  .onRun(async (context) => {
    const projectId = process.env.GCLOUD_PROJECT;
    const client = new admin.firestore.v1.FirestoreAdminClient();
    
    // é€²è¡Œä¸­ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
    const inProgressBackups = await admin.firestore()
      .collection('_system').doc('backups').collection('history')
      .where('status', '==', 'in_progress')
      .get();
    
    for (const doc of inProgressBackups.docs) {
      const backup = doc.data();
      
      // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ“ä½œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
      const [operation] = await client.getOperation({ name: backup.backupId });
      
      if (operation.done) {
        await doc.ref.update({
          status: operation.error ? 'failed' : 'completed',
          completedAt: admin.firestore.FieldValue.serverTimestamp(),
          error: operation.error ? operation.error.message : null
        });
        
        if (operation.error) {
          // Slackã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
          await sendSlackAlert({
            severity: 'error',
            message: `ğŸš¨ Firestore backup failed`,
            details: operation.error
          });
        } else {
          console.log(`Backup completed successfully: ${backup.backupId}`);
        }
      }
    }
  });
```

#### 15.2.2 BigQueryã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

```sql
-- BigQueryã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆï¼ˆæ—¥æ¬¡å®Ÿè¡Œï¼‰
-- Cloud Schedulerã§ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ

-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
CREATE SNAPSHOT TABLE `project-id.ai_fitness_mvp.training_sessions_snapshot`
CLONE `project-id.ai_fitness_mvp.training_sessions`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
CREATE SNAPSHOT TABLE `project-id.ai_fitness_mvp.user_profiles_snapshot`
CLONE `project-id.ai_fitness_mvp.user_profiles`
OPTIONS(
  expiration_timestamp = TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
);
```

### 15.3 ãƒªã‚¹ãƒˆã‚¢æˆ¦ç•¥

#### 15.3.1 Firestoreã®ãƒªã‚¹ãƒˆã‚¢æ‰‹é †

```bash
# 1. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¢ºèª
gcloud firestore operations list

# 2. ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œï¼ˆç‰¹å®šã®æ—¥æ™‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ï¼‰
gcloud firestore import gs://[PROJECT_ID]-firestore-backups/[TIMESTAMP]/ \
  --collection-ids='users,sessions,consents' \
  --async

# 3. ãƒªã‚¹ãƒˆã‚¢çŠ¶æ³ã®ç¢ºèª
gcloud firestore operations describe [OPERATION_NAME]
```

#### 15.3.2 BigQueryã®ãƒªã‚¹ãƒˆã‚¢æ‰‹é †

```sql
-- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¾©å…ƒ
CREATE TABLE `project-id.ai_fitness_mvp.training_sessions`
CLONE `project-id.ai_fitness_mvp.training_sessions_snapshot`;

-- ç‰¹å®šã®æ™‚ç‚¹ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ï¼‰
CREATE TABLE `project-id.ai_fitness_mvp.training_sessions_restored`
AS SELECT * FROM `project-id.ai_fitness_mvp.training_sessions`
FOR SYSTEM_TIME AS OF TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY);
```

### 15.4 ç½å®³å¾©æ—§ï¼ˆDRï¼‰è¨ˆç”»

#### 15.4.1 RPO/RTOç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | å®Ÿè£…æ–¹æ³• |
|-----|--------|---------|
| RPO (Recovery Point Objective) | 24æ™‚é–“ | æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| RTO (Recovery Time Objective) | 24æ™‚é–“ | è‡ªå‹•ãƒªã‚¹ãƒˆã‚¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |

#### 15.4.2 ç½å®³å¾©æ—§æ‰‹é †æ›¸

```markdown
# ç½å®³å¾©æ—§æ‰‹é †æ›¸ v1.0

## 1. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¤œå‡º
- ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆã®ç¢ºèª
- Slackã§ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé€šçŸ¥å—ä¿¡

## 2. å½±éŸ¿ç¯„å›²ã®è©•ä¾¡
- å½±éŸ¿ã‚’å—ã‘ãŸã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å®š
- ãƒ‡ãƒ¼ã‚¿æå¤±ã®ç¨‹åº¦ã‚’è©•ä¾¡

## 3. ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œ
### Firestoreã®ãƒªã‚¹ãƒˆã‚¢
1. æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèª
2. gcloud CLIã§ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œ
3. ãƒªã‚¹ãƒˆã‚¢å®Œäº†ã‚’ç¢ºèª

### BigQueryã®ãƒªã‚¹ãƒˆã‚¢
1. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
2. CREATE TABLE ... CLONE ã§å¾©å…ƒ
3. ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

## 4. ã‚µãƒ¼ãƒ“ã‚¹å¾©æ—§ç¢ºèª
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ç¢ºèª

## 5. äº‹å¾Œå¯¾å¿œ
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
- å†ç™ºé˜²æ­¢ç­–ã®æ¤œè¨
```

### 15.5 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä¿æŒæœŸé–“

| ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¨®åˆ¥ | ä¿æŒæœŸé–“ | ç†ç”± |
|----------------|---------|------|
| Firestoreæ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— | 30æ—¥ | é‹ç”¨ä¸Šã®å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ |
| BigQueryã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ | 7æ—¥ | ã‚³ã‚¹ãƒˆæœ€é©åŒ– |
| æœˆæ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆé•·æœŸä¿å­˜ï¼‰ | 1å¹´ | ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶ |

---

## 16. ã¾ã¨ã‚

### 16.1 v3.3ã§ã®ä¸»è¦ãªæ”¹å–„ç‚¹

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å®Œå…¨å®Ÿè£…**
   - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
   - ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
   - å‰Šé™¤çŒ¶äºˆæœŸé–“ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™

2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹ã¸ã®å¯¾å¿œ**
   - æ‡¸å¿µç‚¹#1: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è©³ç´°è¨­è¨ˆ
   - æ‡¸å¿µç‚¹#2: å‰Šé™¤çŒ¶äºˆæœŸé–“ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
   - æ‡¸å¿µç‚¹#4: BigQueryãƒªãƒˆãƒ©ã‚¤å‡¦ç†
   - æ‡¸å¿µç‚¹#9: åŒæ„æ’¤å›å¾Œã®å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
   - æ‡¸å¿µç‚¹#10: ãƒ‡ãƒ¼ã‚¿ä¾µå®³é€šçŸ¥æ‰‹é †

3. **GDPRå®Œå…¨æº–æ‹ **
   - ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ã®è‡ªå‹•ç®¡ç†
   - åŒæ„å±¥æ­´ã®7å¹´é–“ä¿æŒ
   - ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ¨©åˆ©ä¿éšœ

4. **é‹ç”¨æ€§ã®å‘ä¸Š**
   - è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
   - ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã®å®Ÿè£…

### 16.2 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Phase 1ï¼ˆ0-2ãƒ¶æœˆï¼‰**
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆ
   - åŸºæœ¬çš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã®å®Ÿè£…
   - ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…

2. **Phase 2ï¼ˆ2-7ãƒ¶æœˆï¼‰**
   - BigQueryãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã®å®Ÿè£…
   - MediaPipeãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã®è¿½åŠ 
   - ã‚«ã‚¹ã‚¿ãƒ MLç§»è¡Œæº–å‚™ãƒ‡ãƒ¼ã‚¿ã®åé›†é–‹å§‹

3. **Phase 3ï¼ˆ7ãƒ¶æœˆä»¥é™ï¼‰**
   - ç„¡æ–™ãƒ—ãƒ©ãƒ³åˆ¶é™ã®å®Ÿè£…
   - å®Œå…¨ãªDRè¨ˆç”»ã®ç­–å®š
   - ç¶™ç¶šçš„ãªæ”¹å–„ã¨ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—

### 16.3 é‡è¦ãªæ³¨æ„äº‹é …

âš ï¸ **CRITICAL**: ä»¥ä¸‹ã®ç‚¹ã¯å¿…ãšéµå®ˆã—ã¦ãã ã•ã„

1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«**å¿…ãšãƒ†ã‚¹ãƒˆ**ã‚’å®Ÿæ–½
2. åŒæ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯**Cloud Functionsã®ã¿ãŒæ›´æ–°å¯èƒ½**
3. å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯**èª­ã¿å–ã‚Šã®ã¿è¨±å¯**ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰
4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯**æ¯æ—¥è‡ªå‹•å®Ÿè¡Œ**ã‚’ç¢ºèª
5. BigQueryåŒæœŸå¤±æ•—ã¯**3å›ã¾ã§ãƒªãƒˆãƒ©ã‚¤**ã€ãã®å¾ŒDead Letter Queue

---

**Document Version**: 3.3  
**Last Updated**: 2025å¹´11æœˆ24æ—¥  
**Author**: Claude  
**Status**: Draft  
**Next Review**: Phase 1é–‹å§‹æ™‚

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- è¦ä»¶å®šç¾©æ›¸ v3.3
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‡¸å¿µç‚¹åˆ†æ v1.0
- APIè¨­è¨ˆæ›¸(Firebase Functions) v3.2
- BigQueryè¨­è¨ˆæ›¸ v3.2
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ v1.0
