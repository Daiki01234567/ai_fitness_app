# Firestore セキュリティルール ドキュメント

**バージョン**: 1.0.0
**日付**: 2025-11-24
**ステータス**: 実装済み

## 概要

本ドキュメントでは、AI Fitness App の Firestore セキュリティルール実装について説明します。これらのルールは、GDPR 準拠、フィールドレベルのアクセス制御、および機密ユーザーデータの保護を保証します。

## 主要機能

### 1. フィールドレベルのアクセス制御

重要なフィールドは読み取り専用であり、Cloud Functions からのみ変更可能です：
- `tosAccepted` - 利用規約の同意状況
- `ppAccepted` - プライバシーポリシーの同意状況
- `deletionScheduled` - アカウント削除フラグ
- `forceLogout` - 強制ログアウトフラグ
- `createdAt` - 作成タイムスタンプ
- `email` - ユーザーメールアドレス
- `userId` - ユーザー識別子

### 2. GDPR 準拠

#### データ主体の権利
- **アクセス権**: ユーザーは自身のデータを読み取ることができます
- **削除権**: データ削除には30日間の猶予期間があります
- **データポータビリティ**: ユーザーは削除猶予期間中にデータをエクスポートできます
- **同意管理**: 同意変更の不変な監査ログ

#### 削除猶予期間
ユーザーが削除をリクエストした場合：
1. `deletionScheduled` フラグが `true` に設定されます
2. ユーザーはデータの読み取り（エクスポート用）は可能ですが、書き込みはできません
3. 30日後、Cloud Functions がデータを完全に削除します

### 3. カスタムクレーム

ルールは高度なアクセス制御のために2つのカスタムクレームをサポートしています：

#### 管理者クレーム (`admin: true`)
管理用コレクションへのアクセスを許可します：
- `bigquerySyncFailures` - BigQuery 同期エラー追跡
- `securityIncidents` - セキュリティインシデント管理

#### 強制ログアウトクレーム (`forceLogout: true`)
設定されると、ユーザーのすべてのアクセスを即座に無効にします。以下の場合に使用されます：
- ユーザーが同意を撤回した場合
- セキュリティインシデントが検出された場合
- アカウント侵害が疑われる場合

### 4. データバリデーション

すべての書き込み操作には包括的なバリデーションが含まれます：

#### ユーザープロファイルのバリデーション
- 身長: 100-250 cm
- 体重: 30-300 kg
- 性別: `male`、`female`、`other`、`prefer_not_to_say`、または `null`
- メール: 有効なメールアドレス形式

#### セッションデータのバリデーション
- 運動種目: `squat`、`armcurl`、`sideraise`、`shoulderpress`、`pushup`
- ステータス: `active`、`completed`、`cancelled`
- 姿勢データ: 最大10,000フレーム
- 必須フィールドのバリデーション

## コレクション構造

### ルートコレクション

#### `/users/{userId}`
- **読み取り**: 所有者のみ、削除予定でないこと、強制ログアウトでないこと
- **作成**: 所有者のみ、有効な初期データと同意が必要
- **更新**: 所有者のみ、フィールドレベルの制限が適用されます
- **削除**: 禁止（Cloud Functions のみ）

#### `/consents/{consentId}`
- **読み取り**: 所有者のみ（`userId` フィールドに基づく）
- **作成**: 禁止（Cloud Functions のみ）
- **更新**: 禁止（不変データ）
- **削除**: 禁止（不変データ）

#### `/notifications/{notificationId}`
- **読み取り**: 所有者のみ
- **作成**: 禁止（Cloud Functions のみ）
- **更新**: 所有者のみ（既読マーク用）
- **削除**: 所有者のみ

#### `/dataDeletionRequests/{requestId}`
- **読み取り**: 所有者のみ
- **作成**: 所有者のみ、バリデーション付き
- **更新**: 禁止（Cloud Functions のみ）
- **削除**: 禁止

#### `/bigquerySyncFailures/{failureId}`
- **読み取り/書き込み**: 管理者のみ

#### `/securityIncidents/{incidentId}`
- **読み取り/書き込み**: 管理者のみ

### サブコレクション

#### `/users/{userId}/sessions/{sessionId}`
- **読み取り**: 所有者のみ
- **作成**: 所有者のみ、バリデーション付き
- **更新**: バリデーション付きの限定的な更新
- **削除**: 禁止

#### `/users/{userId}/sessions/{sessionId}/frames/{frameId}`
- **読み取り**: 所有者のみ
- **作成**: 所有者のみ、33点のランドマークバリデーション付き
- **更新**: 禁止（不変データ）
- **削除**: 禁止（不変データ）

#### `/users/{userId}/settings/{settingId}`
- **読み取り/書き込み**: 所有者のみ

#### `/users/{userId}/subscriptions/{subscriptionId}`
- **読み取り**: 所有者のみ
- **書き込み**: 禁止（RevenueCat 連携のみ）

## セキュリティパターン

### ゼロトラストアーキテクチャ
- デフォルトですべてのアクセスを拒否
- 各操作に対して明示的な許可が必要
- 複数のバリデーション層

### 多層防御
1. **認証層**: Firebase Authentication
2. **認可層**: Firestore Security Rules
3. **バリデーション層**: データ型と範囲のチェック
4. **監査層**: 不変な同意ログ

### 最小権限の原則
- ユーザーは自身のデータにのみアクセス可能
- 管理者アクセスは特定のコレクションに限定
- Cloud Functions はシステム操作のために昇格された権限を持つ

## テスト

### テストカバレッジ
セキュリティルールは以下をカバーする包括的なテストスイートでテストされています：
- 認証シナリオ
- 認可境界
- データバリデーション
- カスタムクレーム
- エッジケースとエラー条件

### テストの実行

```bash
cd tests
npm install
npm test
```

### テストファイル
- `tests/firestore.rules.test.ts` - メインテストスイート
- `tests/package.json` - テスト依存関係

## デプロイ

### ローカル開発
```bash
firebase emulators:start --only firestore
```

### 本番環境へのデプロイ
```bash
firebase deploy --only firestore:rules
```

### バリデーション
```bash
firebase firestore:rules:validate
```

## モニタリング

### 監視すべきセキュリティイベント
1. 認証失敗の試行
2. 認可違反
3. データバリデーション失敗
4. 管理者アクセスの使用
5. 強制ログアウトの発動

### 推奨アラート
- 同一ユーザーからの複数回のアクセス失敗
- 予期しない管理者アクセスパターン
- 大量の削除リクエスト
- バリデーション失敗の急増

## ベストプラクティス

### 開発者向け
1. 本番環境でセキュリティルールをバイパスしない
2. すべてのルール変更を先にエミュレータでテストする
3. バリデーション関数をシンプルで効率的に保つ
4. ルールの例外は必ずドキュメント化する

### 運用チーム向け
1. セキュリティルールの定期監査（月次）
2. ルール評価のパフォーマンスを監視する
3. システム操作のために Cloud Functions を最新の状態に保つ
4. コンプライアンスのために監査ログを維持する

## コンプライアンスに関する注記

### 満たされた GDPR 要件
- データ最小化（フィールド制限による）
- 目的限定（バリデーションによる）
- 保存制限（削除サポート付き）
- 完全性と機密性（アクセス制御による）
- 説明責任（監査ログによる）

### セキュリティ標準
- OWASP セキュリティ原則に準拠
- 多層防御を実装
- ゼロトラストアーキテクチャ
- 最小権限の原則

## トラブルシューティング

### よくある問題

#### 「Permission Denied」エラー
1. 認証状態を確認する
2. ユーザーがリソースの所有者であることを確認する
3. `deletionScheduled` フラグを確認する
4. `forceLogout` クレームがないことを確認する

#### バリデーション失敗
1. すべての必須フィールドが存在することを確認する
2. データ型が期待値と一致することを確認する
3. 数値の範囲を確認する
4. 列挙値が有効であることを確認する

#### テスト失敗
1. エミュレータが実行中であることを確認する
2. テストデータがバリデーションルールと一致することを確認する
3. カスタムクレームが正しく設定されていることを確認する
4. 最近のルール変更を確認する

## 参考資料

- [Firebase Security Rules ドキュメント](https://firebase.google.com/docs/firestore/security/get-started)
- [GDPR コンプライアンスガイドライン](https://gdpr-info.eu/)
- [OWASP セキュリティ原則](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/)
- プロジェクトドキュメント:
  - `docs/specs/02_Firestoreデータベース設計書_v3_3.md`
  - `docs/specs/07_セキュリティポリシー_v1_0.md`
  - `CLAUDE.md`

## 変更履歴

### バージョン 1.0.0 (2025-11-24)
- 初期実装
- 完全な GDPR 準拠
- フィールドレベルのアクセス制御
- カスタムクレームのサポート
- 包括的なバリデーション
- テストスイートの作成
