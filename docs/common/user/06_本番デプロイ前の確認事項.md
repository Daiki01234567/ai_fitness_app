# 本番デプロイ前の確認事項

**対象**: 中学生〜高校生・初心者プログラマー
**最終更新**: 2025年12月10日

---

## このガイドについて

本番環境（実際のユーザーが使う環境）にデプロイする前に、必ず確認すべき項目をまとめたチェックリストです。

**デプロイ（Deploy）** = 開発したプログラムを本番サーバーにアップロードすること

---

## ⚠️ 重要な注意事項

### デプロイの影響範囲

| デプロイ対象 | 影響 | 注意点 |
|------------|------|--------|
| **Cloud Functions** | 🟡 中 | 新しいバージョンに置き換わる（古いバージョンは消える） |
| **Firestore Rules** | 🔴 高 | 全ユーザーのデータアクセス権限が変わる |
| **Storage Rules** | 🔴 高 | 全ユーザーのファイルアクセス権限が変わる |
| **Firestore Indexes** | 🟢 低 | クエリのパフォーマンスに影響 |

### 基本原則

1. **エミュレータで必ずテスト** ✅
   - 本番デプロイ前に、必ずローカルのエミュレータで動作確認

2. **段階的にデプロイ** ✅
   - 一度に全部デプロイしない
   - まず影響の小さいものからデプロイ

3. **ロールバック準備** ✅
   - 問題があったときに元に戻せるように準備

4. **営業時間外にデプロイ** ✅
   - ユーザーが少ない時間帯（深夜・早朝）を選ぶ

---

## デプロイ前のチェックリスト

### ✅ 1. テストの確認

すべてのテストが合格していることを確認してください。

#### Firestore Rules のテスト

```bash
cd C:\Users\236149\Desktop\ai_fitness_app\firebase
npm test
```

**期待される結果**:
```
Test Suites: 1 passed, 1 total
Tests:       45 passed, 45 total
```

#### Cloud Functions のテスト

```bash
cd C:\Users\236149\Desktop\ai_fitness_app\functions
npm test
```

**期待される結果**:
```
Test Suites: 57 passed, 57 of 60 total
Tests:       1293 passed, 1306 total
```

#### 統合テスト

```bash
cd C:\Users\236149\Desktop\ai_fitness_app\functions
npm run test:integration
```

**期待される結果**:
```
Test Suites: 5 passed, 5 total
Tests:       56 passed, 56 total
```

#### セキュリティ監査

```bash
cd C:\Users\236149\Desktop\ai_fitness_app\functions
npm audit --audit-level=high
```

**期待される結果**:
```
found 0 vulnerabilities
```

---

### ✅ 2. エミュレータでの動作確認

本番デプロイ前に、必ずエミュレータで最終動作確認を行ってください。

#### エミュレータ起動

```bash
cd C:\Users\236149\Desktop\ai_fitness_app
firebase emulators:start
```

#### 確認すべき項目

- [ ] エミュレータが正常に起動する
- [ ] Firestore Emulator (http://localhost:4000) が表示される
- [ ] Cloud Functions がデプロイされている
- [ ] テストユーザーでログインできる
- [ ] プロフィール取得・更新ができる
- [ ] 同意管理APIが動作する
- [ ] エラーログが出ていない

---

### ✅ 3. Firebaseプロジェクトの確認

#### 正しいプロジェクトを選択

```bash
firebase use
```

**期待される結果**:
```
Active Project: tokyo-list-478804-e5 (your-project-name)
```

**間違っていたら**:
```bash
firebase use tokyo-list-478804-e5
```

#### プロジェクト一覧を確認

```bash
firebase projects:list
```

すべてのプロジェクトが表示されます。本番環境のプロジェクトIDを確認してください。

---

### ✅ 4. Gitの状態確認

#### すべての変更がコミット済みか確認

```bash
git status
```

**期待される結果**:
```
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
```

#### 未コミットの変更がある場合

```bash
# 変更を確認
git diff

# ステージに追加
git add .

# コミット
git commit -m "feat: Phase 1完了・本番デプロイ準備"

# プッシュ
git push origin main
```

---

### ✅ 5. デプロイ権限の確認

#### Firebase Console で権限を確認

1. Firebase Console を開く
   - https://console.firebase.google.com/

2. プロジェクト `tokyo-list-478804-e5` を選択

3. **設定（歯車アイコン）** → **ユーザーと権限** をクリック

4. 自分のアカウントが **編集者** 以上の権限を持っているか確認

**権限レベル**:
- **編集者**: デプロイ可能 ✅
- **閲覧者**: デプロイ不可 ❌

---

### ✅ 6. バックアップの確認

デプロイ前に、現在の状態をバックアップしておきます。

#### Firestore Rules のバックアップ

```bash
# 現在のルールを保存
firebase firestore:rules --project tokyo-list-478804-e5 > firestore.rules.backup
```

#### Cloud Functions の現在のバージョンを記録

```bash
# 現在デプロイされている関数を確認
firebase functions:list --project tokyo-list-478804-e5
```

出力をメモ帳にコピーして保存してください。

---

## デプロイの手順（段階的）

### ステップ1: Firestore Rules のみデプロイ（影響: 中）

```bash
firebase deploy --only firestore:rules --project tokyo-list-478804-e5
```

**デプロイ後の確認**:
1. Firebase Console → Firestore → ルール を開く
2. 最新のルールが反映されているか確認
3. エミュレータでテストユーザーを作成して、アクセス制御が正しく動作するか確認

**問題があった場合**:
```bash
# バックアップから復元
firebase deploy --only firestore:rules --project tokyo-list-478804-e5
# （firestore.rulesをバックアップ版に戻してから実行）
```

---

### ステップ2: Cloud Functions のみデプロイ（影響: 中）

```bash
# まずビルドして確認
cd functions
npm run build

# デプロイ
firebase deploy --only functions --project tokyo-list-478804-e5
```

**デプロイ時間**: 5〜10分

**デプロイ後の確認**:
1. Firebase Console → Functions を開く
2. すべての関数が「有効」になっているか確認
3. ログを確認してエラーがないか確認

```bash
# ログを確認
firebase functions:log --project tokyo-list-478804-e5
```

**問題があった場合**:
- Gitで前のコミットに戻して再デプロイ
- または、Firebase Console から関数を削除

---

### ステップ3: すべてまとめてデプロイ（上級者向け）

```bash
firebase deploy --project tokyo-list-478804-e5
```

**注意**: これは全て（Functions, Firestore Rules, Storage Rules, Indexes）をまとめてデプロイします。
初めての場合は、**ステップ1とステップ2を別々に実行することを推奨**します。

---

## デプロイ後の確認事項

### 1. Firebase Console での確認

#### Cloud Functions

1. Firebase Console → Functions を開く
2. すべての関数が「有効」になっているか確認
3. 関数の詳細を開いて、デプロイ日時が最新になっているか確認

#### Firestore

1. Firebase Console → Firestore → ルール を開く
2. ルールが最新になっているか確認
3. テストモードになっていないか確認（**本番では絶対にテストモードにしない**）

---

### 2. ログの確認

```bash
# 最新のログを確認（30行）
firebase functions:log --project tokyo-list-478804-e5 --limit 30

# エラーのみを確認
firebase functions:log --project tokyo-list-478804-e5 --only-errors
```

**確認すべき項目**:
- [ ] デプロイ成功のログが出ている
- [ ] エラーログが出ていない
- [ ] 警告ログの内容を確認

---

### 3. 動作テスト（本番環境）

⚠️ **注意**: 本番環境でのテストは、必ずテストユーザーで行ってください。

#### テスト手順

1. **テストユーザーを作成**
   - Firebase Console → Authentication → ユーザー追加
   - メール: `test@example.com`
   - パスワード: テスト用のパスワード

2. **アプリからログイン**
   - Expo版またはFlutter版アプリから、テストユーザーでログイン

3. **基本機能の動作確認**
   - [ ] ログインできる
   - [ ] プロフィール取得ができる
   - [ ] プロフィール更新ができる
   - [ ] 利用規約同意ができる
   - [ ] ログアウトできる

4. **テストユーザーを削除**
   - Firebase Console → Authentication → テストユーザーを削除

---

## トラブルシューティング

### エラー1: `HTTP Error: 403, The caller does not have permission`

**原因**: デプロイ権限がない

**解決法**:
1. Firebase Console → プロジェクト設定 → ユーザーと権限
2. 自分のアカウントが「編集者」以上の権限を持っているか確認

---

### エラー2: `Function deployment failed`

**原因**: ビルドエラーまたはメモリ不足

**解決法**:

1. **ビルドエラーの場合**
```bash
cd functions
npm run build
# エラーメッセージを確認して修正
```

2. **メモリ不足の場合**

`functions/src/index.ts` でメモリを増やす:
```typescript
import { setGlobalOptions } from "firebase-functions/v2";

setGlobalOptions({
  region: "asia-northeast1",
  memory: "512MiB",  // デフォルトは256MiB
  timeoutSeconds: 60,
});
```

---

### エラー3: `Deployment quota exceeded`

**原因**: 1日のデプロイ回数制限を超えた

**解決法**:
- デプロイ回数を減らす（まとめてデプロイ）
- 明日まで待つ
- Firebase プランをアップグレード（有料プラン）

---

## ロールバック（元に戻す）方法

デプロイ後に問題が見つかった場合、前のバージョンに戻す方法です。

### Cloud Functions のロールバック

```bash
# Gitで前のコミットに戻る
git revert HEAD

# 再デプロイ
firebase deploy --only functions --project tokyo-list-478804-e5
```

### Firestore Rules のロールバック

Firebase Console から:
1. Firestore → ルール → バージョン履歴
2. 前のバージョンを選択
3. 「公開」をクリック

---

## よくある質問

### Q: Linuxサーバーで動作確認する際、Firebaseはデプロイしないといけない？

**A**: いいえ、デプロイ不要です。

Linuxサーバー上でも、Firebaseエミュレータを使えばローカルで動作確認できます:

```bash
# Linuxサーバー上で
firebase emulators:start
```

これで、本番環境にデプロイせずに動作確認ができます。

---

### Q: 全テスト通過しているから、いつでもデプロイしていい？

**A**: 基本的にはYESですが、以下を確認してください:

#### ✅ デプロイ可能な条件

1. **すべてのテストが合格**
   - Firestore Rules: 45/45 ✅
   - Cloud Functions: 1293/1293 ✅
   - Integration: 56/56 ✅
   - Security Audit: 0 vulnerabilities ✅

2. **Gitにコミット済み**
   - すべての変更がコミット・プッシュされている

3. **エミュレータで動作確認済み**
   - ローカルのエミュレータで最終確認が完了している

4. **デプロイ時間を選ぶ**
   - ユーザーが少ない時間帯（深夜・早朝）を選ぶ
   - 平日の営業時間は避ける

5. **ロールバック準備**
   - 問題があったときに元に戻す準備ができている

#### ⚠️ デプロイ前に確認すべきこと

- [ ] 本番環境のプロジェクトIDは正しいか？（`tokyo-list-478804-e5`）
- [ ] デプロイ権限はあるか？（編集者以上）
- [ ] 現在のバージョンをバックアップしたか？
- [ ] チームメンバーに通知したか？

---

### Q: デプロイしたら、すぐにユーザーに反映される？

**A**: はい、数分以内に反映されます。

| デプロイ対象 | 反映時間 |
|------------|---------|
| Cloud Functions | 5〜10分 |
| Firestore Rules | 10〜30秒 |
| Storage Rules | 10〜30秒 |

**注意**: ユーザーがアプリを開いている場合、再起動するまで反映されない場合があります。

---

## まとめ

### デプロイ前の最終チェック

```
✅ 全テスト合格（1394/1394）
✅ セキュリティ監査合格（0 vulnerabilities）
✅ エミュレータで動作確認
✅ 正しいプロジェクトを選択（tokyo-list-478804-e5）
✅ Gitにコミット済み
✅ バックアップ完了
✅ デプロイ時間を選択（深夜・早朝）
```

### 推奨デプロイ順序

```bash
# 1. Firestore Rules のみデプロイ
firebase deploy --only firestore:rules --project tokyo-list-478804-e5

# 2. 動作確認（Firebase Console + ログ）

# 3. Cloud Functions のみデプロイ
firebase deploy --only functions --project tokyo-list-478804-e5

# 4. 動作確認（Firebase Console + ログ + 本番テスト）
```

---

**おめでとうございます！** 🎉

これで本番環境へのデプロイ準備が整いました。

このチェックリストに従ってデプロイすれば、安全に本番環境に公開できます。

---

## 参考資料

- `docs/common/user/04_デプロイ方法.md` - デプロイコマンド詳細
- `docs/common/user/05_トラブルシューティング.md` - エラー対処法
- [Firebase Deploy ドキュメント](https://firebase.google.com/docs/cli#deployment)
