# テストの実行方法ガイド

**対象**: 中学生〜高校生・初心者プログラマー
**最終更新**: 2025年12月10日

---

## このガイドについて

このガイドでは、プログラムが正しく動くかを確認するための「テスト」の実行方法を説明します。

**テスト** とは、プログラムが期待通りに動くかを自動で確認する仕組みです。テストを実行することで、バグ（プログラムの間違い）を早く見つけることができます。

---

## なぜテストが重要なのか

### テストのメリット

1. **バグを早期発見**
   - プログラムを書いた直後にバグが見つかる
   - ユーザーに届く前に修正できる

2. **安心して開発**
   - コードを変更しても、テストが通れば問題ないと分かる
   - 他の部分を壊していないか自動で確認できる

3. **ドキュメント代わりになる**
   - テストコードを読めば、プログラムの使い方が分かる

---

## テストの種類

このプロジェクトには3種類のテストがあります:

| テスト種類 | 内容 | フォルダ |
|-----------|------|----------|
| **ユニットテスト** | 関数やクラス単体のテスト | `functions/tests/` |
| **セキュリティルールテスト** | Firestoreのアクセス制御のテスト | `firebase/__tests__/` |
| **統合テスト** | 複数の機能を組み合わせたテスト | `functions/tests/integration/` |

---

## ステップ1: エミュレータを起動

テストを実行する前に、Firebaseエミュレータを起動します。

### エミュレータ起動

1. **プロジェクトルートに移動**
   ```bash
   cd C:\Users\236149\Desktop\ai_fitness_app
   ```

2. **エミュレータを起動**
   ```bash
   firebase emulators:start
   ```

3. **別のターミナルを開く**
   - エミュレータは起動したまま、別のターミナルでテストを実行します

**ヒント**:
- ターミナルを2つ開いておくと便利です
- 1つ目: エミュレータ用（常に起動）
- 2つ目: テスト実行用

---

## ステップ2: Cloud Functionsのユニットテスト

Cloud Functions（サーバー側のプログラム）のテストを実行します。

### テスト実行手順

1. **functionsフォルダに移動**
   ```bash
   cd functions
   ```

2. **全テストを実行**
   ```bash
   npm test
   ```

### テスト結果の見方

#### 成功した場合

```
PASS  tests/api/users/updateProfile.test.ts
  ✓ プロフィール更新が成功する (45ms)
  ✓ 未認証ユーザーは更新できない (12ms)
  ✓ 削除予定ユーザーは更新できない (15ms)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Time:        2.5s
```

**説明**:
- `✓` = テストが成功
- `PASS` = テストファイル全体が成功
- `Tests: 3 passed` = 3つのテストが全て成功

#### 失敗した場合

```
FAIL  tests/api/users/updateProfile.test.ts
  ✕ プロフィール更新が成功する (52ms)

  ● プロフィール更新が成功する

    expect(received).toEqual(expected)

    Expected: 200
    Received: 401

    at Object.<anonymous> (tests/api/users/updateProfile.test.ts:25:23)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 2 passed, 3 total
```

**説明**:
- `✕` = テストが失敗
- `FAIL` = テストファイルに失敗がある
- エラーメッセージに、何が期待されて（Expected）、何が返ってきたか（Received）が表示される

### 特定のテストだけ実行

```bash
# 特定のファイルだけテスト
npm test -- tests/api/users/updateProfile.test.ts

# 特定のテスト名で絞り込み
npm test -- -t "プロフィール更新"
```

### ウォッチモード（自動再実行）

コードを変更するたびに自動でテストを実行する:

```bash
npm run test:watch
```

ファイルを保存すると自動でテストが走ります。
終了するには `q` を押します。

### カバレッジレポート（どこがテストされているか）

```bash
npm run test:coverage
```

実行すると、`coverage/` フォルダに詳細なレポートが作成されます:

```bash
# ブラウザでレポートを開く
start coverage/lcov-report/index.html   # Windows
open coverage/lcov-report/index.html    # Mac
```

---

## ステップ3: Firestoreセキュリティルールのテスト

Firestore（データベース）のアクセス制御が正しく設定されているかテストします。

### テスト実行手順

1. **firebaseフォルダに移動**
   ```bash
   cd ../firebase
   ```

2. **全テストを実行**
   ```bash
   npm test
   ```

### テスト結果の見方

#### 成功例

```
PASS  __tests__/firestore.rules.test.ts
  Users Collection
    Read Access
      ✓ 未認証ユーザーは読み取りできない (45ms)
      ✓ 認証済みユーザーは自分のドキュメントを読み取りできる (32ms)
      ✓ 認証済みユーザーは他人のドキュメントを読み取りできない (28ms)

Test Suites: 1 passed, 1 total
Tests:       40 passed, 40 total
```

### 重要なテスト項目

| テスト項目 | 確認内容 |
|-----------|---------|
| **認証テスト** | ログインしていない人はデータにアクセスできない |
| **所有権テスト** | 自分のデータだけ読み書きできる |
| **フィールド保護テスト** | 同意フィールドなど、変更してはいけない項目が守られている |
| **削除予定ユーザー** | アカウント削除予定の人は書き込みできない |

---

## ステップ4: 統合テスト

複数の機能を組み合わせてテストします。

### 統合テスト実行

```bash
cd ../functions
npm run test:integration
```

### 統合テストの内容

- ユーザー登録 → プロフィール更新 → データ取得の一連の流れ
- 同意更新 → 同意履歴取得の流れ
- セッション保存 → BigQueryへの同期

---

## テストが失敗したときの対処法

### ステップ1: エラーメッセージを読む

テストが失敗したら、まずエラーメッセージをよく読みます。

```
Expected: 200
Received: 401
```

この場合:
- 期待: ステータスコード200（成功）
- 実際: ステータスコード401（認証エラー）

→ 認証に関する問題がありそう

### ステップ2: テストコードを見る

失敗したテストのコードを開いて、何をテストしているか確認します。

```typescript
test("プロフィール更新が成功する", async () => {
  const response = await updateProfile(userId, { height: 170 });
  expect(response.status).toEqual(200);  // ← ここで失敗
});
```

### ステップ3: 実装コードを確認

テスト対象のコード（実装コード）を確認します。

```typescript
// functions/src/api/users/updateProfile.ts
if (!context.auth) {
  throw new HttpsError("unauthenticated", "認証が必要です");
  // ← 認証がないと401エラーになる
}
```

### ステップ4: 修正して再テスト

問題を修正したら、再度テストを実行します。

```bash
npm test
```

---

## よくある失敗パターンと解決法

### エラー: `Cannot find module`

**原因**: 必要なパッケージがインストールされていない

**解決法**:
```bash
npm install
```

### エラー: `ECONNREFUSED localhost:8080`

**原因**: Firestoreエミュレータが起動していない

**解決法**:
別のターミナルで:
```bash
firebase emulators:start
```

### エラー: `Timeout - Async callback was not invoked`

**原因**: テストのタイムアウト（時間切れ）

**解決法**:
1. エミュレータが正しく起動しているか確認
2. テストの実行時間を延長:
```typescript
test("...", async () => {
  // ...
}, 10000);  // 10秒に延長
```

### エラー: `Port already in use`

**原因**: ポートが別のプログラムに使われている

**解決法**:
```bash
# エミュレータを停止
# Ctrl + C を押す

# 再度起動
firebase emulators:start
```

---

## テストのベストプラクティス

### 1. テストは小さく書く

1つのテストで1つのことだけ確認する:

**良い例**:
```typescript
test("プロフィール更新: 身長が正しく保存される", async () => {
  await updateProfile(userId, { height: 170 });
  const profile = await getProfile(userId);
  expect(profile.height).toBe(170);
});

test("プロフィール更新: 体重が正しく保存される", async () => {
  await updateProfile(userId, { weight: 65 });
  const profile = await getProfile(userId);
  expect(profile.weight).toBe(65);
});
```

**悪い例**:
```typescript
test("プロフィール更新が全部動く", async () => {
  // 身長、体重、性別、目標... 全部まとめてテスト
  // ← 失敗したとき、どこが原因か分かりにくい
});
```

### 2. テスト名は分かりやすく

何をテストしているか、日本語で明確に書く:

```typescript
// ✅ 良い
test("未認証ユーザーはプロフィールを更新できない")

// ❌ 悪い
test("test1")
```

### 3. テストは独立させる

テストの順番が変わっても動くようにする:

```typescript
// ✅ 良い - 各テストで必要なデータを作成
beforeEach(async () => {
  await createTestUser(userId);
});

// ❌ 悪い - 前のテストの結果に依存
test("test1", async () => {
  await createUser(); // 作成
});
test("test2", async () => {
  await updateUser(); // test1の結果を使う ← NG
});
```

---

## テストコマンド一覧

### Cloud Functions

```bash
cd functions

# 全テスト実行
npm test

# 特定のファイルをテスト
npm test -- tests/api/users/updateProfile.test.ts

# ウォッチモード
npm run test:watch

# カバレッジ
npm run test:coverage

# 統合テスト
npm run test:integration
```

### Firestore Rules

```bash
cd firebase

# 全テスト実行
npm test

# ウォッチモード
npm run test:watch

# カバレッジ
npm run test:coverage
```

---

## 次のステップ

テストの実行方法が分かったら:

1. **03_Cloud_Functionsの開発.md** - 新しいAPIの作り方
2. **04_デプロイ方法.md** - 本番環境への公開
3. **05_トラブルシューティング.md** - 困ったときの対処法

---

## 用語集

| 用語 | 意味 |
|------|------|
| **ユニットテスト** | 関数やクラス単体のテスト |
| **統合テスト** | 複数の機能を組み合わせたテスト |
| **カバレッジ** | コードのどこがテストされているかの割合 |
| **モック** | テスト用の偽物のデータやオブジェクト |
| **アサーション** | 「〜であるべき」という期待値の宣言 |
| **タイムアウト** | テストの実行時間の上限 |

---

**おめでとうございます！** 🎉

テストの実行方法をマスターしました。
これでバグを早期に発見し、安心して開発を進められます！
