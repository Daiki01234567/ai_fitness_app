# フォーム評価ロジック v1.0

**バージョン**: 1.0
**最終更新日**: 2025年12月9日
**対象**: AIフィットネスアプリ（共通仕様）
**基準**: Expo版要件定義書 v1.0

---

## 目次

1. [ドキュメント概要](#1-ドキュメント概要)
2. [MediaPipe Pose概要](#2-mediapipe-pose概要)
3. [共通定義](#3-共通定義)
4. [種目1: スクワット](#4-種目1-スクワット)
5. [種目2: プッシュアップ](#5-種目2-プッシュアップ)
6. [種目3: アームカール](#6-種目3-アームカール)
7. [種目4: サイドレイズ](#7-種目4-サイドレイズ)
8. [種目5: ショルダープレス](#8-種目5-ショルダープレス)

---

## 1. ドキュメント概要

### 1.1 目的

本ドキュメントは、5種目のトレーニングフォーム確認補助ロジックの詳細仕様を定義します。

**重要な前提条件**:
- **本サービスは医療機器ではありません**
- 提供する情報は「参考情報」であり、医学的アドバイスではありません
- 診断、治療、予防を目的とするものではありません
- 利用者の最終判断を代替するものではありません

### 1.2 対象種目

| No | 種目名 | カテゴリ | 難易度 | 器具 |
|----|--------|---------|--------|------|
| 1 | スクワット | 下半身 | 初級 | 不要 |
| 2 | プッシュアップ | 胸 | 初級 | 不要 |
| 3 | アームカール | 腕 | 初級 | ダンベル |
| 4 | サイドレイズ | 肩 | 中級 | ダンベル |
| 5 | ショルダープレス | 肩 | 中級 | ダンベル |

### 1.3 パフォーマンス要件

- **目標FPS**: 30fps（推奨端末スペックで維持）
- **最低FPS**: 15fps（低スペック端末では自動調整）
- **骨格検出信頼度**: 0.7以上を推奨、0.5以上を最低ライン
- **処理遅延**: 1フレームあたり33ms以下を目標

---

## 2. MediaPipe Pose概要

### 2.1 検出関節点（33個）

MediaPipe Poseは以下の33個の関節点を検出します：

```
0: nose (鼻)
1-2: left/right eye inner (左右目の内側)
3-4: left/right eye (左右目)
5-6: left/right eye outer (左右目の外側)
7-8: left/right ear (左右耳)
9-10: left/right mouth (左右口角)
11-12: left/right shoulder (左右肩)
13-14: left/right elbow (左右肘)
15-16: left/right wrist (左右手首)
17-18: left/right pinky (左右小指)
19-20: left/right index (左右人差し指)
21-22: left/right thumb (左右親指)
23-24: left/right hip (左右腰)
25-26: left/right knee (左右膝)
27-28: left/right ankle (左右足首)
29-30: left/right heel (左右かかと)
31-32: left/right foot index (左右足先)
```

### 2.2 座標系

各関節点は以下の4つの値を持ちます：

| 値 | 範囲 | 説明 |
|---|-----|------|
| x | 0.0 - 1.0 | 正規化されたX座標（画面幅に対する相対位置） |
| y | 0.0 - 1.0 | 正規化されたY座標（画面高さに対する相対位置） |
| z | 任意 | 深度（相対値、腰の中心を0とする） |
| visibility | 0.0 - 1.0 | 関節点の信頼度スコア |

---

## 3. 共通定義

### 3.1 角度計算

3点を指定して角度を計算する共通関数：

```typescript
/**
 * 3点から角度を計算（度数法）
 * @param pointA 始点
 * @param pointB 頂点（角度を測定する点）
 * @param pointC 終点
 * @returns 角度（0-180度）
 */
function calculateAngle(
  pointA: { x: number; y: number },
  pointB: { x: number; y: number },
  pointC: { x: number; y: number }
): number {
  const radians =
    Math.atan2(pointC.y - pointB.y, pointC.x - pointB.x) -
    Math.atan2(pointA.y - pointB.y, pointA.x - pointB.x);

  let angle = Math.abs((radians * 180.0) / Math.PI);

  if (angle > 180.0) {
    angle = 360 - angle;
  }

  return angle;
}
```

### 3.2 距離計算

```typescript
/**
 * 2点間の距離を計算
 */
function calculateDistance(
  pointA: { x: number; y: number },
  pointB: { x: number; y: number }
): number {
  return Math.sqrt(
    Math.pow(pointB.x - pointA.x, 2) + Math.pow(pointB.y - pointA.y, 2)
  );
}
```

### 3.3 信頼度チェック

```typescript
/**
 * 関節点の信頼度をチェック
 */
function isLandmarkVisible(
  landmark: { visibility: number },
  threshold: number = 0.5
): boolean {
  return landmark.visibility >= threshold;
}
```

### 3.4 スコアリングアルゴリズム

全種目共通のスコアリング方式：

```typescript
/**
 * フレーム単位のスコア計算
 * @param checks 各チェック項目の結果（true = 正しい、false = 誤り）
 * @returns 0-100のスコア
 */
function calculateFrameScore(checks: boolean[]): number {
  const passedChecks = checks.filter((check) => check).length;
  const totalChecks = checks.length;

  return Math.round((passedChecks / totalChecks) * 100);
}

/**
 * セッション全体のスコア計算
 * @param frameScores 各フレームのスコア配列
 * @returns 0-100の総合スコア
 */
function calculateOverallScore(frameScores: number[]): number {
  const sum = frameScores.reduce((acc, score) => acc + score, 0);
  return Math.round(sum / frameScores.length);
}
```

---

## 4. 種目1: スクワット

### 4.1 概要

- **カテゴリ**: 下半身
- **難易度**: 初級
- **器具**: 不要
- **推奨カメラ位置**: 横（side）

### 4.2 重要関節点

| 関節 | ID | 説明 |
|-----|---|------|
| 左肩 | 11 | 上半身の基準 |
| 右肩 | 12 | 上半身の基準 |
| 左腰 | 23 | 体幹の屈曲を検出 |
| 右腰 | 24 | 体幹の屈曲を検出 |
| 左膝 | 25 | 膝の角度を測定 |
| 右膝 | 26 | 膝の角度を測定 |
| 左足首 | 27 | 足の位置を確認 |
| 右足首 | 28 | 足の位置を確認 |

### 4.3 フォーム評価基準

#### チェック1: 膝の角度（しゃがむ深さ）

**目標**: 膝の角度が90-110度

```typescript
function checkKneeAngle(
  shoulder: Landmark,
  hip: Landmark,
  knee: Landmark
): { passed: boolean; angle: number } {
  const angle = calculateAngle(shoulder, hip, knee);
  const passed = angle >= 90 && angle <= 110;

  return { passed, angle };
}
```

#### チェック2: 膝がつま先を越えていないか

**目標**: 膝のX座標がつま先のX座標を超えない

```typescript
function checkKneeOverToe(
  knee: Landmark,
  ankle: Landmark,
  footIndex: Landmark
): boolean {
  // カメラが横（side）の場合
  return knee.x <= footIndex.x + 0.05;  // 5%の許容誤差
}
```

#### チェック3: 背中が真っ直ぐか

**目標**: 肩-腰-膝の角度が150度以上（ほぼ直線）

```typescript
function checkBackStraight(
  shoulder: Landmark,
  hip: Landmark,
  knee: Landmark
): { passed: boolean; angle: number } {
  const angle = calculateAngle(shoulder, hip, knee);
  const passed = angle >= 150;

  return { passed, angle };
}
```

### 4.4 レップカウントロジック

```typescript
enum SquatPhase {
  STANDING = 'standing',
  DESCENDING = 'descending',
  BOTTOM = 'bottom',
  ASCENDING = 'ascending'
}

class SquatCounter {
  private phase: SquatPhase = SquatPhase.STANDING;
  private repCount: number = 0;

  processFrame(kneeAngle: number): number {
    switch (this.phase) {
      case SquatPhase.STANDING:
        if (kneeAngle < 140) {
          this.phase = SquatPhase.DESCENDING;
        }
        break;

      case SquatPhase.DESCENDING:
        if (kneeAngle <= 110) {
          this.phase = SquatPhase.BOTTOM;
        }
        break;

      case SquatPhase.BOTTOM:
        if (kneeAngle > 110) {
          this.phase = SquatPhase.ASCENDING;
        }
        break;

      case SquatPhase.ASCENDING:
        if (kneeAngle >= 160) {
          this.repCount++;
          this.phase = SquatPhase.STANDING;
        }
        break;
    }

    return this.repCount;
  }
}
```

---

## 5. 種目2: プッシュアップ

### 5.1 概要

- **カテゴリ**: 胸
- **難易度**: 初級
- **器具**: 不要
- **推奨カメラ位置**: 横（side）

### 5.2 重要関節点

| 関節 | ID | 説明 |
|-----|---|------|
| 肩 | 11/12 | 基準点 |
| 肘 | 13/14 | 肘の角度を測定 |
| 手首 | 15/16 | 手の位置を確認 |
| 腰 | 23/24 | 体のラインを確認 |
| 足首 | 27/28 | 体のラインを確認 |

### 5.3 フォーム評価基準

#### チェック1: 肘の角度

**目標**: 最下点で肘の角度が80-100度

```typescript
function checkElbowAngle(
  shoulder: Landmark,
  elbow: Landmark,
  wrist: Landmark
): { passed: boolean; angle: number } {
  const angle = calculateAngle(shoulder, elbow, wrist);
  const passed = angle >= 80 && angle <= 100;

  return { passed, angle };
}
```

#### チェック2: 体のライン

**目標**: 肩-腰-足首が一直線（角度が170度以上）

```typescript
function checkBodyLine(
  shoulder: Landmark,
  hip: Landmark,
  ankle: Landmark
): { passed: boolean; angle: number } {
  const angle = calculateAngle(shoulder, hip, ankle);
  const passed = angle >= 170;

  return { passed, angle };
}
```

---

## 6. 種目3: アームカール

### 6.1 概要

- **カテゴリ**: 腕
- **難易度**: 初級
- **器具**: ダンベル
- **推奨カメラ位置**: 前（front）

### 6.2 フォーム評価基準

#### チェック1: 肘の角度

**目標**: 最高点で肘の角度が30-50度

```typescript
function checkElbowAngle(
  shoulder: Landmark,
  elbow: Landmark,
  wrist: Landmark
): { passed: boolean; angle: number } {
  const angle = calculateAngle(shoulder, elbow, wrist);
  const passed = angle >= 30 && angle <= 50;

  return { passed, angle };
}
```

#### チェック2: 肘の位置固定

**目標**: 肘のY座標がほぼ一定（肩と腰の中間）

```typescript
function checkElbowFixed(
  elbow: Landmark,
  shoulder: Landmark,
  hip: Landmark
): boolean {
  const midpoint = (shoulder.y + hip.y) / 2;
  const tolerance = 0.05;  // 5%の許容誤差

  return Math.abs(elbow.y - midpoint) <= tolerance;
}
```

---

## 7. 種目4: サイドレイズ

### 7.1 概要

- **カテゴリ**: 肩
- **難易度**: 中級
- **器具**: ダンベル
- **推奨カメラ位置**: 前（front）

### 7.2 フォーム評価基準

#### チェック1: 腕の挙上角度

**目標**: 最高点で肩-肘が水平（肘のY座標が肩のY座標とほぼ同じ）

```typescript
function checkArmElevation(
  shoulder: Landmark,
  elbow: Landmark
): { passed: boolean; diff: number } {
  const diff = Math.abs(shoulder.y - elbow.y);
  const passed = diff <= 0.05;  // 5%の許容誤差

  return { passed, diff };
}
```

#### チェック2: 左右対称性

**目標**: 左右の肘の高さがほぼ同じ

```typescript
function checkSymmetry(
  leftElbow: Landmark,
  rightElbow: Landmark
): { passed: boolean; diff: number } {
  const diff = Math.abs(leftElbow.y - rightElbow.y);
  const passed = diff <= 0.1;  // 10%の許容誤差

  return { passed, diff };
}
```

---

## 8. 種目5: ショルダープレス

### 8.1 概要

- **カテゴリ**: 肩
- **難易度**: 中級
- **器具**: ダンベル
- **推奨カメラ位置**: 前（front）

### 8.2 フォーム評価基準

#### チェック1: 肘の角度

**目標**: 最高点で肘の角度が160-180度（ほぼ真っ直ぐ）

```typescript
function checkElbowAngle(
  shoulder: Landmark,
  elbow: Landmark,
  wrist: Landmark
): { passed: boolean; angle: number } {
  const angle = calculateAngle(shoulder, elbow, wrist);
  const passed = angle >= 160 && angle <= 180;

  return { passed, angle };
}
```

#### チェック2: 手首の高さ

**目標**: 最高点で手首のY座標が頭（nose）より上

```typescript
function checkWristHeight(
  nose: Landmark,
  wrist: Landmark
): boolean {
  return wrist.y < nose.y;
}
```

---

## 変更履歴

| バージョン | 日付 | 主な変更内容 |
|-----------|------|-------------|
| **v1.0** | 2025年12月9日 | 初版作成。Expo版の5種目（スクワット、プッシュアップ、アームカール、サイドレイズ、ショルダープレス）に対応。 |

---

**このドキュメントは、Expo版とFlutter版の両方で共通利用可能です。**

**注意**: Flutter版は異なる5種目（スクワット、プッシュアップ、プランク、ランジ、ブリッジ）を実装していますが、本ドキュメントはExpo版の仕様を基準としています。

**作成者**: Claude (Documentation Engineer)
**最終確認日**: 2025年12月9日
