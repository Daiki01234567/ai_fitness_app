# セキュリティポリシー v1.0

**バージョン**: 1.0
**最終更新日**: 2025年12月9日
**対象**: AIフィットネスアプリ（共通仕様）
**基準**: Expo版要件定義書 v1.0

---

## 目次

1. [概要](#1-概要)
2. [セキュリティ原則](#2-セキュリティ原則)
3. [認証とアクセス制御](#3-認証とアクセス制御)
4. [データ暗号化](#4-データ暗号化)
5. [ネットワークセキュリティ](#5-ネットワークセキュリティ)
6. [脆弱性管理](#6-脆弱性管理)
7. [インシデント対応](#7-インシデント対応)
8. [監視とログ](#8-監視とログ)

---

## 1. 概要

### 1.1 目的

本ドキュメントは、AIフィットネスアプリのセキュリティポリシーを定義します。

### 1.2 適用範囲

- モバイルアプリケーション（Expo/React Native、Flutter/Dart）
- バックエンドサービス（Firebase Functions）
- データベース（Cloud Firestore）
- データウェアハウス（BigQuery）

### 1.3 遵守すべき規格・基準

- GDPR（EU一般データ保護規則）
- 個人情報保護法（日本）
- OWASP Mobile Top 10
- OWASP API Security Top 10

---

## 2. セキュリティ原則

### 2.1 ゼロトラストアーキテクチャ

**基本方針**: 全てのアクセスを認証・認可する

**実装**:
- Firebase Authenticationによる認証
- Firestoreセキュリティルールによる認可
- APIレベルでの認証チェック

### 2.2 最小権限の原則

**基本方針**: 必要最小限の権限のみ付与

**実装**:
- ユーザーは自身のデータのみアクセス可能
- Cloud Functionsはサービスアカウント経由で最小権限を付与
- 管理者権限は限定的に使用

### 2.3 多層防御

**基本方針**: 複数のセキュリティ層で保護

**実装層**:
1. クライアント側：入力バリデーション
2. ネットワーク層：TLS 1.3暗号化
3. 認証層：Firebase Authentication
4. 認可層：Firestoreセキュリティルール
5. アプリケーション層：Cloud Functions
6. データ層：暗号化保存

---

## 3. 認証とアクセス制御

### 3.1 認証方式

**サポートする認証方式**:
- メールアドレス/パスワード
- Google認証（OAuth 2.0）
- Apple認証（Sign in with Apple）

**パスワードポリシー**:
- 最低8文字、最大128文字
- 英字と数字を混在
- 記号は任意
- bcryptでハッシュ化

### 3.2 セッション管理

**実装**:
- Firebase Authenticationトークンベース認証
- トークン有効期限：1時間
- リフレッシュトークン有効期限：30日
- 同意撤回時の強制ログアウト

### 3.3 アクセス制御

**Firestoreセキュリティルール**:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証済みユーザーのみ
    function isAuthenticated() {
      return request.auth != null;
    }

    // 本人確認
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 削除予定ユーザーチェック
    function isNotScheduledForDeletion() {
      return !resource.data.deletionScheduled;
    }

    // Usersコレクション
    match /users/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated()
                   && isOwner(userId)
                   && isNotScheduledForDeletion();
    }
  }
}
```

---

## 4. データ暗号化

### 4.1 通信暗号化

**プロトコル**: TLS 1.3

**実装**:
- すべてのHTTPS通信でTLS 1.3を使用
- 証明書ピンニング（Phase 2実装予定）
- HTTP Strict Transport Security（HSTS）

### 4.2 保存時暗号化

**データベース暗号化**:
- Firestore：Google管理鍵による暗号化
- BigQuery：Google管理鍵による暗号化
- Firebase Storage：Google管理鍵による暗号化

**パスワード暗号化**:
- bcryptアルゴリズム
- ソルト長：10ラウンド
- 平文パスワードは保存しない

### 4.3 仮名化処理

**実装**:
- ユーザーIDをSHA-256ハッシュ化
- メールアドレスを削除
- カメラ映像は送信しない

```typescript
import crypto from 'crypto';

function pseudonymizeUserId(userId: string): string {
  const salt = process.env.PSEUDONYMIZATION_SALT;
  return crypto
    .createHash('sha256')
    .update(userId + salt)
    .digest('hex');
}
```

---

## 5. ネットワークセキュリティ

### 5.1 ファイアウォール

**Cloud Firestore**:
- デフォルトで全拒否
- セキュリティルールで明示的に許可

**Cloud Functions**:
- HTTPS経由のみアクセス可能
- 認証必須

### 5.2 レート制限

**実装**:
- Firebase App Check
- カスタムレート制限ロジック

**制限値**:
- 認証API：10回/時/IP
- ユーザーAPI：50回/時/ユーザー
- トレーニングAPI：100回/日/ユーザー

### 5.3 DDoS対策

**実装**:
- Cloud Loadバランシングの自動スケーリング
- Firebase App Checkによる不正アクセス防止
- Cloud Armorによる防御（Phase 2実装予定）

---

## 6. 脆弱性管理

### 6.1 脆弱性スキャン

**実装**:
- Dependabotによる依存関係の自動更新
- npm auditによる脆弱性チェック
- Snykによるセキュリティスキャン

### 6.2 セキュリティアップデート

**ポリシー**:
- Critical脆弱性：24時間以内に対応
- High脆弱性：7日以内に対応
- Medium脆弱性：30日以内に対応
- Low脆弱性：次回リリース時に対応

### 6.3 ペネトレーションテスト

**実施タイミング**:
- MVP正式リリース前
- 年1回の定期実施
- 重要な機能追加時

---

## 7. インシデント対応

### 7.1 データ侵害対応（GDPR第33条・34条）

**対応手順**:

#### ステップ1: 検知と評価（24時間以内）

1. インシデント検知
2. 影響範囲の評価
3. データ侵害の分類（高/中/低リスク）

#### ステップ2: 封じ込めと調査（48時間以内）

1. 侵害の封じ込め
2. 根本原因の調査
3. 影響を受けたデータ主体の特定

#### ステップ3: 通知（72時間以内）

**監督機関への通知**（GDPR第33条）:
- データ侵害を認識してから72時間以内
- 個人情報保護委員会（日本）
- 各EU加盟国のデータ保護機関

**利用者への通知**（GDPR第34条）:
- 高リスクの場合のみ
- メール、アプリ内通知、Webサイト告知

#### ステップ4: 復旧と改善（2週間以内）

1. システムの復旧
2. セキュリティ対策の強化
3. 再発防止策の実施

### 7.2 インシデント分類

| リスク | 例 | 対応 |
|-------|---|------|
| **高リスク** | 氏名・メールアドレス・決済情報の流出 | 利用者への通知必須 |
| **中リスク** | 仮名化データの流出 | 監督機関への通知のみ |
| **低リスク** | 暗号化されたデータの流出（暗号鍵は流出していない） | 内部記録のみ |

---

## 8. 監視とログ

### 8.1 ログ記録

**実装**:
- Cloud Loggingによるすべてのイベント記録
- 認証イベント、API呼び出し、エラーを記録
- ログ保存期間：30日

**ログレベル**:
- **INFO**: 通常のAPI呼び出し
- **WARNING**: リトライ可能なエラー
- **ERROR**: リトライ不可能なエラー
- **CRITICAL**: システム障害

### 8.2 監視とアラート

**Cloud Monitoring**:
- エラーレート
- レスポンスタイム
- アクセス数
- リソース使用率

**アラート設定**:
- エラーレート > 5%：即座に通知
- レスポンスタイム > 1秒：警告
- 不正アクセスの疑い：即座に通知

### 8.3 セキュリティ監査

**実施頻度**:
- 週次：自動脆弱性スキャン
- 月次：ログレビュー
- 四半期：セキュリティレビュー
- 年次：外部監査

---

## 変更履歴

| バージョン | 日付 | 主な変更内容 |
|-----------|------|-------------|
| **v1.0** | 2025年12月9日 | 初版作成。Flutter版を基に、Expo版とFlutter版の両方に対応。 |

---

**このドキュメントは、Expo版とFlutter版の両方で共通利用可能です。**

**作成者**: Claude (Documentation Engineer)
**最終確認日**: 2025年12月9日
