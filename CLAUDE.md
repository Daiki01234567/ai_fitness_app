# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## âš ï¸ é‡è¦ãªåˆ¶ç´„äº‹é …

### å¿…ãšå®ˆã‚‹ã¹ãé–‹ç™ºãƒ«ãƒ¼ãƒ«

1. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå„ªå…ˆã®åŸå‰‡**
   - ã‚³ãƒ¼ãƒ‰å®Ÿè£…ãƒ»è¨­è¨ˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ã‚¿ã‚¹ã‚¯åˆ†è§£ãªã©ã‚’è¡Œã†éš›ã¯ã€**å¿…ãš `docs/specs` é…ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æœ€å„ªå…ˆã§å‚ç…§ã—ã¦ãã ã•ã„**
   - æ¨æ¸¬ã§ã¯ãªãã€**è¦ä»¶å®šç¾©æ›¸ãƒ»å„ç¨®è¨­è¨ˆæ›¸ãƒ»ãƒãƒªã‚·ãƒ¼é¡ã‚’æ ¹æ‹ ã«åˆ¤æ–­ã—ã¦ãã ã•ã„**

2. **æ¨æ¸¬ã‚’è¡Œã†å ´åˆã®æ˜ç¤º**
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ãªã„ã“ã¨ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã¯ã€**ã€Œæ¨æ¸¬ã§ã‚ã‚‹ã€ã€Œæš«å®šæ¡ˆã§ã‚ã‚‹ã€ã“ã¨ã‚’æ˜ç¤º**ã—ã¦ãã ã•ã„
   - å¿…ãš**é¸æŠè‚¢ã¨ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æç¤º**ã—ã¦ãã ã•ã„

3. **ä»•æ§˜æ›¸ã®å‚ç…§é †åº**
   1. ã¾ãšè¦ä»¶å®šç¾©æ›¸ã§æ©Ÿèƒ½è¦ä»¶ã‚’ç¢ºèª
   2. è©²å½“ã™ã‚‹è¨­è¨ˆæ›¸ã§è©³ç´°è¨­è¨ˆã‚’ç¢ºèª
   3. å®Ÿè£…ã«å…¥ã‚‹å‰ã«é–¢é€£ã™ã‚‹å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª

## ğŸ“ ä»•æ§˜æ›¸ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§

| ã‚«ãƒ†ã‚´ãƒª | ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|---------|---------|------|
| è¦ä»¶ | `docs/specs/00_è¦ä»¶å®šç¾©æ›¸_v3_3.md` | 38æ©Ÿèƒ½è¦ä»¶ + 37éæ©Ÿèƒ½è¦ä»¶ |
| è¦ä»¶ | `docs/specs/09_é–‹ç™ºã‚¿ã‚¹ã‚¯è©³ç´°_ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«_v3_3.md` | Phase 1-2ã‚¿ã‚¹ã‚¯ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« |
| ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | `docs/specs/01_ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸_v3_2.md` | ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“è¨­è¨ˆ |
| ãƒ‡ãƒ¼ã‚¿ | `docs/specs/02_Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸_v3_3.md` | ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ« |
| API | `docs/specs/03_APIè¨­è¨ˆæ›¸_Firebase_Functions_v3_3.md` | Cloud Functions APIä»•æ§˜ |
| åˆ†æ | `docs/specs/04_BigQueryè¨­è¨ˆæ›¸_v3_3.md` | åˆ†æåŸºç›¤è¨­è¨ˆ |
| UI | `docs/specs/05_ç”»é¢é·ç§»å›³_ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ _v3_3.md` | 15ç”»é¢ã®é·ç§»ã¨UIè¨­è¨ˆ |
| ãƒ­ã‚¸ãƒƒã‚¯ | `docs/specs/08_README_form_validation_logic_v3_3.md` | 5ç¨®ç›®ã®ãƒ•ã‚©ãƒ¼ãƒ è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ |
| æ³•ä»¤ | `docs/specs/06_ãƒ‡ãƒ¼ã‚¿å‡¦ç†è¨˜éŒ²_ROPA_v1_0.md` | GDPRæº–æ‹ ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†è¨˜éŒ² |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | `docs/specs/07_ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼_v1_0.md` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ |
| æ³•å‹™ | `docs/specs/åˆ©ç”¨è¦ç´„_v3_2.md`, `docs/specs/ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼_v3.1.md` | åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ |

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

AIã‚’æ´»ç”¨ã—ãŸãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã‚¢ãƒ—ãƒªï¼ˆMediaPipeã«ã‚ˆã‚‹ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å§¿å‹¢æ¤œå‡ºï¼‰ã€‚æ—¥æœ¬å¸‚å ´å‘ã‘ã§GDPRæº–æ‹ ã€è–¬æ©Ÿæ³•ä¸Šã®åŒ»ç™‚æ©Ÿå™¨ã«ã¯è©²å½“ã—ãªã„ã€‚

- **Firebase Project ID**: `ai-fitness-c38f0`
- **é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º**: MVP Phase 1-2 (0-7ãƒ¶æœˆ)
- **æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: Flutter (Dart 3.10+) + Firebase Functions (TypeScript/Node 24) + Firestore + BigQuery

## é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

### Flutter (flutter_app/)
```bash
flutter pub get                    # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
flutter analyze                    # é™çš„è§£æ
flutter run                        # ãƒ‡ãƒã‚¤ã‚¹å®Ÿè¡Œ
flutter test                       # å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
flutter test test/screens/auth/    # ç‰¹å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ†ã‚¹ãƒˆ
dart run build_runner build        # Freezed/Riverpodã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
```

### Firebase Functions (functions/)
```bash
npm install                 # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm run lint                # ESLint (Google style, double quotes)
npm run lint:fix            # ESLintè‡ªå‹•ä¿®æ­£
npm run format              # Prettier ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
npm run build               # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
npm run build:watch         # ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
npm test                    # Jestãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:watch          # ãƒ†ã‚¹ãƒˆã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
npm run test:coverage       # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
npm run serve               # ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

### Firebaseæ“ä½œ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ)
```bash
firebase emulators:start                   # ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿èµ·å‹• (UI: localhost:4000)
firebase deploy                            # å…¨ä½“ãƒ‡ãƒ—ãƒ­ã‚¤
firebase deploy --only functions           # Functions ã®ã¿
firebase deploy --only firestore:rules     # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ã¿
```

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```
flutter_app/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart                 # ã‚¢ãƒ—ãƒªã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€FirebaseåˆæœŸåŒ–
â”‚   â”œâ”€â”€ firebase_options.dart     # Firebaseè¨­å®šï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ auth/                 # èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã€çŠ¶æ…‹ç®¡ç†ï¼ˆRiverpodï¼‰
â”‚   â”‚   â”œâ”€â”€ router/               # GoRouterãƒ™ãƒ¼ã‚¹ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ theme/                # Material 3ãƒ†ãƒ¼ãƒ
â”‚   â”‚   â”œâ”€â”€ utils/                # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ widgets/              # å…±é€šã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
â”‚   â””â”€â”€ screens/                  # ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆauth/, home/, splash/ï¼‰
â””â”€â”€ test/                         # ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

functions/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                  # é–¢æ•°ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
â”‚   â”œâ”€â”€ auth/                     # Auth triggersï¼ˆonCreate, onDelete, customClaimsï¼‰
â”‚   â”œâ”€â”€ api/                      # HTTP callableé–¢æ•°ï¼ˆusers/ï¼‰
â”‚   â”œâ”€â”€ middleware/               # èªè¨¼ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â”‚   â”œâ”€â”€ services/                 # BigQueryã€CloudTasksã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ types/                    # TypeScriptå‹å®šç¾©
â”‚   â””â”€â”€ utils/                    # ãƒ­ã‚¬ãƒ¼ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†
â””â”€â”€ tests/                        # Jestãƒ†ã‚¹ãƒˆã€ãƒ¢ãƒƒã‚¯

firebase/
â”œâ”€â”€ firestore.rules               # Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
â”œâ”€â”€ firestore.indexes.json        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©
â””â”€â”€ storage.rules                 # Storageã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

docs/
â”œâ”€â”€ specs/                        # ä»•æ§˜æ›¸ï¼ˆå‚ç…§å¿…é ˆï¼‰
â””â”€â”€ tickets/                      # é–‹ç™ºãƒã‚±ãƒƒãƒˆï¼ˆ001-020ï¼‰
```

### çŠ¶æ…‹ç®¡ç†ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

- **Riverpod**: `authStateProvider` ã§èªè¨¼çŠ¶æ…‹ç®¡ç†ã€`ProviderScope` ã§DI
- **GoRouter**: `appRouterProvider` ã§èªè¨¼çŠ¶æ…‹ã«å¿œã˜ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¶å¾¡
- **Freezed**: ä¸å¤‰çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ç”Ÿæˆï¼ˆ`*.freezed.dart`ï¼‰

### Firebase Functions ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š

```typescript
setGlobalOptions({
  region: "asia-northeast1",  // æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  maxInstances: 10,           // ã‚³ã‚¹ãƒˆåˆ¶å¾¡
  memory: "256MiB",
  timeoutSeconds: 60,
});
```

### ä»•æ§˜æ›¸ã®å‚ç…§é †åº

1. `00_è¦ä»¶å®šç¾©æ›¸_v3_3.md` â†’ æ©Ÿèƒ½è¦ä»¶ï¼ˆFR-xxxï¼‰
2. `01_ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸_v3_2.md` â†’ å®Ÿè£…æ–¹æ³•
3. `02_Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸_v3_3.md` â†’ ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
4. `03_APIè¨­è¨ˆæ›¸_Firebase_Functions_v3_3.md` â†’ APIä»•æ§˜
5. `05_ç”»é¢é·ç§»å›³_ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ _v3_3.md` â†’ 15ç”»é¢ï¼ˆ4ã‚¿ãƒ–ï¼‰

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª (Flutter)
    â†“ MediaPipe ã§ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å„ªå…ˆï¼‰
    â†“ ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ‡ãƒ¼ã‚¿ã®ã¿é€ä¿¡ï¼ˆ33é–¢ç¯€Ã—4å€¤ï¼‰
Cloud Function (HTTPS ãƒˆãƒªã‚¬ãƒ¼)
    â†“ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œ Firestore ä¿å­˜
    â†“ Cloud Task ã§éåŒæœŸå‡¦ç†
BigQueryï¼ˆåŒ¿ååŒ–ã•ã‚ŒãŸåˆ†æãƒ‡ãƒ¼ã‚¿ï¼‰
    â†“ 2å¹´ä¿å­˜ï¼ˆGDPRæº–æ‹ ï¼‰
```

### é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³

**ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å„ªå…ˆå‡¦ç†**:
- ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰å‡ºãªã„
- MediaPipe ã¯ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å®Ÿè¡Œï¼ˆç›®æ¨™30fpsã€æœ€ä½15fpsï¼‰
- éª¨æ ¼é–¢ç¯€ãƒ‡ãƒ¼ã‚¿ã®ã¿é€ä¿¡

**GDPRæº–æ‹ **:
- å‰Šé™¤30æ—¥é–“çŒ¶äºˆæœŸé–“ï¼ˆ`deletionScheduled` ãƒ•ãƒ©ã‚°ï¼‰
- Firestore ãƒ«ãƒ¼ãƒ«ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- åŒæ„è¿½è·¡ã¯åˆ¥ã®ä¸å¤‰ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- `tosAccepted`ã€`ppAccepted` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿å–ã‚Šå°‚ç”¨

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤**:
1. TLS 1.3 ã«ã‚ˆã‚‹é€šä¿¡æš—å·åŒ–
2. Firebase Auth ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ 
3. Firestore ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
4. ä¿å­˜æ™‚æš—å·åŒ–ï¼ˆGoogleç®¡ç†ï¼‰

**ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
- Firestore ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
- Cloud Tasks ã«ã‚ˆã‚‹ãƒªãƒˆãƒ©ã‚¤ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
- Dead Letter Queue ã«ã‚ˆã‚‹å¤±æ•—å‡¦ç†
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–¢æ•°ã«ã‚ˆã‚‹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### Firestoreä¸»è¦ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

`02_Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸_v3_3.md` ã‚ˆã‚Šï¼š

- **Users**: ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€åŒæ„ãƒ•ãƒ©ã‚°ã€`deletionScheduled` çŠ¶æ…‹
- **Sessions**: `poseData` ã¨ `sessionMetadata` ã‚’å«ã‚€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿
- **Consents**: åŒæ„å¤‰æ›´ã®ä¸å¤‰ç›£æŸ»ãƒ­ã‚°
- **DataDeletionRequests**: 30æ—¥çŒ¶äºˆæœŸé–“ç®¡ç†
- **BigQuerySyncFailures**: åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®DLQ

### ãƒ•ã‚©ãƒ¼ãƒ è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯

`08_README_form_validation_logic_v3_3.md` ã«ã‚ˆã‚‹ MediaPipe Pose æ¤œå‡ºã‚’ä½¿ç”¨ã—ãŸ5ç¨®ç›®ï¼š

1. **ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ**: è†è§’åº¦ 90-110Â°ã€è†ãŒã¤ã¾å…ˆã‚’è¶Šãˆãªã„ã‹ãƒã‚§ãƒƒã‚¯
2. **ã‚¢ãƒ¼ãƒ ã‚«ãƒ¼ãƒ«**: è‚˜è§’åº¦ 30-160Â°ã€åå‹•æ¤œå‡º
3. **ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º**: è…•ã®æŒ™ä¸Šè§’åº¦ 70-90Â°ã€å·¦å³å¯¾ç§°æ€§ãƒã‚§ãƒƒã‚¯
4. **ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹**: è‚˜ã®è»Œé“ã€è…°ã®åã‚Šãƒã‚§ãƒƒã‚¯
5. **ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—**: ä½“ã®ãƒ©ã‚¤ãƒ³ç¶­æŒã€è‚˜è§’åº¦ 90Â°

å„ç¨®ç›®ã¯çŠ¶æ…‹ãƒã‚·ãƒ³ã«ã‚ˆã‚‹ãƒ¬ãƒƒãƒ—ã‚«ã‚¦ãƒ³ãƒˆã¨0-100ç‚¹ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã€‚

## ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³

**å®Œäº†æ¸ˆã¿**:
- åŒ…æ‹¬çš„ãªä»•æ§˜æ›¸ï¼ˆv3.3ï¼‰
- Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿è¨­å®š
- Cloud Functions åŸºç›¤ï¼ˆauth triggers, API scaffolding, middleware, servicesï¼‰
- Flutter èªè¨¼ç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã€ç™»éŒ²ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼‰ã€ãƒ›ãƒ¼ãƒ ç”»é¢
- Riverpod çŠ¶æ…‹ç®¡ç†ã€GoRouter ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- ãƒ†ã‚¹ãƒˆåŸºç›¤ï¼ˆJest for Functions, Flutter testï¼‰

**é€²è¡Œä¸­**:
- Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ï¼ˆç¾åœ¨ã¯é–‹ç™ºç”¨ã®å…¨è¨±å¯ãƒ«ãƒ¼ãƒ«ï¼‰
- è¿½åŠ  API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…

**æœªç€æ‰‹**:
- MediaPipe çµ±åˆã€ãƒ•ã‚©ãƒ¼ãƒ è©•ä¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- BigQuery ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- æ±ºæ¸ˆæ©Ÿèƒ½ï¼ˆRevenueCatï¼‰

## ã‚¿ã‚¹ã‚¯ç®¡ç†ã¨ãƒã‚±ãƒƒãƒˆé‹ç”¨

é–‹ç™ºã‚¿ã‚¹ã‚¯ã¯ `/docs/tickets/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç•ªå·ä»˜ããƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ001-020ï¼‰ã¨ã—ã¦ç®¡ç†ã€‚

**é€²æ—ç®¡ç†**: Todoã‚¢ã‚¤ãƒ†ãƒ ã¯ `[ ]` â†’ `[x]` ã§å®Œäº†ãƒãƒ¼ã‚¯ã€‚ä½œæ¥­å®Œäº†å¾Œã¯å³åº§ã«æ›´æ–°ã€‚

## é–‹ç™ºä¸Šã®åˆ¶ç´„

### æ³•çš„è¦ä»¶

**è–¬æ©Ÿæ³•**:
- åŒ»ç™‚æ©Ÿå™¨ã§ã¯ãªã„
- ã€Œæ²»ç™‚ã€ã€Œè¨ºæ–­ã€ã€Œæ²»ã™ã€ã¨ã„ã£ãŸç”¨èªã¯ä½¿ç”¨ç¦æ­¢
- ä½¿ç”¨å¯èƒ½ï¼šã€Œãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ã€ã€Œé‹å‹•ã€ã€Œãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ã€Œå¥åº·ç¶­æŒã€

**GDPR**:
- 72æ™‚é–“ä»¥å†…ã®é•åé€šçŸ¥
- ãƒ‡ãƒ¼ã‚¿æœ€å°åŒ–åŸå‰‡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©åˆ©ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã€å‰Šé™¤ã€ãƒãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ï¼‰
- è©³ç´°ã¯ `docs/specs/06_ãƒ‡ãƒ¼ã‚¿å‡¦ç†è¨˜éŒ²_ROPA_v1_0.md` å‚ç…§

**åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼**:
- `docs/specs/åˆ©ç”¨è¦ç´„_v3_2.md` ã§å…¨æ–‡ç¢ºèª
- `docs/specs/ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼_v3.1.md` ã§å…¨æ–‡ç¢ºèª

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

**MediaPipe**:
- å¯¾è±¡ãƒ‡ãƒã‚¤ã‚¹ã§æœ€ä½30fpsï¼ˆNFR-024ã€NFR-025ï¼‰
- ä½ã‚¹ãƒšãƒƒã‚¯ãƒ‡ãƒã‚¤ã‚¹ã§ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…

**Cloud Functions**:
- æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ï¼š10ï¼ˆã‚³ã‚¹ãƒˆåˆ¶å¾¡ï¼‰
- ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–ï¼ˆNFR-037ï¼‰

**BigQuery**:
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¤ãƒ³ã‚µãƒ¼ãƒˆä½¿ç”¨ï¼ˆãƒãƒƒãƒå‡¦ç†ã§ã¯ãªã„ï¼‰
- ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“ï¼š2å¹´ï¼ˆGDPRæº–æ‹ ï¼‰

### ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«

**TypeScript**:
- ESLint Google ã‚¹ã‚¿ã‚¤ãƒ«
- ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆä½¿ç”¨
- strict ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹

**Flutter**:
- flutter_lints ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ«ãƒ¼ãƒ«é©ç”¨

**è¨€èª**:
- ã‚³ãƒ¼ãƒ‰å†…ã‚³ãƒ¡ãƒ³ãƒˆï¼šè‹±èªï¼ˆä¿å®ˆæ€§ã®ãŸã‚ï¼‰
- UI ãƒ†ã‚­ã‚¹ãƒˆï¼šæ—¥æœ¬èªï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¸‚å ´ï¼‰
- **æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹ã‚‚ã®ï¼ˆåŸå‰‡ï¼‰**:
  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆREADMEã€è¨­è¨ˆæ›¸ã€ãƒã‚±ãƒƒãƒˆç­‰ï¼‰
  - Docstring / JSDoc / DartDoc
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ãƒ»ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰
  - ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ»ã‚¬ã‚¤ãƒ‰
  - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - PRã®èª¬æ˜æ–‡
- **è‹±èªã§è¨˜è¿°ã™ã‚‹ã‚‚ã®**:
  - ã‚³ãƒ¼ãƒ‰å†…ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
  - å¤‰æ•°åãƒ»é–¢æ•°åãƒ»ã‚¯ãƒ©ã‚¹å
  - å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

## ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### TypeScript (Firebase Functions)

- **å‹å®‰å…¨æ€§**: `any` ã‚’é¿ã‘ `unknown` + å‹ã‚¬ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã€å¼•æ•°ã¨æˆ»ã‚Šå€¤ã«å‹ã‚’æ˜ç¤º
- **éåŒæœŸå‡¦ç†**: `async/await` + `try/catch`ã€ä¸¦åˆ—å‡¦ç†ã¯ `Promise.all()`
- **é–¢æ•°è¨­è¨ˆ**: å˜ä¸€è²¬ä»»ã€ç´”ç²‹é–¢æ•°å„ªå…ˆã€å†ªç­‰æ€§ã‚’ä¿ã¤
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: `functions.https.HttpsError` ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™ã€ãƒ­ã‚°ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚ã‚‹ï¼ˆã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–æƒ…å ±ã¯é™¤å¤–ï¼‰
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Firestoreèª­ã¿å–ã‚Šæœ€å°åŒ–ã€ãƒãƒƒãƒã¯500ä»¶ä»¥ä¸‹ã€ä¸è¦ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆå‰Šæ¸›ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–ï¼‰

### Dart/Flutter

- **Null Safety**: `?.`, `??` ã‚’æ´»ç”¨ã€`late` ã¯åˆæœŸåŒ–ä¿è¨¼æ™‚ã®ã¿
- **Widgetè¨­è¨ˆ**: StatelessWidgetå„ªå…ˆã€`const` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ä½¿ç”¨ã€å°ã•ãåˆ†å‰²
- **çŠ¶æ…‹ç®¡ç† (Riverpod)**: Provideræ©Ÿèƒ½åˆ†å‰²ã€Notifierå†…ã§çŠ¶æ…‹å¤‰æ›´å®Œçµã€UI/ãƒ­ã‚¸ãƒƒã‚¯åˆ†é›¢
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: `ListView.builder`ã§é…å»¶èª­ã¿è¾¼ã¿ã€MediaPipeã¯30fpsç¶­æŒï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—è€ƒæ…®ï¼‰

### Firebase Functions ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
export const updateUserProfile = functions.https.onCall(async (data, context) => {
  if (!context.auth) throw new functions.https.HttpsError("unauthenticated", "èªè¨¼ãŒå¿…è¦ã§ã™");
  if (context.auth.uid !== data.userId) throw new functions.https.HttpsError("permission-denied", "æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
  // ... validation and processing
});
```

### ãƒ­ã‚°å‡ºåŠ›

```typescript
logger.info("Session created", { userId, sessionId, exerciseType, duration: performance.now() - startTime });
```

### Firebase Security Rules

å‚è€ƒ: https://firebase.google.com/docs/rules

**åŸºæœ¬åŸå‰‡**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…¨æ‹’å¦ï¼ˆæ˜ç¤ºçš„ã«è¨±å¯ã—ãŸã‚‚ã®ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆ`tosAccepted`, `ppAccepted`, `deletionScheduled` ã¯èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
- `request.auth.uid` ã§æœ¬äººç¢ºèªã‚’å¾¹åº•

**é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³**:

```javascript
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function isOwner(userId) { return request.auth != null && request.auth.uid == userId; }

// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ã®æ¤œè¨¼
allow update: if isOwner(userId)
  && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['tosAccepted', 'ppAccepted', 'deletionScheduled']);

// å‰Šé™¤äºˆå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›¸ãè¾¼ã¿ç¦æ­¢
allow write: if isOwner(userId) && !resource.data.deletionScheduled;

// ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ 
function isAdmin() { return request.auth.token.admin == true; }
```

**ãƒ†ã‚¹ãƒˆ**: `firebase emulators:start --only firestore` + `@firebase/rules-unit-testing`

### Cloud IAM (Identity and Access Management)

å‚è€ƒ: https://docs.cloud.google.com/iam/docs/overview

**åŸºæœ¬åŸå‰‡**: æœ€å°æ¨©é™ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«å½¹å‰²åˆ†é›¢ã€å®šæœŸçš„ãªæ¨©é™ç›£æŸ»

**ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ§‹æˆ**:
| ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | æ¨©é™ |
|-------------------|------|
| Cloud Functions SA | Firestoreèª­ã¿æ›¸ã, BigQueryç·¨é›†, Cloud Tasks, Logging |
| BigQueryå‡¦ç† SA | BigQueryã‚¸ãƒ§ãƒ–, ãƒ‡ãƒ¼ã‚¿é–²è¦§ï¼ˆç‰¹å®šãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼‰ |
| ãƒ‡ãƒ—ãƒ­ã‚¤ SA (CI/CD) | Functions/Firestoreãƒ«ãƒ¼ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¤ãƒ¼ |

**ç’°å¢ƒåˆ†é›¢**: `firebase use dev` / `firebase use production` ã§åˆ‡ã‚Šæ›¿ãˆ

## ãƒ•ã‚§ãƒ¼ã‚ºè¨ˆç”»

`09_é–‹ç™ºã‚¿ã‚¹ã‚¯è©³ç´°_ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«_v3_3.md` ã‚ˆã‚Šï¼š

### Phase 1 (0-2ãƒ¶æœˆ): ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
- Firebase ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€èªè¨¼
- åŸºæœ¬çš„ãª Firestore ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å®Ÿè£…

### Phase 2 (2-7ãƒ¶æœˆ): æ©Ÿèƒ½å®Ÿè£…
- 5ç¨®ç›®ã®ãƒ•ã‚©ãƒ¼ãƒ è©•ä¾¡
- MediaPipe çµ±åˆ
- æ±ºæ¸ˆæ©Ÿèƒ½ï¼ˆRevenueCatï¼‰
- BigQuery åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

### Phase 3+ (å°†æ¥): MVPå¤–
- ã‚«ã‚¹ã‚¿ãƒ MLãƒ¢ãƒ‡ãƒ«ï¼ˆMediaPipeç½®ãæ›ãˆï¼‰
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«æ©Ÿèƒ½
- å¤šè¨€èªå¯¾å¿œ

**å®Ÿè£…å‰ã«å¿…ãšæ©Ÿèƒ½ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**

## é‡è¦ãªæ³¨æ„äº‹é …

- **æ¨æ¸¬ç¦æ­¢**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãªã„å®Ÿè£…ã¯å¿…ãšã€Œæ¨æ¸¬ã€ã¨æ˜è¨˜
- **ä»•æ§˜æ›¸å„ªå…ˆ**: ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã‚ˆã‚Šä»•æ§˜æ›¸ã®å†…å®¹ã‚’å„ªå…ˆï¼ˆä¸Šè¨˜ã€Œä»•æ§˜æ›¸ã®å‚ç…§é †åºã€å‚ç…§ï¼‰
- **ãƒ•ã‚§ãƒ¼ã‚ºå³å®ˆ**: Phase 3ã®æ©Ÿèƒ½ã‚’Phase 1-2ã§å®Ÿè£…ã—ãªã„
- **æ³•ä»¤éµå®ˆ**: è–¬æ©Ÿæ³•ï¼ˆåŒ»ç™‚ç”¨èªç¦æ­¢ï¼‰ãƒ»GDPRãƒ»å€‹äººæƒ…å ±ä¿è­·æ³•ã‚’å¿…ãšç¢ºèª
