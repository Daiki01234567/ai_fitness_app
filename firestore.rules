rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================================
    // ヘルパー関数
    // ==============================================

    // ユーザー認証チェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // ユーザー本人チェック
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 管理者チェック
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // ユーザーが削除予定でないかチェック（readルール用）
    function isNotScheduledForDeletion() {
      // 読み取り時は既存のドキュメントを参照
      // resourceがnullの場合またはdeletionScheduledがtrueでない場合はtrue
      // deletionScheduledがtrueの場合のみfalse
      return !(resource != null && resource.data.deletionScheduled == true);
    }

    // ユーザーが削除予定でないかチェック（updateルール用）
    function isNotScheduledForDeletionForUpdate(userId) {
      // 更新時は既存のドキュメントを取得
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      // deletionScheduledがtrueの場合はアクセスを拒否
      return userDoc.data.deletionScheduled != true;
    }

    // ユーザーが強制ログアウト状態でないかチェック
    function isNotForcedLogout() {
      // request.auth が存在しない場合は false (未認証)
      // forceLogout クレームのデフォルト値を false に設定して安全にアクセス
      return request.auth != null && request.auth.token.get('forceLogout', false) == false;
    }

    // firestore.rules に適用する修正
    // タイムスタンプバリデーション
    function isValidTimestamp(ts) {
      // 引数 ts が 'timestamp' 型であるかをチェック
      return ts is timestamp;
    }

    // メールアドレスバリデーション（簡易版）
    function isValidEmail(email) {
      return email is string && email.matches('.+@.+\\..+');
    }

    // ==============================================
    // バリデーション関数
    // ==============================================

    // ユーザー作成バリデーション
    function validateUserCreate(data) {
      return data.keys().hasAll(['userId', 'email', 'tosAccepted', 'ppAccepted',
                                  'isActive', 'createdAt', 'updatedAt'])
             && data.userId is string
             && data.userId == request.auth.uid
             && isValidEmail(data.email)
             && data.tosAccepted == true
             && data.ppAccepted == true
             && data.isActive == true
             && (!('deletionScheduled' in data) || data.deletionScheduled == false)
             && (!('forceLogout' in data) || data.forceLogout == false)
             && isValidTimestamp(data.createdAt)
             && isValidTimestamp(data.updatedAt);
    }

    // ユーザー更新バリデーション
    function validateUserUpdate(newData, oldData) {
      // 変更不可フィールドのチェック
      // userIdとemailは更新リクエストに含まれない可能性があるため存在チェックを追加
      return (!('userId' in newData) || newData.userId == oldData.userId)
             && (!('email' in newData) || newData.email == oldData.email)
             && (!('createdAt' in newData) || newData.createdAt == oldData.createdAt)
             // 同意フィールドは変更不可（Cloud Functionsのみが変更可能）
             && (!('tosAccepted' in newData) || newData.tosAccepted == oldData.tosAccepted)
             && (!('tosAcceptedAt' in newData) || (!('tosAcceptedAt' in oldData) || newData.tosAcceptedAt == oldData.tosAcceptedAt))
             && (!('tosVersion' in newData) || (!('tosVersion' in oldData) || newData.tosVersion == oldData.tosVersion))
             && (!('ppAccepted' in newData) || newData.ppAccepted == oldData.ppAccepted)
             && (!('ppAcceptedAt' in newData) || (!('ppAcceptedAt' in oldData) || newData.ppAcceptedAt == oldData.ppAcceptedAt))
             && (!('ppVersion' in newData) || (!('ppVersion' in oldData) || newData.ppVersion == oldData.ppVersion))
             // 削除予定フラグは変更不可（Cloud Functionsのみが変更可能）
             && (!('deletionScheduled' in newData) || (!('deletionScheduled' in oldData) || newData.deletionScheduled == oldData.deletionScheduled))
             && (!('deletionScheduledAt' in newData) || (!('deletionScheduledAt' in oldData) || newData.deletionScheduledAt == oldData.deletionScheduledAt))
             && (!('scheduledDeletionDate' in newData) || (!('scheduledDeletionDate' in oldData) || newData.scheduledDeletionDate == oldData.scheduledDeletionDate))
             // 強制ログアウトフラグは変更不可（Cloud Functionsのみが変更可能）
             && (!('forceLogout' in newData) || (!('forceLogout' in oldData) || newData.forceLogout == oldData.forceLogout))
             && (!('forceLogoutAt' in newData) || (!('forceLogoutAt' in oldData) || newData.forceLogoutAt == oldData.forceLogoutAt))
             // プロフィール情報のバリデーション
             && (!('profile' in newData) || validateProfileData(newData.profile));
    }

    // プロフィールデータバリデーション
    function validateProfileData(profile) {
      return profile is map
             && (!('height' in profile) || (profile.height is number && profile.height >= 100 && profile.height <= 250))
             && (!('weight' in profile) || (profile.weight is number && profile.weight >= 30 && profile.weight <= 300))
             && (!('birthday' in profile) || isValidTimestamp(profile.birthday))
             && (!('gender' in profile) || profile.gender in ['male', 'female', 'other', 'prefer_not_to_say', null]);
    }

    // セッション作成バリデーション
    function validateSessionCreate(data) {
      return data.keys().hasAll(['sessionId', 'userId', 'exerciseType', 'startTime',
                                  'status', 'repCount', 'setCount', 'createdAt', 'updatedAt'])
             && data.sessionId is string
             && data.userId is string
             && data.userId == request.auth.uid
             && data.exerciseType in ['squat', 'armcurl', 'sideraise', 'shoulderpress', 'pushup']
             && isValidTimestamp(data.startTime)
             && data.status in ['active', 'completed', 'cancelled']
             && data.repCount is number && data.repCount >= 0
             && data.setCount is number && data.setCount >= 0
             && isValidTimestamp(data.createdAt)
             && isValidTimestamp(data.updatedAt)
             // poseDataのサイズ制限（配列の場合）
             && (!('poseData' in data) || data.poseData.size() <= 10000);
    }

    // セッション更新バリデーション
    function validateSessionUpdate(newData, oldData) {
      return newData.sessionId == oldData.sessionId
             && newData.userId == oldData.userId
             && newData.exerciseType == oldData.exerciseType
             && newData.startTime == oldData.startTime
             && newData.createdAt == oldData.createdAt
             && newData.status in ['active', 'completed', 'cancelled']
             && (!('poseData' in newData) || newData.poseData.size() <= 10000);
    }

    // フレーム作成バリデーション
    function validateFrameCreate(data) {
      return data.keys().hasAll(['frameId', 'timestamp', 'landmarks'])
             && data.frameId is string
             && data.timestamp is number
             && data.landmarks is list
             && data.landmarks.size() == 33;  // MediaPipe Poseは33ポイント
    }

    // 同意記録バリデーション
    function validateConsentCreate(data) {
      return data.keys().hasAll(['consentId', 'userId', 'type', 'action',
                                  'version', 'timestamp'])
             && data.consentId is string
             && data.userId is string
             && data.type in ['tos', 'pp']
             && data.action in ['accept', 'withdraw']
             && data.version is string
             && isValidTimestamp(data.timestamp);
    }

    // データ削除リクエストバリデーション
    function validateDeletionRequest(data) {
      return data.keys().hasAll(['requestId', 'userId', 'requestedAt',
                                  'scheduledDeletionDate', 'status'])
             && data.requestId is string
             && data.userId is string
             && data.userId == request.auth.uid
             && isValidTimestamp(data.requestedAt)
             && isValidTimestamp(data.scheduledDeletionDate)
             && data.status in ['pending', 'processing', 'completed', 'cancelled'];
    }

    // ==============================================
    // Usersコレクション
    // ==============================================

    match /users/{userId} {
      // 読み取り: 本人のみ、削除予定でない、強制ログアウトでない
      allow read: if isOwner(userId)
                  && isNotScheduledForDeletion()
                  && isNotForcedLogout();

      // 作成: 本人のみ、必須フィールドの検証
      allow create: if isOwner(userId)
                    && validateUserCreate(request.resource.data);

      // 更新: 本人のみ、削除予定でない、フィールドレベルの検証
      allow update: if isOwner(userId)
                    && isNotScheduledForDeletionForUpdate(userId)
                    && isNotForcedLogout()
                    && validateUserUpdate(request.resource.data, resource.data);

      // 削除: Cloud Functionsのみ（一般ユーザーは削除不可）
      allow delete: if false;

      // ========================================
      // Sessionsサブコレクション
      // ========================================

      match /sessions/{sessionId} {
        // 読み取り: 本人のみ、削除予定でない
        allow read: if isOwner(userId)
                    && isNotScheduledForDeletionForUpdate(userId)
                    && isNotForcedLogout();

        // 作成: 本人のみ、削除予定でない、バリデーション
        allow create: if isOwner(userId)
                      && isNotScheduledForDeletionForUpdate(userId)
                      && isNotForcedLogout()
                      && validateSessionCreate(request.resource.data);

        // 更新: 本人のみ、削除予定でない、バリデーション
        allow update: if isOwner(userId)
                      && isNotScheduledForDeletionForUpdate(userId)
                      && isNotForcedLogout()
                      && validateSessionUpdate(request.resource.data, resource.data);

        // 削除: Cloud Functionsのみ
        allow delete: if false;

        // ========================================
        // Framesサブコレクション
        // ========================================

        match /frames/{frameId} {
          // 読み取り: 本人のみ、削除予定でない
          allow read: if isOwner(userId)
                      && isNotScheduledForDeletionForUpdate(userId)
                      && isNotForcedLogout();

          // 作成: 本人のみ、削除予定でない、バリデーション
          allow create: if isOwner(userId)
                        && isNotScheduledForDeletionForUpdate(userId)
                        && isNotForcedLogout()
                        && validateFrameCreate(request.resource.data);

          // 更新・削除: 不許可（不変データ）
          allow update, delete: if false;
        }
      }

      // ========================================
      // Settingsサブコレクション
      // ========================================

      match /settings/{settingId} {
        // 読み取り: 本人のみ、削除予定でない
        allow read: if isOwner(userId)
                    && isNotScheduledForDeletionForUpdate(userId)
                    && isNotForcedLogout();

        // 作成・更新: 本人のみ、削除予定でない
        allow create, update: if isOwner(userId)
                              && isNotScheduledForDeletionForUpdate(userId)
                              && isNotForcedLogout();

        // 削除: 本人のみ、削除予定でない
        allow delete: if isOwner(userId)
                      && isNotScheduledForDeletionForUpdate(userId)
                      && isNotForcedLogout();
      }

      // ========================================
      // Subscriptionsサブコレクション
      // ========================================

      match /subscriptions/{subscriptionId} {
        // 読み取り: 本人のみ
        allow read: if isOwner(userId)
                    && isNotForcedLogout();

        // 作成・更新・削除: Cloud Functionsのみ（RevenueCat連携）
        allow create, update, delete: if false;
      }
    }

    // ==============================================
    // Consentsコレクション（同意管理）
    // ==============================================

    match /consents/{consentId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // 作成: Cloud Functionsのみ（監査ログのため）
      allow create: if false;

      // 更新・削除: 不許可（不変データ）
      allow update, delete: if false;
    }

    // ==============================================
    // Notificationsコレクション
    // ==============================================

    match /notifications/{notificationId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // 作成: Cloud Functionsのみ
      allow create: if false;

      // 更新: 本人のみ（既読状態の更新）
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId
                    && request.resource.data.type == resource.data.type
                    && request.resource.data.createdAt == resource.data.createdAt;

      // 削除: 本人のみ
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // ==============================================
    // DataDeletionRequestsコレクション
    // ==============================================

    match /dataDeletionRequests/{requestId} {
      // 読み取り: 本人のみ
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // 作成: 本人のみ、バリデーション
      allow create: if isAuthenticated()
                    && validateDeletionRequest(request.resource.data);

      // 更新: Cloud Functionsのみ（ステータス更新）
      allow update: if false;

      // 削除: 不許可
      allow delete: if false;
    }

    // ==============================================
    // BigQuerySyncFailuresコレクション
    // ==============================================

    match /bigquerySyncFailures/{failureId} {
      // 読み取り・書き込み: 管理者のみ
      allow read, write: if isAdmin();
    }

    // ==============================================
    // SecurityIncidentsコレクション
    // ==============================================

    match /securityIncidents/{incidentId} {
      // 読み取り・書き込み: 管理者のみ
      allow read, write: if isAdmin();
    }

    // ==============================================
    // デフォルトルール（全拒否）
    // ==============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
